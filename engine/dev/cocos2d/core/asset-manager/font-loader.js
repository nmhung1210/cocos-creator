
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/font-loader.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var textUtils = require('../utils/text-utils');

var _canvasContext = null; // letter symbol number CJK

var _testString = "BES bswy:->@123\u4E01\u3041\u1101";

var _fontFaces = Object.create(null);

var _intervalId = -1;

var _loadingFonts = []; // 3 seconds timeout

var _timeout = 3000; // Refer to https://github.com/typekit/webfontloader/blob/master/src/core/fontwatcher.js

var useNativeCheck = function () {
  var nativeCheck = undefined;
  return function () {
    if (nativeCheck === undefined) {
      if (!!window.FontFace) {
        var match = /Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent);
        var safari10Match = /OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent) && /Apple/.exec(window.navigator.vendor);

        if (match) {
          nativeCheck = parseInt(match[1], 10) > 42;
        } else if (safari10Match) {
          nativeCheck = false;
        } else {
          nativeCheck = true;
        }
      } else {
        nativeCheck = false;
      }
    }

    return nativeCheck;
  };
}();

function _checkFontLoaded() {
  var allFontsLoaded = true;
  var now = Date.now();

  for (var i = _loadingFonts.length - 1; i >= 0; i--) {
    var fontLoadHandle = _loadingFonts[i];
    var fontFamily = fontLoadHandle.fontFamilyName; // load timeout

    if (now - fontLoadHandle.startTime > _timeout) {
      cc.warnID(4933, fontFamily);
      fontLoadHandle.onComplete(null, fontFamily);

      _loadingFonts.splice(i, 1);

      continue;
    }

    var oldWidth = fontLoadHandle.refWidth;
    var fontDesc = '40px ' + fontFamily;
    _canvasContext.font = fontDesc;
    var newWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // loaded successfully

    if (oldWidth !== newWidth) {
      _loadingFonts.splice(i, 1);

      fontLoadHandle.onComplete(null, fontFamily);
    } else {
      allFontsLoaded = false;
    }
  }

  if (allFontsLoaded) {
    clearInterval(_intervalId);
    _intervalId = -1;
  }
} // refer to https://github.com/typekit/webfontloader/blob/master/src/core/nativefontwatchrunner.js


function nativeCheckFontLoaded(start, font, callback) {
  var loader = new Promise(function (resolve, reject) {
    var check = function check() {
      var now = Date.now();

      if (now - start >= _timeout) {
        reject();
      } else {
        document.fonts.load('40px ' + font).then(function (fonts) {
          if (fonts.length >= 1) {
            resolve();
          } else {
            setTimeout(check, 100);
          }
        }, function () {
          reject();
        });
      }
    };

    check();
  });
  var timeoutId = null,
      timer = new Promise(function (resolve, reject) {
    timeoutId = setTimeout(reject, _timeout);
  });
  Promise.race([timer, loader]).then(function () {
    if (timeoutId) {
      clearTimeout(timeoutId);
      timeoutId = null;
    }

    callback(null, font);
  }, function () {
    cc.warnID(4933, font);
    callback(null, font);
  });
}

var fontLoader = {
  loadFont: function loadFont(url, options, onComplete) {
    var fontFamilyName = fontLoader._getFontFamily(url); // Already loaded fonts


    if (_fontFaces[fontFamilyName]) {
      return onComplete(null, fontFamilyName);
    }

    if (!_canvasContext) {
      var labelCanvas = document.createElement('canvas');
      labelCanvas.width = 100;
      labelCanvas.height = 100;
      _canvasContext = labelCanvas.getContext('2d');
    } // Default width reference to test whether new font is loaded correctly


    var fontDesc = '40px ' + fontFamilyName;
    _canvasContext.font = fontDesc;
    var refWidth = textUtils.safeMeasureText(_canvasContext, _testString, fontDesc); // Setup font face style

    var fontStyle = document.createElement("style");
    fontStyle.type = "text/css";
    var fontStr = "";
    if (isNaN(fontFamilyName - 0)) fontStr += "@font-face { font-family:" + fontFamilyName + "; src:";else fontStr += "@font-face { font-family:'" + fontFamilyName + "'; src:";
    fontStr += "url('" + url + "');";
    fontStyle.textContent = fontStr + "}";
    document.body.appendChild(fontStyle); // Preload font with div

    var preloadDiv = document.createElement("div");
    var divStyle = preloadDiv.style;
    divStyle.fontFamily = fontFamilyName;
    preloadDiv.innerHTML = ".";
    divStyle.position = "absolute";
    divStyle.left = "-100px";
    divStyle.top = "-100px";
    document.body.appendChild(preloadDiv);

    if (useNativeCheck()) {
      nativeCheckFontLoaded(Date.now(), fontFamilyName, onComplete);
    } else {
      // Save loading font
      var fontLoadHandle = {
        fontFamilyName: fontFamilyName,
        refWidth: refWidth,
        onComplete: onComplete,
        startTime: Date.now()
      };

      _loadingFonts.push(fontLoadHandle);

      if (_intervalId === -1) {
        _intervalId = setInterval(_checkFontLoaded, 100);
      }
    }

    _fontFaces[fontFamilyName] = fontStyle;
  },
  _getFontFamily: function _getFontFamily(fontHandle) {
    var ttfIndex = fontHandle.lastIndexOf(".ttf");
    if (ttfIndex === -1) return fontHandle;
    var slashPos = fontHandle.lastIndexOf("/");
    var fontFamilyName;

    if (slashPos === -1) {
      fontFamilyName = fontHandle.substring(0, ttfIndex) + "_LABEL";
    } else {
      fontFamilyName = fontHandle.substring(slashPos + 1, ttfIndex) + "_LABEL";
    }

    if (fontFamilyName.indexOf(' ') !== -1) {
      fontFamilyName = '"' + fontFamilyName + '"';
    }

    return fontFamilyName;
  }
};
module.exports = fontLoader;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL2Fzc2V0LW1hbmFnZXIvZm9udC1sb2FkZXIuanMiXSwibmFtZXMiOlsidGV4dFV0aWxzIiwicmVxdWlyZSIsIl9jYW52YXNDb250ZXh0IiwiX3Rlc3RTdHJpbmciLCJfZm9udEZhY2VzIiwiT2JqZWN0IiwiY3JlYXRlIiwiX2ludGVydmFsSWQiLCJfbG9hZGluZ0ZvbnRzIiwiX3RpbWVvdXQiLCJ1c2VOYXRpdmVDaGVjayIsIm5hdGl2ZUNoZWNrIiwidW5kZWZpbmVkIiwid2luZG93IiwiRm9udEZhY2UiLCJtYXRjaCIsImV4ZWMiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJzYWZhcmkxME1hdGNoIiwidmVuZG9yIiwicGFyc2VJbnQiLCJfY2hlY2tGb250TG9hZGVkIiwiYWxsRm9udHNMb2FkZWQiLCJub3ciLCJEYXRlIiwiaSIsImxlbmd0aCIsImZvbnRMb2FkSGFuZGxlIiwiZm9udEZhbWlseSIsImZvbnRGYW1pbHlOYW1lIiwic3RhcnRUaW1lIiwiY2MiLCJ3YXJuSUQiLCJvbkNvbXBsZXRlIiwic3BsaWNlIiwib2xkV2lkdGgiLCJyZWZXaWR0aCIsImZvbnREZXNjIiwiZm9udCIsIm5ld1dpZHRoIiwic2FmZU1lYXN1cmVUZXh0IiwiY2xlYXJJbnRlcnZhbCIsIm5hdGl2ZUNoZWNrRm9udExvYWRlZCIsInN0YXJ0IiwiY2FsbGJhY2siLCJsb2FkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNoZWNrIiwiZG9jdW1lbnQiLCJmb250cyIsImxvYWQiLCJ0aGVuIiwic2V0VGltZW91dCIsInRpbWVvdXRJZCIsInRpbWVyIiwicmFjZSIsImNsZWFyVGltZW91dCIsImZvbnRMb2FkZXIiLCJsb2FkRm9udCIsInVybCIsIm9wdGlvbnMiLCJfZ2V0Rm9udEZhbWlseSIsImxhYmVsQ2FudmFzIiwiY3JlYXRlRWxlbWVudCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2V0Q29udGV4dCIsImZvbnRTdHlsZSIsInR5cGUiLCJmb250U3RyIiwiaXNOYU4iLCJ0ZXh0Q29udGVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsInByZWxvYWREaXYiLCJkaXZTdHlsZSIsInN0eWxlIiwiaW5uZXJIVE1MIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwicHVzaCIsInNldEludGVydmFsIiwiZm9udEhhbmRsZSIsInR0ZkluZGV4IiwibGFzdEluZGV4T2YiLCJzbGFzaFBvcyIsInN1YnN0cmluZyIsImluZGV4T2YiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXlCQSxJQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxxQkFBRCxDQUF6Qjs7QUFFQSxJQUFJQyxjQUFjLEdBQUcsSUFBckIsRUFDQTs7QUFDQSxJQUFJQyxXQUFXLEdBQUcsbUNBQWxCOztBQUVBLElBQUlDLFVBQVUsR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWMsSUFBZCxDQUFqQjs7QUFDQSxJQUFJQyxXQUFXLEdBQUcsQ0FBQyxDQUFuQjs7QUFDQSxJQUFJQyxhQUFhLEdBQUcsRUFBcEIsRUFDQTs7QUFDQSxJQUFJQyxRQUFRLEdBQUcsSUFBZixFQUVBOztBQUNBLElBQUlDLGNBQWMsR0FBSSxZQUFZO0FBQzlCLE1BQUlDLFdBQVcsR0FBR0MsU0FBbEI7QUFDQSxTQUFPLFlBQVk7QUFDZixRQUFJRCxXQUFXLEtBQUtDLFNBQXBCLEVBQStCO0FBQzNCLFVBQUksQ0FBQyxDQUFDQyxNQUFNLENBQUNDLFFBQWIsRUFBdUI7QUFDbkIsWUFBSUMsS0FBSyxHQUFHLHdCQUF3QkMsSUFBeEIsQ0FBNkJILE1BQU0sQ0FBQ0ksU0FBUCxDQUFpQkMsU0FBOUMsQ0FBWjtBQUNBLFlBQUlDLGFBQWEsR0FBRyw4QkFBOEJILElBQTlCLENBQW1DSCxNQUFNLENBQUNJLFNBQVAsQ0FBaUJDLFNBQXBELEtBQWtFLFFBQVFGLElBQVIsQ0FBYUgsTUFBTSxDQUFDSSxTQUFQLENBQWlCRyxNQUE5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QUNsQyxRQUFJQyxRQUFRLEdBQUdELFVBQVUsQ0FBQ0UsV0FBWCxDQUF1QixNQUF2QixDQUFmO0FBQ0EsUUFBSUQsUUFBUSxLQUFLLENBQUMsQ0FBbEIsRUFBcUIsT0FBT0QsVUFBUDtBQUVyQixRQUFJRyxRQUFRLEdBQUdILFVBQVUsQ0FBQ0UsV0FBWCxDQUF1QixHQUF2QixDQUFmO0FBQ0EsUUFBSTFELGNBQUo7O0FBQ0EsUUFBSTJELFFBQVEsS0FBSyxDQUFDLENBQWxCLEVBQXFCO0FBQ2pCM0QsTUFBQUEsY0FBYyxHQUFHd0QsVUFBVSxDQUFDSSxTQUFYLENBQXFCLENBQXJCLEVBQXdCSCxRQUF4QixJQUFvQyxRQUFyRDtBQUNILEtBRkQsTUFFTztBQUNIekQsTUFBQUEsY0FBYyxHQUFHd0QsVUFBVSxDQUFDSSxTQUFYLENBQXFCRCxRQUFRLEdBQUcsQ0FBaEMsRUFBbUNGLFFBQW5DLElBQStDLFFBQWhFO0FBQ0g7O0FBQ0QsUUFBSXpELGNBQWMsQ0FBQzZELE9BQWYsQ0FBdUIsR0FBdkIsTUFBZ0MsQ0FBQyxDQUFyQyxFQUF3QztBQUNwQzdELE1BQUFBLGNBQWMsR0FBRyxNQUFNQSxjQUFOLEdBQXVCLEdBQXhDO0FBQ0g7O0FBQ0QsV0FBT0EsY0FBUDtBQUNIO0FBN0VZLENBQWpCO0FBZ0ZBOEQsTUFBTSxDQUFDQyxPQUFQLEdBQWlCakMsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuIENvcHlyaWdodCAoYykgMjAxOSBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXG4gIG5vdCB1c2UgQ29jb3MgQ3JlYXRvciBzb2Z0d2FyZSBmb3IgZGV2ZWxvcGluZyBvdGhlciBzb2Z0d2FyZSBvciB0b29scyB0aGF0J3NcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuICBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cblxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmNvbnN0IHRleHRVdGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3RleHQtdXRpbHMnKTtcblxubGV0IF9jYW52YXNDb250ZXh0ID0gbnVsbDtcbi8vIGxldHRlciBzeW1ib2wgbnVtYmVyIENKS1xubGV0IF90ZXN0U3RyaW5nID0gXCJCRVMgYnN3eTotPkAxMjNcXHU0RTAxXFx1MzA0MVxcdTExMDFcIjtcblxubGV0IF9mb250RmFjZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xubGV0IF9pbnRlcnZhbElkID0gLTE7XG5sZXQgX2xvYWRpbmdGb250cyA9IFtdO1xuLy8gMyBzZWNvbmRzIHRpbWVvdXRcbmxldCBfdGltZW91dCA9IDMwMDA7XG5cbi8vIFJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS90eXBla2l0L3dlYmZvbnRsb2FkZXIvYmxvYi9tYXN0ZXIvc3JjL2NvcmUvZm9udHdhdGNoZXIuanNcbmxldCB1c2VOYXRpdmVDaGVjayA9IChmdW5jdGlvbiAoKSB7XG4gICAgdmFyIG5hdGl2ZUNoZWNrID0gdW5kZWZpbmVkO1xuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChuYXRpdmVDaGVjayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoISF3aW5kb3cuRm9udEZhY2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSAvR2Vja28uKkZpcmVmb3hcXC8oXFxkKykvLmV4ZWMod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xuICAgICAgICAgICAgICAgIHZhciBzYWZhcmkxME1hdGNoID0gL09TIFguKlZlcnNpb25cXC8xMFxcLi4qU2FmYXJpLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KSAmJiAvQXBwbGUvLmV4ZWMod2luZG93Lm5hdmlnYXRvci52ZW5kb3IpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBwYXJzZUludChtYXRjaFsxXSwgMTApID4gNDI7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChzYWZhcmkxME1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmF0aXZlQ2hlY2s7XG4gICAgICAgIFxuICAgIH1cbn0pKCk7XG5cbmZ1bmN0aW9uIF9jaGVja0ZvbnRMb2FkZWQgKCkge1xuICAgIGxldCBhbGxGb250c0xvYWRlZCA9IHRydWU7XG4gICAgbGV0IG5vdyA9IERhdGUubm93KCk7XG5cbiAgICBmb3IgKGxldCBpID0gX2xvYWRpbmdGb250cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSBfbG9hZGluZ0ZvbnRzW2ldO1xuICAgICAgICBsZXQgZm9udEZhbWlseSA9IGZvbnRMb2FkSGFuZGxlLmZvbnRGYW1pbHlOYW1lO1xuICAgICAgICAvLyBsb2FkIHRpbWVvdXRcbiAgICAgICAgaWYgKG5vdyAtIGZvbnRMb2FkSGFuZGxlLnN0YXJ0VGltZSA+IF90aW1lb3V0KSB7XG4gICAgICAgICAgICBjYy53YXJuSUQoNDkzMywgZm9udEZhbWlseSk7XG4gICAgICAgICAgICBmb250TG9hZEhhbmRsZS5vbkNvbXBsZXRlKG51bGwsIGZvbnRGYW1pbHkpO1xuICAgICAgICAgICAgX2xvYWRpbmdGb250cy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBvbGRXaWR0aCA9IGZvbnRMb2FkSGFuZGxlLnJlZldpZHRoO1xuICAgICAgICBsZXQgZm9udERlc2MgPSAnNDBweCAnICsgZm9udEZhbWlseTtcbiAgICAgICAgX2NhbnZhc0NvbnRleHQuZm9udCA9IGZvbnREZXNjO1xuICAgICAgICBsZXQgbmV3V2lkdGggPSB0ZXh0VXRpbHMuc2FmZU1lYXN1cmVUZXh0KF9jYW52YXNDb250ZXh0LCBfdGVzdFN0cmluZywgZm9udERlc2MpO1xuICAgICAgICAvLyBsb2FkZWQgc3VjY2Vzc2Z1bGx5XG4gICAgICAgIGlmIChvbGRXaWR0aCAhPT0gbmV3V2lkdGgpIHtcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgZm9udExvYWRIYW5kbGUub25Db21wbGV0ZShudWxsLCBmb250RmFtaWx5KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGFsbEZvbnRzTG9hZGVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoYWxsRm9udHNMb2FkZWQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbChfaW50ZXJ2YWxJZCk7XG4gICAgICAgIF9pbnRlcnZhbElkID0gLTE7XG4gICAgfVxufVxuXG4vLyByZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vdHlwZWtpdC93ZWJmb250bG9hZGVyL2Jsb2IvbWFzdGVyL3NyYy9jb3JlL25hdGl2ZWZvbnR3YXRjaHJ1bm5lci5qc1xuZnVuY3Rpb24gbmF0aXZlQ2hlY2tGb250TG9hZGVkIChzdGFydCwgZm9udCwgY2FsbGJhY2spIHtcbiAgICB2YXIgbG9hZGVyID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICB2YXIgY2hlY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTtcblxuICAgICAgICAgICAgaWYgKG5vdyAtIHN0YXJ0ID49IF90aW1lb3V0KSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgICAgICB9IFxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuZm9udHMubG9hZCgnNDBweCAnICsgZm9udCkudGhlbihmdW5jdGlvbiAoZm9udHMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvbnRzLmxlbmd0aCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVjaywgMTAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgY2hlY2soKTtcbiAgICB9KTtcbiAgXG4gICAgdmFyIHRpbWVvdXRJZCA9IG51bGwsXG4gICAgdGltZXIgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQocmVqZWN0LCBfdGltZW91dCk7XG4gICAgfSk7XG4gIFxuICAgIFByb21pc2UucmFjZShbdGltZXIsIGxvYWRlcl0pLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGZvbnQpO1xuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY2Mud2FybklEKDQ5MzMsIGZvbnQpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBmb250KTtcbiAgICB9KTtcbn1cblxudmFyIGZvbnRMb2FkZXIgPSB7XG4gICAgbG9hZEZvbnQ6IGZ1bmN0aW9uICh1cmwsIG9wdGlvbnMsIG9uQ29tcGxldGUpIHtcbiAgICAgICAgbGV0IGZvbnRGYW1pbHlOYW1lID0gZm9udExvYWRlci5fZ2V0Rm9udEZhbWlseSh1cmwpO1xuXG4gICAgICAgIC8vIEFscmVhZHkgbG9hZGVkIGZvbnRzXG4gICAgICAgIGlmIChfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSkge1xuICAgICAgICAgICAgcmV0dXJuIG9uQ29tcGxldGUobnVsbCwgZm9udEZhbWlseU5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfY2FudmFzQ29udGV4dCkge1xuICAgICAgICAgICAgbGV0IGxhYmVsQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgICAgICBsYWJlbENhbnZhcy53aWR0aCA9IDEwMDtcbiAgICAgICAgICAgIGxhYmVsQ2FudmFzLmhlaWdodCA9IDEwMDtcbiAgICAgICAgICAgIF9jYW52YXNDb250ZXh0ID0gbGFiZWxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gRGVmYXVsdCB3aWR0aCByZWZlcmVuY2UgdG8gdGVzdCB3aGV0aGVyIG5ldyBmb250IGlzIGxvYWRlZCBjb3JyZWN0bHlcbiAgICAgICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHlOYW1lO1xuICAgICAgICBfY2FudmFzQ29udGV4dC5mb250ID0gZm9udERlc2M7XG4gICAgICAgIGxldCByZWZXaWR0aCA9IHRleHRVdGlscy5zYWZlTWVhc3VyZVRleHQoX2NhbnZhc0NvbnRleHQsIF90ZXN0U3RyaW5nLCBmb250RGVzYyk7XG5cbiAgICAgICAgLy8gU2V0dXAgZm9udCBmYWNlIHN0eWxlXG4gICAgICAgIGxldCBmb250U3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIik7XG4gICAgICAgIGZvbnRTdHlsZS50eXBlID0gXCJ0ZXh0L2Nzc1wiO1xuICAgICAgICBsZXQgZm9udFN0ciA9IFwiXCI7XG4gICAgICAgIGlmIChpc05hTihmb250RmFtaWx5TmFtZSAtIDApKVxuICAgICAgICAgICAgZm9udFN0ciArPSBcIkBmb250LWZhY2UgeyBmb250LWZhbWlseTpcIiArIGZvbnRGYW1pbHlOYW1lICsgXCI7IHNyYzpcIjtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgZm9udFN0ciArPSBcIkBmb250LWZhY2UgeyBmb250LWZhbWlseTonXCIgKyBmb250RmFtaWx5TmFtZSArIFwiJzsgc3JjOlwiO1xuICAgICAgICBmb250U3RyICs9IFwidXJsKCdcIiArIHVybCArIFwiJyk7XCI7XG4gICAgICAgIGZvbnRTdHlsZS50ZXh0Q29udGVudCA9IGZvbnRTdHIgKyBcIn1cIjtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb250U3R5bGUpO1xuXG4gICAgICAgIC8vIFByZWxvYWQgZm9udCB3aXRoIGRpdlxuICAgICAgICBsZXQgcHJlbG9hZERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIGxldCBkaXZTdHlsZSA9IHByZWxvYWREaXYuc3R5bGU7XG4gICAgICAgIGRpdlN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5TmFtZTtcbiAgICAgICAgcHJlbG9hZERpdi5pbm5lckhUTUwgPSBcIi5cIjtcbiAgICAgICAgZGl2U3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgICAgIGRpdlN0eWxlLmxlZnQgPSBcIi0xMDBweFwiO1xuICAgICAgICBkaXZTdHlsZS50b3AgPSBcIi0xMDBweFwiO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHByZWxvYWREaXYpO1xuXG4gICAgICAgIGlmICh1c2VOYXRpdmVDaGVjaygpKSB7XG4gICAgICAgICAgICBuYXRpdmVDaGVja0ZvbnRMb2FkZWQoRGF0ZS5ub3coKSwgZm9udEZhbWlseU5hbWUsIG9uQ29tcGxldGUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy8gU2F2ZSBsb2FkaW5nIGZvbnRcbiAgICAgICAgICAgIGxldCBmb250TG9hZEhhbmRsZSA9IHtcbiAgICAgICAgICAgICAgICBmb250RmFtaWx5TmFtZSxcbiAgICAgICAgICAgICAgICByZWZXaWR0aCxcbiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlLFxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogRGF0ZS5ub3coKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgX2xvYWRpbmdGb250cy5wdXNoKGZvbnRMb2FkSGFuZGxlKTtcbiAgICAgICAgICAgIGlmIChfaW50ZXJ2YWxJZCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICBfaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKF9jaGVja0ZvbnRMb2FkZWQsIDEwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgX2ZvbnRGYWNlc1tmb250RmFtaWx5TmFtZV0gPSBmb250U3R5bGU7XG4gICAgfSxcblxuICAgIF9nZXRGb250RmFtaWx5OiBmdW5jdGlvbiAoZm9udEhhbmRsZSkge1xuICAgICAgICB2YXIgdHRmSW5kZXggPSBmb250SGFuZGxlLmxhc3RJbmRleE9mKFwiLnR0ZlwiKTtcbiAgICAgICAgaWYgKHR0ZkluZGV4ID09PSAtMSkgcmV0dXJuIGZvbnRIYW5kbGU7XG5cbiAgICAgICAgdmFyIHNsYXNoUG9zID0gZm9udEhhbmRsZS5sYXN0SW5kZXhPZihcIi9cIik7XG4gICAgICAgIHZhciBmb250RmFtaWx5TmFtZTtcbiAgICAgICAgaWYgKHNsYXNoUG9zID09PSAtMSkge1xuICAgICAgICAgICAgZm9udEZhbWlseU5hbWUgPSBmb250SGFuZGxlLnN1YnN0cmluZygwLCB0dGZJbmRleCkgKyBcIl9MQUJFTFwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9udEZhbWlseU5hbWUgPSBmb250SGFuZGxlLnN1YnN0cmluZyhzbGFzaFBvcyArIDEsIHR0ZkluZGV4KSArIFwiX0xBQkVMXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvbnRGYW1pbHlOYW1lLmluZGV4T2YoJyAnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIGZvbnRGYW1pbHlOYW1lID0gJ1wiJyArIGZvbnRGYW1pbHlOYW1lICsgJ1wiJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZm9udEZhbWlseU5hbWU7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBmb250TG9hZGVyIl0sInNvdXJjZVJvb3QiOiIvIn0=