
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/asset-manager/fetch.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2019 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
  worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
  not use Cocos Creator software for developing other software or tools that's
  used for developing games. You are not granted to publish, distribute,
  sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var packManager = require('./pack-manager');

var Task = require('./task');

var _require = require('./utilities'),
    getDepends = _require.getDepends,
    clear = _require.clear,
    forEach = _require.forEach;

var _require2 = require('./shared'),
    assets = _require2.assets,
    fetchPipeline = _require2.fetchPipeline;

function fetch(task, done) {
  var firstTask = false;

  if (!task.progress) {
    task.progress = {
      finish: 0,
      total: task.input.length
    };
    firstTask = true;
  }

  var options = task.options,
      depends = [],
      progress = task.progress,
      total = progress.total;
  options.__exclude__ = options.__exclude__ || Object.create(null);
  task.output = [];
  forEach(task.input, function (item, cb) {
    if (!item.isNative && assets.has(item.uuid)) {
      var asset = assets.get(item.uuid);
      asset.addRef();
      handle(item, task, asset, null, asset.__asyncLoadAssets__, depends, total, done);
      return cb();
    }

    packManager.load(item, task.options, function (err, data) {
      if (err) {
        if (!task.isFinish) {
          if (!cc.assetManager.force) {
            cc.error(err.message, err.stack);
            done(err);
          } else {
            handle(item, task, null, null, false, depends, total, done);
          }
        }
      } else {
        if (!task.isFinish) handle(item, task, null, data, !item.isNative, depends, total, done);
      }

      cb();
    });
  }, function () {
    if (task.isFinish) {
      clear(task, true);
      return task.dispatch('error');
    }

    if (depends.length > 0) {
      // stage 2 , download depend asset
      var subTask = Task.create({
        name: task.name + ' dependencies',
        input: depends,
        progress: progress,
        options: options,
        onProgress: task.onProgress,
        onError: Task.prototype.recycle,
        onComplete: function onComplete(err) {
          if (!err) {
            task.output.push.apply(task.output, this.output);
            subTask.recycle();
          }

          if (firstTask) decreaseRef(task);
          done(err);
        }
      });
      fetchPipeline.async(subTask);
      return;
    }

    if (firstTask) decreaseRef(task);
    done();
  });
}

function decreaseRef(task) {
  var output = task.output;

  for (var i = 0, l = output.length; i < l; i++) {
    output[i].content && output[i].content.decRef(false);
  }
}

function handle(item, task, content, file, loadDepends, depends, last, done) {
  var exclude = task.options.__exclude__;
  var progress = task.progress;
  item.content = content;
  item.file = file;
  task.output.push(item);

  if (loadDepends) {
    exclude[item.uuid] = true;
    var err = getDepends(item.uuid, file || content, exclude, depends, true, false, item.config);

    if (err) {
      if (!cc.assetManager.force) {
        cc.error(err.message, err.stack);
        return done(err);
      }

      item.file = null;
    }

    progress.total = last + depends.length;
  }

  task.dispatch('progress', ++progress.finish, progress.total, item);
}

module.exports = fetch;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL2Fzc2V0LW1hbmFnZXIvZmV0Y2guanMiXSwibmFtZXMiOlsicGFja01hbmFnZXIiLCJyZXF1aXJlIiwiVGFzayIsImdldERlcGVuZHMiLCJjbGVhciIsImZvckVhY2giLCJhc3NldHMiLCJmZXRjaFBpcGVsaW5lIiwiZmV0Y2giLCJ0YXNrIiwiZG9uZSIsImZpcnN0VGFzayIsInByb2dyZXNzIiwiZmluaXNoIiwidG90YWwiLCJpbnB1dCIsImxlbmd0aCIsIm9wdGlvbnMiLCJkZXBlbmRzIiwiX19leGNsdWRlX18iLCJPYmplY3QiLCJjcmVhdGUiLCJvdXRwdXQiLCJpdGVtIiwiY2IiLCJpc05hdGl2ZSIsImhhcyIsInV1aWQiLCJhc3NldCIsImdldCIsImFkZFJlZiIsImhhbmRsZSIsIl9fYXN5bmNMb2FkQXNzZXRzX18iLCJsb2FkIiwiZXJyIiwiZGF0YSIsImlzRmluaXNoIiwiY2MiLCJhc3NldE1hbmFnZXIiLCJmb3JjZSIsImVycm9yIiwibWVzc2FnZSIsInN0YWNrIiwiZGlzcGF0Y2giLCJzdWJUYXNrIiwibmFtZSIsIm9uUHJvZ3Jlc3MiLCJvbkVycm9yIiwicHJvdG90eXBlIiwicmVjeWNsZSIsIm9uQ29tcGxldGUiLCJwdXNoIiwiYXBwbHkiLCJkZWNyZWFzZVJlZiIsImFzeW5jIiwiaSIsImwiLCJjb250ZW50IiwiZGVjUmVmIiwiZmlsZSIsImxvYWREZXBlbmRzIiwibGFzdCIsImV4Y2x1ZGUiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXdCQSxJQUFNQSxXQUFXLEdBQUdDLE9BQU8sQ0FBQyxnQkFBRCxDQUEzQjs7QUFDQSxJQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQXBCOztlQUN1Q0EsT0FBTyxDQUFDLGFBQUQ7SUFBdENFLHNCQUFBQTtJQUFZQyxpQkFBQUE7SUFBT0Ms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LENBQUNDLFlBQUgsQ0FBZ0JDLEtBQXJCLEVBQTRCO0FBQ3hCRixRQUFBQSxFQUFFLENBQUNHLEtBQUgsQ0FBU04sR0FBRyxDQUFDTyxPQUFiLEVBQXNCUCxHQUFHLENBQUNRLEtBQTFCO0FBQ0EsZUFBT2hDLElBQUksQ0FBQ3dCLEdBQUQsQ0FBWDtBQUNIOztBQUNEWCxNQUFBQSxJQUFJLENBQUNvQyxJQUFMLEdBQVksSUFBWjtBQUNIOztBQUNEL0MsSUFBQUEsUUFBUSxDQUFDRSxLQUFULEdBQWlCK0MsSUFBSSxHQUFHM0MsT0FBTyxDQUFDRixNQUFoQztBQUNIOztBQUVEUCxFQUFBQSxJQUFJLENBQUNrQyxRQUFMLENBQWMsVUFBZCxFQUEwQixFQUFFL0IsUUFBUSxDQUFDQyxNQUFyQyxFQUE2Q0QsUUFBUSxDQUFDRSxLQUF0RCxFQUE2RFMsSUFBN0Q7QUFDSDs7QUFFRHlDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnpELEtBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTkgWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXG5cbiBodHRwczovL3d3dy5jb2Nvcy5jb20vXG5cbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXG4gIHdvcmxkd2lkZSwgcm95YWx0eS1mcmVlLCBub24tYXNzaWduYWJsZSwgcmV2b2NhYmxlIGFuZCBub24tZXhjbHVzaXZlIGxpY2Vuc2VcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcbiAgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXG5cbiBUaGUgc29mdHdhcmUgb3IgdG9vbHMgaW4gdGhpcyBMaWNlbnNlIEFncmVlbWVudCBhcmUgbGljZW5zZWQsIG5vdCBzb2xkLlxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXG5cbiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuIFRIRSBTT0ZUV0FSRS5cbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuY29uc3QgcGFja01hbmFnZXIgPSByZXF1aXJlKCcuL3BhY2stbWFuYWdlcicpO1xuY29uc3QgVGFzayA9IHJlcXVpcmUoJy4vdGFzaycpO1xuY29uc3QgeyBnZXREZXBlbmRzLCBjbGVhciwgZm9yRWFjaCB9ID0gcmVxdWlyZSgnLi91dGlsaXRpZXMnKTtcbmNvbnN0IHsgYXNzZXRzLCBmZXRjaFBpcGVsaW5lIH0gPSByZXF1aXJlKCcuL3NoYXJlZCcpO1xuXG5mdW5jdGlvbiBmZXRjaCAodGFzaywgZG9uZSkge1xuXG4gICAgbGV0IGZpcnN0VGFzayA9IGZhbHNlO1xuICAgIGlmICghdGFzay5wcm9ncmVzcykge1xuICAgICAgICB0YXNrLnByb2dyZXNzID0geyBmaW5pc2g6IDAsIHRvdGFsOiB0YXNrLmlucHV0Lmxlbmd0aCB9OyBcbiAgICAgICAgZmlyc3RUYXNrID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBsZXQgb3B0aW9ucyA9IHRhc2sub3B0aW9ucywgZGVwZW5kcyA9IFtdLCBwcm9ncmVzcyA9IHRhc2sucHJvZ3Jlc3MsIHRvdGFsID0gcHJvZ3Jlc3MudG90YWw7XG4gICAgb3B0aW9ucy5fX2V4Y2x1ZGVfXyA9IG9wdGlvbnMuX19leGNsdWRlX18gfHwgT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgIHRhc2sub3V0cHV0ID0gW107XG5cbiAgICBmb3JFYWNoKHRhc2suaW5wdXQsIGZ1bmN0aW9uIChpdGVtLCBjYikge1xuICAgICAgICBcbiAgICAgICAgaWYgKCFpdGVtLmlzTmF0aXZlICYmIGFzc2V0cy5oYXMoaXRlbS51dWlkKSkge1xuICAgICAgICAgICAgdmFyIGFzc2V0ID0gYXNzZXRzLmdldChpdGVtLnV1aWQpO1xuICAgICAgICAgICAgYXNzZXQuYWRkUmVmKCk7XG4gICAgICAgICAgICBoYW5kbGUoaXRlbSwgdGFzaywgYXNzZXQsIG51bGwsIGFzc2V0Ll9fYXN5bmNMb2FkQXNzZXRzX18sIGRlcGVuZHMsIHRvdGFsLCBkb25lKTtcbiAgICAgICAgICAgIHJldHVybiBjYigpO1xuICAgICAgICB9XG5cbiAgICAgICAgcGFja01hbmFnZXIubG9hZChpdGVtLCB0YXNrLm9wdGlvbnMsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRhc2suaXNGaW5pc2gpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYy5hc3NldE1hbmFnZXIuZm9yY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNjLmVycm9yKGVyci5tZXNzYWdlLCBlcnIuc3RhY2spO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZShlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlKGl0ZW0sIHRhc2ssIG51bGwsIG51bGwsIGZhbHNlLCBkZXBlbmRzLCB0b3RhbCwgZG9uZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRhc2suaXNGaW5pc2gpIGhhbmRsZShpdGVtLCB0YXNrLCBudWxsLCBkYXRhLCAhaXRlbS5pc05hdGl2ZSwgZGVwZW5kcywgdG90YWwsIGRvbmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgIH0sIGZ1bmN0aW9uICgpIHtcblxuICAgICAgICBpZiAodGFzay5pc0ZpbmlzaCkge1xuICAgICAgICAgICAgY2xlYXIodGFzaywgdHJ1ZSk7XG4gICAgICAgICAgICByZXR1cm4gdGFzay5kaXNwYXRjaCgnZXJyb3InKTtcbiAgICAgICAgfSBcbiAgICAgICAgaWYgKGRlcGVuZHMubGVuZ3RoID4gMCkge1xuXG4gICAgICAgICAgICAvLyBzdGFnZSAyICwgZG93bmxvYWQgZGVwZW5kIGFzc2V0XG4gICAgICAgICAgICBsZXQgc3ViVGFzayA9IFRhc2suY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0YXNrLm5hbWUgKyAnIGRlcGVuZGVuY2llcycsXG4gICAgICAgICAgICAgICAgaW5wdXQ6IGRlcGVuZHMsXG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgICAgICBvblByb2dyZXNzOiB0YXNrLm9uUHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgb25FcnJvcjogVGFzay5wcm90b3R5cGUucmVjeWNsZSxcbiAgICAgICAgICAgICAgICBvbkNvbXBsZXRlOiBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXNrLm91dHB1dC5wdXNoLmFwcGx5KHRhc2sub3V0cHV0LCB0aGlzLm91dHB1dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJUYXNrLnJlY3ljbGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RUYXNrKSBkZWNyZWFzZVJlZih0YXNrKTtcbiAgICAgICAgICAgICAgICAgICAgZG9uZShlcnIpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZldGNoUGlwZWxpbmUuYXN5bmMoc3ViVGFzayk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpcnN0VGFzaykgZGVjcmVhc2VSZWYodGFzayk7XG4gICAgICAgIGRvbmUoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gZGVjcmVhc2VSZWYgKHRhc2spIHtcbiAgICBsZXQgb3V0cHV0ID0gdGFzay5vdXRwdXQ7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBvdXRwdXQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIG91dHB1dFtpXS5jb250ZW50ICYmIG91dHB1dFtpXS5jb250ZW50LmRlY1JlZihmYWxzZSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGUgKGl0ZW0sIHRhc2ssIGNvbnRlbnQsIGZpbGUsIGxvYWREZXBlbmRzLCBkZXBlbmRzLCBsYXN0LCBkb25lKSB7XG5cbiAgICB2YXIgZXhjbHVkZSA9IHRhc2sub3B0aW9ucy5fX2V4Y2x1ZGVfXztcbiAgICB2YXIgcHJvZ3Jlc3MgPSB0YXNrLnByb2dyZXNzO1xuXG4gICAgaXRlbS5jb250ZW50ID0gY29udGVudDtcbiAgICBpdGVtLmZpbGUgPSBmaWxlO1xuICAgIHRhc2sub3V0cHV0LnB1c2goaXRlbSk7XG5cbiAgICBpZiAobG9hZERlcGVuZHMpIHtcbiAgICAgICAgZXhjbHVkZVtpdGVtLnV1aWRdID0gdHJ1ZTtcbiAgICAgICAgdmFyIGVyciA9IGdldERlcGVuZHMoaXRlbS51dWlkLCBmaWxlIHx8IGNvbnRlbnQsIGV4Y2x1ZGUsIGRlcGVuZHMsIHRydWUsIGZhbHNlLCBpdGVtLmNvbmZpZyk7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGlmICghY2MuYXNzZXRNYW5hZ2VyLmZvcmNlKSB7XG4gICAgICAgICAgICAgICAgY2MuZXJyb3IoZXJyLm1lc3NhZ2UsIGVyci5zdGFjayk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW0uZmlsZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcHJvZ3Jlc3MudG90YWwgPSBsYXN0ICsgZGVwZW5kcy5sZW5ndGg7XG4gICAgfVxuXG4gICAgdGFzay5kaXNwYXRjaCgncHJvZ3Jlc3MnLCArK3Byb2dyZXNzLmZpbmlzaCwgcHJvZ3Jlc3MudG90YWwsIGl0ZW0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZldGNoOyJdLCJzb3VyY2VSb290IjoiLyJ9