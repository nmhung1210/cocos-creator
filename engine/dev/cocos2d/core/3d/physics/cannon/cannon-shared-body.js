
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/3d/physics/cannon/cannon-shared-body.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

exports.__esModule = true;
exports.CannonSharedBody = void 0;

var _cannon = _interopRequireDefault(require("../../../../../external/cannon/cannon"));

var _physicsEnum = require("../framework/physics-enum");

var _util = require("../framework/util");

var _cannonUtil = require("./cannon-util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var LocalDirtyFlag = cc.Node._LocalDirtyFlag;
var PHYSICS_SCALE = LocalDirtyFlag.PHYSICS_SCALE;
var Quat = cc.Quat;
var Vec3 = cc.Vec3;
var fastRemoveAt = cc.js.array.fastRemoveAt;
var v3_0 = new Vec3();
var quat_0 = new Quat();
var contactsPool = [];
var CollisionEventObject = {
  type: 'collision-enter',
  selfCollider: null,
  otherCollider: null,
  contacts: []
};
/**
 * sharedbody, node : sharedbody = 1 : 1
 * static
 */

var CannonSharedBody = /*#__PURE__*/function () {
  CannonSharedBody.getSharedBody = function getSharedBody(node, wrappedWorld) {
    var key = node._id;

    if (CannonSharedBody.sharedBodiesMap.has(key)) {
      return CannonSharedBody.sharedBodiesMap.get(key);
    } else {
      var newSB = new CannonSharedBody(node, wrappedWorld);
      CannonSharedBody.sharedBodiesMap.set(node._id, newSB);
      return newSB;
    }
  };

  _createClass(CannonSharedBody, [{
    key: "enabled",

    /**
     * add or remove from world \
     * add, if enable \
     * remove, if disable & shapes.length == 0 & wrappedBody disable
     */
    set: function set(v) {
      if (v) {
        if (this.index < 0) {
          this.index = this.wrappedWorld.bodies.length;
          this.wrappedWorld.addSharedBody(this);
          this.syncSceneToPhysics(true);
        }
      } else {
        if (this.index >= 0) {
          var isRemove = this.shapes.length == 0 && this.wrappedBody == null || this.shapes.length == 0 && this.wrappedBody != null && !this.wrappedBody.rigidBody.enabledInHierarchy || this.shapes.length == 0 && this.wrappedBody != null && !this.wrappedBody.isEnabled;

          if (isRemove) {
            this.body.sleep(); // clear velocity etc.

            this.index = -1;
            this.wrappedWorld.removeSharedBody(this);
          }
        }
      }
    }
  }, {
    key: "reference",
    set: function set(v) {
      v ? this.ref++ : this.ref--;

      if (this.ref == 0) {
        this.destroy();
      }
    }
  }]);

  function CannonSharedBody(node, wrappedWorld) {
    this.node = void 0;
    this.wrappedWorld = void 0;
    this.body = new _cannon["default"].Body();
    this.shapes = [];
    this.wrappedBody = null;
    this.index = -1;
    this.ref = 0;
    this.onCollidedListener = this.onCollided.bind(this);
    this.wrappedWorld = wrappedWorld;
    this.node = node;
    this.body.material = this.wrappedWorld.world.defaultMaterial;
    this.body.addEventListener('collide', this.onCollidedListener);

    this._updateGroup();

    this.node.on(cc.Node.EventType.GROUP_CHANGED, this._updateGroup, this);
  }

  var _proto = CannonSharedBody.prototype;

  _proto._updateGroup = function _updateGroup() {
    (0, _cannonUtil.groupIndexToBitMask)(this.node.groupIndex, this.body);
  };

  _proto.addShape = function addShape(v) {
    var index = this.shapes.indexOf(v);

    if (index < 0) {
      var _index = this.body.shapes.length;
      this.body.addShape(v.shape);
      this.shapes.push(v);
      v.setIndex(_index);
      var offset = this.body.shapeOffsets[_index];
      var orient = this.body.shapeOrientations[_index];
      v.setOffsetAndOrient(offset, orient);
    }
  };

  _proto.removeShape = function removeShape(v) {
    var index = this.shapes.indexOf(v);

    if (index >= 0) {
      fastRemoveAt(this.shapes, index);
      this.body.removeShape(v.shape);
      v.setIndex(-1);
    }
  };

  _proto.syncSceneToPhysics = function syncSceneToPhysics(force) {
    if (force === void 0) {
      force = false;
    }

    var node = this.node;
    var needUpdateTransform = (0, _util.updateWorldTransform)(node, force);

    if (!force && !needUpdateTransform) {
      return;
    }

    Vec3.copy(this.body.position, node.__wpos);
    Quat.copy(this.body.quaternion, node.__wrot);

    if (node._localMatDirty & PHYSICS_SCALE) {
      var wscale = node.__wscale;

      for (var i = 0; i < this.shapes.length; i++) {
        this.shapes[i].setScale(wscale);
      }
    }

    if (this.body.isSleeping()) {
      this.body.wakeUp();
    } // body world aabb need to be recalculated


    this.body.aabbNeedsUpdate = true;
  };

  _proto.syncPhysicsToScene = function syncPhysicsToScene() {
    if (this.body.type != _physicsEnum.ERigidBodyType.STATIC) {
      Vec3.copy(v3_0, this.body.position);
      Quat.copy(quat_0, this.body.quaternion);
      (0, _util.updateWorldRT)(this.node, v3_0, quat_0);
    }
  };

  _proto.destroy = function destroy() {
    this.node.off(cc.Node.EventType.GROUP_CHANGED, this._updateGroup, this);
    CannonSharedBody.sharedBodiesMap["delete"](this.node._id);
    this.node = null;
    this.wrappedWorld = null;
    this.body = null;
    this.shapes = null;
    this.onCollidedListener = null;
  };

  _proto.onCollided = function onCollided(event) {
    CollisionEventObject.type = event.event;
    var self = (0, _util.getWrap)(event.selfShape);
    var other = (0, _util.getWrap)(event.otherShape);

    if (self) {
      CollisionEventObject.selfCollider = self.collider;
      CollisionEventObject.otherCollider = other ? other.collider : null;
      var i = 0;

      for (i = CollisionEventObject.contacts.length; i--;) {
        contactsPool.push(CollisionEventObject.contacts.pop());
      }

      for (i = 0; i < event.contacts.length; i++) {
        var cq = event.contacts[i];

        if (contactsPool.length > 0) {
          var c = contactsPool.pop();
          Vec3.copy(c.contactA, cq.ri);
          Vec3.copy(c.contactB, cq.rj);
          Vec3.copy(c.normal, cq.ni);
          CollisionEventObject.contacts.push(c);
        } else {
          var _c = {
            contactA: Vec3.copy(new Vec3(), cq.ri),
            contactB: Vec3.copy(new Vec3(), cq.rj),
            normal: Vec3.copy(new Vec3(), cq.ni)
          };
          CollisionEventObject.contacts.push(_c);
        }
      }

      for (i = 0; i < this.shapes.length; i++) {
        var shape = this.shapes[i];
        shape.collider.emit(CollisionEventObject.type, CollisionEventObject);
      }
    }
  };

  return CannonSharedBody;
}();

exports.CannonSharedBody = CannonSharedBody;
CannonSharedBody.sharedBodiesMap = new Map();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlLzNkL3BoeXNpY3MvY2Fubm9uL2Nhbm5vbi1zaGFyZWQtYm9keS50cyJdLCJuYW1lcyI6WyJMb2NhbERpcnR5RmxhZyIsImNjIiwiTm9kZSIsIl9Mb2NhbERpcnR5RmxhZyIsIlBIWVNJQ1NfU0NBTEUiLCJRdWF0IiwiVmVjMyIsImZhc3RSZW1vdmVBdCIsImpzIiwiYXJyYXkiLCJ2M18wIiwicXVhdF8wIiwiY29udGFjdHNQb29sIiwiQ29sbGlzaW9uRXZlbnRPYmplY3QiLCJ0eXBlIiwic2VsZkNvbGxpZGVyIiwib3RoZXJDb2xsaWRlciIsImNvbnRhY3RzIiwiQ2Fubm9uU2hhcmVkQm9keSIsImdldFNoYXJlZEJvZHkiLCJub2RlIiwid3JhcHBlZFdvcmxkIiwia2V5IiwiX2lkIiwic2hhcmVkQm9kaWVzTWFwIiwiaGFzIiwiZ2V0IiwibmV3U0IiLCJzZXQiLCJ2IiwiaW5kZXgiLCJib2RpZXMiLCJsZW5ndGgiLCJhZGRTaGFyZWRCb2R5Iiwic3luY1NjZW5lVG9QaHlzaWNzIiwiaXNSZW1vdmUiLCJzaGFwZXMiLCJ3cmFwcGVkQm9keSIsInJpZ2lkQm9keSIsImVuYWJsZWRJbkhpZXJhcmNoeSIsImlzRW5hYmxlZCIsImJvZHkiLCJzbGVlcCIsInJlbW92ZVNoYXJlZEJvZHkiLCJyZWYiLCJkZXN0cm95IiwiQ0FOTk9OIiwiQm9keSIsIm9uQ29sbGlkZWRMaXN0ZW5lciIsIm9uQ29sbGlkZWQiLCJiaW5kIiwibWF0ZXJpYWwiLCJ3b3JsZCIsImRlZmF1bHRNYXRlcmlhbCIsImFkZEV2ZW50TGlzdGVuZXIiLCJfdXBkYXRlR3JvdXAiLCJvbiIsIkV2ZW50VHlwZSIsIkdST1VQX0NIQU5HRUQiLCJncm91cEluZGV4IiwiYWRkU2hhcGUiLCJpbmRleE9mIiwic2hhcGUiLCJwdXNoIiwic2V0SW5kZXgiLCJvZmZzZXQiLCJzaGFwZU9mZnNldHMiLCJvcmllbnQiLCJzaGFwZU9yaWVudGF0aW9ucyIsInNldE9mZnNldEFuZE9yaWVudCIsInJlbW92ZVNoYXBlIiwiZm9yY2UiLCJuZWVkVXBkYXRlVHJhbnNmb3JtIiwiY29weSIsInBvc2l0aW9uIiwiX193cG9zIiwicXVhdGVybmlvbiIsIl9fd3JvdCIsIl9sb2NhbE1hdERpcnR5Iiwid3NjYWxlIiwiX193c2NhbGUiLCJpIiwic2V0U2NhbGUiLCJpc1NsZWVwaW5nIiwid2FrZVVwIiwiYWFiYk5lZWRzVXBkYXRlIiwic3luY1BoeXNpY3NUb1NjZW5lIiwiRVJpZ2lkQm9keVR5cGUiLCJTVEFUSUMiLCJvZmYiLCJldmVudCIsInNlbGYiLCJzZWxmU2hhcGUiLCJvdGhlciIsIm90aGVyU2hhcGUiLCJjb2xsaWRlciIsInBvcCIsImNxIiwiYyIsImNvbnRhY3RBIiwicmkiLCJjb250YWN0QiIsInJqIiwibm9ybWFsIiwibmkiLCJlbWl0IiwiTWFwIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBeUJBOztBQUNBOztBQUNBOztBQU1BOzs7Ozs7OztBQUdBLElBQU1BLGNBQWMsR0FBR0MsRUFBRSxDQUFDQyxJQUFILENBQVFDLGVBQS9CO0FBQ0EsSUFBTUMsYUFBYSxHQUFHSixjQUFjLENBQUNJLGFBQXJDO0FBQ0EsSUFBTUMsSUFBSSxHQUFHSixFQUFFLENBQUNJLElBQWhCO0FBQ0EsSUFBTUMsSUFBSSxHQUFHTCxFQUFFLENBQUNLLElBQWhCO0FBQ0EsSUFBTUMsWUFBWSxHQUFHTixFQUFFLENBQUNPLEVBQUgsQ0FBTUMsS0FBTixDQUFZRixZQUFqQztBQUNBLElBQU1HLElBQUksR0FBRyxJQUFJSixJQUFKLEVBQWI7QUFDQSxJQUFNSyxNQUFNLEdBQUcsSUFBSU4sSUFBSixFQUFmO0FBQ0EsSUFBTU8sWUFBWSxHQUFHLEVBQXJCO0FBQ0EsSUFBTUMsb0JBQW9CLEdBQUc7QUFDekJDLEVBQUFBLElBQUksRUFBRSxpQkFEbUI7QUFFekJDLEVBQUFBLFlBQVksRUFBRSxJQUZXO0FBR3pCQyxFQUFBQSxhQUFhLEVBQUUsSUFIVTtBQUl6QkMsRUFBQUEsUUFBUSxF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LGNBQU1BLEVBQUMsR0FBRztBQUNOQyxZQUFBQSxRQUFRLEVBQUU3RixJQUFJLENBQUNtRSxJQUFMLENBQVUsSUFBSW5FLElBQUosRUFBVixFQUFzQjJGLEVBQUUsQ0FBQ0csRUFBekIsQ0FESjtBQUVOQyxZQUFBQSxRQUFRLEVBQUUvRixJQUFJLENBQUNtRSxJQUFMLENBQVUsSUFBSW5FLElBQUosRUFBVixFQUFzQjJGLEVBQUUsQ0FBQ0ssRUFBekIsQ0FGSjtBQUdOQyxZQUFBQSxNQUFNLEVBQUVqRyxJQUFJLENBQUNtRSxJQUFMLENBQVUsSUFBSW5FLElBQUosRUFBVixFQUFzQjJGLEVBQUUsQ0FBQ08sRUFBekI7QUFIRixXQUFWO0FBS0EzRixVQUFBQSxvQkFBb0IsQ0FBQ0ksUUFBckIsQ0FBOEI4QyxJQUE5QixDQUFtQ21DLEVBQW5DO0FBQ0g7QUFDSjs7QUFFRCxXQUFLakIsQ0FBQyxHQUFHLENBQVQsRUFBWUEsQ0FBQyxHQUFHLEtBQUs3QyxNQUFMLENBQVlKLE1BQTVCLEVBQW9DaUQsQ0FBQyxFQUFyQyxFQUF5QztBQUNyQyxZQUFNbkIsS0FBSyxHQUFHLEtBQUsxQixNQUFMLENBQVk2QyxDQUFaLENBQWQ7QUFDQW5CLFFBQUFBLEtBQUssQ0FBQ2lDLFFBQU4sQ0FBZVUsSUFBZixDQUFvQjVGLG9CQUFvQixDQUFDQyxJQUF6QyxFQUErQ0Qsb0JBQS9DO0FBQ0g7QUFDSjtBQUNKOzs7Ozs7QUE1S1FLLGlCQUVlTSxrQkFBa0IsSUFBSWtGLEdBQUoiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuIENvcHlyaWdodCAoYykgMjAxOSBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IENBTk5PTiBmcm9tICcuLi8uLi8uLi8uLi8uLi9leHRlcm5hbC9jYW5ub24vY2Fubm9uJztcbmltcG9ydCB7IEVSaWdpZEJvZHlUeXBlIH0gZnJvbSAnLi4vZnJhbWV3b3JrL3BoeXNpY3MtZW51bSc7XG5pbXBvcnQgeyBnZXRXcmFwIH0gZnJvbSAnLi4vZnJhbWV3b3JrL3V0aWwnO1xuaW1wb3J0IHsgQ2Fubm9uV29ybGQgfSBmcm9tICcuL2Nhbm5vbi13b3JsZCc7XG5pbXBvcnQgeyBDYW5ub25TaGFwZSB9IGZyb20gJy4vc2hhcGVzL2Nhbm5vbi1zaGFwZSc7XG5pbXBvcnQgeyBDb2xsaWRlcjNEIH0gZnJvbSAnLi4vZXhwb3J0cy9waHlzaWNzLWZyYW1ld29yayc7XG5pbXBvcnQgeyBDb2xsaXNpb25FdmVudFR5cGUgfSBmcm9tICcuLi9mcmFtZXdvcmsvcGh5c2ljcy1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ2Fubm9uUmlnaWRCb2R5IH0gZnJvbSAnLi9jYW5ub24tcmlnaWQtYm9keSc7XG5pbXBvcnQgeyBncm91cEluZGV4VG9CaXRNYXNrIH0gZnJvbSAnLi9jYW5ub24tdXRpbCdcbmltcG9ydCB7IHVwZGF0ZVdvcmxkVHJhbnNmb3JtLCB1cGRhdGVXb3JsZFJUIH0gZnJvbSBcIi4uL2ZyYW1ld29yay91dGlsXCJcblxuY29uc3QgTG9jYWxEaXJ0eUZsYWcgPSBjYy5Ob2RlLl9Mb2NhbERpcnR5RmxhZztcbmNvbnN0IFBIWVNJQ1NfU0NBTEUgPSBMb2NhbERpcnR5RmxhZy5QSFlTSUNTX1NDQUxFO1xuY29uc3QgUXVhdCA9IGNjLlF1YXQ7XG5jb25zdCBWZWMzID0gY2MuVmVjMztcbmNvbnN0IGZhc3RSZW1vdmVBdCA9IGNjLmpzLmFycmF5LmZhc3RSZW1vdmVBdDtcbmNvbnN0IHYzXzAgPSBuZXcgVmVjMygpO1xuY29uc3QgcXVhdF8wID0gbmV3IFF1YXQoKTtcbmNvbnN0IGNvbnRhY3RzUG9vbCA9IFtdIGFzIGFueTtcbmNvbnN0IENvbGxpc2lvbkV2ZW50T2JqZWN0ID0ge1xuICAgIHR5cGU6ICdjb2xsaXNpb24tZW50ZXInIGFzIENvbGxpc2lvbkV2ZW50VHlwZSxcbiAgICBzZWxmQ29sbGlkZXI6IG51bGwgYXMgQ29sbGlkZXIzRCB8IG51bGwsXG4gICAgb3RoZXJDb2xsaWRlcjogbnVsbCBhcyBDb2xsaWRlcjNEIHwgbnVsbCxcbiAgICBjb250YWN0czogW10gYXMgYW55LFxufTtcblxuLyoqXG4gKiBzaGFyZWRib2R5LCBub2RlIDogc2hhcmVkYm9keSA9IDEgOiAxXG4gKiBzdGF0aWNcbiAqL1xuZXhwb3J0IGNsYXNzIENhbm5vblNoYXJlZEJvZHkge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgc2hhcmVkQm9kaWVzTWFwID0gbmV3IE1hcDxzdHJpbmcsIENhbm5vblNoYXJlZEJvZHk+KCk7XG5cbiAgICBzdGF0aWMgZ2V0U2hhcmVkQm9keSAobm9kZTogY2MuTm9kZSwgd3JhcHBlZFdvcmxkOiBDYW5ub25Xb3JsZCkge1xuICAgICAgICBjb25zdCBrZXkgPSBub2RlLl9pZDtcbiAgICAgICAgaWYgKENhbm5vblNoYXJlZEJvZHkuc2hhcmVkQm9kaWVzTWFwLmhhcyhrZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gQ2Fubm9uU2hhcmVkQm9keS5zaGFyZWRCb2RpZXNNYXAuZ2V0KGtleSkhO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbmV3U0IgPSBuZXcgQ2Fubm9uU2hhcmVkQm9keShub2RlLCB3cmFwcGVkV29ybGQpO1xuICAgICAgICAgICAgQ2Fubm9uU2hhcmVkQm9keS5zaGFyZWRCb2RpZXNNYXAuc2V0KG5vZGUuX2lkLCBuZXdTQik7XG4gICAgICAgICAgICByZXR1cm4gbmV3U0I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZWFkb25seSBub2RlOiBjYy5Ob2RlO1xuICAgIHJlYWRvbmx5IHdyYXBwZWRXb3JsZDogQ2Fubm9uV29ybGQ7XG4gICAgcmVhZG9ubHkgYm9keTogQ0FOTk9OLkJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoKTtcbiAgICByZWFkb25seSBzaGFwZXM6IENhbm5vblNoYXBlW10gPSBbXTtcbiAgICB3cmFwcGVkQm9keTogQ2Fubm9uUmlnaWRCb2R5IHwgbnVsbCA9IG51bGw7XG5cbiAgICBwcml2YXRlIGluZGV4OiBudW1iZXIgPSAtMTtcbiAgICBwcml2YXRlIHJlZjogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIG9uQ29sbGlkZWRMaXN0ZW5lciA9IHRoaXMub25Db2xsaWRlZC5iaW5kKHRoaXMpO1xuXG4gICAgLyoqXG4gICAgICogYWRkIG9yIHJlbW92ZSBmcm9tIHdvcmxkIFxcXG4gICAgICogYWRkLCBpZiBlbmFibGUgXFxcbiAgICAgKiByZW1vdmUsIGlmIGRpc2FibGUgJiBzaGFwZXMubGVuZ3RoID09IDAgJiB3cmFwcGVkQm9keSBkaXNhYmxlXG4gICAgICovXG4gICAgc2V0IGVuYWJsZWQgKHY6IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKHYpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5kZXggPSB0aGlzLndyYXBwZWRXb3JsZC5ib2RpZXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIHRoaXMud3JhcHBlZFdvcmxkLmFkZFNoYXJlZEJvZHkodGhpcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5zeW5jU2NlbmVUb1BoeXNpY3ModHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pbmRleCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaXNSZW1vdmUgPSAodGhpcy5zaGFwZXMubGVuZ3RoID09IDAgJiYgdGhpcy53cmFwcGVkQm9keSA9PSBudWxsKSB8fFxuICAgICAgICAgICAgICAgICAgICAodGhpcy5zaGFwZXMubGVuZ3RoID09IDAgJiYgdGhpcy53cmFwcGVkQm9keSAhPSBudWxsICYmICF0aGlzLndyYXBwZWRCb2R5LnJpZ2lkQm9keS5lbmFibGVkSW5IaWVyYXJjaHkpIHx8XG4gICAgICAgICAgICAgICAgICAgICh0aGlzLnNoYXBlcy5sZW5ndGggPT0gMCAmJiB0aGlzLndyYXBwZWRCb2R5ICE9IG51bGwgJiYgIXRoaXMud3JhcHBlZEJvZHkuaXNFbmFibGVkKVxuXG4gICAgICAgICAgICAgICAgaWYgKGlzUmVtb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYm9keS5zbGVlcCgpOyAvLyBjbGVhciB2ZWxvY2l0eSBldGMuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5kZXggPSAtMTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53cmFwcGVkV29ybGQucmVtb3ZlU2hhcmVkQm9keSh0aGlzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXQgcmVmZXJlbmNlICh2OiBib29sZWFuKSB7XG4gICAgICAgIHYgPyB0aGlzLnJlZisrIDogdGhpcy5yZWYtLTtcbiAgICAgICAgaWYgKHRoaXMucmVmID09IDApIHsgdGhpcy5kZXN0cm95KCk7IH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yIChub2RlOiBjYy5Ob2RlLCB3cmFwcGVkV29ybGQ6IENhbm5vbldvcmxkKSB7XG4gICAgICAgIHRoaXMud3JhcHBlZFdvcmxkID0gd3JhcHBlZFdvcmxkO1xuICAgICAgICB0aGlzLm5vZGUgPSBub2RlO1xuICAgICAgICB0aGlzLmJvZHkubWF0ZXJpYWwgPSB0aGlzLndyYXBwZWRXb3JsZC53b3JsZC5kZWZhdWx0TWF0ZXJpYWw7XG4gICAgICAgIHRoaXMuYm9keS5hZGRFdmVudExpc3RlbmVyKCdjb2xsaWRlJywgdGhpcy5vbkNvbGxpZGVkTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLl91cGRhdGVHcm91cCgpO1xuICAgICAgICB0aGlzLm5vZGUub24oY2MuTm9kZS5FdmVudFR5cGUuR1JPVVBfQ0hBTkdFRCwgdGhpcy5fdXBkYXRlR3JvdXAsIHRoaXMpO1xuICAgIH1cblxuICAgIF91cGRhdGVHcm91cCAoKSB7XG4gICAgICAgIGdyb3VwSW5kZXhUb0JpdE1hc2sodGhpcy5ub2RlLmdyb3VwSW5kZXgsIHRoaXMuYm9keSk7XG4gICAgfVxuXG4gICAgYWRkU2hhcGUgKHY6IENhbm5vblNoYXBlKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zaGFwZXMuaW5kZXhPZih2KTtcbiAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmJvZHkuc2hhcGVzLmxlbmd0aDtcbiAgICAgICAgICAgIHRoaXMuYm9keS5hZGRTaGFwZSh2LnNoYXBlKTtcbiAgICAgICAgICAgIHRoaXMuc2hhcGVzLnB1c2godik7XG5cbiAgICAgICAgICAgIHYuc2V0SW5kZXgoaW5kZXgpO1xuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5ib2R5LnNoYXBlT2Zmc2V0c1tpbmRleF07XG4gICAgICAgICAgICBjb25zdCBvcmllbnQgPSB0aGlzLmJvZHkuc2hhcGVPcmllbnRhdGlvbnNbaW5kZXhdO1xuICAgICAgICAgICAgdi5zZXRPZmZzZXRBbmRPcmllbnQob2Zmc2V0LCBvcmllbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVtb3ZlU2hhcGUgKHY6IENhbm5vblNoYXBlKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zaGFwZXMuaW5kZXhPZih2KTtcbiAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICAgIGZhc3RSZW1vdmVBdCh0aGlzLnNoYXBlcywgaW5kZXgpO1xuICAgICAgICAgICAgdGhpcy5ib2R5LnJlbW92ZVNoYXBlKHYuc2hhcGUpO1xuICAgICAgICAgICAgdi5zZXRJbmRleCgtMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzeW5jU2NlbmVUb1BoeXNpY3MgKGZvcmNlOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgICAgIGxldCBuZWVkVXBkYXRlVHJhbnNmb3JtID0gdXBkYXRlV29ybGRUcmFuc2Zvcm0obm9kZSwgZm9yY2UpO1xuICAgICAgICBpZiAoIWZvcmNlICYmICFuZWVkVXBkYXRlVHJhbnNmb3JtKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBWZWMzLmNvcHkodGhpcy5ib2R5LnBvc2l0aW9uLCBub2RlLl9fd3Bvcyk7XG4gICAgICAgIFF1YXQuY29weSh0aGlzLmJvZHkucXVhdGVybmlvbiwgbm9kZS5fX3dyb3QpO1xuXG4gICAgICAgIGlmIChub2RlLl9sb2NhbE1hdERpcnR5ICYgUEhZU0lDU19TQ0FMRSkge1xuICAgICAgICAgICAgbGV0IHdzY2FsZSA9IG5vZGUuX193c2NhbGU7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2hhcGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaGFwZXNbaV0uc2V0U2NhbGUod3NjYWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMuYm9keS5pc1NsZWVwaW5nKCkpIHtcbiAgICAgICAgICAgIHRoaXMuYm9keS53YWtlVXAoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGJvZHkgd29ybGQgYWFiYiBuZWVkIHRvIGJlIHJlY2FsY3VsYXRlZFxuICAgICAgICB0aGlzLmJvZHkuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBzeW5jUGh5c2ljc1RvU2NlbmUgKCkge1xuICAgICAgICBpZiAodGhpcy5ib2R5LnR5cGUgIT0gRVJpZ2lkQm9keVR5cGUuU1RBVElDKSB7XG4gICAgICAgICAgICBWZWMzLmNvcHkodjNfMCwgdGhpcy5ib2R5LnBvc2l0aW9uKTtcbiAgICAgICAgICAgIFF1YXQuY29weShxdWF0XzAsIHRoaXMuYm9keS5xdWF0ZXJuaW9uKTtcbiAgICAgICAgICAgIHVwZGF0ZVdvcmxkUlQodGhpcy5ub2RlLCB2M18wLCBxdWF0XzApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZXN0cm95ICgpIHtcbiAgICAgICAgdGhpcy5ub2RlLm9mZihjYy5Ob2RlLkV2ZW50VHlwZS5HUk9VUF9DSEFOR0VELCB0aGlzLl91cGRhdGVHcm91cCwgdGhpcyk7XG4gICAgICAgIENhbm5vblNoYXJlZEJvZHkuc2hhcmVkQm9kaWVzTWFwLmRlbGV0ZSh0aGlzLm5vZGUuX2lkKTtcbiAgICAgICAgKHRoaXMubm9kZSBhcyBhbnkpID0gbnVsbDtcbiAgICAgICAgKHRoaXMud3JhcHBlZFdvcmxkIGFzIGFueSkgPSBudWxsO1xuICAgICAgICAodGhpcy5ib2R5IGFzIGFueSkgPSBudWxsO1xuICAgICAgICAodGhpcy5zaGFwZXMgYXMgYW55KSA9IG51bGw7XG4gICAgICAgICh0aGlzLm9uQ29sbGlkZWRMaXN0ZW5lciBhcyBhbnkpID0gbnVsbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQ29sbGlkZWQgKGV2ZW50OiBDQU5OT04uSUNvbGxpc2lvbkV2ZW50KSB7XG4gICAgICAgIENvbGxpc2lvbkV2ZW50T2JqZWN0LnR5cGUgPSBldmVudC5ldmVudDtcbiAgICAgICAgY29uc3Qgc2VsZiA9IGdldFdyYXA8Q2Fubm9uU2hhcGU+KGV2ZW50LnNlbGZTaGFwZSk7XG4gICAgICAgIGNvbnN0IG90aGVyID0gZ2V0V3JhcDxDYW5ub25TaGFwZT4oZXZlbnQub3RoZXJTaGFwZSk7XG5cbiAgICAgICAgaWYgKHNlbGYpIHtcbiAgICAgICAgICAgIENvbGxpc2lvbkV2ZW50T2JqZWN0LnNlbGZDb2xsaWRlciA9IHNlbGYuY29sbGlkZXI7XG4gICAgICAgICAgICBDb2xsaXNpb25FdmVudE9iamVjdC5vdGhlckNvbGxpZGVyID0gb3RoZXIgPyBvdGhlci5jb2xsaWRlciA6IG51bGw7XG4gICAgICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgICAgICBmb3IgKGkgPSBDb2xsaXNpb25FdmVudE9iamVjdC5jb250YWN0cy5sZW5ndGg7IGktLTspIHtcbiAgICAgICAgICAgICAgICBjb250YWN0c1Bvb2wucHVzaChDb2xsaXNpb25FdmVudE9iamVjdC5jb250YWN0cy5wb3AoKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudC5jb250YWN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNxID0gZXZlbnQuY29udGFjdHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRhY3RzUG9vbC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBjb250YWN0c1Bvb2wucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgIFZlYzMuY29weShjLmNvbnRhY3RBLCBjcS5yaSk7XG4gICAgICAgICAgICAgICAgICAgIFZlYzMuY29weShjLmNvbnRhY3RCLCBjcS5yaik7XG4gICAgICAgICAgICAgICAgICAgIFZlYzMuY29weShjLm5vcm1hbCwgY3EubmkpO1xuICAgICAgICAgICAgICAgICAgICBDb2xsaXNpb25FdmVudE9iamVjdC5jb250YWN0cy5wdXNoKGMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0QTogVmVjMy5jb3B5KG5ldyBWZWMzKCksIGNxLnJpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3RCOiBWZWMzLmNvcHkobmV3IFZlYzMoKSwgY3EucmopLFxuICAgICAgICAgICAgICAgICAgICAgICAgbm9ybWFsOiBWZWMzLmNvcHkobmV3IFZlYzMoKSwgY3EubmkpLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBDb2xsaXNpb25FdmVudE9iamVjdC5jb250YWN0cy5wdXNoKGMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMuc2hhcGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2hhcGUgPSB0aGlzLnNoYXBlc1tpXTtcbiAgICAgICAgICAgICAgICBzaGFwZS5jb2xsaWRlci5lbWl0KENvbGxpc2lvbkV2ZW50T2JqZWN0LnR5cGUsIENvbGxpc2lvbkV2ZW50T2JqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn0iXSwic291cmNlUm9vdCI6Ii8ifQ==