
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/renderer/webgl/assemblers/sprite/2d/mesh.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _assembler2d = _interopRequireDefault(require("../../../../assembler-2d"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

var MeshSpriteAssembler = /*#__PURE__*/function (_Assembler2D) {
  _inheritsLoose(MeshSpriteAssembler, _Assembler2D);

  function MeshSpriteAssembler() {
    return _Assembler2D.apply(this, arguments) || this;
  }

  var _proto = MeshSpriteAssembler.prototype;

  _proto.initData = function initData(sprite) {
    this._renderData.createFlexData(0, 4, 6, this.getVfmt());
  };

  _proto.updateRenderData = function updateRenderData(sprite) {
    this.packToDynamicAtlas(sprite, sprite._spriteFrame);
    var frame = sprite.spriteFrame;

    if (frame) {
      var vertices = frame.vertices;

      if (vertices) {
        this.verticesCount = vertices.x.length;
        this.indicesCount = vertices.triangles.length;
        var renderData = this._renderData;
        var flexBuffer = renderData._flexBuffer;

        if (flexBuffer.reserve(this.verticesCount, this.indicesCount)) {
          this.updateColor(sprite);
          sprite._vertsDirty = true;
        }

        flexBuffer.used(this.verticesCount, this.indicesCount);
        this.updateIndices(vertices.triangles);

        if (sprite._vertsDirty) {
          this.updateUVs(sprite);
          this.updateVerts(sprite);
          this.updateWorldVerts(sprite);
          sprite._vertsDirty = false;
        }
      }
    }
  };

  _proto.updateIndices = function updateIndices(triangles) {
    this._renderData.iDatas[0].set(triangles);
  };

  _proto.updateUVs = function updateUVs(sprite) {
    var vertices = sprite.spriteFrame.vertices,
        u = vertices.nu,
        v = vertices.nv;
    var uvOffset = this.uvOffset;
    var floatsPerVert = this.floatsPerVert;
    var verts = this._renderData.vDatas[0];

    for (var i = 0; i < u.length; i++) {
      var dstOffset = floatsPerVert * i + uvOffset;
      verts[dstOffset] = u[i];
      verts[dstOffset + 1] = v[i];
    }
  };

  _proto.updateVerts = function updateVerts(sprite) {
    var node = sprite.node,
        contentWidth = Math.abs(node.width),
        contentHeight = Math.abs(node.height),
        appx = node.anchorX * contentWidth,
        appy = node.anchorY * contentHeight;
    var frame = sprite.spriteFrame,
        vertices = frame.vertices,
        x = vertices.x,
        y = vertices.y,
        originalWidth = frame._originalSize.width,
        originalHeight = frame._originalSize.height,
        rectWidth = frame._rect.width,
        rectHeight = frame._rect.height,
        offsetX = frame._offset.x,
        offsetY = frame._offset.y,
        trimX = offsetX + (originalWidth - rectWidth) / 2,
        trimY = offsetY + (originalHeight - rectHeight) / 2;
    var scaleX = contentWidth / (sprite.trim ? rectWidth : originalWidth),
        scaleY = contentHeight / (sprite.trim ? rectHeight : originalHeight);
    var local = this._local;

    if (!sprite.trim) {
      for (var i = 0, l = x.length; i < l; i++) {
        var offset = i * 2;
        local[offset] = x[i] * scaleX - appx;
        local[offset + 1] = (originalHeight - y[i]) * scaleY - appy;
      }
    } else {
      for (var _i = 0, _l = x.length; _i < _l; _i++) {
        var _offset = _i * 2;

        local[_offset] = (x[_i] - trimX) * scaleX - appx;
        local[_offset + 1] = (originalHeight - y[_i] - trimY) * scaleY - appy;
      }
    }
  };

  _proto.updateWorldVerts = function updateWorldVerts(sprite) {
    var node = sprite.node;
    var matrix = node._worldMatrix;
    var matrixm = matrix.m;
    var a = matrixm[0],
        b = matrixm[1],
        c = matrixm[4],
        d = matrixm[5],
        tx = matrixm[12],
        ty = matrixm[13];
    var local = this._local;
    var world = this._renderData.vDatas[0];
    var floatsPerVert = this.floatsPerVert;

    for (var i = 0, l = this.verticesCount; i < l; i++) {
      var lx = local[i * 2];
      var ly = local[i * 2 + 1];
      world[floatsPerVert * i] = lx * a + ly * c + tx;
      world[floatsPerVert * i + 1] = lx * b + ly * d + ty;
    }
  };

  return MeshSpriteAssembler;
}(_assembler2d["default"]);

exports["default"] = MeshSpriteAssembler;
module.exports = exports["default"];
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL3JlbmRlcmVyL3dlYmdsL2Fzc2VtYmxlcnMvc3ByaXRlLzJkL21lc2guanMiXSwibmFtZXMiOlsiTWVzaFNwcml0ZUFzc2VtYmxlciIsImluaXREYXRhIiwic3ByaXRlIiwiX3JlbmRlckRhdGEiLCJjcmVhdGVGbGV4RGF0YSIsImdldFZmbXQiLCJ1cGRhdGVSZW5kZXJEYXRhIiwicGFja1RvRHluYW1pY0F0bGFzIiwiX3Nwcml0ZUZyYW1lIiwiZnJhbWUiLCJzcHJpdGVGcmFtZSIsInZlcnRpY2VzIiwidmVydGljZXNDb3VudCIsIngiLCJsZW5ndGgiLCJpbmRpY2VzQ291bnQiLCJ0cmlhbmdsZXMiLCJyZW5kZXJEYXRhIiwiZmxleEJ1ZmZlciIsIl9mbGV4QnVmZmVyIiwicmVzZXJ2ZSIsInVwZGF0ZUNvbG9yIiwiX3ZlcnRzRGlydHkiLCJ1c2VkIiwidXBkYXRlSW5kaWNlcyIsInVwZGF0ZVVWcyIsInVwZGF0ZVZlcnRzIiwidXBkYXRlV29ybGRWZXJ0cyIsImlEYXRhcyIsInNldCIsInUiLCJudSIsInYiLCJudiIsInV2T2Zmc2V0IiwiZmxvYXRzUGVyVmVydCIsInZlcnRzIiwidkRhdGFzIiwiaSIsImRzdE9mZnNldCIsIm5vZGUiLCJjb250ZW50V2lkdGgiLCJNYXRoIiwiYWJzIiwid2lkdGgiLCJjb250ZW50SGVpZ2h0IiwiaGVpZ2h0IiwiYXBweCIsImFuY2hvclgiLCJhcHB5IiwiYW5jaG9yWSIsInkiLCJvcmlnaW5hbFdpZHRoIiwiX29yaWdpbmFsU2l6ZSIsIm9yaWdpbmFsSGVpZ2h0IiwicmVjdFdpZHRoIiwiX3JlY3QiLCJyZWN0SGVpZ2h0Iiwib2Zmc2V0WCIsIl9vZmZzZXQiLCJvZmZzZXRZIiwidHJpbVgiLCJ0cmltWSIsInNjYWxlWCIsInRyaW0iLCJzY2FsZVkiLCJsb2NhbCIsIl9sb2NhbCIsImwiLCJvZmZzZXQiLCJtYXRyaXgiLCJfd29ybGRNYXRyaXgiLCJtYXRyaXhtIiwibSIsImEi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QUFBQSxLQUFLLENBQUM3QyxhQUFhLEdBQUdHLENBQWpCLENBQUwsR0FBMkIyQyxFQUFFLEdBQUdQLENBQUwsR0FBU1EsRUFBRSxHQUFHTixDQUFkLEdBQWtCRSxFQUE3QztBQUNBRSxNQUFBQSxLQUFLLENBQUM3QyxhQUFhLEdBQUdHLENBQWhCLEdBQW9CLENBQXJCLENBQUwsR0FBK0IyQyxFQUFFLEdBQUdOLENBQUwsR0FBU08sRUFBRSxHQUFHTCxDQUFkLEdBQWtCRSxFQUFqRDtBQUNIO0FBQ0o7OztFQTdHNENJIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAxOCBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC5cblxuIGh0dHBzOi8vd3d3LmNvY29zLmNvbS9cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGVuZ2luZSBzb3VyY2UgY29kZSAodGhlIFwiU29mdHdhcmVcIiksIGEgbGltaXRlZCxcbiB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcbiBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXG4gdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxuIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxuXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbiBUSEUgU09GVFdBUkUuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IEFzc2VtYmxlcjJEIGZyb20gJy4uLy4uLy4uLy4uL2Fzc2VtYmxlci0yZCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1lc2hTcHJpdGVBc3NlbWJsZXIgZXh0ZW5kcyBBc3NlbWJsZXIyRCB7XG4gICAgaW5pdERhdGEgKHNwcml0ZSkge1xuICAgICAgICB0aGlzLl9yZW5kZXJEYXRhLmNyZWF0ZUZsZXhEYXRhKDAsIDQsIDYsIHRoaXMuZ2V0VmZtdCgpKTtcbiAgICB9XG4gICAgXG4gICAgdXBkYXRlUmVuZGVyRGF0YSAoc3ByaXRlKSB7XG4gICAgICAgIHRoaXMucGFja1RvRHluYW1pY0F0bGFzKHNwcml0ZSwgc3ByaXRlLl9zcHJpdGVGcmFtZSk7XG5cbiAgICAgICAgbGV0IGZyYW1lID0gc3ByaXRlLnNwcml0ZUZyYW1lO1xuICAgICAgICBpZiAoZnJhbWUpIHtcbiAgICAgICAgICAgIGxldCB2ZXJ0aWNlcyA9IGZyYW1lLnZlcnRpY2VzO1xuICAgICAgICAgICAgaWYgKHZlcnRpY2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy52ZXJ0aWNlc0NvdW50ID0gdmVydGljZXMueC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgdGhpcy5pbmRpY2VzQ291bnQgPSB2ZXJ0aWNlcy50cmlhbmdsZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICAgICAgbGV0IHJlbmRlckRhdGEgPSB0aGlzLl9yZW5kZXJEYXRhO1xuICAgICAgICAgICAgICAgIGxldCBmbGV4QnVmZmVyID0gcmVuZGVyRGF0YS5fZmxleEJ1ZmZlcjtcbiAgICAgICAgICAgICAgICBpZiAoZmxleEJ1ZmZlci5yZXNlcnZlKHRoaXMudmVydGljZXNDb3VudCwgdGhpcy5pbmRpY2VzQ291bnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ29sb3Ioc3ByaXRlKTtcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlLl92ZXJ0c0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmxleEJ1ZmZlci51c2VkKHRoaXMudmVydGljZXNDb3VudCwgdGhpcy5pbmRpY2VzQ291bnQpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVJbmRpY2VzKHZlcnRpY2VzLnRyaWFuZ2xlcyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoc3ByaXRlLl92ZXJ0c0RpcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVVZzKHNwcml0ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVmVydHMoc3ByaXRlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVXb3JsZFZlcnRzKHNwcml0ZSk7XG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZS5fdmVydHNEaXJ0eSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZUluZGljZXMgKHRyaWFuZ2xlcykge1xuICAgICAgICB0aGlzLl9yZW5kZXJEYXRhLmlEYXRhc1swXS5zZXQodHJpYW5nbGVzKTtcbiAgICB9XG5cbiAgICB1cGRhdGVVVnMgKHNwcml0ZSkge1xuICAgICAgICBsZXQgdmVydGljZXMgPSBzcHJpdGUuc3ByaXRlRnJhbWUudmVydGljZXMsXG4gICAgICAgICAgICB1ID0gdmVydGljZXMubnUsXG4gICAgICAgICAgICB2ID0gdmVydGljZXMubnY7XG5cbiAgICAgICAgbGV0IHV2T2Zmc2V0ID0gdGhpcy51dk9mZnNldDtcbiAgICAgICAgbGV0IGZsb2F0c1BlclZlcnQgPSB0aGlzLmZsb2F0c1BlclZlcnQ7XG4gICAgICAgIGxldCB2ZXJ0cyA9IHRoaXMuX3JlbmRlckRhdGEudkRhdGFzWzBdO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGxldCBkc3RPZmZzZXQgPSBmbG9hdHNQZXJWZXJ0ICogaSArIHV2T2Zmc2V0O1xuICAgICAgICAgICAgdmVydHNbZHN0T2Zmc2V0XSA9IHVbaV07XG4gICAgICAgICAgICB2ZXJ0c1tkc3RPZmZzZXQgKyAxXSA9IHZbaV07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVWZXJ0cyAoc3ByaXRlKSB7XG4gICAgICAgIGxldCBub2RlID0gc3ByaXRlLm5vZGUsXG4gICAgICAgICAgICBjb250ZW50V2lkdGggPSBNYXRoLmFicyhub2RlLndpZHRoKSxcbiAgICAgICAgICAgIGNvbnRlbnRIZWlnaHQgPSBNYXRoLmFicyhub2RlLmhlaWdodCksXG4gICAgICAgICAgICBhcHB4ID0gbm9kZS5hbmNob3JYICogY29udGVudFdpZHRoLFxuICAgICAgICAgICAgYXBweSA9IG5vZGUuYW5jaG9yWSAqIGNvbnRlbnRIZWlnaHQ7XG5cbiAgICAgICAgbGV0IGZyYW1lID0gc3ByaXRlLnNwcml0ZUZyYW1lLFxuICAgICAgICAgICAgdmVydGljZXMgPSBmcmFtZS52ZXJ0aWNlcyxcbiAgICAgICAgICAgIHggPSB2ZXJ0aWNlcy54LFxuICAgICAgICAgICAgeSA9IHZlcnRpY2VzLnksXG4gICAgICAgICAgICBvcmlnaW5hbFdpZHRoID0gZnJhbWUuX29yaWdpbmFsU2l6ZS53aWR0aCxcbiAgICAgICAgICAgIG9yaWdpbmFsSGVpZ2h0ID0gZnJhbWUuX29yaWdpbmFsU2l6ZS5oZWlnaHQsXG4gICAgICAgICAgICByZWN0V2lkdGggPSBmcmFtZS5fcmVjdC53aWR0aCxcbiAgICAgICAgICAgIHJlY3RIZWlnaHQgPSBmcmFtZS5fcmVjdC5oZWlnaHQsXG4gICAgICAgICAgICBvZmZzZXRYID0gZnJhbWUuX29mZnNldC54LFxuICAgICAgICAgICAgb2Zmc2V0WSA9IGZyYW1lLl9vZmZzZXQueSxcbiAgICAgICAgICAgIHRyaW1YID0gb2Zmc2V0WCArIChvcmlnaW5hbFdpZHRoIC0gcmVjdFdpZHRoKSAvIDIsXG4gICAgICAgICAgICB0cmltWSA9IG9mZnNldFkgKyAob3JpZ2luYWxIZWlnaHQgLSByZWN0SGVpZ2h0KSAvIDI7XG5cbiAgICAgICAgbGV0IHNjYWxlWCA9IGNvbnRlbnRXaWR0aCAvIChzcHJpdGUudHJpbSA/IHJlY3RXaWR0aCA6IG9yaWdpbmFsV2lkdGgpLFxuICAgICAgICAgICAgc2NhbGVZID0gY29udGVudEhlaWdodCAvIChzcHJpdGUudHJpbSA/IHJlY3RIZWlnaHQgOiBvcmlnaW5hbEhlaWdodCk7XG5cbiAgICAgICAgbGV0IGxvY2FsID0gdGhpcy5fbG9jYWw7XG4gICAgICAgIGlmICghc3ByaXRlLnRyaW0pIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0geC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0ID0gaSAqIDI7XG4gICAgICAgICAgICAgICAgbG9jYWxbb2Zmc2V0XSA9ICh4W2ldKSAqIHNjYWxlWCAtIGFwcHg7XG4gICAgICAgICAgICAgICAgbG9jYWxbb2Zmc2V0ICsgMV0gPSAob3JpZ2luYWxIZWlnaHQgLSB5W2ldKSAqIHNjYWxlWSAtIGFwcHk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHgubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgbGV0IG9mZnNldCA9IGkgKiAyO1xuICAgICAgICAgICAgICAgIGxvY2FsW29mZnNldF0gPSAoeFtpXSAtIHRyaW1YKSAqIHNjYWxlWCAtIGFwcHg7XG4gICAgICAgICAgICAgICAgbG9jYWxbb2Zmc2V0ICsgMV0gPSAob3JpZ2luYWxIZWlnaHQgLSB5W2ldIC0gdHJpbVkpICogc2NhbGVZIC0gYXBweTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZVdvcmxkVmVydHMgKHNwcml0ZSkge1xuICAgICAgICBsZXQgbm9kZSA9IHNwcml0ZS5ub2RlO1xuICAgICAgICBsZXQgbWF0cml4ID0gbm9kZS5fd29ybGRNYXRyaXg7XG4gICAgICAgIGxldCBtYXRyaXhtID0gbWF0cml4Lm07XG4gICAgICAgIGxldCBhID0gbWF0cml4bVswXSwgYiA9IG1hdHJpeG1bMV0sIGMgPSBtYXRyaXhtWzRdLCBkID0gbWF0cml4bVs1XSxcbiAgICAgICAgICAgIHR4ID0gbWF0cml4bVsxMl0sIHR5ID0gbWF0cml4bVsxM107XG4gICAgICAgIGxldCBsb2NhbCA9IHRoaXMuX2xvY2FsO1xuICAgICAgICBsZXQgd29ybGQgPSB0aGlzLl9yZW5kZXJEYXRhLnZEYXRhc1swXTtcbiAgICAgICAgbGV0IGZsb2F0c1BlclZlcnQgPSB0aGlzLmZsb2F0c1BlclZlcnQ7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy52ZXJ0aWNlc0NvdW50OyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBsZXQgbHggPSBsb2NhbFtpKjJdO1xuICAgICAgICAgICAgbGV0IGx5ID0gbG9jYWxbaSoyICsgMV07XG4gICAgICAgICAgICB3b3JsZFtmbG9hdHNQZXJWZXJ0ICogaV0gPSBseCAqIGEgKyBseSAqIGMgKyB0eDtcbiAgICAgICAgICAgIHdvcmxkW2Zsb2F0c1BlclZlcnQgKiBpICsgMV0gPSBseCAqIGIgKyBseSAqIGQgKyB0eTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLyJ9