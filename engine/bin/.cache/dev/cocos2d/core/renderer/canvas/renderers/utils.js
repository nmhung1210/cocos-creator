
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'engine-dev/cocos2d/core/renderer/canvas/renderers/utils.js';
                    var __require = nodeEnv ? function (request) {
                        return require(request);
                    } : function (request) {
                        return __quick_compile_engine__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_engine__.registerModule(__filename, module);}"use strict";

/****************************************************************************
 Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.

 https://www.cocos.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated engine source code (the "Software"), a limited,
 worldwide, royalty-free, non-assignable, revocable and non-exclusive license
 to use Cocos Creator solely to develop games on your target platforms. You shall
 not use Cocos Creator software for developing other software or tools that's
 used for developing games. You are not granted to publish, distribute,
 sublicense, and/or sell copies of Cocos Creator.

 The software or tools in this License Agreement are licensed, not sold.
 Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var WHITE = (255 << 16) + (255 << 8) + 255;
var MAX_CANVAS_COUNT = 32;

function colorizedFrame(canvas, texture, color, sx, sy, sw, sh) {
  var image = texture._image;
  var ctx = canvas.getContext("2d");
  canvas.width = sw;
  canvas.height = sh; // Draw color

  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgb(' + color.r + ',' + color.g + ',' + color.b + ')';
  ctx.fillRect(0, 0, sw, sh); // Multiply color with texture

  ctx.globalCompositeOperation = 'multiply';
  ctx.drawImage(image, sx, sy, sw, sh, 0, 0, sw, sh); // Clip out transparent pixels

  ctx.globalCompositeOperation = "destination-atop";
  ctx.drawImage(image, sx, sy, sw, sh, 0, 0, sw, sh);
  return canvas;
}

var canvasMgr = {
  canvasMap: {},
  canvasUsed: {},
  canvasPool: [],
  checking: false,
  check: function check() {
    var exist = false;

    for (var key in this.canvasUsed) {
      exist = true;

      if (!this.canvasUsed[key]) {
        var canvas = this.canvasMap[key];
        canvas.width = 0;
        canvas.height = 0;

        if (this.canvasPool.length < 32) {
          this.canvasPool.push(canvas);
        }

        delete this.canvasMap[key];
        delete this.canvasUsed[key];
      } else {
        this.canvasUsed[key] = false;
      }
    }

    if (!exist) {
      cc.director.off(cc.Director.EVENT_AFTER_DRAW, this.check, this);
      this.checking = false;
    }
  },
  startCheck: function startCheck() {
    cc.director.on(cc.Director.EVENT_AFTER_DRAW, this.check, this);
    this.checking = true;
  },
  getCanvas: function getCanvas(key) {
    this.canvasUsed[key] = true;
    return this.canvasMap[key];
  },
  cacheCanvas: function cacheCanvas(canvas, key) {
    this.canvasMap[key] = canvas;
    this.canvasUsed[key] = true;

    if (!this.checking) {
      this.startCheck();
    }
  },
  dropImage: function dropImage(key) {
    if (this.canvasMap[key]) {
      delete this.canvasMap[key];
    }
  }
};
module.exports = {
  getColorizedImage: function getColorizedImage(texture, color) {
    if (!texture) return null;
    if (texture.width === 0 || texture.height === 0) return texture._image; // original image

    var cval = color._val & 0x00ffffff;

    if (cval === WHITE) {
      return texture._image;
    } // get from cache


    var key = texture.nativeUrl + cval;
    var cache = canvasMgr.getCanvas(key);

    if (!cache) {
      cache = canvasMgr.canvasPool.pop() || document.createElement("canvas");
      colorizedFrame(cache, texture, color, 0, 0, texture.width, texture.height);
      canvasMgr.cacheCanvas(cache, key);
    }

    return cache;
  },
  getFrameCache: function getFrameCache(texture, color, sx, sy, sw, sh) {
    if (!texture || !texture.nativeUrl || sx < 0 || sy < 0 || sw <= 0 || sh <= 0) {
      return null;
    }

    var key = texture.nativeUrl;
    var generate = false;
    var cval = color._val & 0x00ffffff;

    if (cval !== WHITE) {
      key += cval;
      generate = true;
    }

    if (sx !== 0 || sy !== 0 && sw !== texture.width && sh !== texture.height) {
      key += '_' + sx + '_' + sy + '_' + sw + '_' + sh;
      generate = true;
    }

    if (!generate) {
      return texture._image;
    } // get from cache


    var cache = canvasMgr.getCanvas(key);

    if (!cache) {
      cache = canvasMgr.canvasPool.pop() || document.createElement("canvas");
      colorizedFrame(cache, texture, color, sx, sy, sw, sh);
      canvasMgr.cacheCanvas(cache, key);
    }

    return cache;
  },
  dropColorizedImage: function dropColorizedImage(texture, color) {
    var key = texture.nativeUrl + (color._val & 0x00ffffff);
    canvasMgr.dropImage(key);
  }
}; // cache context data of device.

var _globalAlpha = -1;

var context = {
  setGlobalAlpha: function setGlobalAlpha(ctx, alpha) {
    if (_globalAlpha === alpha) {
      return;
    }

    _globalAlpha = alpha;
    ctx.globalAlpha = _globalAlpha;
  },
  reset: function reset() {
    _globalAlpha = -1;
  }
};
module.exports.context = context;
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_engine__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZS1kZXYvY29jb3MyZC9jb3JlL3JlbmRlcmVyL2NhbnZhcy9yZW5kZXJlcnMvdXRpbHMuanMiXSwibmFtZXMiOlsiV0hJVEUiLCJNQVhfQ0FOVkFTX0NPVU5UIiwiY29sb3JpemVkRnJhbWUiLCJjYW52YXMiLCJ0ZXh0dXJlIiwiY29sb3IiLCJzeCIsInN5Iiwic3ciLCJzaCIsImltYWdlIiwiX2ltYWdlIiwiY3R4IiwiZ2V0Q29udGV4dCIsIndpZHRoIiwiaGVpZ2h0IiwiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIiwiZmlsbFN0eWxlIiwiciIsImciLCJiIiwiZmlsbFJlY3QiLCJkcmF3SW1hZ2UiLCJjYW52YXNNZ3IiLCJjYW52YXNNYXAiLCJjYW52YXNVc2VkIiwiY2FudmFzUG9vbCIsImNoZWNraW5nIiwiY2hlY2siLCJleGlzdCIsImtleSIsImxlbmd0aCIsInB1c2giLCJjYyIsImRpcmVjdG9yIiwib2ZmIiwiRGlyZWN0b3IiLCJFVkVOVF9BRlRFUl9EUkFXIiwic3RhcnRDaGVjayIsIm9uIiwiZ2V0Q2FudmFzIiwiY2FjaGVDYW52YXMiLCJkcm9wSW1hZ2UiLCJtb2R1bGUiLCJleHBvcnRzIiwiZ2V0Q29sb3JpemVkSW1hZ2UiLCJjdmFsIiwiX3ZhbCIsIm5hdGl2ZVVybCIsImNhY2hlIiwicG9wIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiZ2V0RnJhbWVDYWNoZSIsImdlbmVyYXRlIiwiZHJvcENvbG9yaXplZEltYWdlIiwiX2dsb2JhbEFscGhhIiwiY29udGV4dCIsInNldEdsb2JhbEFscGhhIiwiYWxwaGEiLCJnbG9iYWxBbHBoYSIsInJlc2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXlCQSxJQUFNQSxLQUFLLEdBQUcsQ0FBQyxPQUFLLEVBQU4sS0FBYSxPQUFLLENBQWxCLElBQXVCLEdBQXJDO0FBQ0EsSUFBTUMsZ0JBQWdCLEdBQUcsRUFBekI7O0FBRUEs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QVA7QUFDSCxHQWxEWTtBQW9EYk0sRUFBQUEsa0JBcERhLDhCQW9ET25ELE9BcERQLEVBb0RnQkMsS0FwRGhCLEVBb0R1QjtBQUNoQyxRQUFJeUIsR0FBRyxHQUFHMUIsT0FBTyxDQUFDNEMsU0FBUixJQUFxQjNDLEtBQUssQ0FBQzBDLElBQU4sR0FBYSxVQUFsQyxDQUFWO0FBQ0F4QixJQUFBQSxTQUFTLENBQUNtQixTQUFWLENBQW9CWixHQUFwQjtBQUNIO0FBdkRZLENBQWpCLEVBMERBOztBQUNBLElBQUkwQixZQUFZLEdBQUcsQ0FBQyxDQUFwQjs7QUFFQSxJQUFJQyxPQUFPLEdBQUc7QUFDVkMsRUFBQUEsY0FEVSwwQkFDTTlDLEdBRE4sRUFDVytDLEtBRFgsRUFDa0I7QUFDeEIsUUFBSUgsWUFBWSxLQUFLRyxLQUFyQixFQUE0QjtBQUN4QjtBQUNIOztBQUVESCxJQUFBQSxZQUFZLEdBQUdHLEtBQWY7QUFDQS9DLElBQUFBLEdBQUcsQ0FBQ2dELFdBQUosR0FBa0JKLFlBQWxCO0FBQ0gsR0FSUztBQVVWSyxFQUFBQSxLQVZVLG1CQVVEO0FBQ0xMLElBQUFBLFlBQVksR0FBRyxDQUFDLENBQWhCO0FBQ0g7QUFaUyxDQUFkO0FBZUFiLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlYSxPQUFmLEdBQXlCQSxPQUF6QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gQ29weXJpZ2h0IChjKSAyMDE3LTIwMTggWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuXG5cbiBodHRwczovL3d3dy5jb2Nvcy5jb20vXG5cbiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXG4gd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxuIHRvIHVzZSBDb2NvcyBDcmVhdG9yIHNvbGVseSB0byBkZXZlbG9wIGdhbWVzIG9uIHlvdXIgdGFyZ2V0IHBsYXRmb3Jtcy4gWW91IHNoYWxsXG4gbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xuIHVzZWQgZm9yIGRldmVsb3BpbmcgZ2FtZXMuIFlvdSBhcmUgbm90IGdyYW50ZWQgdG8gcHVibGlzaCwgZGlzdHJpYnV0ZSxcbiBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgQ29jb3MgQ3JlYXRvci5cblxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXG4gWGlhbWVuIFlhamkgU29mdHdhcmUgQ28uLCBMdGQuIHJlc2VydmVzIGFsbCByaWdodHMgbm90IGV4cHJlc3NseSBncmFudGVkIHRvIHlvdS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmNvbnN0IFdISVRFID0gKDI1NTw8MTYpICsgKDI1NTw8OCkgKyAyNTU7XG5jb25zdCBNQVhfQ0FOVkFTX0NPVU5UID0gMzI7XG5cbmZ1bmN0aW9uIGNvbG9yaXplZEZyYW1lIChjYW52YXMsIHRleHR1cmUsIGNvbG9yLCBzeCwgc3ksIHN3LCBzaCkge1xuICAgIGxldCBpbWFnZSA9IHRleHR1cmUuX2ltYWdlO1xuXG4gICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgY2FudmFzLndpZHRoID0gc3c7XG4gICAgY2FudmFzLmhlaWdodCA9IHNoO1xuXG4gICAgLy8gRHJhdyBjb2xvclxuICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAnc291cmNlLW92ZXInO1xuICAgIGN0eC5maWxsU3R5bGUgPSAncmdiKCcgKyBjb2xvci5yICsgJywnICsgY29sb3IuZyArICcsJyArIGNvbG9yLmIgKyAnKSc7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIHN3LCBzaCk7XG5cbiAgICAvLyBNdWx0aXBseSBjb2xvciB3aXRoIHRleHR1cmVcbiAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ211bHRpcGx5JztcbiAgICBjdHguZHJhd0ltYWdlKGltYWdlLCBzeCwgc3ksIHN3LCBzaCwgMCwgMCwgc3csIHNoKTtcblxuICAgIC8vIENsaXAgb3V0IHRyYW5zcGFyZW50IHBpeGVsc1xuICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSBcImRlc3RpbmF0aW9uLWF0b3BcIjtcbiAgICBjdHguZHJhd0ltYWdlKGltYWdlLCBzeCwgc3ksIHN3LCBzaCwgMCwgMCwgc3csIHNoKTtcbiAgICByZXR1cm4gY2FudmFzO1xufVxuXG5sZXQgY2FudmFzTWdyID0ge1xuICAgIGNhbnZhc01hcDoge30sXG4gICAgY2FudmFzVXNlZDoge30sXG4gICAgY2FudmFzUG9vbDogW10sXG5cbiAgICBjaGVja2luZzogZmFsc2UsXG5cbiAgICBjaGVjayAoKSB7XG4gICAgICAgIGxldCBleGlzdCA9IGZhbHNlO1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5jYW52YXNVc2VkKSB7XG4gICAgICAgICAgICBleGlzdCA9IHRydWU7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY2FudmFzVXNlZFtrZXldKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNhbnZhcyA9IHRoaXMuY2FudmFzTWFwW2tleV07XG4gICAgICAgICAgICAgICAgY2FudmFzLndpZHRoID0gMDtcbiAgICAgICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gMDtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW52YXNQb29sLmxlbmd0aCA8IDMyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FudmFzUG9vbC5wdXNoKGNhbnZhcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbnZhc01hcFtrZXldO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbnZhc1VzZWRba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FudmFzVXNlZFtrZXldID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFleGlzdCkge1xuICAgICAgICAgICAgY2MuZGlyZWN0b3Iub2ZmKGNjLkRpcmVjdG9yLkVWRU5UX0FGVEVSX0RSQVcsIHRoaXMuY2hlY2ssIHRoaXMpO1xuICAgICAgICAgICAgdGhpcy5jaGVja2luZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIHN0YXJ0Q2hlY2sgKCkge1xuICAgICAgICBjYy5kaXJlY3Rvci5vbihjYy5EaXJlY3Rvci5FVkVOVF9BRlRFUl9EUkFXLCB0aGlzLmNoZWNrLCB0aGlzKTtcbiAgICAgICAgdGhpcy5jaGVja2luZyA9IHRydWU7XG4gICAgfSxcblxuICAgIGdldENhbnZhcyAoa2V5KSB7XG4gICAgICAgIHRoaXMuY2FudmFzVXNlZFtrZXldID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FudmFzTWFwW2tleV07XG4gICAgfSxcblxuICAgIGNhY2hlQ2FudmFzIChjYW52YXMsIGtleSkge1xuICAgICAgICB0aGlzLmNhbnZhc01hcFtrZXldID0gY2FudmFzO1xuICAgICAgICB0aGlzLmNhbnZhc1VzZWRba2V5XSA9IHRydWU7XG4gICAgICAgIGlmICghdGhpcy5jaGVja2luZykge1xuICAgICAgICAgICAgdGhpcy5zdGFydENoZWNrKCk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIFxuICAgIGRyb3BJbWFnZSAoa2V5KSB7XG4gICAgICAgIGlmICh0aGlzLmNhbnZhc01hcFtrZXldKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5jYW52YXNNYXBba2V5XTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIGdldENvbG9yaXplZEltYWdlICh0ZXh0dXJlLCBjb2xvcikge1xuICAgICAgICBpZiAoIXRleHR1cmUpIHJldHVybiBudWxsO1xuICAgICAgICBpZiAodGV4dHVyZS53aWR0aCA9PT0gMCB8fCB0ZXh0dXJlLmhlaWdodCA9PT0gMCkgIHJldHVybiB0ZXh0dXJlLl9pbWFnZTtcblxuICAgICAgICAvLyBvcmlnaW5hbCBpbWFnZVxuICAgICAgICBsZXQgY3ZhbCA9IGNvbG9yLl92YWwgJiAweDAwZmZmZmZmO1xuICAgICAgICBpZiAoY3ZhbCA9PT0gV0hJVEUpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0dXJlLl9pbWFnZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGdldCBmcm9tIGNhY2hlXG4gICAgICAgIGxldCBrZXkgPSB0ZXh0dXJlLm5hdGl2ZVVybCArIGN2YWw7XG4gICAgICAgIGxldCBjYWNoZSA9IGNhbnZhc01nci5nZXRDYW52YXMoa2V5KTtcbiAgICAgICAgaWYgKCFjYWNoZSkge1xuICAgICAgICAgICAgY2FjaGUgPSBjYW52YXNNZ3IuY2FudmFzUG9vbC5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgICAgICAgICAgY29sb3JpemVkRnJhbWUoY2FjaGUsIHRleHR1cmUsIGNvbG9yLCAwLCAwLCB0ZXh0dXJlLndpZHRoLCB0ZXh0dXJlLmhlaWdodCk7XG4gICAgICAgICAgICBjYW52YXNNZ3IuY2FjaGVDYW52YXMoY2FjaGUsIGtleSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNhY2hlO1xuICAgIH0sXG5cbiAgICBnZXRGcmFtZUNhY2hlICh0ZXh0dXJlLCBjb2xvciwgc3gsIHN5LCBzdywgc2gpIHtcbiAgICAgICAgaWYgKCF0ZXh0dXJlIHx8ICF0ZXh0dXJlLm5hdGl2ZVVybCB8fCBzeCA8IDAgfHwgc3kgPCAwIHx8IHN3IDw9IDAgfHwgc2ggPD0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQga2V5ID0gdGV4dHVyZS5uYXRpdmVVcmw7XG4gICAgICAgIGxldCBnZW5lcmF0ZSA9IGZhbHNlO1xuICAgICAgICBsZXQgY3ZhbCA9IGNvbG9yLl92YWwgJiAweDAwZmZmZmZmO1xuICAgICAgICBpZiAoY3ZhbCAhPT0gV0hJVEUpIHtcbiAgICAgICAgICAgIGtleSArPSBjdmFsO1xuICAgICAgICAgICAgZ2VuZXJhdGUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzeCAhPT0gMCB8fCBzeSAhPT0gMCAmJiBzdyAhPT0gdGV4dHVyZS53aWR0aCAmJiBzaCAhPT0gdGV4dHVyZS5oZWlnaHQpIHtcbiAgICAgICAgICAgIGtleSArPSAnXycgKyBzeCArICdfJyArIHN5ICsgJ18nICsgc3cgKyAnXycgKyBzaDtcbiAgICAgICAgICAgIGdlbmVyYXRlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWdlbmVyYXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGV4dHVyZS5faW1hZ2U7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIGdldCBmcm9tIGNhY2hlXG4gICAgICAgIGxldCBjYWNoZSA9IGNhbnZhc01nci5nZXRDYW52YXMoa2V5KTtcbiAgICAgICAgaWYgKCFjYWNoZSkge1xuICAgICAgICAgICAgY2FjaGUgPSBjYW52YXNNZ3IuY2FudmFzUG9vbC5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgICAgICAgICAgY29sb3JpemVkRnJhbWUoY2FjaGUsIHRleHR1cmUsIGNvbG9yLCBzeCwgc3ksIHN3LCBzaCk7XG4gICAgICAgICAgICBjYW52YXNNZ3IuY2FjaGVDYW52YXMoY2FjaGUsIGtleSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNhY2hlO1xuICAgIH0sXG5cbiAgICBkcm9wQ29sb3JpemVkSW1hZ2UgKHRleHR1cmUsIGNvbG9yKSB7XG4gICAgICAgIGxldCBrZXkgPSB0ZXh0dXJlLm5hdGl2ZVVybCArIChjb2xvci5fdmFsICYgMHgwMGZmZmZmZik7XG4gICAgICAgIGNhbnZhc01nci5kcm9wSW1hZ2Uoa2V5KTtcbiAgICB9XG59O1xuXG4vLyBjYWNoZSBjb250ZXh0IGRhdGEgb2YgZGV2aWNlLlxubGV0IF9nbG9iYWxBbHBoYSA9IC0xO1xuXG5sZXQgY29udGV4dCA9IHtcbiAgICBzZXRHbG9iYWxBbHBoYSAoY3R4LCBhbHBoYSkge1xuICAgICAgICBpZiAoX2dsb2JhbEFscGhhID09PSBhbHBoYSkge1xuICAgICAgICAgICAgcmV0dXJuIFxuICAgICAgICB9XG5cbiAgICAgICAgX2dsb2JhbEFscGhhID0gYWxwaGE7XG4gICAgICAgIGN0eC5nbG9iYWxBbHBoYSA9IF9nbG9iYWxBbHBoYTtcbiAgICB9LFxuXG4gICAgcmVzZXQgKCkge1xuICAgICAgICBfZ2xvYmFsQWxwaGEgPSAtMTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzLmNvbnRleHQgPSBjb250ZXh0OyJdLCJzb3VyY2VSb290IjoiLyJ9