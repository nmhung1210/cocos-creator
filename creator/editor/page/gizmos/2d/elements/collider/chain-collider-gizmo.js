"use strict";let t=require("./collider-gizmo"),e=require("../tools"),o={None:0,Point:1,Line:2};module.exports=class extends t{onCreateMoveCallbacks(){let t,e;return{start:(l,i,r,n)=>{if(n===o.Point){let o=r.currentTarget.instance;if(e=o.point.origin,t=e.clone(),r.ctrlKey||r.metaKey){this.recordChanges();let t=this.target.points;return t.splice(t.indexOf(e),1),this.commitChanges(),void 0}}else if(n===o.Line){this.recordChanges();let t=this.screenToNodeLocalPos(cc.v2(l,i),this.node),e=r.currentTarget.instance,o=e.startSvgPoint.point.origin,n=e.endSvgPoint.point.origin,s=this.target.points.indexOf(o)+1,c=o.x-n.x,a=o.y-n.y,h=(t.x-o.x)*(o.x-n.x)+(t.y-o.y)*(o.y-n.y);h/=c*c+a*a,t.x=o.x+h*c,t.y=o.y+h*a,this.adjustValue(t),this.target.points.splice(s,0,t),this.commitChanges()}},update:(l,i,r,n)=>{let s=this.screenToNodeLocalDelta(cc.v2(l,i),this.node);if(n===o.Point){if(r.ctrlKey||r.metaKey)return;s.addSelf(t),this.adjustValue(s),e.x=s.x,e.y=s.y}}}}onCreateRoot(){let t=this._root,l=t.linesGroup=t.group(),i=[];l.style("cursor","normal");let r=()=>e.lineTool(l,cc.v2(0,0),cc.v2(0,0),"#7fc97a",null,this.createMoveCallbacks(o.Line)),n=t.pointsGroup=t.group(),s=[];n.hide();let c=()=>{let t=e.circleTool(n,5,{color:"#7fc97a"},null,"pointer",this.createMoveCallbacks(o.Point));return t.on("mouseover",function(e){(e.ctrlKey||e.metaKey)&&(t.fill({color:"#f00"}),t.l1&&t.l1.stroke({color:"#f00"}),t.l2&&t.l2.stroke({color:"#f00"}))}),t.on("mouseout",function(e){t.fill({color:"#7fc97a"}),t.l1&&t.l1.stroke({color:"#7fc97a"}),t.l2&&t.l2.stroke({color:"#7fc97a"})}),t};t.plot=function(t){let e=[];for(let o=0,l=t.length;o<l;o++){let n=t[o];e.push([n.x,n.y]);let a=s[o];if(a||(a=s[o]=c()),a.point=n,a.show(),a.center(n.x,n.y),o===l-1)continue;let h=o+1,u=s[h];u||(u=s[h]=c());let p=i[o];p||(p=i[o]=r());let d=n,g=t[h];p.show(),p.plot(d.x,d.y,g.x,g.y),p.startSvgPoint=a,p.endSvgPoint=u,a.l1=p,u.l2=p}for(let e=t.length,o=s.length;e<o;e++)s[e].hide();for(let e=t.length-1,o=s.length;e<o;e++)i[e]&&i[e].hide()}}onUpdate(){let t=this.target.points,e=(this.node,cc.mat4());this.node.getWorldMatrix(e);let o=[];for(let l=0,i=t.length;l<i;l++){let i=t[l],r=cc.v2();cc.Vec2.transformMat4(r,i,e),(r=this.worldToPixel(r)).origin=t[l],o.push(r)}this._root.plot(o)}enterEditing(){let t=this._root;t.pointsGroup.show(),t.linesGroup.style("cursor","copy")}leaveEditing(){let t=this._root;t.pointsGroup.hide(),t.linesGroup.style("cursor","normal")}};