"use strict";const{create3DNode:e,getRaycastResults:o}=require("../utils/engine"),t=require("./gizmo-defines"),i=require("../../../3d/manager/node"),s=require("../../selection"),n=require("../utils/transform-tool-data"),l=require("../../operation"),r=require("./elements/controller/world-axis-controller");let h=cc.v3();n.on("tool-name-changed",e=>{Manager.Ipc.send("broadcast","scene:gizmo-tool-changed",e)}),module.exports=new class{queryToolName(){return this.transformToolName}setTransformToolName(e){["position","rotation","scale"].includes(e)&&(this.transformToolName=e)}init(){this.gizmoRootNode=e("gizmoRoot"),this.gizmoRootNode.parent=Manager.foregroundNode,this.hoverinNode=null,this.curSelectNode=null,l.on("mousedown",this.onMouseDown.bind(this)),l.on("mousemove",this.onMouseMove.bind(this)),l.on("mouseup",this.onMouseUp.bind(this)),l.on("wheel",this.onMouseWheel.bind(this)),l.on("keydown",this.onKeyDown.bind(this)),l.on("keyup",this.onKeyUp.bind(this)),this._gizmoToolMap={},this._selection=[],this._gizmosPool={},s.on("select",(e,o)=>{this.select(e,o)}),s.on("unselect",e=>{this.unselect([e])}),this._worldAxisController=new r(this.gizmoRootNode)}onSceneLoaded(){this.clearAllGizmos(),this.transformToolName="position";let e=s.query();this.select(e)}get transformTool(){return this._transformTool}get transformToolName(){return n.toolName}set transformToolName(e){n.toolName=e;let o=this.getGizmoToolByName(n.toolName);if(null!=o&&o!==this._transformTool){let e=[];null!=this._transformTool&&(this._transformTool.hide(),e=this._transformTool.target),this._transformTool=o,this.edit(e)}}get coordinate(){return n.coordinate}set coordinate(e){n.coordinate=e,this._transformTool&&this.edit(this._transformTool.target)}get pivot(){return n.pivot}set pivot(e){n.pivot=e,this._transformTool&&this.edit(this._transformTool.target)}lockGizmoTool(e){n.isLocked=e}isGizmoToolLocked(){return n.isLocked}getGizmoToolByName(e){let o=this._gizmoToolMap[e];if(null==o){let i;switch(e){case"position":i=t.position;break;case"rotation":i=t.rotation;break;case"scale":i=t.scale}null!=i?(this._gizmoToolMap[e]=this.createGizmo(e,i),o=this._gizmoToolMap[e]):console.error("Unknown transform tool %s",e)}return o}clearAllGizmos(){Object.keys(this._gizmosPool).forEach(e=>{this._gizmosPool[e].forEach(e=>{this.destoryGizmo(e)})})}createGizmo(e,o,t){if(null==o)return;let i=this._gizmosPool[e],s=null;if(null==i)i=[],s=new o(t),i.push(s),this._gizmosPool[e]=i;else{for(let e=0;e<i.length;e++)if(!i[e].visible()){(s=i[e]).target=t;break}s||(s=new o(t),i.push(s))}return s}destoryGizmo(e){e&&e.hide()}showNodeGizmo(e){if(!e)return;let o=null,i=null;if(null==e.gizmo){let s=cc.js.getClassName(e);(o=t[s])&&((i=this.createGizmo(s,o,e)).show(),e.gizmo=i)}e._components.forEach(s=>{if(e.active&&s.enabled&&null==s.gizmo){o=null,i=null;let e=cc.js.getClassName(s);null!=(o=t.components[e])&&((i=this.createGizmo(e,o,s)).show(),s.gizmo=i)}})}hideNodeGizmo(e){e&&(e.gizmo&&(this.destoryGizmo(e.gizmo),e.gizmo=null),e._components.forEach(e=>{e.gizmo&&(this.destoryGizmo(e.gizmo),e.gizmo=null)}))}onComponentEnable(e){let o=cc.engine.getInstanceById(e);-1!==this._selection.indexOf(o.node.uuid)&&this.showNodeGizmo(o.node)}onComponentDisable(e){let o=cc.engine.getInstanceById(e);o&&o.gizmo&&(this.destoryGizmo(o.gizmo),o.gizmo=null)}updateGizmosState(e,o){if(!e)return;let t=e._components;Object.keys(o).forEach(i=>{e.gizmo&&(e.gizmo[i]=o[i]),t.forEach(e=>{e.gizmo&&(e.gizmo[i]=o[i])})})}select(e,o){if(!e||!o)return;let t=i.query(e);if(!t)return;this.showNodeGizmo(t),this._selection=o;let s=[];o.forEach(e=>{let o=i.query(e);o&&(this.updateGizmosState(o,{selecting:!0,editing:!1}),s.push(o))}),this.edit(s)}unselect(e){e.forEach(e=>{let o=this._selection.indexOf(e);-1!==o&&this._selection.splice(o,1);let t=i.query(e);this.updateGizmosState(t,{selecting:!1,editing:!1}),this.hideNodeGizmo(t)});let o=this._selection.map(e=>i.query(e));this.edit(o.filter(e=>!!e))}edit(e){if(0===e.length)return this._transformTool&&(this._transformTool.target=[]),void 0;1===e.length&&this.updateGizmosState(e[0],{selecting:!1,editing:!0}),null!=this.transformTool&&(this.transformTool.target=e,this.transformTool.show())}onMouseDown(e){if(e.leftButton){let t=e.x,i=cc.game.canvas.height-e.y,s=o(this.gizmoRootNode,t,i),n=s.ray;if(s.length>0){let e=s[0],o=new cc.Event("mouseDown",!0);return cc.Vec3.scale(h,n.d,e.distance),cc.Vec3.add(h,n.o,h),o.hitPoint=h,o.x=t,o.y=i,this.curSelectNode=e.node,this.curSelectNode.emit(o.type,o),!0}return!1}}onMouseWheel(e){}onMouseMove(e){let t=e.x,i=cc.game.canvas.height-e.y,s=o(this.gizmoRootNode,t,i),n=new cc.Event("mouseMove",!0);if(n.x=t,n.y=i,n.moveDeltaX=e.moveDeltaX,n.moveDeltaY=-e.moveDeltaY,null!=this.curSelectNode)this.curSelectNode.emit(n.type,n);else if(s.length>0){let e=s[0].node;e!==this.hoverinNode&&(null!=this.hoverinNode&&(n=new cc.Event("hoverOut",!0),this.hoverinNode.emit(n.type,n)),this.hoverinNode=e,(n=new cc.Event("hoverIn",!0)).x=t,n.y=i,this.hoverinNode.emit(n.type,n))}else null!=this.hoverinNode&&(n=new cc.Event("hoverOut",!0),this.hoverinNode.emit(n.type,n)),this.hoverinNode=null}onMouseUp(e){let t=e.x,i=cc.game.canvas.height-e.y,s=new cc.Event("mouseUp",!0);if(null!=this.curSelectNode)return this.curSelectNode.emit(s.type,s),this.curSelectNode=null,!1;{let e=o(this.gizmoRootNode,t,i);for(let o=0;o<e.length;o++)e[o].node.emit(s.type,s)}}onMouseLeave(){let e=new cc.Event("mouseLeave",!0);null!=this.curSelectNode&&(this.curSelectNode.emit(e.type,e),this.curSelectNode=null)}onKeyDown(e){if(!this.isGizmoToolLocked())switch(e.key.toLowerCase()){case"g":this.coordinate="global";break;case"l":this.coordinate="local"}this.transformTool&&this.transformTool.onGizmoKeyDown&&this.transformTool.onGizmoKeyDown(e)}onKeyUp(e){this.transformTool&&this.transformTool.onGizmoKeyUp&&this.transformTool.onGizmoKeyUp(e)}onNodeChanged(e){null!=e&&e.emit("change"),this.hideNodeGizmo(e),-1!==this._selection.indexOf(e.uuid)&&this.showNodeGizmo(e)}onNodeRemoved(e){null!=e&&this.hideNodeGizmo(e)}onComponentAdded(e,o){this.showNodeGizmo(o)}onBeforeComponentRemove(e,o){this.destoryGizmo(e.gizmo)}};