"use strict";var c={};module.exports=c;const{gfx:t,createMesh:e}=require("../../../utils/engine"),{Vec3:n,Quat:i}=cc.math,r=require("../../../utils/external").EditorMath,s=require("../../../utils");c.cylinder=function(c=.5,t=.5,n=2,i={}){let r=.5*n,s=i.radialSegments||16,o=i.heightSegments||1,l=void 0===i.capped||i.capped,a=i.arc||2*Math.PI,u=0;l||(c>0&&u++,t>0&&u++);let v=(s+1)*(o+1);l&&(v+=(s+1)*u+s*u);let h=s*o*2*3;l&&(h+=s*u*3);let p=new Array(h),f=new Array(v),m=new Array(v),d=new Array(v),y=Math.max(c,t),P=cc.v3(-y,-r,-y),g=cc.v3(y,r,y),x=0,A=0;function M(e){let n,i,o=e?c:t,l=e?1:-1;n=x;for(let c=1;c<=s;++c)f[x]=cc.v3(0,r*l,0),m[x]=cc.v3(0,l,0),d[x]=cc.v2(.5,.5),++x;i=x;for(let c=0;c<=s;++c){let t=c/s*a,e=Math.cos(t),n=Math.sin(t);f[x]=cc.v3(o*n,r*l,o*e),m[x]=cc.v3(0,l,0),d[x]=cc.v2(.5-.5*n*l,.5+.5*e),++x}for(let c=0;c<s;++c){let t=n+c,r=i+c;e?(p[A]=r+1,p[++A]=t,p[++A]=r,++A):(p[A]=t,p[++A]=r+1,p[++A]=r,++A)}}return function(){let e=[],i=(c-t)/n;for(let l=0;l<=o;l++){let u=[],v=l/o,h=v*(c-t)+t;for(let c=0;c<=s;++c){let t=c/s,e=t*a,o=Math.sin(e),l=Math.cos(e);f[x]=cc.v3(h*o,v*n-r,h*l),m[x]=cc.v3(o,-i,l).normalizeSelf(),d[x]=cc.v2(2*(1-t)%1,v),u.push(x),++x}e.push(u)}for(let c=0;c<o;++c)for(let t=0;t<s;++t){let n=e[c][t],i=e[c+1][t],r=e[c+1][t+1],s=e[c][t+1];p[A]=n,p[++A]=s,p[++A]=i,p[++A]=s,p[++A]=r,p[++A]=i,++A}}(),l&&(t>0&&M(!1),c>0&&M(!0)),e({positions:f,normals:m,uvs:d,indices:p,minPos:P,maxPos:g})},c.cone=function(t,e,n){return c.cylinder(0,t,e,n)},c.quad=function(c,t){let n=c/2,i=t/2;return e({positions:[cc.v3(-n,i,0),cc.v3(-n,-i,0),cc.v3(n,-i,0),cc.v3(n,i,0)],normals:Array(4).fill(cc.v3(0,0,1)),indices:[0,3,1,1,3,2],minPos:cc.v3(-n,-i,-1),maxPos:cc.v3(n,i,1),doubleSided:!0})},c.line=function(c,n){return e({positions:[cc.v3(c.x,c.y,c.z),cc.v3(n.x,n.y,n.z)],normals:Array(2).fill(cc.v3(0,1,0)),indices:[0,1],primitiveType:t.PT_LINES})},c.lineWithBoundingBox=function(c,n=3){return e({positions:[cc.v3(),cc.v3(c,0,0)],normals:Array(2).fill(cc.v3(0,1,0)),indices:[0,1],minPos:cc.v3(0,-n,-n),maxPos:cc.v3(c,n,n),primitiveType:t.PT_LINES})},c.circle=function(t,e,n){let i=c.getBiNormalByNormal(e);return c.arc(t,e,i,r.TWO_PI,n,60)},c.cube=function(c,t,n,i={}){let r=i.widthSegments?i.widthSegments:1,s=i.heightSegments?i.heightSegments:1,o=i.lengthSegments?i.lengthSegments:1,l=.5*c,a=.5*t,u=.5*n,v=[cc.v3(-l,-a,u),cc.v3(l,-a,u),cc.v3(l,a,u),cc.v3(-l,a,u),cc.v3(l,-a,-u),cc.v3(-l,-a,-u),cc.v3(-l,a,-u),cc.v3(l,a,-u)],h=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],p=[cc.v3(0,0,1),cc.v3(0,0,-1),cc.v3(0,1,0),cc.v3(0,-1,0),cc.v3(1,0,0),cc.v3(-1,0,0)],f=[],m=[],d=[],y=[],P=cc.v3(-l,-a,-u),g=cc.v3(l,a,u);function x(c,t,e){let n,i,r,s,o=f.length,l=h[c],a=p[c];for(s=0;s<=e;s++)for(r=0;r<=t;r++){n=r/t,i=s/e;let c=v[l[0]].lerp(v[l[1]],n),u=v[l[0]].lerp(v[l[2]],i);if(f.push(c.add(u.sub(v[l[0]]))),m.push(a.clone()),d.push(cc.v2(n,i)),r<t&&s<e){let c=t+1,e=r+s*c,n=r+(s+1)*c,i=r+1+(s+1)*c,l=r+1+s*c;y.push(o+e,o+l,o+n),y.push(o+n,o+l,o+i)}}}return x(0,r,s),x(4,o,s),x(1,r,s),x(5,o,s),x(3,r,o),x(2,r,o),e({positions:f,indices:y,normals:m,minPos:P,maxPos:g})},c.torus=function(c,t,n={}){let i=n.radialSegments||30,r=n.tubularSegments||20,s=n.arc||2*Math.PI,o=[],l=[],a=[],u=[],v=cc.v3(-c-t,-t,-c-t),h=cc.v3(c+t,t,c+t);for(let e=0;e<=i;e++)for(let n=0;n<=r;n++){let v=n/r,h=e/i,p=v*s,f=h*Math.PI*2,m=(c+t*Math.cos(f))*Math.sin(p),d=t*Math.sin(f),y=(c+t*Math.cos(f))*Math.cos(p),P=Math.sin(p)*Math.cos(f),g=Math.sin(f),x=Math.cos(p)*Math.cos(f);if(o.push(cc.v3(m,d,y)),l.push(cc.v3(P,g,x)),a.push(cc.v2(v,h)),n<r&&e<i){let c=r+1,t=c*e+n,i=c*(e+1)+n,s=c*(e+1)+n+1,o=c*e+n+1;u.push(t,o,i),u.push(o,s,i)}}return e({positions:o,indices:u,normals:l,uvs:a,minPos:v,maxPos:h})},c.calcArcPoints=function(c,t,e,r,s,o=60){n.normalize(e,e),n.normalize(t,t);let l=cc.quat(0,0,0,1),a=o;i.fromAxisAngle(l,t,r/(a-1));let u=cc.v3();n.scale(u,e,s);let v=[];for(let t=0;t<a;t++)v[t]=c.add(u),n.transformQuat(u,u,l);return v},c.getBiNormalByNormal=function(c){let t=cc.v3();return n.cross(t,c,cc.v3(0,1,0)),s.getSqrMagnitude(t)<.001&&n.cross(t,c,cc.v3(1,0,0)),t},c.calcCirclePoints=function(t,e,n,i=60){let s=c.getBiNormalByNormal(e);return c.calcArcPoints(t,e,s,r.TWO_PI,n,i)},c.calcDiscPoints=function(t,e,n,i=60){let s=c.getBiNormalByNormal(e);return c.calcSectorPoints(t,e,s,r.TWO_PI,n,i)},c.calcSectorPoints=function(t,e,n,i,r,s){let o=[];o.push(t);let l=c.calcArcPoints(t,e,n,i,r,s);return o=o.concat(l)},c.disc=function(t,e,n){let i=c.getBiNormalByNormal(e);return c.sector(t,e,i,r.TWO_PI,n,60)},c.sector=function(n,i,r,s,o,l){return e({positions:c.calcSectorPoints(n,i,r,s,o,l),normals:Array(l+1).fill(cc.v3(i)),indices:[...Array(l+1).keys()],primitiveType:t.PT_TRIANGLE_FAN})},c.arc=function(n,i,r,s,o,l=60){return e({positions:c.calcArcPoints(n,i,r,s,o,l),normals:Array(l).fill(cc.v3(i)),indices:[...Array(l).keys()],primitiveType:t.PT_LINE_STRIP})},c.arcDirectionLine=function(i,r,s,o,l,a,u){let v=[],h=[],p=c.calcArcPoints(i,r,s,o,l,u),f=cc.v3();n.scale(f,r,a);for(let c=0;c<p.length;c++){let t=cc.v3();n.add(t,p[c],f),v.push(p[c],t),h.push(2*c,2*c+1)}for(let c=1;c<p.length;c++)v.push(p[c-1]),h.push(v.length-1),v.push(p[c]),h.push(v.length-1);return e({positions:v,normals:Array(v.length).fill(cc.v3(0,1,1)),indices:h,primitiveType:t.PT_LINES})},c.lines=function(c,n){return e({positions:c,normals:Array(c.length).fill(cc.v3(0,1,0)),indices:n,primitiveType:t.PT_LINES})},c.calcBoxPoints=function(c,t){let e=cc.v3();n.scale(e,t,.5);let i=[];return i[0]=c.add(cc.v3(-e.x,-e.y,-e.z)),i[1]=c.add(cc.v3(-e.x,e.y,-e.z)),i[2]=c.add(cc.v3(e.x,e.y,-e.z)),i[3]=c.add(cc.v3(e.x,-e.y,-e.z)),i[4]=c.add(cc.v3(-e.x,-e.y,e.z)),i[5]=c.add(cc.v3(-e.x,e.y,e.z)),i[6]=c.add(cc.v3(e.x,e.y,e.z)),i[7]=c.add(cc.v3(e.x,-e.y,e.z)),i},c.wireframeBox=function(n,i){let r=c.calcBoxPoints(n,i),s=[];for(let c=1;c<4;c++)s.push(c-1,c);s.push(0,3);for(let c=5;c<8;c++)s.push(c-1,c);s.push(4,7);for(let c=0;c<4;c++)s.push(c,c+4);return e({positions:r,normals:Array(r.length).fill(cc.v3(0,1,0)),indices:s,primitiveType:t.PT_LINES})},c.calcFrustum=function(c,t,e,n,i,s){let o,l,a,u,v=[],h=[];c?l=u=(o=a=t)*n:(l=(o=Math.tan(r.deg2rad(e/2))*i)*n,u=(a=Math.tan(r.deg2rad(e/2))*s)*n),v[0]=cc.v3(-l,-o,-i),v[1]=cc.v3(-l,o,-i),v[2]=cc.v3(l,o,-i),v[3]=cc.v3(l,-o,-i),v[4]=cc.v3(-u,-a,-s),v[5]=cc.v3(-u,a,-s),v[6]=cc.v3(u,a,-s),v[7]=cc.v3(u,-a,-s);for(let c=1;c<4;c++)h.push(c-1,c);h.push(0,3);for(let c=5;c<8;c++)h.push(c-1,c);h.push(4,7);for(let c=0;c<4;c++)h.push(c,c+4);return{vertices:v,indices:h}},c.frustum=function(n,i,r,s){let o=c.calcFrustum(n,i,r,s);return e({positions:o.vertices,normals:Array(o.vertices.length).fill(cc.v3(0,1,0)),indices:o.indices,primitiveType:t.PT_LINES})};