"use strict";let e=require("./engine-interface");const t=require("../../../../3d/manager/camera");let o=require("../external").GeometryUtils.aabb,n=cc.gfx,r=function(e,t){return e.map(t).reduce((e,t)=>e.concat(t),[])};const c=(e,t)=>e.distance-t.distance,a=cc.geometry.ray.create();module.exports=new class extends e{constructor(){super(),this.gfx=n,this.panPlaneLayer=cc.Layers.Editor}create3DNode(e){let t=new cc.Node(e);return t._layer=cc.Layers.Gizmos,t.modelColor=cc.color(),t}createMesh(e){e.positions=r(e.positions,e=>[e.x,e.y,e.z]),e.normals&&(e.normals=r(e.normals,e=>[e.x,e.y,e.z])),e.uvs&&(e.uvs=r(e.uvs,e=>[e.x,e.y]));let t=cc.utils.createMesh(cc.game._renderContext,e);return t.getSubMesh(0).doubleSided=e.doubleSided,t}addMeshToNode(e,t,o={}){let r=e.addComponent(cc.ModelComponent);r.mesh=t;let c=new cc.Material;if(c.effectName="__editor-gizmo",o.unlit?c.effect.LOD=50:t.getSubMesh(0)._primitiveType<n.PT_TRIANGLES&&(c.effect.LOD=o.noDepthTestForLines?50:0),c.setProperty("color",e.modelColor),c.effect){let e=c.effect.getActiveTechnique().passes[0];o.cullMode&&e.setCullMode(o.cullMode)}r.material=c}setMeshColor(e,t){e.modelColor.r=t.r,e.modelColor.g=t.g,e.modelColor.b=t.b}getMeshColor(e){return e.modelColor}setNodeOpacity(e,t){e.modelColor.a=t}getNodeOpacity(e){return e.modelColor.a}getRaycastResults(e,o,n){let r=cc.director._renderSystem._scene;t._camera._camera.screenPointToRay(o,n,cc.winSize.width,cc.winSize.height,a);let s=r.raycast(a,e._layer).sort(c);return s.ray=a,s}getModel(e){return e.getComponent(cc.ModelComponent)}updateVBAttr(e,t,o){let n=e.getSubMesh(0)._vertexBuffer,r=n[t];o.forEach((e,t)=>{r[3*t]=e.x,r[3*t+1]=e.y,r[3*t+2]=e.z}),n.updateAttr(t)}getBoudingBox(e){let t=null;if(e instanceof cc.ModelComponent){let n=e.mesh;n&&(t=o.fromPoints(o.create(),n.minPosition,n.maxPosition))}else console.error("target is not a cc.ModelComponent");return t}getRootBoneNode(e){let t=null;if(e instanceof cc.SkinningModelComponent){if(e.skeleton){let o=e.skeleton.joints;o&&o.length>0&&e._skinningTarget&&(t=e._skinningTarget.get(o[0]))}}else console.error("target is not a cc.SkinningModelComponent");return t}getRootBindPose(e){let t=null;if(e instanceof cc.SkinningModelComponent){let o=e.skeleton;o&&(t=o.bindposes[0])}else console.error("target is not a cc.SkinningModelComponent");return t}getCameraData(e){let t=null;return e instanceof cc.CameraComponent?((t={}).projection=e.projection,t.orthoHeight=e.orthoHeight,t.fov=e.fov,t.aspect=cc.winSize.width/cc.winSize.height,t.near=e.near,t.far=e.far):console.error("target is not a cc.CameraComponent"),t}setCameraData(e,t){e instanceof cc.CameraComponent?(t.fov&&(e.fov=t.fov),t.far&&(e.far=t.far)):console.error("target is not a cc.CameraComponent")}getLightData(e){let t=null;return e instanceof cc.LightComponent?((t={}).type=e.type,t.range=e.range,t.spotAngle=e.spotAngle):console.error("target is not a cc.LightComponent"),t}setLightData(e,t){e instanceof cc.LightComponent?(t.range&&(e.range=t.range),t.spotAngle&&(e.spotAngle=t.spotAngle)):console.error("target is not a cc.LightComponent")}};