const t=require(Editor.url("app://editor/share/sharp")),e=require("child_process").spawn,r=require("child_process").spawnSync,n=require("fire-fs"),o=require("fire-path"),i=require("async"),a=require("./texture-compress-cache"),c=Editor.remote.Project.path,s=o.join(c,"temp/TexturePacker/build");function l(t,e){return o.join(o.dirname(t),o.basenameNoExt(t)+e)}function u(t){let e=cc.Texture2D.PixelFormat;if(t.name.startsWith("pvrtc_")){let r=e.RGBA_PVRTC_4BPPV1;return"pvrtc_2bits"===t.name?r=e.RGBA_PVRTC_2BPPV1:"pvrtc_4bits_rgb"===t.name?r=e.RGB_PVRTC_4BPPV1:"pvrtc_2bits_rgb"===t.name?r=e.RGB_PVRTC_2BPPV1:"pvrtc_4bits_rgb_a"===t.name?r=e.RGB_A_PVRTC_4BPPV1:"pvrtc_2bits_rgb_a"===t.name&&(r=e.RGB_A_PVRTC_2BPPV1),`.pvr@${r}`}if(t.name.startsWith("etc")){let r=e.RGB_ETC1;return"etc1"===t.name?r=e.RGBA_ETC1:"etc2"===t.name?r=e.RGBA_ETC2:"etc2_rgb"===t.name&&(r=e.RGB_ETC2),`.pkm@${r}`}return"."+t.name}function p(e,r,n,o){let i=t(e),a=".png";if("webp"===n.name)i=i.webp({quality:n.quality}),a=".webp";else if("jpg"===n.name)i=i.jpeg({quality:n.quality}),a=".jpg";else if("png"===n.name){let t=n.quality/10|0;i=i.png({compressionLevel:t})}r=l(r,a),i.toFile(r,t=>{o(t)})}function m(t){if("number"!=typeof t)return;let e=2;for(;t>e;)e*=2;return e}function _(e,r,i){let a=new t(e);a.metadata().then(e=>{const c=e.width,s=e.height;let l=m(c),u=m(s);u<l/2&&(u=l/2);let p=e.channels,_=4===p;a.raw().toBuffer((e,a)=>{if(e)return i(e);const l=2*c*u*3;let m,f,d=Buffer.alloc(l,0);for(let t=0;t<s;t++)for(let e=0;e<c;e++){let r=t*c+e,n=r*p;d[m=3*r]=a[n],d[m+1]=a[n+1],d[m+2]=a[n+2],f=3*((t+u)*c+e);let o=a[n+3];_||(o=255),d[f]=o,d[f+1]=o,d[f+2]=o}const b={raw:{width:c,height:2*u,channels:3}};n.ensureDirSync(o.dirname(r)),t(d,b).toFile(r,t=>{i(t)})})})}function f(t,r,n,i){let a=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/OSX_x86/PVRTexToolCLI");"win32"===process.platform&&(a=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/Windows_x86_64/PVRTexToolCLI.exe"));let u=!1,p="PVRTC1_4";function m(){r=l(r,".pvr");let o="pvrtc"+n.quality,c=["-i",t,"-o",r,"-squarecanvas","+","-potcanvas","+","-q",o,"-f",`${p},UBN,lRGB`];console.log(`pvrtc compress command :  ${a} ${c.join(" ")}`),function(t,r,n,o){let i=e(t,r,n);i.stdout.on("data",function(t){t.toString().split("\n").forEach(t=>{Editor.log(t)})}),i.stderr.on("data",function(t){t.toString().split("\n").forEach(t=>{Editor.info(t)})}),i.on("close",function(){o&&o(null)}),i.on("error",function(t){o&&o(t)})}(a,c,{},i)}if("pvrtc_4bits"===n.name?p="PVRTC1_4":"pvrtc_4bits_rgb"===n.name?p="PVRTC1_4_RGB":"pvrtc_2bits"===n.name?p="PVRTC1_2":"pvrtc_2bits_rgb"===n.name?p="PVRTC1_2_RGB":"pvrtc_4bits_rgb_a"===n.name?(p="PVRTC1_4_RGB",u=!0):"pvrtc_2bits_rgb_a"===n.name&&(p="PVRTC1_2_RGB",u=!0),u){let e=o.relative(c,t),r=o.join(s,"pvr_alpha",e);return _(t,r,e=>{if(e)return i(e);t=r,setTimeout(()=>{m()},10)}),void 0}m()}function d(t,e,n,i){let a=Editor.url("unpack://static/tools/texture-compress/mali/OSX_x86/etcpack");"win32"===process.platform&&(a=Editor.url("unpack://static/tools/texture-compress/mali/Windows_64/etcpack.exe"));let l=o.dirname(a);a="."+o.sep+o.basename(a);let u="etc1",p="RGB";"etc1"===n.name?(u="etc1",p="RGBA"):"etc1_rgb"===n.name?u="etc1":"etc2"===n.name?(u="etc2",p="RGBA"):"etc2_rgb"===n.name&&(u="etc2");let m=!1;function f(){let c=[o.normalize(t),o.dirname(e),"-c",u,"-s",n.quality],s=l,m=Object.assign({},process.env);m.PATH=l+":"+m.PATH;let _={cwd:s,env:m};"etc2"===u&&c.push("-f",p),console.log(`etc compress command :  ${a} ${c.join(" ")}`),function(t,e,n,o){let i=r(t,e,n);i.stdout.length>0&&i.stdout.toString().split("\n").forEach(t=>{Editor.log(t)}),i.stderr.length>0&&i.stderr.toString().split("\n").forEach(t=>{Editor.error(t)}),o(i.error)}(a,c,_,i)}if("etc1"===u&&"RGBA"===p&&(m=!0),m){let e=o.relative(c,t),r=o.join(s,"etc_alpha",e);return _(t,r,e=>{if(e)return i(e);t=r,setTimeout(()=>{f()},10)}),void 0}f()}module.exports=function(t,e){let r=t.uuid,c=t.src,s=t.dst,m=t.platform,_=t.actualPlatform,b=t.compressOption,g=!!r,R="wechatgame-subcontext"!==_&&"baidugame-subcontext"!==_;"web-mobile"===_||"web-desktop"===_?_="web":"mac"===_||"win32"===_?_="native":"mini-game"!==m&&"runtime"!==m||(_="minigame");let P=[],h=b[_];function T(){return P.map(u)}if(h&&h.formats.length>0&&R?P=h.formats:b.default&&(P=b.default.formats),n.ensureDirSync(o.dirname(s)),0===P.length)return n.copy(c,s,t=>{t&&Editor.error("Failed to copy native asset file %s to %s",c,s),e(t,T(),[s])}),void 0;i.each(P,(t,e)=>{let n=p;t.name.startsWith("pvrtc_")?n=f:t.name.startsWith("etc")&&(n=d);let o=u(t);o=o.replace(/@.*/,"");let i=l(s,o);if(g&&a.exportTo(r,t,o,i))return e(),void 0;n(c,s,t,n=>{g&&!n&&a.add(r,t,o,i),e(n)})},t=>{let r=T(),n=r.map(t=>l(s,t.replace(/@.*/,"")));e(t,r,n)})};