(()=>{"use strict";0;const e=require("electron").ipcRenderer;var t,r,i,n,o,a;const s="none",l="default",d="merge_all_json";window.onerror=function(e,t,r,i,n){window.onerror=null;var o=n.stack||n;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&(Editor.Ipc.sendToMain("app:build-project-abort",o),Editor.Ipc.sendToMain("metrics:track-exception",o))},window.addEventListener("unhandledrejection",function e(t){window.removeEventListener("unhandledrejection",e),window.onerror(void 0,void 0,void 0,void 0,t.reason)}),e.on("app:init-build-worker",function(e,s,l){t=require("path"),r=require("fire-fs"),require("gulp"),require("event-stream"),i=require("async"),n=require("lodash"),o=require("../../share/build-platforms"),Editor.isBuilder=!0,window.CC_TEST=!1,window.CC_EDITOR=!0,window.CC_PREVIEW=!1,window.CC_DEV=!1,window.CC_DEBUG=!0,window.CC_BUILD=!1,window.CC_JSB=!1,Editor.require("app://editor/share/editor-utils"),Editor.require("unpack://engine-dev"),Editor.require("app://editor/share/engine-extends/init"),Editor.require("app://editor/share/engine-extends/serialize"),Editor.require("app://editor/page/asset-db"),Editor.require("app://editor/share/register-builtin-assets");const d=require(Editor.url("app://editor/page/project-scripts"));a=Editor.remote.importPath.replace(/\\/g,"/");var c=Editor.remote.Builder.actualPlatform2Platform(s),u=!o[c].exportSimpleProject;i.waterfall([function(e){cc.assetManager.init({importBase:a,nativeBase:a}),cc.assetManager.cacheAsset=!1,cc.assetManager.force=!0,cc.assetManager.downloader.maxRetryCount=0,cc.assetManager.downloader.limited=!1,cc.assetManager.downloader.appendTimeStamp=!0;var t=document.createElement("canvas");document.body.appendChild(t),t.id="engine-canvas",cc.game.run({width:800,height:600,id:"engine-canvas",debugMode:cc.debug.DebugMode.INFO},e)},Editor.Utils.asyncif(u,d.load.bind(d))],t=>{e.reply(t||null)})}),e.on("app:build-assets",function(e,{dest:c,root:u,scenes:p},m,f,w){var E,g,h=4,b=Editor.remote.Builder.actualPlatform2Platform(m),q=o[b],v=w.hasOwnProperty("pack")?w.pack:q.pack,k=t.join(c,"import"),y=require("./file-writer"),x=require("./asset-crawler"),C=require("./build-asset"),U=require("./group-manager"),P=require("./group-strategies"),T=require("./texture-packer"),j=require("./building-assetdb"),S=new y(k,f),_=new j(Editor.assetdb),A=new T;if(w.compressionType===l){if(q.isNative){if(w.optimizeHotUpdate)w.inlineSpriteFrames=!1;else{w.inlineSpriteFrames&&Editor.info('Enable "%s" in native platform will increase the package size used in hot update.',Editor.T("BUILDER.merge_asset.inline_SpriteFrames"))}v=v&&(w.optimizeHotUpdate||w.inlineSpriteFrames)}}else w.compressionType===s?v=!1:w.compressionType===d?(w.mergeAllJson=!0,w.inlineSpriteFrames=!1):w.inlineSpriteFrames=!1;v&&(g=w.compressionType===d?new P.MergeAllJson:q.isNative?w.optimizeHotUpdate?new P.ForHotUpdate:new P.GroupStrategyBase:new P.SizeMinimized,console.log("group strategy:",cc.js.getClassName(g)),E=new U(S,f,g,_,n.pick(w,"inlineSpriteFrames","mergeAllJson")));var M,B,F,I=new C(S,a,_,m,w.sharedUuid),R=new x(I,h,A);var z=[e=>{console.time("queryResources"),e(null)},function(e){u?Editor.assetdb.queryAssets(`${u}/**/*`,null,function(t,i){if("db://internal/resources"===u){const e=Editor.url("unpack://engine/modules.json");let t=[];try{let i=r.readJsonSync(e);const n=Editor.Profile.load("project://project.json").get("excluded-modules")||[];n.length>0&&i.forEach(e=>{let r=e["internal/resources"];n.includes(e.name)&&r&&(t=t.concat(r))})}catch(e){Editor.warn(e)}if(console.log("excluded assetsï¼š"+JSON.stringify(t)),t.length>0){const e=require("fire-url");i=i.filter(r=>{let i=e.basenameNoExt(r.url);return!t.includes(i)})}}e(t,i)}):e(null,[])},(e,t)=>{console.timeEnd("queryResources"),console.time("startAssetCrawler"),t(null,e)},function(e,t){var r=e.filter(e=>"folder"!==e.type&&"javascript"!==e.type&&"typescript"!==e.type).map(e=>e.uuid),i=p;M=n.uniq(i.concat(r)),R.start(M,t)},(e,t)=>{console.timeEnd("startAssetCrawler"),t(null,e)},function(e,t){B=e,t(null)}];1,z=[].concat(function(e){Editor.assetdb.queryAssets("db://assets/**/*.pac",null,e)},function(e,t){A.init({root:u,files:e,writer:S,actualPlatform:m}).then(t).catch(t)},z,function(e){console.time("pack textures"),A.pack(B).then(t=>{let{unpackedTextures:r,packedSpriteFrames:i,packedTextures:o}=t,a=r.map(e=>e.textureUuid),s=n.pullAll(A.textureUuids,a);for(let e in i)B[e]={dependUuids:[i[e]]};for(let e in o){let t=o[e];B[e]={nativePath:t[0],nativePaths:t},_.addGeneratedAsset(e,t[0],"texture",!1)}let l=[],d=A.texture2pac;if(s.length>0)for(let e in B){let t=B[e];if("object"!=typeof t)continue;let r=t.dependUuids;if(r)for(let t=0,i=r.length;t<i;t++){let i=r[t];if(-1!==s.indexOf(i)&&-1===l.indexOf(i)){l.push(i);let t=Editor.assetdb.remote.uuidToUrl(i),r=d[i].relativePath,n=Editor.assetdb.remote.uuidToUrl(e);Editor.warn(Editor.T("BUILDER.error.keep_raw_texture_of_atlas",{texturePath:t,pacPath:r,assetPath:n}))}}}if(n.pullAll(M,A.textureUuids),r.length>0||l.length>0){let t=r.map(e=>{let t=Editor.assetdb.remote.uuidToUrl(e.textureUuid);return Editor.warn(`${t} has not been packed into AutoAtlas.`),e.uuid}).concat(l);new x(I,h).start(t,(t,r)=>{if(t)return e(t);Object.assign(B,r),e()}),M=n.uniq(M.concat(t))}else e();console.timeEnd("pack textures")}).catch(t=>e(t))}),v&&z.push(function(e){console.time("init packs"),E.initPacks(M,B,e)},function(e){console.timeEnd("init packs"),console.time("build packs"),E.buildPacks(e)},function(e,t){console.timeEnd("build packs"),F=e.packedAssets,t()}),z.push(function(e){S.flush(e)}),i.waterfall(z,function(t){if(t)(t=t&&t.stack)instanceof Error||(t=new Error(t)),e.reply(t);else{console.log("finished build-worker"),M.forEach(e=>{var t=B[e];"object"!=typeof t?B[e]={isRoot:!0}:t.isRoot=!0});e.reply(null,B,F)}})})})();