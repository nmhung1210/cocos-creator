(()=>{"use strict";const{promisify:e}=require("util");require("electron").ipcRenderer.on("app:compile-worker-start",function(r,t){const i=require("fire-path"),o=(require("async"),require("globby")),n=require("gulp"),s=require("del"),a=require("fire-fs");Editor.isDarwin&&require("graceful-fs").gracefulify(require("fs"));var l=t.cacheDir?null:require("browserify"),u=t.cacheDir?require("persistify"):null;let c=!1;const d=require("vinyl-source-stream"),p=require("vinyl-buffer"),f=require("gulp-sourcemaps"),m=Editor.require("unpack://engine/gulp/util/utils").uglify,b=Editor.require("app://editor/page/refine-sourcemap"),g=a.readFileSync(Editor.url("unpack://static/_prelude.js"),"utf8");window.onerror=function(e,r,t,i,o){window.onerror=null;var s=o.stack||o;if(Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("metrics:track-exception",s),c)return n.emit("error",o),!0;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("editor:renderer-console-error",s)},Editor.require("app://editor/share/editor-utils"),Editor.require("app://editor/page/asset-db");var h="library/imports",y="Compile error:",E="Error: ",v="Cannot find module ";t.dest=t.dest||"library/bundle.js",t.platform=t.platform||"editor",t.debug=!!t.debug,t.sourceMaps="sourceMaps"in t?t.sourceMaps:t.debug;var w={proj:i.resolve(t.project)};t.platform;if(i.contains(Editor.appPath,w.proj)){return r.reply(null,new Error(`${y} Invalid project path: ${t.project}`).stack),void 0}console.log("Compiling "+w.proj);var q={},_={};function j(e){return i.basenameNoExt(e)}n.task("do-clean",async function(){for(let r=0;r<$.length;++r){let t=$[r];var e=i.join(t.scriptDest,"index.js");try{await s(e,{force:!0})}catch(r){throw Editor.error(`Failed to delete ${e}, press [F7] to try again.`),r}}}),n.task("clean",n.parallel("do-clean"),function(e){setTimeout(e,100)});let k={},x=[],$=t.bundles;function C(e,r,o,s,a){var h,E=w.proj,j={debug:t.sourceMaps,basedir:E,builtins:["assert","buffer","console","constants","crypto","domain","events","http","https","os","path","punycode","querystring","stream","_stream_duplex","_stream_passthrough","_stream_readable","_stream_transform","_stream_writable","string_decoder","sys","timers","tty","url","util","vm","zlib","_process"],extensions:[".ts"],ignoreMissing:!0,externalRequireName:"window.__require",prelude:g};e.sort(),function(e,r){if(r._bresolve)r.__bresolve=r._bresolve,r._bresolve=function t(o,n,s){r.__bresolve(o,n,function(r,a,l){if(r){if(n&&n.filename){var u=_[n.filename]||_[n.filename.toLowerCase()];if(u)return n.filename=u,n.basedir=i.dirname(u),t(o,n,s);console.warn(`Failed to resolve script "${o}" in raw directory: `,n)}return s(null,a,l)}var c=q[a];return c||(c=q[a.toLowerCase()])&&console.log(`resolve "${o}" to "${c}" by ignoring case mistake`),s(null,a=!c&&e?"":c||a,l)})};else if(c){let e=new Error("Failed to patch browserify");n.emit("error",e)}}(s,h=t.cacheDir?u(j,{recreate:t.recreateCache,cacheId:t.platform+"_"+!!t.debug+"_"+!!t.sourceMaps,cacheDir:t.cacheDir}):new l(j));for(let r=0;r<e.length;++r){var k=e[r];h.add(k),h.require(k,{expose:i.basenameNoExt(k)})}for(let r=0;r<x.length;++r){let t=x[r];-1===e.indexOf(t)&&h.exclude(q[t.toLowerCase()])}var $=h.bundle().on("error",function(e){c&&(e=new Error(function(e){function r(e,r,t){if(e.startsWith(r)){if(!t)return e.slice(r.length);if(e.endsWith(t))return e.slice(r.length,-t.length)}return""}var t,o=(e.message||e.toString()).trim();if(!o)return e;if(t=r(o,"ENOENT, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(t=r(o,"ENOENT: no such file or directory, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(r(o,v)){let e=v.length+1,r=o.indexOf("'",e);if(-1===r)return o;let t=o.slice(e,r);if(i.basename(t)===t&&i.extname(t))return`${y} Cannot require '${t}', module not found, please remove file extension and retry. ( just "require('${i.basenameNoExt(t)}');"`;o=o.replace(v,"Cannot require ")+". Module not found."}return e.annotated&&(o=o+"\n"+e.annotated),y+" "+o}(e)),n.emit("error",e))}).pipe(d(o));$=$.pipe(p()),t.sourceMaps&&($=$.pipe(f.init({loadMaps:!0})));var C=Editor.require("app://editor/share/build-platforms")[t.platform].isNative,M="runtime"===t.platform;let N={jsb:C&&!M,runtime:M,minigame:"mini-game"===t.platform,debug:t.debug};t.compileFlags&&Object.assign(N,t.compileFlags),$=$.pipe(m("build",N)),t.sourceMaps&&($=$.pipe(b(q,E)).pipe(f.write("./"))),($=$.pipe(n.dest(r))).on("end",a)}n.task("query-bundles",function(r){(async function(r){for(let t=0;t<$.length;++t){let i=$[t];if(i.scripts=[],!i.root)continue;let o=i.root+"/**/*",n=null;try{n=await e(Editor.remote.assetdb.queryAssets.bind(Editor.remote.assetdb))(o,null)}catch(e){return r(e)}n=n.filter(e=>"javascript"===e.type||"typescript"===e.type);for(let e=0;e<n.length;++e){let r=n[e],t=Editor.assetdb.remote.uuidToFspath(r.uuid);i.scripts.push(t)}}r()})(r)}),n.task("get-scripts",function(e){(function(e){var r=i.join(h,"**/*.js"),t=w.proj,n={cwd:t};function s(e){return i.relative(n.cwd,e)}function a(e,r,t){e[r]=t;let i=r.toLowerCase();i in e||(e[i]=t)}let l=$.find(e=>!e.root).scripts;o(r,n,(r,o)=>{if(r)return e(r);for(var n=0;n<o.length;n++){var u=o[n],c=j(u),d=Editor.assetdb.remote.uuidToFspath(c);if(d){var p=i.resolve(t,u);a(_,p,d),a(q,d,p);var f=i.basenameNoExt(d),m=k[f];if(m){var b=s(d),g=s(m),h=new Error(`${y} Filename conflict, the module "${f}" both defined in "${b}" and "${g}"`);return e(h)}k[f]=d,$.find(e=>e.scripts.find(e=>i.contains(e,d)))||l.push(d),x.push(d)}else Editor.warn("Can not get fspath of: "+c+" from assetdb, but script found in library.")}e()})})(e)}),n.task("browserify-bundles",async r=>{for(var t=0;t<$.length;t++){let o=$[t].scripts,n=$[t].scriptDest,s=!!$[t].root,a="index.js";console.log("Output bundle : "+i.join(n,a));try{await e(C)(o,n,a,s)}catch(e){return r(e)}}r()}),n.task("compile",n.series("clean","query-bundles","get-scripts","browserify-bundles")),n.once("error",function(e){e=function(e){return e.error?"boolean"==typeof e.error.showStack?e.error.toString():e.error.stack?e.error:new Error(String(e.error)):new Error(String(e.message))}(e);let t=Editor.Utils.toString(e);if("string"==typeof e.stack){if(!(e=e.stack).startsWith(t)){let r=/^.*/.exec(t)[0];e.startsWith(r)&&(e=(e=e.slice(r.length)).trimLeft()),e=t+"\n"+e}e.startsWith(E+y)&&(e=e.slice(E.length))}else e=t;if(c){c=!1;let t=null;r.reply(t,e)}}),c=!0,n.task("compile")(function(){c=!1;r.reply(null,null),console.log("Compile Worker Finished")})})})();