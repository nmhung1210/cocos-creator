"use strict";var e=cc.Font;const t=!1,i=require("path"),s=require("fire-fs"),r=require("../../share/build-platforms"),a=require("../scene-utils/missing-class-reporter").MissingClass,l=Editor.require("app://editor/page/build/texture-compress");class o{constructor(e,t,i,s,a){this.writer=e,this.library=t,this.assetdb=i,this.sharedUuids=a||{},this.platform=Editor.remote.Builder.actualPlatform2Platform(s);var l=r[this.platform];this.actualPlatform=s,this.isJSB=l.isNative,this.exportSimpleFormat=!l.stripDefaultValues||l.exportSimpleProject,this.shouldExportScript=!l.exportSimpleProject,this.deserializeDetails=new cc.deserialize.Details,this.existsCache={},this._bindedGetAssetRef=this._getAssetRef.bind(this),this.uuid2meta=Editor.remote.assetdb._uuid2meta}build(e,t){if(this.sharedUuids[e])return t(null,{redirect:this.sharedUuids[e]});this.assetdb.queryInfoByUuid(e,(i,s)=>{if(!s)return this.existsCache[e]=!1,t(new Error(o.AssetMissing));this.existsCache[e]=!0;var r=s.type;return r?"folder"===r?(console.warn("Should not build folder"),t()):(this._buildAsset(e,t),void 0):t(new Error("Asset type not specified "+s.url))})}_exportNativeAsset(e,t){let r=e.nativeUrl,a=i.relative(this.library,r),o=i.join(this.writer.dest,"..","native",a);if(e instanceof cc.Texture2D){let s=this.uuid2meta[e._uuid];l({uuid:e._uuid,src:r,dst:o,platform:this.platform,actualPlatform:this.actualPlatform,compressOption:s.platformSettings},(s,r,a)=>{s&&Editor.error(s),r&&r.length>0?e._exportedExts=r:e._exportedExts=[i.extname(o)],t(null,a)})}else{try{s.copySync(r,o)}catch(e){return Editor.error("Failed to copy native asset file %s to %s,",r,o,e),t(null,"")}t(null,[o])}}_getAssetRef(e){var t=this.existsCache[e];return void 0===t&&(t=this.existsCache[e]=!!Editor.assetdb.remote.uuidToFspath(e)),t?Editor.serialize.asAsset(e):null}_buildAsset(r,l){var o=i.join(this.library,r.slice(0,2),r+".json"),d=s.readFileSync(o);t&&console.log("building "+o),this.deserializeDetails.reset();var u=cc.deserialize(d,this.deserializeDetails,{ignoreEditorOnly:!0,classFinder:a.classFinder});u._uuid=r,this.shouldExportScript&&a.reportMissingClass(u),a.reset(),this.deserializeDetails.assignAssetsBy(this._bindedGetAssetRef);var n,h=this.deserializeDetails.uuidList.slice();h.length>0&&(n=this.deserializeDetails.uuidObjList.slice()),u._native&&(this.isJSB||!u.constructor.preventPreloadNativeObject||u instanceof e)?this._exportNativeAsset(u,(e,t)=>{this._doBuildJson(u,h,n,t,l)}):this._doBuildJson(u,h,n,void 0,l)}_doBuildJson(e,t,i,s,r){var a=Editor.serialize(e,{exporting:!0,nicify:!this.exportSimpleFormat,stringify:!1,dontStripDefault:this.exportSimpleFormat});this.writer.writeJsonByUuid(e._uuid,a,e=>e?r(e):r(null,{dependUuids:t,ownersForDependUuids:i,nativePaths:s}))}}o.AssetMissing="asset missing",module.exports=o;