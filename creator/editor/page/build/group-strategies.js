"use strict";var e=require("lodash"),r=require("async");class n{constructor(){this.groupManager=null}init(e){this.groupManager=e}shouldPack(e){return!1}transformGroups(e,r){r(null,e=e.map(e=>({uuids:e,name:"",type:"normal"})))}mergeSmallFiles(e,r){r(null,e)}}module.exports={GroupStrategyBase:n,Balanced:class extends n{shouldPack(e){return"scene"===e.type||!!Editor.assetdb.remote.containsSubAssetsByUuid(e.uuid)}},SizeMinimized:class extends n{shouldPack(e){return!e.isSubAsset}transformGroups(e,r){r(null,e=(e=this.splitGroups(e)).map(e=>({uuids:e,name:"",type:"normal"})))}splitGroups(r,n){if(n=void 0!==n&&n,r.length<2)return r;var t=[r[0]];e:for(var s=1;s<r.length;s++){for(var a=r[s],i=t.length,u=0;u<i;u++){var l=t[u],o=e.intersection(l,a),d=l.length,c=a.length,p=o.length;if(0!==p)if(p===d){if(d===c)continue e;a=e.difference(a,o)}else{if(p===c){d!==c&&(l=e.difference(l,o),t[u]=l,t.push(o));continue e}a=e.difference(a,o),l=e.difference(l,o),t[u]=l,t.push(o)}}t.push(a)}if(n){var m=e.flatten(t),f=e.uniq(m);if(f.length<m.length)return Editor.warn("Internal error: SizeMinimized.transformGroups: res not unique, transform canceled"),r;var h=e.flatten(r);if(e.difference(h,f).length>0)return Editor.warn("Internal error: SizeMinimized.transformGroups: not have the same members, transform canceled"),r}return t}},ForHotUpdate:class extends n{mergeSmallFiles(e,n){this.groupManager.queryAssetInfosInBuild(cc.SpriteFrame,(t,s)=>{var a=new Editor.Utils.MultipleValueDict,i=this.groupManager.writer;r.each(s,(e,r)=>{let n=e.uuid;i.readJsonByUuid(n,(e,t)=>{let s=t&&t.content&&t.content.texture;s&&a.add(s,n),r()})},()=>{a=a.multiple();for(let r in a){let n=a[r];this.groupManager.removeFromGroups(e,n),e.push({name:"",uuids:n})}n(null,e)})})}},MergeAllJson:class extends n{shouldPack(){return!0}transformGroups(r,n){n(null,r=[{name:"",type:"normal",uuids:e.union(...r,this.groupManager.packableGroupRootUuids)}])}}};