"use strict";var e=require("async"),i=require("lodash");const{promisify:t}=require("util");var s=Editor.require("app://editor/share/engine-extends/json-packer"),r=Editor.require("app://editor/share/engine-extends/texture-asset-packer"),l=require("./hash-uuid");const n=8,u=500;var o=!0;function a(i,t,s){return new Promise((r,l)=>{e.eachLimit(i,s,t,e=>{e?l(e):r()})})}module.exports=class{constructor(e,i,t,s,r){this.writer=e,this.strategy=t,this.assetdb=s,this.minify=!i,t.init(this),this.inlineSpriteFrames=!!r.inlineSpriteFrames,this.mergeAllJson=!!r.mergeAllJson,this.packers=[],this.rootUuids=null,this.packableGroupRootUuids=null,this.buildAssets=null}_isPackable(e){var i=e.type;return!!i&&!!Editor.assets[i]}_queryPackableByUuid(e,i){this.assetdb.queryInfoByUuid(e,(e,t)=>e?i(e):t?t.type?(i(null,this._isPackable(t)),void 0):i(new Error("Asset type not specified "+t.url)):i(null,!1))}_queryPackableDepends(e,t){var s=Editor.Utils.getDependsRecursively(this.buildAssets,e,"dependUuids");if(!Array.isArray(s)||0===s.length)return t(null,null);s=s.filter(e=>{var i=this.buildAssets[e];return!i||!i.redirect});var r=i([e]).concat(s).uniq().value();Editor.Utils.filterAsync(r,this._queryPackableByUuid.bind(this),t)}_groupInRoot(e){var i=[];a(this.rootUuids,(e,t)=>{var s=this.buildAssets[e];if(s&&s.redirect)return t();this.assetdb.queryInfoByUuid(e,(s,r)=>s?t(s):r?r.type?this.strategy.shouldPack(r)?(this.packableGroupRootUuids.push(e),this._queryPackableDepends(e,(e,s)=>{if(e)return t(e);s&&s.length>1&&i.push(s),t()}),void 0):t():t(new Error("Asset type not specified "+r.url)):t(new Error("Can not get asset info of "+e)))},u).then(()=>{e(null,i)},t=>{e(t,i)})}removeFromGroups(e,t){for(let s=0;s<e.length;s++){let r=e[s].uuids;i.pullAll(r,t),0===r.length&&(cc.js.array.fastRemoveAt(e,s),--s)}}getAllUuidsInBuild(){return i(this.buildAssets).values().filter(e=>"object"==typeof e&&e.dependUuids&&!e.redirect).map(e=>e.dependUuids).push(this.rootUuids).flatten().uniq().value()}async queryAssetInfosInBuild(e,t){var s=i.findKey(Editor.assets,i=>i===e);if(!s)return Editor.error("can not find asset type for "+cc.js.getClassName(e)),t([]);var r=this.getAllUuidsInBuild(),l=[];await a(r,(e,i)=>{this.assetdb.queryInfoByUuid(e,(e,t)=>{t&&t.type===s&&l.push(t),i()})},u),t(null,l)}_inlineToDependsGroup(e,i){let t=Object.create(null);for(let e in this.buildAssets){let i=this.buildAssets[e];if("object"!=typeof i)continue;let s=i.dependUuids;if(s)for(let i=0;i<s.length;i++){let r=t[s[i]];r?r.push(e):t[s[i]]=[e]}}let s=Object.create(null),r=[];for(let l=0;l<i.length;l++){let n=i[l],u=0,o=t[n];if(o){for(let i=0;i<o.length;i++){let t=o[i],r=s[t];if(!r){r=[];for(let i=0;i<e.length;i++){let s=e[i].uuids;-1!==s.indexOf(t)&&r.push(s)}s[t]=r}if(r.length>0)for(let e=0;e<r.length;e++){let i=r[e];-1===i.indexOf(n)&&(i.push(n),++u)}else{let i=[t,n];e.push({name:"",uuids:i}),r.push(i),++u}}u>0&&r.push(n)}}return r}_inlineSpriteFrames(e,i){console.time("inline single SpriteFrames: queryAssetInfosInBuild"),this.queryAssetInfosInBuild(cc.SpriteFrame,(t,s)=>{console.timeEnd("inline single SpriteFrames: queryAssetInfosInBuild"),console.time("inline single SpriteFrames: 1");var r=s.filter(e=>!this.buildAssets[e.uuid]||!this.buildAssets[e.uuid].redirect).map(e=>e.uuid);if(console.timeEnd("inline single SpriteFrames: 1"),console.time("inline single SpriteFrames: 2"),o)this.removeFromGroups(e,r);else{let i=new Set;for(let t=0;t<e.length;t++){let s=e[t].uuids;if(s.length>1)for(let e=0;e<s.length;e++)i.add(s[e])}r=r.filter(e=>!i.has(e))}console.timeEnd("inline single SpriteFrames: 2"),console.time("inline single SpriteFrames: 3");let l=this._inlineToDependsGroup(e,r);console.timeEnd("inline single SpriteFrames: 3"),console.time("inline single SpriteFrames: 4");for(let i=0;i<l.length;i++){let t=l[i];-1!==this.packableGroupRootUuids.indexOf(t)&&(e.push({name:"",uuids:[t],isPlaceholder:!0}),console.log(`add dummy group to allow download ${t} individually`))}console.timeEnd("inline single SpriteFrames: 4"),i(null,e)})}_packAllTextures(e,i){this.queryAssetInfosInBuild(cc.Texture2D,(t,s)=>{var r=s.filter(e=>!this.buildAssets[e.uuid]||!this.buildAssets[e.uuid].redirect).map(e=>e.uuid);this.removeFromGroups(e,r),e.push({name:"",uuids:r,type:"texture"}),i(null,e)})}_mergeSmallFiles(i,t){var s=[e=>e(null,i)];this.inlineSpriteFrames&&s.push(this._inlineSpriteFrames.bind(this)),this.mergeAllJson||s.push(this._packAllTextures.bind(this)),e.waterfall(s,t)}_computeGroup(i){console.time("init packs: computeGroup"),console.time("computeGroup: _groupInRoot"),e.waterfall([this._groupInRoot.bind(this),(e,i)=>{console.timeEnd("computeGroup: _groupInRoot"),console.time("computeGroup: strategy.transformGroups"),i(null,e)},this.strategy.transformGroups.bind(this.strategy),(e,i)=>{console.timeEnd("computeGroup: strategy.transformGroups"),i(null,e)},this.strategy.mergeSmallFiles.bind(this.strategy),(e,i)=>{console.time("computeGroup: _mergeSmallFiles"),i(null,e)},this._mergeSmallFiles.bind(this),(e,i)=>{console.timeEnd("computeGroup: _mergeSmallFiles"),i(null,e)},(e,i)=>{i(null,e.filter(e=>e.isPlaceholder||e.uuids.length>1))},(e,i)=>{console.timeEnd("init packs: computeGroup"),i(null,e)}],i)}_packAssets(i,t,s){e.each(t,(e,t)=>{this.writer.readJsonByUuid(e,(s,r)=>{if(s)return t(s);i.add(e,r),t()})},s)}initPacks(i,t,l){this.rootUuids=i,this.packableGroupRootUuids=[],this.buildAssets=t,this._computeGroup((i,t)=>{if(i)return l(i);e.eachLimit(t,n,(e,i)=>{var t=e.uuids,l="texture"===e.type?new r:new s;this._packAssets(l,t,t=>{if(t)return i(t);l.name=e.name,this.packers.push(l),i()})},l)})}buildPacks(i){var t=this.packers.map(e=>e.pack(this.minify)),s=t.map(e=>e.indices),r=l.calculate(s,l.BuiltinHashType.PackedAssets);console.time("build packs: write pack");var u={};e.eachLimit(Object.keys(t),n,(e,i)=>{var s=t[e],l=r[e];u[l]=s.indices,this.writer.deleteJsonsByUuid(s.indices,e=>{if(e)return i(e);this.writer.writeJsonByUuidNoCache(l,s.data,i)})},e=>{console.timeEnd("build packs: write pack"),e?i(e):i(null,{packedAssets:u})})}};