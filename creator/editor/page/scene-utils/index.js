"use strict";const e=require("async"),t=require("fire-url"),i=(require("fire-path"),Editor.require("unpack://engine-dev/cocos2d/core/platform/CCClass").getDefault,require("./edit-mode")),r=require("./lib/sandbox"),n=require("./lib/tasks"),o=require("./utils/prefab"),s=require("./utils/node"),a=require("./utils/animation"),c=require("./utils/effect"),d=require("./utils/scene"),l=Editor.require("packages://scene/panel/tools/camera"),u=Editor.Profile.load("global://settings.json");let h={_UndoImpl:require("./undo/scene-undo-impl"),Undo:require("./undo"),EngineEvents:require("./lib/engine-events"),DetectConflict:require("./lib/detect-conflict"),AssetsWatcher:require("./lib/asset-watcher"),StashInPage:require("./lib/stash-scene"),PhysicsUtils:require("./utils/physics"),PrefabUtils:require("./utils/prefab"),AnimUtils:require("./utils/animation"),SceneUtils:require("./utils/scene"),MaterialUtils:require("./utils/material"),_inited:!1,isLoadingScene:!1,gizmos:{},Sandbox:Editor.require("scene://lib/sandbox"),init(e){this.view||(this.view=document.createElement("scene-view"),this.view.id="sceneView",this.view.classList.add("fit"),this.view.tabIndex=-1),this.gizmosView||(this.gizmosView=this.view.$gizmosView),this.Undo.init(),this.Undo.on("changed",()=>{this.updateTitle(this.title())})},reset(){Editor.Selection.clear("node"),this.gizmosView.reset(),a.pauseAnimation(),cc.engine.resetAnimatingInEditMode()},newScene(e){this.reset();let t=d.createDefaultScene();d.loadScene(t),e&&e()},loadSceneByUuid(e,t){this.reset(),d.loadSceneByUuid(e,()=>{t&&t()})},initScene(t){let i=Editor.remote.stashedScene,n=i&&i.sceneJson;n?e.waterfall([r.loadScripts,e=>{_Scene.reset(),cc.assetManager.editorExtend.loadJson(n,e)},(e,t)=>{cc.director.runSceneImmediate(e.scene),t()},_Scene.loadWorkspace.bind(this,i)],t):e.waterfall([r.loadScripts,e=>{let t=Editor.remote.currentSceneUuid;if(t)d.loadSceneByUuid(t,t=>{e(t,null)});else{let t=d.createDefaultScene();d.loadScene(t),e(null,null)}},_Scene.loadWorkspace],t)},getEditingWorkspace(){let e=Editor.Selection.curGlobalActivate();return{cameraSetting:l.setting,designWidth:this.gizmosView.designSize[0],designHeight:this.gizmosView.designSize[1],sceneSelection:Editor.Selection.curSelection("node"),activeType:e?e.type:null}},loadWorkspace(e,t){if(e){if(Editor.Selection.select("node",e.sceneSelection,!0,!0),e.activeType&&"node"!==e.activeType){let t=Editor.Selection.curSelection(e.activeType);Editor.Selection.select(e.activeType,t)}l.setting=e.cameraSetting}t&&t()},stashScene(e){let t,r=i.curMode();if(r&&r.getPreviewScene)t=r.getPreviewScene();else{var n=cc.director.getScene();let e=new cc.SceneAsset;e.scene=n,e.name=n.name,t=Editor.serialize(e,{stringify:!0})}var o=this.getEditingWorkspace();o.sceneJson=t,Editor.remote.stashedScene=o,e&&e(null,t)},_applyCanvasPreferences(e,t){if(!(e=e||cc.Canvas.instance))return;let i=Editor.Profile.load("project://project.json"),r=i.get("design-resolution-width"),n=i.get("design-resolution-height");e.designResolution=cc.size(r,n),e.fitWidth=i.get("fit-width"),e.fitHeight=i.get("fit-height"),t&&t()},currentScene:()=>cc.director.getScene(),title:()=>i.title(),updateTitle(e){Editor.Ipc.sendToMain("scene:update-title",this.Undo.dirty(),e)},adjustNumber(e,t){return t=t||Editor.Math.numOfDecimalsF(1/this.view.scale),Editor.Math.toPrecision(e,t)},adjustVec2(e,t){return t=t||Editor.Math.numOfDecimalsF(1/this.view.scale),e.x=Editor.Math.toPrecision(e.x,t),e.y=Editor.Math.toPrecision(e.y,t),e},adjustSize(e,t){return t=t||Editor.Math.numOfDecimalsF(1/this.view.scale),e.width=Editor.Math.toPrecision(e.width,t),e.height=Editor.Math.toPrecision(e.height,t),e},adjustNodePosition(e,t){void 0===t&&(t=Editor.Math.numOfDecimalsF(1/this.view.scale)),e.setPosition(Editor.Math.toPrecision(e.position.x,t),Editor.Math.toPrecision(e.position.y,t),Editor.Math.toPrecision(e.position.z,t))},adjustNodeScale(e,t){void 0===t&&(t=Editor.Math.numOfDecimalsF(1/this.view.scale)),e.setScale(Editor.Math.toPrecision(e.scaleX,t),Editor.Math.toPrecision(e.scaleY,t),Editor.Math.toPrecision(e.scaleX,t))},adjustNodeRotation(e,t){void 0===t&&(t=Editor.Math.numOfDecimalsF(1/this.view.scale)),e.rotation=Editor.Math.toPrecision(e.rotation,t)},adjustNodeSize(e,t){void 0===t&&(t=Editor.Math.numOfDecimalsF(1/this.view.scale)),e.setContentSize(Editor.Math.toPrecision(e.width,t),Editor.Math.toPrecision(e.height,t))},adjustNodeAnchor(e,t){void 0===t&&(t=Editor.Math.numOfDecimalsF(1/this.view.scale)),e.setAnchorPoint(Editor.Math.toPrecision(e.anchorX,t),Editor.Math.toPrecision(e.anchorY,t))},walk(e,t,i){if(e){if(!i)return Editor.warn("walk need a callback"),void 0;if(t){if(i(e))return}(function e(t,i){let r=t._children;for(let t=0;t<r.length;t++){let n=r[t];i(n)||e(n,i)}})(e,i)}},createPrefab(e,i){let r=cc.engine.getInstanceById(e),n=o.createPrefabFrom(r),s=t.join(i,r.name+".prefab"),a=Editor.serialize(n);Editor.Ipc.sendToMain("scene:create-prefab",s,a,(e,t)=>{if(e)return Editor.error(e),o.unlinkPrefab(r),void 0;n._uuid=t,u.get("auto-sync-prefab")&&o._setPrefabSync(r,!0)})},applyPrefab(e){let t=cc.engine.getInstanceById(e);if(!t||!t._prefab)return;let r=t._prefab.asset._uuid;if(!!!Editor.assetdb.remote.uuidToFspath(r))return Editor.error(`Failed to apply "${t._prefab.root.name}" because the prefab asset is missing, please save the prefab to a new asset by dragging and drop the node from Node Tree into Assets.`);let n=o.createAppliedPrefab(t),s=Editor.serialize(n);Editor.Ipc.sendToMain("scene:apply-prefab",r,s),"prefab"===i.curMode().name&&_Scene.Undo.save(),_Scene.Undo.syncedPrefabSave()},revertPrefab(e){let t=cc.engine.getInstanceById(e);t&&t._prefab&&(t=t._prefab.root,o.revertPrefab(t,()=>{_Scene.Undo.syncedPrefabSave(),a.onRevertPrefab(e)}))},setPrefabSync(e){let t=cc.engine.getInstanceById(e);t&&t._prefab&&(t=t._prefab.root,o.setPrefabSync(t,!t._prefab.sync))},setGroupSync(e,t){let i=cc.engine.getInstanceById(e);if(i&&i.children.length>0){0===Editor.Dialog.messageBox({type:"info",buttons:[Editor.T("MESSAGE.confirm"),Editor.T("MESSAGE.cancel")],title:"",message:Editor.T("MESSAGE.node.sync_group_message"),detail:Editor.T("MESSAGE.node.sync_group_detail",{group:t}),defaultId:0,cancelId:1,noLink:!0})&&this.walk(i,!1,e=>{e.group=t})}},breakPrefabInstance(e){if(e.length>0){let t=!1;for(let i of e){let e=cc.engine.getInstanceById(i);e&&e._prefab&&(this.Undo.recordNode(i),t=!0,e=e._prefab.root,o.unlinkPrefab(e),Editor.Utils.refreshSelectedInspector("node",i))}t&&this.Undo.commit()}else Editor.Dialog.messageBox({type:"info",buttons:[Editor.T("MESSAGE.ok")],message:Editor.T("MESSAGE.prefab.select_prefab_first"),noLink:!0})},linkPrefab(){let e={type:"info",buttons:[Editor.T("MESSAGE.sure")],message:Editor.T("MESSAGE.prefab.select_asset_first")},t={type:"info",buttons:[Editor.T("MESSAGE.sure")],message:Editor.T("MESSAGE.prefab.select_node_first")},i=Editor.Selection.curActivate("node"),r=i&&cc.engine.getInstanceById(i);if(!r)return Editor.Dialog.messageBox(t);let n=Editor.Selection.curActivate("asset");n?Editor.assetdb.queryInfoByUuid(n,(t,i)=>{!t&&i&&("prefab"===i.type?cc.assetManager.loadAny(n,(e,t)=>{t&&(r._prefab&&o.unlinkPrefab(r._prefab.root),o.linkPrefab(t,r),r.name.endsWith(o.MISSING_PREFAB_SUFFIX)&&o.setPrefabSync(r,!0,!0)&&(r.name=r.name.slice(0,-o.MISSING_PREFAB_SUFFIX.length)))}):Editor.Dialog.messageBox(e))}):Editor.Dialog.messageBox(e)},dumpNode(e){let t=cc.engine.getInstanceById(e);return Editor.getNodeDump(t)},select(e){this.gizmosView.select(e)},unselect(e){this.gizmosView.unselect(e)},hoverin(e){this.gizmosView.hoverin(e)},hoverout(e){this.gizmosView.hoverout(e)},activate(e){let t=cc.engine.getInstanceById(e);if(t){a.activate(t);for(let e=0;e<t._components.length;++e){let i=t._components[e];if(cc.isValid(i)&&i.constructor._executeInEditMode){if(i.onFocusInEditor)try{i.onFocusInEditor()}catch(e){cc._throw(e)}i.constructor._playOnFocus&&i.enabledInHierarchy&&cc.engine.setAnimatingInEditMode(!0,"component_playOnFocus")}}}},deactivate(e){let t=cc.engine.getInstanceById(e);if(t&&t.isValid){if(!(n.runningTask&&n.runningTask.run===this._softReload)&&t._prefab&&t._prefab.root&&t._prefab.root._prefab.sync){"prefab"===i.curMode().name||o.confirmPrefabSyncedLater(t._prefab.root)}a.deactivate(t);for(let e=0;e<t._components.length;++e){let i=t._components[e];if(cc.isValid(i)&&i.constructor._executeInEditMode){if(i.onLostFocusInEditor)try{i.onLostFocusInEditor()}catch(e){cc._throw(e)}i.constructor._playOnFocus&&i.enabledInHierarchy&&cc.engine.setAnimatingInEditMode(!1,"component_playOnFocus")}}}},_syncPrefab(e,t){let i=Editor.Selection.curActivate("node"),r=i&&cc.engine.getInstanceById(i);if(r&&r._prefab&&r._prefab.asset._uuid===e.uuid&&r._prefab.root&&r._prefab.root._prefab.sync){if(o.confirmPrefabSynced(r._prefab.root))return t()}o.syncPrefab(e.uuid),t()},syncPrefab(e){n.push({name:"sync-prefab",target:this,run:this._syncPrefab,params:[e]})},assetChanged(e){if(a.assetChanged(e),c.assetChanged(e),"prefab"===e.type){let t=i.curMode();"prefab"===t.name?t.prefabAssetChanged(e):this.syncPrefab(e)}},assetsMoved(e){a.assetsMoved(e),c.assetsMoved(e)},assetsCreated(e){c.assetsCreated(e)},assetsDeleted(e){c.assetsDeleted(e)},setTransformTool(e){this.gizmosView&&(this.gizmosView.transformTool=e),cc.engine.isInitialized&&cc.engine.repaintInEditMode()},setPivot(e){this.gizmosView&&(this.gizmosView.pivot=e),cc.engine.isInitialized&&cc.engine.repaintInEditMode()},setCoordinate(e){this.gizmosView&&(this.gizmosView.coordinate=e),cc.engine.isInitialized&&cc.engine.repaintInEditMode()},setGizmoDimension(e){this.gizmosView&&(this.gizmosView.is2D=e),cc.engine.isInitialized&&cc.engine.repaintInEditMode()},isGizmoToolLocked(){return this.gizmosView.lockGizmoTool},lockGizmoTool(e){this.gizmosView&&(this.gizmosView.lockGizmoTool=e)},alignSelection(e){let t=Editor.Selection.curSelection("node");if(t.length<=1)return;let i=1e10,r=1e10,n=-1e10,o=-1e10,a=(t=(t=t.map(e=>cc.engine.getInstanceById(e))).filter(e=>{let i=e.parent;for(;i;){if(-1!==t.indexOf(i))return!1;i=i.parent}return!0})).map(e=>{let t=s.getWorldBounds(e);return i=Math.min(i,t.x),r=Math.min(r,t.y),n=Math.max(n,t.xMax),o=Math.max(o,t.yMax),{node:e,bounds:t}}),c=cc.rect(i,r,n-i,o-r);a.forEach(t=>{let i,r=t.node;switch(this.Undo.recordNode(r.uuid),e){case"top":i=cc.v2(0,c.yMax-t.bounds.yMax);break;case"v-center":i=cc.v2(0,c.center.y-t.bounds.center.y);break;case"bottom":i=cc.v2(0,c.y-t.bounds.y);break;case"left":i=cc.v2(c.x-t.bounds.x,0);break;case"h-center":i=cc.v2(c.center.x-t.bounds.center.x,0);break;case"right":i=cc.v2(c.xMax-t.bounds.xMax,0);break;default:i=cc.v2()}let n=s.getWorldPosition(r);s.setWorldPosition(r,n.add(i));var o=Editor.Math.numOfDecimalsF(1/this.view.scale);this.adjustNodePosition(r,o),cc.engine.repaintInEditMode()}),this.Undo.commit()},distributeSelection:function(e){let t=Editor.Selection.curSelection("node");if(t.length<=2)return;let i=(t=(t=t.map(e=>cc.engine.getInstanceById(e))).filter(e=>{let i=e.parent;for(;i;){if(-1!==t.indexOf(i))return!1;i=i.parent}return!0})).map(e=>{return{node:e,bounds:s.getWorldBounds(e)}});i.sort((t,i)=>{let r=!0;switch(e){case"top":r=t.bounds.yMax-i.bounds.yMax;break;case"v-center":r=t.bounds.center.y-i.bounds.center.y;break;case"bottom":r=t.bounds.y-i.bounds.y;break;case"left":r=t.bounds.x-i.bounds.x;break;case"h-center":r=t.bounds.center.x-i.bounds.center.x;break;case"right":r=t.bounds.center.xMax-i.bounds.center.xMax}return r});let r=i.length-1,n=i[0].bounds,o=i[r].bounds;i.forEach((t,i)=>{let a,c=t.node,d=t.bounds;switch(this.Undo.recordNode(c.uuid),e){case"top":a=cc.v2(0,n.yMax+(o.yMax-n.yMax)*i/r-d.yMax);break;case"v-center":a=cc.v2(0,n.center.y+(o.center.y-n.center.y)*i/r-d.center.y);break;case"bottom":a=cc.v2(0,n.y+(o.y-n.y)*i/r-d.y);break;case"left":a=cc.v2(n.x+(o.x-n.x)*i/r-d.x,0);break;case"h-center":a=cc.v2(n.center.x+(o.center.x-n.center.x)*i/r-d.center.x,0);break;case"right":a=cc.v2(n.xMax+(o.xMax-n.xMax)*i/r-d.xMax,0);break;default:a=cc.v2()}let l=s.getWorldPosition(c);s.setWorldPosition(c,l.add(a));var u=Editor.Math.numOfDecimalsF(1/this.view.scale);this.adjustNodePosition(c,u),cc.engine.repaintInEditMode()}),this.Undo.commit()},projectProfileUpdated:function(e){cc.game.collisionMatrix=e.get("collision-matrix"),cc.game.groupList=e.get("group-list")}};window._Scene=h,require("./engine-extends"),Object.assign(Editor,require("./debug-helper")),require("./reset-node");const f=require("./editor-engine");cc.engine=new f(!1),Editor.getNodeDump=require("./dump/get-node-dump"),Editor.getNodeFunctions=require("./dump/get-node-functions");let g=require("./set-property-by-path");Editor.setAsset=g.setAsset,Editor.getPropertyByPath=g.getPropertyByPath,Editor.setPropertyByPath=g.setPropertyByPath,Editor.resetPropertyByPath=g.resetPropertyByPath,Editor.setDeepPropertyByPath=g.setDeepPropertyByPath,Editor.fillDefaultValue=g.fillDefaultValue,Editor.setNodePropertyByPath=g.setNodePropertyByPath,Editor.preprocessForSetProperty=g.preprocessForSetProperty;