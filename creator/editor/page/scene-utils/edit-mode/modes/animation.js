"use strict";require("../../lib/tasks");const e=require("../../utils/animation"),n=require("../../lib/sandbox"),t=require("./scene");let o=e.STATE,i=e.Cache,c=!1;module.exports={name:"animation",title:"",open:function(e){if(o.RECORD)return e&&e();o.RECORD=!0;let t=cc.engine.getInstanceById(i.aNode);for(;t&&!t.getComponent(cc.Animation);){if(t.parent instanceof cc.Scene){t=node;break}t=t.parent}i.rNode=t.uuid,Editor.Ipc.sendToAll("scene:animation-record-changed",!0,t.uuid),t&&(i.component=t.getComponent(cc.Animation).uuid),cc.engine.editingRootNode=t.uuid;let c=Object.create(null);_Scene.walk(t,!0,e=>{let n=c[e.uuid]=_Scene._UndoImpl.recordNode(e),t=e.getComponent(cc.Animation);t&&delete n.comps[t.uuid]}),i.recordDumps=n.registerReloadableData(c),i.undoDump=n.registerReloadableData(_Scene.Undo.dump()),_Scene.Undo.clear(),e&&e()},softReload:function(e,n){return c=!0,!1},save:e.save,beforePushOther:function(e){require("../index").popAll()},confirmClose:function(n){return n=void 0===n?2:n,e.confirm(n)},close:function(r,a){if(!o.RECORD)return a&&a();if(o.RECORD=!1,1===r)return a&&a();let d={save(){e.save(()=>{d.exit()})},doNotSave(){e.restoreClip(()=>{d.exit()})},exit(){let o=cc.engine.getInstanceById(i.component).getAnimationState(i.animation);o&&(o.setTime(0),e.pauseAnimation()),cc.engine.setAnimatingInEditMode(!1,"timeline"),e.hideTrajectoryGizmo(),Editor.Ipc.sendToAll("scene:animation-record-changed",!1);let r=n.popReloadableData(i.recordDumps);for(let e in r){let n=cc.engine.getInstanceById(e),t=r[e],o=n._children.slice();_Scene._UndoImpl.restoreNode(n,t),n._children=o}return cc.engine.editingRootNode="",_Scene.Undo.restore(n.popReloadableData(i.undoDump)),i.undoDump=null,i.recordDumps=null,i.animation=null,i.component=null,c&&(t.softReload(),c=!1),a&&a()}};0===r?d.save():d.doNotSave()},dirty:function(){return o.DIRTY}};