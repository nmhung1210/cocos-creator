"use strict";const e=require("./node");CC_EDITOR&&Editor.require("unpack://engine-dev/cocos2d/core/utils/prefab-helper");var r=require("../../../share/engine-extends/object-walker"),n=["parent","rotation","rotationX","rotationY","angle"],t=n.concat("name","active","position","x","y","zIndex"),a=["node","_objFlags"],o=["quat"],i=[];(function(){for(var e=cc.Node,r=e.__props__,a=0;a<r.length;a++){var c=r[a],f=cc.Class.attr(e,c);!1===f.serializable&&!f.hasGetter&&!f.hasSetter||f.readonly||"_"===c[0]||f.hasGetter!==f.hasSetter||(cc.js.array.contains(n,c)||o.push(c),cc.js.array.contains(t,c)||i.push(c))}})();var c={};function f(e,r){if(!r(e))for(var n=e._children,t=n.length-1;t>=0;--t)f(n[t],r)}function s(e,r,n,t){var a=e._prefab=new cc._PrefabInfo;a.asset=r,a.root=n,a.fileId=t||e.uuid}function d(e,r,n){for(var t,a,c,f=n?i:o,s=0;s<f.length;s++){var d=f[s];r[d]=e[d]}for(t=0;t<r._components.length;++t)a=r._components[t],(c=e.getComponent(a.constructor))&&a.constructor===c.constructor||a.destroy();cc.Object._deferredDestroy();var p=[];for(t=0;t<e._components.length;++t)c=e._components[t],(a=r.getComponent(c.constructor))&&a.constructor===c.constructor||(a=r.addComponent(c.constructor)),p.push(a),a instanceof cc.RenderComponent?u(c,a):l(c,a);e._components.length=0,e._components.push.apply(e._components,p)}function l(e,r){for(var n=r.constructor.__values__,t=0;t<n.length;t++){var o=n[t];if(!cc.js.array.contains(a,o)){var i=e[o];r[o]=i}}}function u(e,r){let n=r.constructor,t=n.__props__;for(let o in t){let i=t[o],c=cc.Class.attr(n,i);!1===c.serializable&&!c.hasGetter&&!c.hasSetter||c.readonly||"_"===i[0]||c.hasGetter!==c.hasSetter||(cc.js.array.contains(a,i)||(r[i]=e[i]))}}function p(e,r){if(e._prefab&&e._prefab.fileId===r)return e;for(var n=e._children,t=0,a=n.length;t<a;t++)if(e=p(n[t],r))return e;return null}function _(r,n,t,a,o){var i=t.node,c=i&&i._prefab&&i._prefab.root,f=r&&r._prefab&&r._prefab.root;if(c!==f){var s;if(c&&c._prefab.sync)s="MESSAGE.prefab.synced_disallow_ref_to_external";else if(f&&f._prefab.sync)r!==f?s="MESSAGE.prefab.disallow_ref_to_chlid_of_synced":n&&(s="MESSAGE.prefab.disallow_ref_to_comp_of_synced");if(s)return function(r,n,t,a,o){var i=Editor.T(r),c=Editor.T("MESSAGE.prefab.invalid_ref_detail",{component:cc.js.getClassName(t),property:a,node:e.getNodePath(n)});o?Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.sure")],message:i,detail:c,noLink:!0}):Editor.error(Editor.T("MESSAGE.prefab.message_and_detail",{message:i,detail:c}))}(s,i,t,a,o),!1}return!0}c.getDumpableNode=function(e,r){return f(e=cc.instantiate(e),function(n){(function(e,r){function n(e,n){for(var t=(n=n||e.constructor).__values__,a=0;a<t.length;a++){var o=t[a],i=e[o];if(i&&"object"==typeof i)if(Array.isArray(i))for(var c=0;c<i.length;c++)cc.isValid(i)&&r(i,""+c,i[c]);else cc.isValid(i)&&r(e,o,i)}}for(var t=0;t<e._components.length;++t)n(e._components[t])})(n,function(n,t,a){var o,i=!1;a instanceof cc.Component.EventHandler&&(a=a.target),a instanceof cc.Component&&(a=a.node),a instanceof cc._BaseNode&&(a.isChildOf(e)||(i=!0,o=a.name)),i&&(n[t]=null,CC_TEST||r||Editor.error('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.',t,n.name||e.name,o))}),n._id="";for(var t=0;t<n._components.length;++t){n._components[t]._id=""}}),e._prefab.sync=!1,e},c.createPrefabFrom=function(e,r){var n=new cc.Prefab;f(e,function(t){let a=void 0;r&&(a=r(t)),s(t,n,e,a)});var t=c.getDumpableNode(e);return n.data=t,n},c.createAppliedPrefab=function(e){var r=c.getDumpableNode(e._prefab.root),n=new cc.Prefab;return n.data=r,n},c.linkPrefab=function(e,r,n){if(!e._uuid)return cc.error('Can not get uuid from asset "%s"',e.name),void 0;f(n||r,function(n){var t=n._prefab;t?(t.asset=e,t.root=r):s(n,e,r)}),n&&r!==n&&(n._prefab.sync=!1),e.data&&(r._prefab.fileId=e.data._prefab.fileId)},c.initClonedChildOfPrefab=function(e){f(e,function(e){e._prefab.fileId=e.uuid})},c.unlinkPrefab=function(e){f(e,function(e){e._prefab=null})},c._doRevertPrefab=function(e,n){let t=cc.instantiate(n.data);(function(e,n){r.walkProperties(n,function(r,n,t,a){var o=t&&"object"==typeof t&&(cc.Node.isNode(t)||t instanceof cc.Component);if(o){if(r instanceof cc.Component){if("node"===n)return}else{if(r instanceof cc._BaseNode||r instanceof cc._PrefabInfo||r instanceof cc.Asset)return;for(var i=null,c=a.length-1;c>=0;c--){var f=a[c];if(f instanceof cc.Component||cc.Node.isNode(f)||f instanceof cc.Asset||f instanceof cc._PrefabInfo){i=f;break}}if(!(i instanceof cc.Component)){if(i)return;Editor.error("Unknown parsing object")}}(function(e,r,n,t){var a;a=n instanceof cc.Component?n.node:n;if(!a._prefab)return cc.error("Node in prefab should have PrefabInfo");var o=a._prefab.fileId,i=p(t,o);i&&n instanceof cc.Component&&(i=i.getComponent(n.constructor));e[r]=i})(r,n,t,e)}},{ignoreParent:!0})})(e,t);var a=Object.create(null),o=Object.create(null);if(e._prefab.fileId!==t._prefab.fileId)return Editor.error("Can not revert prefab because the scene node's uuid mismatched with the prefab's track id, your should instantiate a new node from prefab.");function i(e,r){throw new Error(`Can not revert prefab, the file id of ${e} is duplicated with ${r}, please recreate the prefab again by click [${Editor.T("MAIN_MENU.node.title")} - ${Editor.T("MAIN_MENU.node.break_prefab_instance")}] and [${Editor.T("MAIN_MENU.node.title")} - ${Editor.T("MAIN_MENU.node.link_prefab")}] in the menu.`)}f(t,function(r){var t=r._prefab.fileId;if(!t)throw new Error('Can not revert prefab, the file id of "'+r.name+'" is missing, please save the prefab to a new asset by dragging and drop the node from Node Tree into Assets.');t in o&&i(`"${r.name}" in prefab asset`,`"${o[t].name}"`),o[t]=r;var c=p(e,t);if(c||(d(r,c=new cc.Node,!1),s(c,n,e,t)),t in a&&i(`"${c.name}" in scene`,`"${a[t].name}"`),a[t]=c,r._parent){var f=r._parent._prefab.fileId,l=a[f];console.assert(l,"parent should exist since we create them from ascendent to descendant"),c.parent=l}}),f(e,function(r){if(r._prefab){var n=r._prefab.fileId,t=o[n];if(t)return d(t,r,r===e),void 0}return r.destroy(),!0}),cc.Object._deferredDestroy(),f(t,function(e){var r=e._children;if(r)for(var n=0;n<r.length;n++){var t=r[n]._prefab.fileId;a[t].setSiblingIndex(n)}})},c.revertPrefab=async function(e,r){if(CC_EDITOR&&cc.engine.isPlaying)return cc.warn("Disallow to revert prefab when the engine is playing.");if(e._prefab){var n=e._prefab.asset._uuid;try{const{promisify:t}=require("util"),a=require("./animation");let o=await t(cc.assetManager.loadAny.bind(cc.assetManager))(n);a.verifyPrefab(e,o)&&(c._doRevertPrefab(e,o),r&&r())}catch(e){Editor.error(e)}}},c._setPrefabSync=function(e,r){e._prefab.sync=r,e._prefab._synced=r},c.setPrefabSync=function(r,n,t){if(r._prefab.sync!==n&&n&&!CC_TEST){var a,o={node:e.getNodePath(r),asset:Editor.assetdb.remote.uuidToUrl(r._prefab.asset._uuid)};if(t){if(0===(a=Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.cancel"),Editor.T("MESSAGE.revert")],message:Editor.T("MESSAGE.prefab.revert_missing_prefab"),detail:Editor.T("MESSAGE.prefab.revert_missing_prefab_detail",o),defaultId:1,cancelId:0,noLink:!0})))return!1;_Scene.revertPrefab(r.uuid)}else{let e=r._prefab.asset.readonly,n=[Editor.T("MESSAGE.apply"),Editor.T("MESSAGE.cancel"),Editor.T("INSPECTOR.node.prefab_btn_revert")];if(e&&(n=[Editor.T("INSPECTOR.node.prefab_btn_revert"),Editor.T("MESSAGE.cancel")]),1===(a=Editor.Dialog.messageBox({type:"question",buttons:n,message:Editor.T("MESSAGE.prefab.apply_new_synced_prefab_message"),detail:Editor.T("MESSAGE.prefab.apply_synced_prefab_detail",o),defaultId:0,cancelId:1,noLink:!0})))return!1;e||0!==a?_Scene.revertPrefab(r.uuid):_Scene.applyPrefab(r.uuid)}}return this._setPrefabSync(r,n),!0},c.syncPrefab=function(e){f(cc.director.getScene(),function(r){if(!r)return!0;var n=r._prefab,t=!1;return n&&(n.sync&&n.asset&&n.asset._uuid===e&&c.revertPrefab(r),t=!0),t})},c.validateSceneReference=function(e,r,n){var t,a;if(e instanceof cc.Component)a=e,t=e.node;else{if(!cc.Node.isNode(e))return!0;t=e}return _(t,a,r,n,!0)},c.validateAllSceneReferences=function(e){r.walkProperties(e,function(e,n,t,a){var o,i;if(t instanceof cc.Component?(i=t,o=t.node):cc.Node.isNode(t)&&(o=t),o){var c;if(e instanceof cc.Component)c=e;else{if(e instanceof cc.Node)return;c=null;for(var f=a.length-1;f>=0;f--){var s=a[f];if(s instanceof cc.Component){c=s;break}if(s instanceof cc.Node)break}if(!c)return}_(o,i,c,c===e?n:r.getNextProperty(a,e,c),!1)}})},c.confirmPrefabSynced=function(r){if(r&&_Scene.Undo.syncedPrefabDirty(r)){if(0===Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.apply"),Editor.T("INSPECTOR.node.prefab_btn_revert")],message:Editor.T("MESSAGE.prefab.apply_synced_prefab_message"),detail:Editor.T("MESSAGE.prefab.apply_synced_prefab_detail",{node:e.getNodePath(r),asset:Editor.assetdb.remote.uuidToUrl(r._prefab.asset._uuid)}),defaultId:0,cancelId:1,noLink:!0}))return _Scene.applyPrefab(r.uuid),!0;_Scene.revertPrefab(r.uuid)}return!1},c.confirmEditingPrefabSynced=function(){var e=Editor.Selection.curActivate("node"),r=e&&cc.engine.getInstanceById(e);r&&r._prefab&&r._prefab.root._prefab.sync&&c.confirmPrefabSynced(r._prefab.root)};var b=-1,E=null;c.confirmPrefabSyncedLater=function(e){if(E){b&&(clearTimeout(b),b=-1);var r=E;E=null;var n=Editor.Selection.curActivate("node"),t=n&&cc.engine.getInstanceById(n);if(t)if((t._prefab&&t._prefab.root)===r)return;this.confirmPrefabSynced(r)}else if(!e)return console.error("Root is invalid");e&&(E=e,b=setTimeout(function(){c.confirmPrefabSyncedLater()},100))},c.NodeRevertableProps_Root=i,c.MISSING_PREFAB_SUFFIX=" (Missing Prefab)",module.exports=c;