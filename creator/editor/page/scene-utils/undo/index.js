"use strict";let e=require("./scene-undo-impl"),t=require("./scene-undo-diff");const o=require("../utils/prefab"),n=require("../utils/node"),i=require("../utils/animation");class r extends Editor.Undo.Command{static get type(){return"record-objects"}undo(){let t=[];for(let o=this.info.before.length-1;o>=0;--o){let n=this.info.before[o],i=cc.engine.getInstanceById(n.id);try{e.restoreObject(i,n.data);let o=null;cc.Node.isNode(i)?o=i:i instanceof cc.Component&&(o=i.node),o&&-1===t.indexOf(o.uuid)&&t.push(o.uuid),Editor.Selection.select("node",t)}catch(e){Editor.error(`Failed to restore object ${i._name}: ${e}`)}}}redo(){let t=[];for(let o=0;o<this.info.after.length;++o){let n=this.info.after[o],i=cc.engine.getInstanceById(n.id);try{e.restoreObject(i,n.data);let o=null;cc.Node.isNode(i)?o=i:i instanceof cc.Component&&(o=i.node),o&&-1===t.indexOf(o.uuid)&&t.push(o.uuid),Editor.Selection.select("node",t)}catch(e){Editor.error(`Failed to restore object ${i._name}: ${e}`)}}}}class d extends Editor.Undo.Command{static get type(){return"record-nodes"}undo(){let t=[];for(let o=this.info.before.length-1;o>=0;--o){let n=this.info.before[o],i=cc.engine.getInstanceById(n.id);try{e.restoreNode(i,n.data),i&&-1===t.indexOf(i.uuid)&&t.push(i.uuid),Editor.Selection.select("node",t)}catch(e){Editor.error(`Failed to restore object ${i._name}: ${e}`)}}i.recordNodeChanged(t)}redo(){let t=[];for(let o=0;o<this.info.after.length;++o){let n=this.info.after[o],i=cc.engine.getInstanceById(n.id);try{e.restoreNode(i,n.data),i&&-1===t.indexOf(i.uuid)&&t.push(i.uuid),Editor.Selection.select("node",t)}catch(e){Editor.error(`Failed to restore object ${i._name}: ${e}`)}}i.recordNodeChanged(t)}}class s extends Editor.Undo.Command{static get type(){return"create-nodes"}undo(){let t=[];for(let o=this.info.list.length-1;o>=0;--o){let i=this.info.list[o];n._destroyForUndo(i.node,()=>{i.data=e.recordDeleteNode(i.node)}),t.push(i.node.uuid)}Editor.Selection.unselect("node",t)}redo(){let t=[];for(let o=0;o<this.info.list.length;++o){let n=this.info.list[o];try{e.restoreDeleteNode(n.node,n.data),t.push(n.node.uuid)}catch(e){Editor.error(`Failed to restore delete node ${n.node._name}: ${e}`)}}Editor.Selection.select("node",t)}}class c extends Editor.Undo.Command{static get type(){return"delete-nodes"}undo(){let t=[];for(let o=this.info.list.length-1;o>=0;--o){let n=this.info.list[o];try{e.restoreDeleteNode(n.node,n.data),t.push(n.node.uuid)}catch(e){Editor.error(`Failed to restore delete node ${n.node._name}: ${e}`)}}for(let e=0;e<this.info.list.length;++e){let t=this.info.list[e];t.node.setSiblingIndex(t.data.siblingIndex)}Editor.Selection.select("node",t)}redo(){let t=[];for(let o=0;o<this.info.list.length;++o){let i=this.info.list[o];n._destroyForUndo(i.node,()=>{i.data=e.recordDeleteNode(i.node)}),t.push(i.node.uuid)}Editor.Selection.unselect("node",t)}}class a extends Editor.Undo.Command{static get type(){return"move-nodes"}static moveNode(e,t,o){if(e.parent!==t){let o=e.getWorldPosition(cc.v3()),n=e.getWorldRotation(cc.quat()),i=e.getWorldScale(cc.v3());e.parent=t,e.setWorldPosition(o),e.setWorldRotation(n),e.setWorldScale(i)}e.setSiblingIndex(o)}undo(){let e=[];for(let t=this.info.before.length-1;t>=0;--t){let o=this.info.before[t];a.moveNode(o.node,o.parent,o.siblingIndex),e.push(o.node.uuid)}Editor.Selection.select("node",e)}redo(){let e=[];for(let t=0;t<this.info.after.length;++t){let o=this.info.after[t];a.moveNode(o.node,o.parent,o.siblingIndex),e.push(o.node.uuid)}Editor.Selection.select("node",e)}}class l extends Editor.Undo.Command{static get type(){return"add-component"}undo(){let t=cc.engine.getInstanceById(this.info.id);t&&(n._destroyForUndo(this.info.comp,()=>{this.info.data=e.recordObject(this.info.comp)}),Editor.Selection.select("node",t.uuid),i.onRemoveComponent(t,this.info.comp))}redo(){let t=cc.engine.getInstanceById(this.info.id);if(t){try{e.restoreObject(this.info.comp,this.info.data),e.renewObject(this.info.comp),t._addComponentAt(this.info.comp,this.info.index)}catch(e){Editor.error(`Failed to restore component at node ${this.info.node.name}: ${e}`)}Editor.Selection.select("node",t.uuid),i.onAddComponent(t,this.info.comp)}}}class f extends Editor.Undo.Command{static get type(){return"remove-component"}undo(){let t=cc.engine.getInstanceById(this.info.id);if(t){try{e.restoreObject(this.info.comp,this.info.data),e.renewObject(this.info.comp),t._addComponentAt(this.info.comp,this.info.index)}catch(e){Editor.error(`Failed to restore component at node ${this.info.node.name}: ${e}`)}Editor.Selection.select("node",t.uuid),i.onAddComponent(t,this.info.comp)}}redo(){let t=cc.engine.getInstanceById(this.info.id);t&&(n._destroyForUndo(this.info.comp,()=>{this.info.data=e.recordObject(this.info.comp)}),Editor.Selection.select("node",t.uuid),i.onRemoveComponent(t,this.info.comp))}}let u=[],p=[],h=[],m=[],g=[],y=Editor.Undo.local(),_=-1;y.on("changed",function(e){switch(e){case"collapse":case"clear-redo":_>y._position&&(_=y._position);break;case"clear":_=-1}});let b={_listeners:[],reset(){u=[],p=[],h=[],m=[],g=[]},init(){y.register(d.type,d),y.register(s.type,s),y.register(c.type,c),y.register(a.type,a),y.register(l.type,l),y.register(f.type,f),y.register(r.type,r),this.reset()},clear(){this.reset(),y.clear()},dump(){let e={};return e._type=y._type,e._position=y._position,e._savePosition=y._savePosition,e._allSyncedPrefabSavedPosition=_,e._groups=[],y._groups.forEach(t=>{let o={};o.desc=t.desc,o._commands=[],t._commands.forEach(e=>{let t={};t.type=e.constructor.type,t.info=e.info,o._commands.push(t)}),e._groups.push(o)}),e},restore(e){y._silent=!0,this.clear(),e._groups.forEach(e=>{e._commands.forEach(e=>{y.add(e.type,e.info)}),y.commit()}),y._type=e._type,y._position=e._position,y._savePosition=e._savePosition,_=e._allSyncedPrefabSavedPosition,y._silent=!1},recordObject(t,o){if(o&&y.setCurrentDescription(o),!g.some(e=>e.id===t)){let o=cc.engine.getInstanceById(t);try{let n=e.recordObject(o);g.push({id:t,data:n})}catch(e){Editor.error(`Failed to record object ${o._name}: ${e}`)}}},recordNode(t,o){if(o&&y.setCurrentDescription(o),!u.some(e=>e.id===t)){let o=cc.engine.getInstanceById(t);if(!o)return;try{let n=e.recordNode(o);u.push({id:t,data:n})}catch(e){Editor.error(`Failed to record node ${o._name}: ${e}`)}}},recordCreateNode(e,t){if(t&&y.setCurrentDescription(t),!p.some(t=>t.node.id===e)){let t=cc.engine.getInstanceById(e);p.push({node:t,parent:t.parent,siblingIndex:t.getSiblingIndex()})}},recordDeleteNode(t,o){if(o&&y.setCurrentDescription(o),!h.some(e=>e.node.id===t)){let o=cc.engine.getInstanceById(t);if(!o)return;try{h.push({node:o,data:e.recordDeleteNode(o)})}catch(e){Editor.error(`Failed to record delete node ${o._name}: ${e}`)}}},recordMoveNode(e,t){if(t&&y.setCurrentDescription(t),!m.some(t=>t.node.id===e)){let t=cc.engine.getInstanceById(e);m.push({node:t,parent:t.parent,siblingIndex:t.getSiblingIndex()})}},recordAddComponent(e,t,o,n){n&&y.setCurrentDescription(n),y.add(l.type,{id:e,comp:t,index:o})},recordRemoveComponent(t,o,n,i){i&&y.setCurrentDescription(i),y.add(f.type,{id:t,comp:o,index:n,data:e.recordObject(o)})},commit(){if(p.length&&(y.add(s.type,{list:p}),p=[]),g.length){try{let t=g,o=g.map(t=>{let o=cc.engine.getInstanceById(t.id);return{id:t.id,data:e.recordObject(o)}});y.add(r.type,{before:t,after:o})}catch(e){Editor.error(`Failed to add record objects to undo list: ${e}`)}g=[]}if(u.length){try{let t=u,o=u.map(t=>{let o=cc.engine.getInstanceById(t.id);return{id:t.id,data:e.recordNode(o)}});y.add(d.type,{before:t,after:o})}catch(e){Editor.error(`Failed to add record nodes to undo list: ${e}`)}u=[]}if(m.length){let e=m,t=m.map(e=>({node:e.node,parent:e.node.parent,siblingIndex:e.node.getSiblingIndex()}));y.add(a.type,{before:e,after:t}),m=[]}h.length&&(y.add(c.type,{list:h}),h=[]),y.commit()},cancel(){p=[],h=[],m=[],g=[],y.cancel()},undo(){y.undo(),cc.engine.repaintInEditMode()},redo(){y.redo(),cc.engine.repaintInEditMode()},save(){y.save()},syncedPrefabSave(){_=y._position},dirty:()=>y.dirty(),syncedPrefabDirty(e){if(_===y._position)return!1;try{let t=n.getChildUuids(e),o=Math.min(y._position,_),i=Math.max(y._position,_);for(let n=o+1;n<=i;n++){let o=y._groups[n];for(let n=0;n<o._commands.length;n++){let i=o._commands[n];if(i.dirty()){if(i instanceof c||this._nodesDirty(i,t))return!0;if(this._syncedPrefabRootDirty(i,e.uuid))return!0}}}}catch(e){Editor.error(e)}return!1},_syncedPrefabRootDirty(e,n){function i(e,n){let i=e.node,r=n.node,d=o.NodeRevertableProps_Root;for(let e=0;e<d.length;e++){let t=d[e],o=i[t],n=r[t];if(o instanceof cc.ValueType){if(!o.equals(n))return!0}else if(o!==n)return!0}return t.isComponentChanged(e.comps,n.comps)}if(e instanceof c||e instanceof s||e instanceof a)return!1;if(e instanceof l||e instanceof f)return e.info.id===n;if(e instanceof r)for(let t=0;t<e.info.before.length;t++){let o=e.info.before[t],i=cc.engine.getInstanceById(o.id);if(cc.Node.isNode(i))i.uuid===n&&console.error("Not yet implement checking node data for RecordObjectsCommand");else if(i instanceof cc.Component&&i.node.uuid===n)return!0}else if(e instanceof d)for(let t=0;t<e.info.before.length;t++){let o=e.info.before[t];if(o.id===n&&i(o.data,e.info.after[t].data))return!0}return!1},on(e,t){this._listeners.push({type:e,listener:t}),y.on.apply(y,arguments)},_unregisterListeners(){this._listeners.forEach(e=>{y.removeListener(e.type,e.listener)})},_registerListeners(){this._listeners.forEach(e=>{y.on(e.type,e.listener)})},_nodesDirty(e,t){let o=e.info;if(!o)return!1;let n,i=o.id;if(i)for(let e=0;e<t.length;e++)if(i===t[e])return!0;if(Array.isArray(o.before))n=o.before;else{if(!Array.isArray(o.list))return!1;n=o.list}if(!n)return!1;for(let e=0;e<n.length;e++){let o=n[e],i=o&&(o.id||o.node&&o.node.uuid);if(i)for(let e=0;e<t.length;e++)if(i===t[e])return!0}return!1}};module.exports=b,module.exports._undo=y;