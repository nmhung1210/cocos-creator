"use strict";const{ipcMain:e}=require("electron"),t=require("../../core/gulp-build"),i=require("../../share/bundle-utils"),r=require("path");var n,s,o,a,c,d=!1;function u(){var e=Editor.require("app://asset-db/lib/meta").get(Editor.assetdb,Editor.currentSceneUuid),t=Editor.stashedScene.sceneJson;if(e){var i=JSON.parse(t),r=Editor.serialize.findRootObject(i,"cc.SceneAsset");r?r.asyncLoadAssets=e.asyncLoadAssets:Editor.warn("Can not find cc.SceneAsset in stashed scene");var n=Editor.serialize.findRootObject(i,"cc.Scene");return n?n.autoReleaseAssets=e.autoReleaseAssets:Editor.warn("Can not find cc.Scene in stashed scene"),JSON.stringify(i)}return t}let l={userMiddlewares:[],_previewPort:7456,_listenByPort(e,t){o?(o.close(),function e(t,i,r){function n(){t.removeListener("error",s),r(null,i)}function s(s){if(t.removeListener("listening",n),"EADDRINUSE"!==s.code&&"EACCES"!==s.code)return r(s);Editor.warn(`The current '${i}' preview port is already occupied, the port is automatically incremented`),e(t,++i,r)}t.once("error",s),t.once("listening",n),t.listen(i)}(o,e,(e,i)=>{if(e)return Editor.warn(e),t&&t(e),void 0;this._previewPort=i,Editor.success(`preview server running at http://localhost:${i}`),Editor.Ipc.sendToAll("preview-server:preview-port-changed",i),t&&t()})):t&&t()},start:function(t,i){var r=require("fire-fs"),d=require("fire-path"),l=require("os"),p=require("del"),f=require("express"),v=require("http"),g=require("mobile-detect"),h=require("async");const m=require("compression");var E=this;this._validateStashedScene=t;var j=d.join(l.tmpdir(),"fireball-game-builds");p.sync(d.join(j,"**/*"),{force:!0}),(s=f()).use(m());let w=d.join(Editor.Project.path,"preview-templates");r.existsSync(w)||(w=Editor.url("unpack://static/preview-templates")),s.set("views",w),s.set("view engine","jade");const b=require("ejs");function S(e,t){var i=e.params[1];if(Editor.stashedScene&&Editor.currentSceneUuid&&d.basenameNoExt(i)===Editor.currentSceneUuid)return t.send(u()),void 0;i=d.join(Editor.importPath,i),t.sendFile(i)}s.engine("html",b.renderFile),s.engine("ejs",b.renderFile),s.locals.basedir=s.get("views"),s.use(function(e,t,i){var r=E.userMiddlewares;Array.isArray(r)&&r.length>0?h.eachSeries(r,(i,r)=>{if(!i)return Editor.warn("Web Preview: Invalid element in userMiddlewares, please check your editor packages."),r(null);i(e,t,r)},i):i()}),s.use("/build",function(e,t,i){a?a(e,t,i):t.send("Please build your game project first!")}),s.use("/preview-android-instant",function(e,t,i){c?c(e,t,i):t.send("Please build your android instant project first!")}),s.get("/",function(e,t){var i=e.headers["user-agent"],n=new g(i),s=r.existsSync(d.join(Editor.Project.path,"library","bundle.project.js")),o=-1!==i.indexOf("MicroMessenger");let a=Editor.require("app://editor/share/quick-compile/check-auto-build-engine")()?".cache/dev/__quick_compile__.js":"cocos2d-js-for-preview.js",c={title:"CocosCreator | "+Editor.Project.name,cocos2d:a,hasProjectScript:s,tip_sceneIsEmpty:Editor.T("PREVIEW.scene_is_empty"),enableDebugger:!!n.mobile()||o};try{Object.assign(c,r.readJsonSync(d.join(w,"configs/options.json")))}catch(e){}t.render(r.existsSync(d.join(w,"index.html"))?"index.html":r.existsSync(d.join(w,"index.ejs"))?"index.ejs":"index",c)}),s.get("/compile",function(e,t){Editor.Compiler.compileScripts(!1,(e,i)=>{i||(e?(t.send("Compiling script successful!"),Editor.Compiler.reload()):t.send("Compile failed!"))})}),s.get("/update-db",function(e,t){Editor.assetdb.submitChanges(),t.send("Changes submitted")}),s.get(["/app/engine/*","/engine/*"],function(e,t){var i=d.join(Editor.url("unpack://engine"),e.params[0]);t.sendFile(i)}),s.get("/engine-dev/*",function(e,t){var i=d.join(Editor.url("unpack://engine-dev"),e.params[0]);t.sendFile(i)}),s.get("/app/editor/static/*",function(e,t){var i=Editor.url("unpack://static/"+e.params[0]);t.sendFile(i)}),s.get("/app/*",function(e,t){var i=Editor.url("app://"+e.params[0]);t.sendFile(i)}),s.get("/project/*",function(e,t){var i=d.join(Editor.Project.path,e.params[0]);t.sendFile(i)}),s.get("/preview-scripts/*",function(e,t){let i=Editor.ProjectCompiler.DEST_PATH;var r=d.join(i,e.params[0]);t.sendFile(r)}),s.get("/plugins/*",function(e,t){var i=e.params[0];i=Editor.assetdb._fspath("db://"+i),t.sendFile(i)}),s.get("/assets/*/import/*",S),s.get("/assets/*/native/*",S),s.get("/assets/*/config.json",function(e,t){E.query(`${e.params[0]}/config.json`,function(e,i){if(e)return t.status(404).send({error:e.message});t.send(i)})}),s.get("/assets/*/index.js",function(e,t){t.send("")}),s.get("/settings.js",function(e,t){E.query("settings.js",function(e,r){if(e)return i(e);t.send(r)})}),s.get("/preview-scene.json",function(e,t){E.getPreviewScene(function(e){return i(e)},function(e){t.send(e)},function(e){t.sendFile(e)})}),s.get("/*",function(e,t,i){return f.static(w)(e,t,i)}),s.use(function(e,t,i,r){console.error(e.stack),r(e)}),s.use(function(e,t,i,r){t.xhr?i.status(e.status||500).send({error:e.message}):r(e)}),s.use(function(e,t){t.status(404).send({error:"404 Error."})}),o=v.createServer(s);let y=Editor.Profile.load("project://project.json");this._listenByPort(y&&y.get("preview-port")||this._previewPort,i),function(e){var t=0;(n=require("socket.io")(e)).on("connection",function(e){e.emit("connected"),t+=1,Editor.Ipc.sendToMainWin("preview-server:connects-changed",t),e.on("disconnect",function(){t-=1,Editor.Ipc.sendToMainWin("preview-server:connects-changed",t)})})}(o),e.removeAllListeners("preview-server:use-new-preview-port"),e.on("preview-server:use-new-preview-port",(e,t)=>{this._previewPort!==t&&this._listenByPort(t)})},query:async function(e,n,s){if(this._validateStashedScene)switch(void 0===s&&(s=n,n="web-desktop"),e){case"settings.js":this._validateStashedScene(async()=>{let e=Editor.Profile.load("project://project.json");var r=await i.queryBundleFolders();let o={designWidth:Editor.stashedScene.designWidth,designHeight:Editor.stashedScene.designHeight,groupList:e.get("group-list"),collisionMatrix:e.get("collision-matrix"),platform:n,scripts:Editor.ProjectCompiler.scripts,hasResourcesBundle:!!r.find(e=>"resources"===e.name)};t.buildSettings({customSettings:o,launchScene:Editor.sceneList[0],debug:!0,preview:!0},s)});break;case"stashed-scene.json":this._validateStashedScene(()=>{s&&s(null,u())});break;case"main/config.json":case"internal/config.json":case"resources/config.json":default:var o=r.dirname(e),a=await i.queryBundlesWithScenes(),c=await i.queryBundleFolders();c.push({name:cc.AssetManager.BuiltinBundleName.MAIN,url:""});var d=c.find(e=>e.name===o);if(!d)return s(new Error("Bundle does not exist!"));t.buildConfig({name:o,importBase:"web-desktop"!==n?"":"import",nativeBase:"web-desktop"!==n?"":"native",root:d.url,sceneList:a[o]?a[o].map(e=>e.uuid):[],debug:!0,preview:!0},s)}},getPreviewScene(e,t,i){let r=Editor._projectProfile.get("start-scene");if("current"!==r&&r!==Editor.currentSceneUuid&&Editor.assetdb.existsByUuid(r)){i(Editor.assetdb._uuidToImportPathNoExt(r)+".json")}else this.query("stashed-scene.json",(i,r)=>{if(i)return e(i);t(r)})},stop:function(){o&&o.close(function(){Editor.info("shutdown preview server"),o=null})},browserReload:function(){d||(d=setTimeout(function(){n.emit("browser:reload"),clearTimeout(d),d=!1},50))},setPreviewBuildPath:function(e){var t=require("express");a=t.static(e)},setPreviewAndroidInstantPath:function(e){var t=require("express");Editor.log("express path is ",e),c=t.static(e)},_validateStashedScene:null};Object.defineProperty(l,"previewPort",{get(){return this._previewPort},set(e){this._previewPort=e,this._listenByPort(e)}}),module.exports=l;