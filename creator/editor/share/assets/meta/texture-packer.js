"use strict";const e=require("fire-fs"),t=require("fire-path"),r=require("plist"),i=require("./sprite-atlas"),s=require("./sprite-frame"),a=/[\{\}]/g,l=/[\\\/]/g;function o(e,t){let r=e.slice(1,-1).split(",");return new t(parseFloat(r[0]),parseFloat(r[1]))}function u(e){return e.split(" ").map(parseFloat)}function h(e){let t=(e=e.replace(a,"")).split(",");return new cc.Rect(parseFloat(t[0]||0),parseFloat(t[1]||0),parseFloat(t[2]||0),parseFloat(t[3]||0))}module.exports=class extends i{constructor(e){super(e),this.type="Texture Packer"}static validate(t){let i=r.parse(e.readFileSync(t,"utf8"));return void 0!==i.frames&&void 0!==i.metadata}static version(){return"1.2.4"}parse(i){let a=this._assetdb,n=r.parse(e.readFileSync(i,"utf8")),p=n.metadata,f=n.frames,c=t.dirname(i);this._rawTextureFile||(this._rawTextureFile=t.join(c,p.realTextureFileName||p.textureFileName)),this.size=o(p.size,cc.Size);let d={},m=this.getSubMetas(),g=[];for(let e in f){let t,r,i,n=f[e],c=!1,v=!1,w=e.replace(l,"-");w!==e&&g.push(e);let x=m[w];x||(x=new s(a)),d[w]=x,0===p.format?(c=!1,v=n.trimmed,t=`{${n.originalWidth},${n.originalHeight}}`,r=`{${n.offsetX},${n.offsetY}}`,i=`{{${n.x},${n.y}},{${n.width},${n.height}}}`):1===p.format||2===p.format?(c=n.rotated,v=n.trimmed,t=n.sourceSize,r=n.offset,i=n.frame):3===p.format&&(c=n.textureRotated,v=n.trimmed,t=n.spriteSourceSize,r=n.spriteOffset,i=n.textureRect),x.rotated=!!c,x.trimType=v?"custom":"auto",x.spriteType="normal";let F=o(t,cc.Size);x.rawWidth=F.width,x.rawHeight=F.height;let S=o(r,cc.Vec2);x.offsetX=S.x,x.offsetY=S.y;let y=h(i);if(x.trimX=y.x,x.trimY=y.y,x.width=y.width,x.height=y.height,x.vertices=void 0,n.triangles){let t=u(n.triangles),r=u(n.vertices),i=u(n.verticesUV);if(r.length!==i.length)Editor.warn(`[${e}] vertices.length [${r.length}] is different with verticesUV.length [${i.length}]`);else{x.vertices={triangles:t,x:[],y:[],u:[],v:[]};for(let e=0;e<r.length;e+=2)x.vertices.x.push(r[e]),x.vertices.y.push(r[e+1]);for(let e=0;e<i.length;e+=2)x.vertices.u.push(i[e]),x.vertices.v.push(i[e+1])}}}g.length>0&&Editor.warn("[SpriteAtlas import] Some of the frame keys have been reformatted : "+JSON.stringify(g)),this.updateSubMetas(d)}postImport(e,t){this.rawTextureUuid=this._assetdb.fspathToUuid(this._rawTextureFile);var r=this.getSubMetas();for(var i in r)r[i].rawTextureUuid=this.rawTextureUuid;super.postImport(e,t)}};