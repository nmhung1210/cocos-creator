"use strict";var e=require("fire-fs"),t=require("readline"),i=require("fire-path"),r=require("async"),s=require("@babel/core"),a=require("convert-source-map"),o=require("./precompile-script"),l=92160;function u(t){if(-1!==i.basename(t).lastIndexOf(".min."))return!0;var r=e.statSync(t);return r&&r.size>=l}function n(t){var r=i.basename(t),s=e.statSync(t);return 0===Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.yes"),Editor.T("MESSAGE.no")],title:Editor.T("MESSAGE.assets.plugin_title"),message:Editor.T("MESSAGE.assets.plugin_message",{fileName:r}),detail:Editor.T("MESSAGE.assets.plugin_detail",{fileSize:function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}(s.size)}),defaultId:0,cancelId:1,noLink:!0})}class p extends Editor.metas.asset{constructor(e){super(e),this.isPlugin=null,this.loadPluginInWeb=!0,this.loadPluginInNative=!0,this.loadPluginInEditor=!1}static defaultType(){return"javascript"}static version(){return"1.0.8"}getImportedPaths(){var e=this._assetdb._uuidToImportPathNoExt(this.uuid);return[e+".js",e+".js.map"]}dests(){if(null===this.isPlugin){var e=this._assetdb.uuidToFspath(this.uuid);this.isPlugin=u(e)}return this.isPlugin?[]:this.getImportedPaths()}compile(t,i){var r;try{var o=e.readFileSync(t,{encoding:"utf-8"}),l=!!a.fromSource(o);r=s.transform(o,{ast:!1,highlightCode:!1,sourceMaps:!0,inputSourceMap:l,compact:!1,filename:t,presets:[[require("@babel/preset-env"),{loose:!0}]],plugins:[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")]]})}catch(e){return i(e)}i(null,{outputText:r.code,sourceMapObject:r.map})}_importToLibrary(e,t){r.waterfall([t=>{this.compile(e,function(e,i){e&&(e.code="ESCRIPTIMPORT",e.stack="Compile error: "+e.stack),t(e,i)})},o.compile.bind(null,this.uuid,e),(e,t)=>{this._assetdb.saveAssetToLibrary(this.uuid,e.outputText,".js"),this._assetdb.saveAssetToLibrary(this.uuid,JSON.stringify(e.sourceMapObject),".js.map"),t(null)}],t)}checkGlobalVariables(i,r){var s=/^var\s+\S+/,a=t.createInterface({input:e.createReadStream(i)});a.on("line",e=>{s.test(e)&&Editor.info(Editor.T("MESSAGE.assets.js_global_var_1_4",{property:Editor.T("INSPECTOR.javascript.loadPluginInEditor"),path:i,line:e.trim()}))}),a.on("close",r)}import(e,t){if(null===this.isPlugin&&(this.isPlugin=!1,u(e)&&(this.isPlugin=n(e))),this.isPlugin){if(!this.loadPluginInEditor)return t();this.checkGlobalVariables(e,t)}else this._importToLibrary(e,t)}export(t,i,r){i?e.writeFile(t,i,r):r&&r()}}!1,module.exports=p;