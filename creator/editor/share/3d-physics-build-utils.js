const e=require("browserify"),i=require("babelify"),s=require("vinyl-source-stream"),r=require("vinyl-buffer"),n=require("path"),t=require("gulp"),u=require("./build-platforms"),l={"3D Physics/Builtin":"physics_builtin","3D Physics/cannon.js":"physics_cannon"},o={},p=[[require("@babel/preset-env"),{loose:!0}],require("@babel/preset-typescript")],c=[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")]];o.getPhysicsModule=function(e,i){let s=Object.keys(l);return 0===(s=s.filter(i=>!e.includes(i))).length?null:s.length>1?(i&&i(),"3D Physics/cannon.js"):s[0]},o.getPhysicsEntries=function(e){let i=Editor.require("unpack://engine/modules.json"),s=Editor.url("unpack://engine"),r=null;if(i.some(i=>{return!(i.name!==e||!i.entries)&&(r=i.entries.map(e=>n.join(s,e)),!0)}),!r)throw new Error("Error on resolving physics modules");return r},o.getPhysicsBuildFlags=function(e){let i={};return Object.keys(l).forEach(e=>{i[l[e]]=!1}),e&&(i[l[e]]=!0),i},o.build=function({dest:l,excludedModules:o,debug:d,platform:a}){return new Promise((h,g)=>{let y=this.getPhysicsModule(o,()=>{Editor.warn(Editor.T("BUILDER.physics_module_undefined"))});if(!y)return h();Editor.log("Building 3D physics modules...");let b=this.getPhysicsEntries(y),m=this.getPhysicsBuildFlags(y),q=u[a].isNative,f="runtime"===a,j={jsb:q&&!f,runtime:f,minigame:"mini-game"===a,debug:d};m&&Object.assign(j,m);let E=new e({extensions:[".js",".ts"],entries:b});const P=Editor.require("unpack://engine/gulp/util/utils"),k=Editor.require("unpack://engine/gulp/util/handleErrors.js");let w=E.transform(i,{extensions:[".js",".ts"],presets:p,plugins:c}).bundle().on("error",k.handler).pipe(k()).pipe(s(q?"physics.js":d?"physics.js":"physics-min.js")).pipe(r()).pipe(P.uglify("build",j)).pipe(t.dest(q?n.join(l,"src"):l));w.once("error",g),w.on("end",h)})},o.updateMinigameRequire=function({debug:e,excludedModules:i},s,r){if(this.getPhysicsModule(i)){let i=r||(e?"require('physics.js');":"require('physics-min.js');");s=s.replace("require('physics-js-path');",i)}else s=s.replace("require('physics-js-path');","");return s},module.exports=o;