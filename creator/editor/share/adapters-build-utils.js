const e={},r=require("browserify"),t=require("babelify"),a=require("@babel/core"),i=require("vinyl-source-stream"),o=require("vinyl-buffer"),n=require("gulp-uglify"),s=require("event-stream"),u=(require("fs"),require("path")),c=require("gulp"),p=Editor.require("packages://adapters/modules.json"),l=[require("@babel/preset-env")],f=[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]];let d={wechatgame:"wechat","wechatgame-subcontext":"wechat",baidugame:"baidu","baidugame-subcontext":"baidu","bytedance-subcontext":"bytedance"};function b(e){return e=d[e]||e,Editor.url(`packages://adapters/platforms/${e}`)}e.buildAdapter=function({actualPlatform:e,debug:a,excludedModules:s,dest:d},g){return new Promise((h,m)=>{let q=u.join(b(e),"index.js"),y=r(q);if(function(e){let r=[];if(e&&e.length>0){let t=Editor.url("packages://adapters");e.forEach(e=>{let a=p[e];a&&a.forEach(e=>{r.push(u.join(t,e))})})}return r}(s).forEach(e=>{y.ignore(e)}),g){let e=Editor.url("packages://adapters");g instanceof Array||(g=[g]),g.forEach(r=>{y.ignore(u.join(e,r))})}let j=y.transform(t,{presets:l,plugins:f}).bundle().pipe(i(a?"adapter.js":"adapter-min.js")).pipe(o());a||(j=j.pipe(n())),j.pipe(c.dest(d)),j.on("end",()=>{h()}),j.once("error",e=>{m(e)})})},e.copyRes=async function(e,r,t,i){return new Promise(async function(i,o){let{platform:n,actualPlatform:p,dest:d}=e,g=b(p),h=[u.join(g,"res/**/*")];r&&(r instanceof Array||(r=[r]),r.forEach(e=>{h.push(`!${u.join(g,"res",e)}`)}));let m=await new Promise((e,r)=>{Editor.Ipc.sendToMain("app:query-plugin-scripts",n,(t,a)=>{if(t)return r(t);let i=[];a.forEach(e=>{let r=u.relative(Editor.Project.path,e);r=r.replace(/\\/g,"/"),i.push(r)}),e(i)})});c.src(h).pipe(s.through(function(r){try{let i=u.basename(r.path);if("object"==typeof t){let a=t[i];"function"==typeof a&&a(r,e)}if("ccRequire.js"===i){let t="// tail",a=r.contents.toString(),i="";m&&m.forEach(e=>{i+=`'src/${e}' () { return require('src/${e}') },\n`}),e.bundles.forEach(r=>{if("subpackage"===r.compressionType&&"alipay"!==e.actualPlatform)return;let t=u.relative(d,r.scriptDest),a=u.join(t,"index.js");a=a.replace(/\\/g,"/"),i+=`'${a}' () { return require('${a}') },\n`}),i+=t,a=a.replace(t,i),r.contents=new Buffer(a)}if(".js"===u.extname(i)&&"ccRequire.js"!==i){let e=a.transform(r.contents.toString(),{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:r.path,presets:l,plugins:f});r.contents=new Buffer(e.code)}}catch(e){return this.emit("error",e)}this.emit("data",r)})).once("error",e=>{o(e)}).pipe(c.dest(d)).on("end",()=>{i()})})},module.exports=e;