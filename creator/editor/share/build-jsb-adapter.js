const e=require("path"),i=require("fs"),n=require("gulp"),t=(require("gulp-sourcemaps"),require("babelify")),r=require("browserify"),s=require("vinyl-source-stream"),o=(require("gulp-uglify"),require("vinyl-buffer")),a=(require("async"),require("aliasify")),u=/[Ww]eb[Vv]iew/;function l(n,t){if(!i.existsSync(t))return!0;let r=i.statSync(t);return function n(t,r){return i.readdirSync(t).some(s=>{let o=e.join(t,s),a=i.statSync(o);return a.isDirectory()?n(o,r):a.mtime.getTime()>r||void 0})}(e.dirname(n),r.mtime.getTime())}function d(i,l,d){let b=e.basename(l),c=function(e){return!!e&&e.some(e=>/.*jsb-webview(\.js)?/.test(e))}(d);l=e.dirname(l);let j=r(i);return d&&d.forEach(function(e){j.exclude(e)}),j=j.transform(t,{presets:[require("@babel/preset-env")]}),c&&(j=j.transform(a,{replacements:{".*jsb-webview(.js)?":!1},verbose:!1})),j.bundle().pipe(s(b)).pipe(o()).on("data",function(e){if(c){let i=e.contents.toString();if(u.test(i))throw new Error("WebView field still exists in jsb-adapter")}}).pipe(n.dest(l))}function b(e,i){return n.src(e).pipe(n.dest(i))}const c={prebuild:async function(i){let{rootPath:n,dstPath:t}=i;if(!n)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(i=>{let r=e.join(n,"./builtin/index.js"),s=e.join(t,"./jsb-builtin.js");l(r,s)?d(r,s).on("end",i):i()}),await new Promise(i=>{let r=e.join(n,"./engine/index.js"),s=e.join(t,"./jsb-engine.js");l(r,s)?d(r,s).on("end",i):i()}),console.timeEnd("build jsb-adapter")},build:async function(i){let{rootPath:n,dstPath:t,excludedModules:r}=i;if(!n)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(i=>{b(e.join(n,"./bin/jsb-builtin.js"),t).on("end",i)}),await new Promise(i=>{if(r&&r.length>0){let s=[],o=require(Editor.url("packages://jsb-adapter/modules.json"));r.forEach(function(i){o.some(function(t){if(t.name===i&&t.entries)return t.entries.forEach(function(i){s.push(e.join(n,i))}),!0})}),d(e.join(n,"./engine/index.js"),e.join(t,"./jsb-engine.js"),s).on("end",i)}else b(e.join(n,"./bin/jsb-engine.js"),t).on("end",i)}),console.timeEnd("build jsb-adapter")}};module.exports=c;