"use strict";require("electron").ipcMain;const e=require("fire-fs"),t=(require("fire-path"),require("async")),i=require("../editor-framework/lib/share/ipc-listener");let o=e=>{process.send&&process.send({channel:"editor-error",message:e.message,stack:e.stack})};function r(){Editor.Window.main.nativeWin.webContents.send("reload-page")}process.on("uncaughtException",o),Editor.App.extend({runDashboard(){Editor.Window.main.close()},run(){"string"!=typeof Editor._buildCommand&&"string"!=typeof Editor._compileCommand&&(Editor.Window.main&&(Editor.Window.main.nativeWin.webContents.on("devtools-reload-page",()=>{Editor.Window.main.nativeWin.webContents.once("did-finish-load",()=>{Editor.Window.main.nativeWin.webContents.send("reload-page")})}),Editor.Window.main.nativeWin.webContents.send("load-editor")),Editor.Metrics.setClientId(function(){Editor.Metrics.prepareUserIdentity(),Editor.Metrics.sendAppInfo(),Editor.Metrics.trackEvent({category:"Editor",action:"Editor Open",label:"new metrics"})}),process.removeListener("uncaughtException",o))},quit(e){let t=String((Date.now()-Editor.CocosAnalytics.openTime)/1e3|0);Editor.CocosAnalytics.trackCocosEvent("CreatorLogout",{projectId:Editor.Project.id,onlineDuration:t}),Editor.CocosAnalytics.trackEvent({category:"logout",exitTag:"successed",onlineDuration:t}),Editor.Metrics.trackEvent({category:"Editor",action:"Editor Close",label:"new metrics"},e),setTimeout(function(){console.log("quit due to request timeout"),e()},2e3)},spawnWorker(e,t,i,o,r){const n="unpack://static/general-worker.html";let a,s=!1;"function"==typeof t&&(r=o,o=i,i=t,t={}),t.scriptUrl=e,function e(){a&&(clearTimeout(a),a=null);const d=new Editor.Window("worker",{show:!!o,save:!1});a=setTimeout(()=>{a=null,s||(Editor.log("Load worker timeout, reload worker."),d.close(),e())},1e4),s=!1,r&&d.nativeWin.webContents.on("crashed",e=>{Editor.log("Worker window crashed, reload to restart worker"),d.load(n,t)}),o&&d.openDevTools(),i&&d.nativeWin.webContents.on("did-finish-load",function(){s=!0,i(d,d.nativeWin)}),d.load(n,t)}()},loadPackage(o,r){if(o.gizmos)for(let e in o.gizmos){Editor.gizmos[e]&&Editor.warn(`Override gizmos [${e}] from [${Editor.gizmos[e]}] to [${o.gizmos[e]}]`);let t=o.gizmos[e];t.startsWith("packages://")?Editor.gizmos[e]=t:Editor.gizmos[e]=`packages://${o.name}/${t}`}o["scene-script"]&&(Editor.sceneScripts[o.name]=`packages://${o.name}/${o["scene-script"]}`,Editor.Ipc.sendToPanel("scene","scene:load-package-scene-script",o.name,Editor.sceneScripts[o.name])),o["build-template"]&&(Editor.Builder.buildTemplates[o.name]=`packages://${o.name}/${o["build-template"]}`);let n=o["simple-build-target"];if(n){let e=Editor.require(`packages://${o.name}/${n}`);if(e.package=o.name,Editor.Builder.simpleBuildTargets[e.platform]=e,e.messages){let t=function(e,t){return-1===t.indexOf(":")?`${e}:${t}`:t},o=new i;for(let i in e.messages){let r=e.messages[i];"function"==typeof r&&o.on(t(e.package,i),r.bind(e))}e._ipc=o}}if(o.inspector)for(let e in o.inspector)Editor.inspectors[e]=`packages://${o.name}/${o.inspector[e]}`;var a=o["runtime-resource"],s="",d=!1,c="";t.waterfall([t=>{if(!a)return t(),void 0;s=Editor.url(`packages://${o.name}/${a.path}`),e.existsSync(s)&&e.isDirSync(s)||(Editor.warn(`Mount runtime resource failed, ${s} is not a valid folder.`),s=""),t()},e=>{if(!s)return e(),void 0;c=`${o.name}-${a.name}`,Editor.assetdb.mount(s,c,{readonly:!0},t=>{t?Editor.warn(`Mount runtime resource failed. message: ${t.stack}`):d=!0,e()})},e=>{if(!d||!Editor.assetdbInited)return e(),void 0;Editor.assetdb.attachMountPath(c,t=>{t&&Editor.warn(`Attach mount path ${c} failed. message: ${t.stack}`),e()})}],e=>{r()})},unloadPackage(e,i){if(e.gizmos)for(let t in e.gizmos)delete Editor.gizmos[t];e["scene-script"]&&(Editor.Ipc.sendToPanel("scene","scene:unload-package-scene-script",e.name),delete Editor.sceneScripts[e.name]),e["build-template"]&&delete Editor.Builder.buildTemplates[e.name];var o=e["simple-build-target"];if(o){let t=Editor.require(`packages://${e.name}/${o}`);delete Editor.Builder.simpleBuildTargets[t.platform],t._ipc&&t._ipc.clear()}if(e.inspector)for(let t in e.inspector)delete Editor.inspectors[t];var r=e["runtime-resource"];if(!r)return i&&i(),void 0;var n=`${e.name}-${r.name}`;t.waterfall([e=>{Editor.assetdb.unattachMountPath(n,t=>{t&&Editor.warn(`Unattach mount path ${n} failed. message: ${t.stack}`),e(t)})},t=>{Editor.assetdb.unmount(n,i=>{i&&Editor.warn(`Unmount runtime resource of package ${e.name} failed. message : ${i.stack}`),t()})}],e=>{i&&i()})}}),Editor.App.on("focus",function(){"test"!==Editor.argv._command&&Editor.assetdbInited&&Editor.assetdb.watchOFF()}),Editor.App.on("blur",function(){"test"!==Editor.argv._command&&Editor.assetdbInited&&Editor.assetdb.watchON()}),Editor.App.on("quit",function(){Editor.PreviewServer.stop(),Editor.NativeUtils.stop(),process.send&&process.send({channel:"show-dashboard"})}),Editor.App.on("gpu-process-crashed",function(){Editor.warn(Editor.T("EDITOR_MAIN.gpu_crash_warning"));let e=Editor.Window.main.nativeWin;e&&(e.webContents.off("did-finish-load",r),e.webContents.once("did-finish-load",r),e.reload())});