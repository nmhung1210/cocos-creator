const e="project://vivo-runtime.json",i="minigame.config.js",n="game.js",t="boot.js",o="manifest.json",r="qgame-adapter.js",a="cocos-library",s="7d8bb580016b6a2fb89d902deda0d3a4",c="src",l="sign",d="engine";let u,m,p,v=require("child_process").spawn,g=require("path"),f=require("fs-extra"),y=require(Editor.url("packages://vivo-runtime/lib/cli")),j="";var E;let S,_,b,h,P,k,T;function x(e){let i=Editor.url("packages://runtime-adapters/platforms/vivo");return void 0===e?i:g.join(i,e)}function w(e){let i=Editor.url("packages://runtime-adapters/common/res");return void 0===e?i:g.join(i,e)}function D(e,i,n){f.readdirSync(e).forEach(function(t){let o=g.join(e,t),r=f.statSync(o);if(r&&r.isDirectory())D(o,i);else{if(".js"!==g.extname(o))return;let e=o.slice(i.length+1,o.length),t=g.basename(o),r=!0;if(void 0!==n&&n instanceof Array)for(let e=0;e<n.length;e++)if(r=!0,t===n[e]){r=!1;break}if(!r)return;let a=(e=e.replace(/\\/g,"/")).replace("engine/",""),s={};s.module_name=a,s.module_path=a,s.module_from=e,j+=JSON.stringify(s)+",\n"}})}function q(){let e={package:u.package,name:u.name,icon:`/image/${g.parse(p).base}`,versionName:u.versionName,versionCode:u.versionCode,minPlatformVersion:u.minPlatformVersion,deviceOrientation:u.deviceOrientation,type:"game",config:{logLevel:u.logLevel},display:{}};!0===u.separateEngineMode&&(e.plugins={"cocos-library":{provider:s,version:CocosEngine,path:"cocos-library"}}),e.subpackages=function(){let e=[],i=[];for(var n=0,t=P.bundles.length;n<t;n++){var o=P.bundles[n];if("subpackage"!==o.compressionType)continue;let t=o.name;i.includes(t)||(i.push(t),e.push({name:"usr_"+t,root:t+"/"}))}0===e.length&&(e=void 0);return e}(),f.writeJsonSync(g.join(m,c,o),e)}function N(){let e=g.join(m,c);f.copySync(g.join(x("res"),n),g.join(e,n));let i=g.join(e,"image");f.emptyDirSync(i),f.copySync(p,g.join(i,g.parse(p).base)),q(),function(){for(let i=0,n=P.bundles.length;i<n;i++){var e=P.bundles[i];if("subpackage"!==e.compressionType)continue;let n=g.join(m,"src",e.name);f.emptyDirSync(n),f.copySync(e.scriptDest,n);let t="index.js",o=g.join(n,t),r=g.join(n,"game.js");f.existsSync(o)&&f.renameSync(o,r)}}()}function $(e,i){y.init(i,u.npmPath,h),m=i.dest,y.isLatestVersion(function(n,t){if(!0===n)return M(e,i),void 0;(function(e,i){Editor.log(Editor.T("vivo-runtime.download_qgame_adater")),y.installQGameAdapter(function(n){if(n)return Editor.log(Editor.T("vivo-runtime.download_qgame_adater_fail")),M(e,i),void 0;Editor.log(Editor.T("vivo-runtime.download_qgame_adater_success")),M(e,i)})})(e,i)})}function M(e,n){if(Editor.log("Checking config file ",n.dest),T=y.getEnvirommentPath(),Editor.log("Building game "+n.platform+" to "+m),!0===u.separateEngineMode&&!y.isSupportSeparateEngine())return e.reply(new Error(Editor.T("vivo-runtime.separate_engine_dont_support"))),void 0;let o=g.join(m,c),s=g.join(m,d);f.emptyDirSync(s),f.existsSync(o)&&f.moveSync(o,g.join(s,c));var p=y.getQGameAdapterPath();f.existsSync(p)||(p=g.join(x("res"),r)),f.copySync(p,g.join(s,"adapter",r)),N(),function(){if(!_){let e=g.join(m,l,"release");return f.emptyDirSync(e),f.copySync(E,g.join(e,"private.pem")),f.copySync(S,g.join(e,"certificate.pem")),void 0}let e=g.join(m,l,"debug");f.emptyDirSync(e),f.copySync(w("certificate.pem"),g.join(e,"certificate.pem")),f.copySync(w("private.pem"),g.join(e,"private.pem"))}(),f.copySync(g.join(x("res"),t),g.join(m,d,c,t)),function(){if(!u.separateEngineMode)return;let e=g.join(m,a),i=g.join(m,d,c,"cocos2d-runtime.js"),n=g.join(e,"cocos2d-runtime.js"),o=g.join(m,d,c,t),r=g.join(e,"plugin.json");Editor.info(Editor.T("vivo-runtime.separate_engine_begin_hint")),f.emptyDirSync(e),f.copySync(i,n);let s={main:"cocos2d-runtime.js"};f.writeJSONSync(r,s);let l=f.readFileSync(o,"utf-8");if(l.indexOf("require('src/cocos2d-runtime.js');")>-1){let e="if (window.requirePlugin) {\n\t\trequirePlugin('cocos-library/cocos2d-runtime.js');\n\t\t} else {\n\t\t\trequire('cocos-library/cocos2d-runtime.js');\n\t\t}";l=l.replace("require('src/cocos2d-runtime.js');",e),f.writeFileSync(o,l)}Editor.info(Editor.T("vivo-runtime.separate_engine_end_hint"))}(),async function(e){let i=require("./build-jsb-adapter"),n=g.join(x(),"engine","index.js"),t=g.join(m,d,"adapter","index.js");await i.build({rootPath:n,dstPath:t,isDebug:P.debug}),e&&e()}(function(){(function(){let e=g.join(m,"assets");f.existsSync(e)&&f.copySync(e,g.join(m,"src","assets"),{filter:function(e){let i=g.extname(e);return".js"!==i}});if(""!==u.tinyPackageServer)return;let i=g.join(m,"remote");f.existsSync(i)&&f.copySync(i,g.join(m,"src","remote"))})(),f.copySync(x(g.join("engine","rename-adapter.js")),g.join(m,d,"adapter","rename-adapter.js")),function(){j="",D(g.join(m,"assets"),m),!0===u.separateEngineMode?(D(g.join(m,d),m,["cocos2d-runtime.js"]),D(g.join(m,a),m)):D(g.join(m,d),m);(function(){let e=g.join(x("res"),i),n=f.readFileSync(e,"utf8");n=n.replace("EXTERNALS_PLACEHOLDER",j),f.writeFileSync(g.join(m,i),n)})()}(),O()})}function O(){Editor.log(Editor.T("vivo-runtime.rpk_installing"));var e=["run"];_?e.push("build"):e.push("release");let i="win32"===process.platform?"npm.cmd":"npm",n=v(i,e,{env:T,cwd:m});n.stdout.on("data",e=>{}),n.stderr.on("data",e=>{Editor.error(`${e}`)}),n.on("close",e=>{let i=g.join(m,"dist",u.package+(_?".":".signed.")+"rpk");if(!f.existsSync(i))return k.reply(new Error(Editor.T("vivo-runtime.rpk_install_fail"))),void 0;Editor.log(Editor.T("vivo-runtime.rpk_install_success")+i),k.reply(),function(){let e={resUrl:u.tinyPackageServer,orientation:u.deviceOrientation,projectName:u.name};if(Editor.Ipc.sendToMain("builder:notify-build-result",P,e),!0===u.useDebugKey||u.package.indexOf("test")>-1||u.name.indexOf("test")>-1||!0===b)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","vivo-runtime",{packageName:u.package,appName:u.name,version:u.versionName,orientation:u.deviceOrientation})}()})}module.exports={name:Editor.T("vivo-runtime.platform_name"),platform:"qgame",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"script-build-finished":function(i,n){let t=Editor.Profile.load(e);n.settings.server=t.get("tinyPackageServer")||"",i.reply()},"build-start":function(i,n){let t=Editor.Profile.load(e).getSelfData();if(y.init(n,t.npmPath,t.showNpmPath),!1===y.isInstallNodeJs(i,t.npmPath))return;if(!1===y.isInstallVivoMinigameTool())return i.reply(new Error("please install tools: npm install -g @vivo-minigame/cli@latest")),void 0;let o=y.isCliProject();if(!1===y.isInitVivoProject()||!1===o)return!1===o&&f.emptyDirSync(n.dest),y.initVivoProject(function(e){if(e)return Editor.log("init  game project failed"),void 0;f.emptyDirSync(g.join(n.dest,"src")),i.reply()}),void 0;i.reply()},"build-finished":function(i,n){k=i,P=n;let t=(u=Editor.Profile.load(e).getSelfData()).package,o=u.name,r=u.icon,a=u.versionName,s=u.versionCode,c=u.minPlatformVersion;h=u.showNpmPath,b=n.debug,sendStatisticsSourceMaps=n.sourceMaps,p=r||"",p=r.trim(),E=u.privatePath||"",S=u.certificatePath||"",_=u.useDebugKey;let l=!0,d=[],m="";if([{name:Editor.T("vivo-runtime.package"),value:t},{name:Editor.T("vivo-runtime.name"),value:o},{name:Editor.T("vivo-runtime.desktop_icon"),value:r},{name:Editor.T("vivo-runtime.version_name"),value:a},{name:Editor.T("vivo-runtime.version_number"),value:s},{name:Editor.T("vivo-runtime.support_min_platform"),value:c}].forEach(function(e){e.value||(l=!1,d.push(e.name))}),l||(m+=d.join("、")+Editor.T("vivo-runtime.not_empty")),r&&(f.existsSync(p)||(l=!1,m+=r+Editor.T("vivo-runtime.icon_not_exist"))),_||(""===E?(l=!1,m+=Editor.T("vivo-runtime.select_private_pem_path")):f.existsSync(E)||(l=!1,m+=`${E} `+Editor.T("vivo-runtime.signature_not_exist")),""===S?(l=!1,m+=Editor.T("vivo-runtime.select_certificate_pem_path")):f.existsSync(S)||(l=!1,m+=`${S}`+Editor.T("vivo-runtime.signature_not_exist"))),!l)return k.reply(new Error(m)),void 0;f.existsSync(g.join(n.dest,"remote"))&&""===u.tinyPackageServer&&Editor.warn(Editor.T("vivo-runtime.had_set_remote_without_tiny_mode")),$(k,n)},play:(e,i)=>{Editor.Panel.open("vivo-runtime.qrcode",i)}},delPattern:function(e){let i=e.dest;return[g.join(i,"**/*"),`!${g.join(i,".eslintrc.json")}`,`!${g.join(i,".npmignore")}`,`!${g.join(i,"babel.config.js")}`,`!${g.join(i,"minigame.config.js")}`,`!${g.join(i,"package.json")}`,`!${g.join(i,"package-lock.json")}`,`!${g.join(i,"node_modules")}`,`!${g.join(i,"node_modules","**/*")}`]},md5:{globalIgnore:function(){return[/.*/]}},buildStart:function(i){let n=Editor.Profile.load(e);i.startSceneAssetBundle=n.get("packFirstScreenRes")||!1,i.separateEngineMode=n.get("separateEngineMode")||!1},settings:Editor.url("packages://vivo-runtime/build-ui.js")};