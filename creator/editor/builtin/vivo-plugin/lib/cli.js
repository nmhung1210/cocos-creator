var{exec:t,execSync:n}=require("child_process"),e=require("path"),i=require("fire-fs"),o=require("fix-path"),r=require("net");function s(t){var n=new r.Socket,e=!1;n.connect("443","www.google-analytics.com",()=>{n.end(),!1===e&&(e=!0,t(!0))}),setTimeout(function(){n.end(),!1===e&&(e=!0,t(!1))},1e3)}let a={init:function(t,n,e){this.options=t,this.initEnvironmentPath(n,e)},initVivoProject:function(n){Editor.log(Editor.T("vivo-runtime.installing_npm_network")),t("mg init qgame --force",{env:this.environmentPath,cwd:e.join(this.options.dest,"..")},t=>{n(t)})},initEnvironmentPath:function(t,n){this.environmentPath={},t?(Editor.log(Editor.T("vivo-runtime.custom_npm_path_config"),t),"win32"===process.platform?this.environmentPath.Path=t:(this.environmentPath.PATH=t,this.environmentPath.PATH+=":/usr/bin:/bin:/usr/sbin:/sbin")):(n&&Editor.log(Editor.T("vivo-runtime.custom_npm_path_not_config")),o(),this.environmentPath=process.env)},isInitVivoProject:function(){return!(!i.existsSync(e.join(this.options.dest,"node_modules"))||i.existsSync(e.join(this.options.dest,"node_modules",".staging")))},isInstallVivoMinigameTool:function(){try{result=n("mg -v",{env:this.environmentPath})}catch(t){return!1}return!0},isCliProject:function(){return!!i.existsSync(e.join(this.options.dest,"node_modules","@vivo-minigame"))},getEnvirommentPath:function(){return this.environmentPath},isInstallNodeJs:function(t,e){try{n("node -v",{env:this.environmentPath})}catch(n){return e?(t.reply(new Error(Editor.T("vivo-runtime.custom_npm_path_config_error"))),void 0):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),t.reply(),"win32"===process.platform?Editor.log(Editor.T("vivo-runtime.not_install_nodejs_windows_error")):Editor.log(Editor.T("vivo-runtime.not_install_nodejs_mac_error")),!1)}return!0},isInstallQGameAdapter:function(){return!!i.existsSync(this.getQGameAdapterPath())},installQGameAdapter:function(n){var e=this;s(function(i){if(!1===i)return n("no internet"),void 0;var o="win32"===process.platform?"npm.cmd":"npm";t(`${o} i -S @qgame/adapter@latest`,{env:e.environmentPath,cwd:e.options.dest},t=>{n(t)})})},isLatestVersion:function(n){let o=this;s(function(r){if(!1===r)return n(!1),void 0;if(!o.isInstallQGameAdapter())return n(!1),void 0;var s=e.join(o.options.dest,"node_modules","@qgame","adapter","package.json"),a=i.readJsonSync(s,{throws:!1});if(null===a)return n(!1),void 0;Editor.log("the current version @qgame/adapter is:",a.version);var d="win32"===process.platform?"npm.cmd":"npm";t(`${d} view @qgame/adapter@latest version`,{env:o.environmentPath,cwd:o.options.dest},(t,e)=>{if(t)return n&&n(o.isInstallQGameAdapter(),t),void 0;let i=e.toString().trim();if(Editor.log("the latest version of @qgame/adapter is:",i),a&&a.version===i)return n(!0),void 0;n(!1)})})},getQGameAdapterPath:function(){return e.join(this.options.dest,"node_modules","@qgame","adapter","dist","main.js")},isSupportSeparateEngine:function(t){var n=e.join(this.options.dest,"package.json"),o=i.readJsonSync(n,{throws:!1}).devDependencies["@vivo-minigame/cli-service"];return parseInt(o.replace(/[^\d]/g,""))>=parseInt("1.3.0".replace(/[^\d]/g,""))}};module.exports=a;