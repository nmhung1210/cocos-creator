let e=require("./jszip.min.js"),i=require("path"),t=require("fs-extra"),a=require("./worker-util.js"),r=require("./adapter-util.js"),n=require("./tinypack-util.js"),o=require("./separate-engine-util.js"),s={};e.prototype.directory=function(e,a){if(!t.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;t.readdirSync(e).forEach(function(e){let a=this.zip,r=i.join(this.srcPath,e),n=t.statSync(r);n.isDirectory()?a.directory(r,e):n.isFile()?a.file(e,t.readFileSync(r)):Editor.error(r+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(a)}))},e.prototype.append=function(e,i){if(!t.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(i,t.readFileSync(e))},module.exports={async gatherInfo(c,d){if(s.customConfig=Editor.Profile.load("project://cpk-publish.json").getSelfData(),!1===this.checkData(s,c,d))return!1;s.md5Cache=d.md5Cache;let p=s.customConfig;s.isTinyPackage=""!==p.tinyPackageServer,s.projectPath=d.project,s.buildPath=d.dest,s.options=d,s.title=d.title,s.cpkName=d.title+".cpk";let u=p.outputCpkPath,l=p.useCustomCpkPath;return s.buildResults=d.buildResults,s.startScene=d.startScene,!0===l?""!==u&&t.existsSync(u)?s.cpkPath=i.join(u,s.cpkName):(Editor.log(Editor.T("cpk-publish.out_cpk_path_error")),s.cpkPath=i.join(s.buildPath,s.cpkName)):s.cpkPath=i.join(s.buildPath,s.cpkName),s.gameConfig={deviceOrientation:p.deviceOrientation,showStatusBar:p.showStatusBar,runtimeVersion:p.runtimeVersion},s.JsZip=e,s.cpk=new e,await a.gatherInfo(s),await r.gatherInfo(s),await n.gatherInfo(s),await o.gatherInfo(s),!0},checkData:(e,a,r)=>(0,t.existsSync(i.join(r.dest,"remote"))&&""===e.customConfig.tinyPackageServer&&Editor.warn(Editor.T("cpk-publish.had_set_remote_without_tiny_mode")),!0),async organizeResources(e){let n=s.buildPath;return await a.organizeResources(),!1!==await r.organizeResources(e)&&(await o.organizeResources(),t.writeJSONSync(i.join(n,"game.config.json"),s.gameConfig),this.handleMainJS(),!0)},handleMainJS(){var e=i.join(s.buildPath,"main.js"),a=t.readFileSync(e,"utf8");if("landscape"===s.customConfig.deviceOrientation){var r="require('jsb-adapter/engine/index.js');",n=a.indexOf(r)+r.length;a=a.slice(0,n)+"\nloadRuntime().callCustomCommand({}, 'setOrientation', '{\"orientation\":0}');\nwindow.orientation = 90;"+a.slice(n)}t.writeFileSync(e,a)},async pack(){let e=s.cpk,c=s.cpkPath,d=s.buildPath;t.existsSync(c)&&t.unlinkSync(c);let p=t.createWriteStream(c);await a.pack(),await r.pack(),await n.pack(),await o.pack(),e.directory(i.join(d,"src"),"src"),e.directory(i.join(d,"assets"),"assets"),e.append(i.join(d,"main.js"),"main.js"),e.append(i.join(d,"game.config.json"),"game.config.json"),e.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(p).on("finish",function(){n.packFinished()})}};