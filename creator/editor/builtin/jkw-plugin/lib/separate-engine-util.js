let e=require("path"),r=require("fs-extra"),o=(require("glob"),require("crypto"));let i,n,c,s,t,a,u,d,p=!1,l={cocos:{provider:"com.cocos.creator.engine2d",version:Editor.versions.CocosCreator,path:"cocos"}},m={main:"cocos2d-runtime.js"},g={provider:"com.cocos.creator.engine2d",signature:[{path:"cocos2d-runtime.js",md5:""}]};module.exports={gatherInfo(r){i=r.cpk,d=r.gameConfig,p=r.customConfig.separateEngineMode;let o=r.buildPath;n=e.join(o,"cocos"),c=e.join(o,"src","cocos2d-runtime.js"),s=e.join(n,"cocos2d-runtime.js");Editor.url("packages://runtime-adapters/platforms/cocos-play");u=e.join(o,"main.js"),t=e.join(n,"plugin.json"),a=e.join(n,"signature.json")},organizeResources(){if(!p)return;Editor.info(Editor.T("cpk-publish.separate_engine_begin_hint")),r.existsSync(n)||r.ensureDirSync(n),r.moveSync(c,s);let e=r.readFileSync(s);g.signature[0].md5=o.createHash("md5").update(e).digest("hex"),r.writeJSONSync(t,m),r.writeJSONSync(a,g);let i=Editor.url("packages://runtime-adapters/platforms/cocos-play/res/main.js"),j=r.readFileSync(i,"utf-8");if(j.indexOf("require('src/cocos2d-runtime.js');")>-1){let e="if (typeof requirePlugin === 'function') {\n\trequirePlugin('cocos');\n} else {\n\trequire('cocos/cocos2d-runtime.js');\n}";j=j.replace("require('src/cocos2d-runtime.js');",e),r.writeFileSync(u,j)}d.plugins=l,Editor.info(Editor.T("cpk-publish.separate_engine_end_hint"))},pack(){p&&i.directory(n,"cocos")}};