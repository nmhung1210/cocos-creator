const e="project://huawei-runtime.json",i="manifest.json",t=Editor.url("packages://runtime-adapters/package/index.js");var n,r,a,o,s,u,d,c,m,p,l,f,g,h=require("path"),v=require("fs-extra"),y=require("fix-path"),_="game.js",E={},w=!1;function j(e){let i=Editor.url("packages://runtime-adapters/platforms/huawei");return void 0===e||""===e?i:h.join(i,e)}function S(e){let i=Editor.url("packages://runtime-adapters/common/res");return void 0===e||""===e?i:h.join(i,e)}function b(e,t){v.emptyDirSync(t);var r=h.join(e.dest,"assets"),a=h.join(e.dest,"remote"),s=h.join(e.dest,"src"),d=h.join(e.dest,"jsb-adapter"),c=h.join(e.dest,"subpackages"),m=h.join(t,"jsb-adapter"),l=h.join(t,"assets"),f=h.join(t,"remote"),g=h.join(t,"src"),y=h.join(t,"subpackages");v.copySync(d,m),!1===(""!==n.tinyPackageServer)&&v.existsSync(a)&&v.copySync(a,f),v.copySync(r,l),v.copySync(s,g),v.existsSync(c)&&v.copySync(c,y),function(e){var i=h.join(e,"image");v.ensureDirSync(i),v.writeFileSync(h.join(i,h.parse(o).base),v.readFileSync(o))}(t),function(e){v.copySync(h.join(j("res"),"main.js"),h.join(e,_))}(t),function(e){var t=h.join(e,i),r=n.package,a=n.name,s=n.versionName,d=n.versionCode,c=n.minPlatformVersion,m=n.deviceOrientation,l=n.logLevel,f={package:r,appType:"fastgame",name:a,versionName:s,versionCode:d,icon:`/image/${h.parse(o).base}`,minPlatformVersion:c,permissions:[{origin:"*"}],router:{}};if(u&&(f.subpackages=u),v.existsSync(p)){var g;try{g=v.readJsonSync(p),Editor.log(Editor.T("huawei-runtime.custom_manifest_data"),JSON.stringify(g))}catch(e){Editor.log(Editor.T("huawei-runtime.custom_manifest_data_error"))}if(g)for(var y in g)"package"!==y&&"appType"!==y&&"name"!==y&&"versionName"!==y&&"versionCode"!==y&&"icon"!==y&&"minPlatformVersion"!==y&&"permissions"!==y&&(f[y]=g[y])}var _={},E={};f.config&&(_=f.config),f.display&&(E=f.display),_.logLevel=l,E.orientation=m,E.fullScreen=n.fullScreen,f.display=E;var w=JSON.stringify(f);v.writeFileSync(t,w)}(t)}function T(e,i){Editor.log("Checking config file "+i.dest),r=i.dest,a=h.join(r,"build"),s=Editor.url("packages://runtime-adapters/package"),i.dest,v.emptyDirSync(a);var t=h.join(r,"build");(function(e){u=[];let i=[];for(var t=0,n=e.bundles.length;t<n;t++){var r=e.bundles[t];if("subpackage"!==r.compressionType)continue;let n=r.name,o=h.join(a,"assets",n);if(i.includes(o))continue;i.push(o);let s=h.join(r.scriptDest,"index.js");v.existsSync(s)&&v.renameSync(s,h.join(r.scriptDest,"game.js")),u.push({name:n,resource:"subpackages/"+n})}})(i),v.emptyDirSync(h.join(r,"dist")),async function(){let a=require("./build-jsb-adapter"),o=h.join(j("engine"),"index.js"),u=h.join(r,"jsb-adapter","engine","index.js");await a.build({rootPath:o,dstPath:u,isDebug:g.debug}),b(i,t),function(){var i=require("child_process").exec,t="win32"===process.platform?"npm.cmd":"npm";E={},n.npmPath?(w=!1,Editor.log(Editor.T("huawei-runtime.custom_npm_path_config"),n.npmPath),"win32"===process.platform?E.Path=n.npmPath:E.PATH=n.npmPath):(f&&Editor.log(Editor.T("huawei-runtime.custom_npm_path_not_config")),w||(w=!0,y()),E=process.env);(function(a){i(`${t} -v`,{env:E,cwd:r},i=>{if(i){if(n.npmPath)return e.reply(new Error(Editor.T("huawei-runtime.custom_npm_path_config_error"))),void 0;if(Editor.Ipc.sendToWins("builder:events","npmPath-show"),"win32"===process.platform)return e.reply(new Error(Editor.T("huawei-runtime.window_default_npm_path_error"))),void 0;e.reply(new Error(Editor.T("huawei-runtime.mac_default_npm_path_error")))}else a&&a()})})(function(){if(v.existsSync(h.join(s,"node_modules")))k(e,i);else{Editor.log(Editor.T("huawei-runtime.begin_install_npm")),void i(`${t} install`,{env:process.env,cwd:s},t=>{if(!t)return Editor.log(Editor.T("huawei-runtime.npm_installed_success")),k(e,i),void 0;e.reply(new Error(Editor.T("huawei-runtime.npm_installed_success")+t))})}})}()}()}function k(e,i){var a=h.join(r,"dist"),o=h.join(r,"build"),s=m?S("private.pem"):d,u=m?S("certificate.pem"):c,p=n.package,f=`node ${t} ${o} ${a} ${p} ${s} ${u}`;Editor.log(Editor.T("huawei-runtime.rpk_installing")),i(`${f}`,{env:E,cwd:r},i=>{if(i)return e.reply(new Error(Editor.T("huawei-runtime.rpk_install_fail")+i)),void 0;Editor.log(Editor.T("huawei-runtime.rpk_install_success")),function(){let e={resUrl:n.tinyPackageServer,orientation:n.deviceOrientation,projectName:n.name};if(Editor.Ipc.sendToMain("builder:notify-build-result",g,e),!0===n.useDebugKey||n.package.indexOf("test")>-1||n.name.indexOf("test")>-1||!0===l)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","huawei-runtime",{packageName:n.package,appName:n.name,version:n.versionName,orientation:n.deviceOrientation})}(),e.reply()})}module.exports={name:Editor.T("huawei-runtime.platform_name"),platform:"huawei",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"script-build-finished":function(i,t){let n=Editor.Profile.load(e);t.settings.server=n.get("tinyPackageServer")||"",i.reply()},"build-finished":function(i,t){g=t;var r=(n=Editor.Profile.load(e).getSelfData()).package,a=n.name,s=n.icon,u=n.versionName,y=n.versionCode,_=n.minPlatformVersion;f=n.showNpmPath,d=n.privatePath,c=n.certificatePath,m=n.useDebugKey,o=s||"",p=n.manifestPath,l=t.debug,sendStatisticsSourceMaps=t.sourceMaps,p||Editor.log(Editor.T("huawei-runtime.not_mainfest_data"));var E=!0,w=[],j="";if([{name:Editor.T("huawei-runtime.package"),value:r},{name:Editor.T("huawei-runtime.name"),value:a},{name:Editor.T("huawei-runtime.desktop_icon"),value:s},{name:Editor.T("huawei-runtime.version_name"),value:u},{name:Editor.T("huawei-runtime.version_number"),value:y},{name:Editor.T("huawei-runtime.support_min_platform"),value:_}].forEach(function(e){e.value||(E=!1,w.push(e.name))}),E||(j+=w.join("、")+Editor.T("huawei-runtime.not_empty")),s&&(v.existsSync(o)||(E=!1,j+=s+Editor.T("huawei-runtime.icon_not_exist"))),m||(""===d?(E=!1,j+=Editor.T("huawei-runtime.private_pem_path_error")):v.existsSync(d)||(E=!1,j+=`${d}`+Editor.T("huawei-runtime.signature_not_exist")),""===c?(E=!1,j+=Editor.T("huawei-runtime.certificate_pem_path_error")):v.existsSync(c)||(E=!1,j+=`${c} `+Editor.T("huawei-runtime.signature_not_exist"))),!E)return i.reply(new Error(j)),void 0;v.existsSync(h.join(t.dest,"remote"))&&""===n.tinyPackageServer&&Editor.warn(Editor.T("huawei-runtime.had_set_remote_without_tiny_mode")),T(i,t)},play:(e,i)=>{Editor.Panel.open("runtime-dev-tools",i)}},md5:{globalIgnore:function(){return[/.*/]}},buildStart:function(i){let t=Editor.Profile.load(e);i.startSceneAssetBundle=t.get("packFirstScreenRes")||!1},delPattern:function(e){let i=e.dest;return[h.join(i,"**/*")]},settings:Editor.url("packages://huawei-runtime/build-ui.js")};