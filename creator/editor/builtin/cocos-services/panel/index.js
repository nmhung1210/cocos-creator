window.CocosServices={},window.ccServices={},window.CocosServicesUpdate=!1;let e=Editor.require("packages://cocos-services/panel/utils/ccServices.js"),i=Editor.require("packages://cocos-services/panel/utils/utils.js"),s=Editor.require("packages://cocos-services/panel/utils/serviceConfig.js");Editor.require("packages://cocos-services/panel/utils/ccServicesAnalytics.js");let t=Editor.require("packages://cocos-services/panel/bindGame/bindGame.js"),a=Editor.require("packages://cocos-services/panel/serviceList/serviceList.js"),c=Editor.require("packages://cocos-services/panel/serviceDetail/serviceDetail.js"),r=Editor.require("packages://cocos-services/panel/toast/toast.js"),o=require("fs");window.fs=o,window.ccServices=e;const n=i.getProjectID();let d=async()=>{await e.init()};Editor.Panel.extend({style:o.readFileSync(Editor.url("packages://cocos-services/panel/assets/style.css","utf8")),template:`\n  <body class='body'>\n    <div id="loader-wrapper">\n      <div id="loader"></div>\n      <div class="loader-section section-left"></div>\n      <div class="loader-section section-right"></div>\n      <br>\n      <div class="load_title">\n        <br>\n        ${i.t("load_cocos_services")}\n        <br>\n        <span> V${e.getCreatorVersion()}</span>\n      </div>\n    </div>\n    <div style="overflow-x: hidden; overflow-y: auto; height:100%;">\n      <toast v-show="visible" :message="message" :visible="visible" :status="status"></toast>\n      <bind-game v-if="isShowBindGame" :islogin="isLogin" @back-home="backHome" @bind-game="bindGameLogic"></bind-game>\n      <service-list v-if="isShowHome" :isCompanyGame="isCompanyGame" :game="game" :services="services" @service-item-click="serviceItemClick" @bind-game="bindGame" @unbind-game="unbindGame"></service-list>\n      <service-detail v-if="isShowService" @back-home="backHome" @enable-service="enableService" :service="service"></service-detail>\n      <ui-loader class="massive" v-if="isDownloadServicePackage"><div style="margin-top:10px; font-size: 14px;">{{ downloadTip }}</div></ui-loader>\n    </div>\n  </body>\n  `,$:{loader_wrapper:"#loader-wrapper",loader_service:"ui-loader"},async ready(){this.$loader_service.hidden=!0;this.$loader_wrapper,this.$loader_service;if(await d(),t.init(),a.init(),c.init(),r.init(),Editor.User.on("login",d),Editor.User.on("logout",d),e.registerServiceComponent(),Editor.Ipc.sendToMain("cocos-services:panel-status-changed","cocos-services",!0),window.CocosServicesUpdate=!1,0!==this.clientHeight){var l=s.readBindGame();l||(l={app_id:"UNKNOW"}),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(e.getUserData().cocos_uid,l,{}),window.ccServicesAnalytics&&window.ccServicesAnalytics.openServicePanel()}this._vm=function(t){return new window.Vue({el:t.shadowRoot,data:{message:"123",visible:!1,status:2,isLogin:!1,isBindGame:!1,isShowBindGame:!1,isShowHome:!0,isShowService:!1,isCompanyUser:!1,isCompanyGame:!1,isItemClickToBindGame:!1,isUpdate:!1,isDownloadServicePackage:!1,downloadTip:i.t("installing"),service:{},game:{name:i.t("unknow_game"),appid:"UNKNOW"},user:{},services:[]},watch:{async game(i,t){var a=s.readEnableService();for(var c of this.services)Vue.set(c,"enable",-1!==a.indexOf(c.service_id)),"UNKNOW"===i.appid?c.service_type:("0"===i.cid,c.service_type),Vue.set(c,"hovered",!0);e.getUserIsLogin()&&await e.getGameDetail(this.game.appid)}},created(){t.$loader_wrapper.hidden=!0,t.$loader_service.hidden=!1;var a=s.readBindGame();a&&"UNKNOW"!=a.appid&&this.checkGameOwner(a)?(this.game=a,this.isBindGame=!0,this.isCompanyGame="0"!==a.cid):(this.game={name:i.t("unknow_game"),appid:"UNKNOW"},this.isBindGame=!1,this.isCompanyGame=!1,s.writeBindGame(this.game)),this.services=s.readServiceList(),this.user=e.getUserData(),this.isCompanyUser=0!==this.user.corporation_id,this.isLogin=e.getUserIsLogin(),this.readEnableService();var c=i.getCreatorHomePath()+"/services";!o.existsSync(c)&&i.mkdirs(c),this.watchFiles(c,(e,s,t)=>{e&&!window.CocosServicesUpdate&&(this.enableService(s,!1),i.printToCreatorConsole("warn",t+" - "+i.t("service_delete_accident")),this.isShowHome=!1,this.isShowService=!1,this.isShowBindGame=!0,this.$nextTick(()=>{this.isShowHome=!0,this.isShowService=!1,this.isShowBindGame=!1})),window.CocosServicesUpdate=!1}),e.removeAll("service:query-service-enable"),e.on("service:query-service-enable",(e,i)=>{if(!this.isBindGame)return i&&i(null,!1);for(var s of this.services)if(s.service_component_name===e.service_component_name)return i&&i(null,s.enable);i&&i(null,"test")})},methods:{showTips:function(e,i,s=1500){this.visible=!0,this.status=e,this.message=i,-1!==s&&setTimeout(()=>this.visible=!1,s)},utils_t:function(e,...s){return i.t(e,...s)},backHome:function(){this.isShowHome=!0,this.isShowService=!1,this.isShowBindGame=!1},serviceItemClick:function(e){if("UNKNOW"!=this.game.appid)if(this.isCompanyUser){if(this.isCompanyGame){if("1"===e.service_type)return i.printToCreatorConsole("warn",this.utils_t("select_person_service")),void 0}else if("2"===e.service_type)return i.printToCreatorConsole("warn",this.utils_t("select_company_service")),void 0}else if("2"===e.service_type)return i.printToCreatorConsole("warn",this.utils_t("select_company_service")),void 0;this.isShowHome=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,e),"0"===e.service_type||this.isBindGame?(this.isShowService=!0,this.isShowBindGame=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterService()):(this.isShowService=!1,this.isShowBindGame=!0,this.isItemClickToBindGame=!0,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterBindCocosAppID());var s=e.service_dev_url;s.match(/<app_id>/)?s=s.replace("<app_id>",this.game.appid):s.match(/app_id=\d+/)&&(s=s.replace(/app_id=\d+/,`app_id=${this.game.appid}`)),e.service_dev_url=s,this.service=e},checkGameOwner:function(s){var t=e.getGameLists();if(!t)return!1;for(var a of t.data)if(a.app_id===s.appid)return!0;return i.printToCreatorConsole("warn",this.utils_t("not_owner")),!1},bindGameLogic:async function(t){if(this.game=t,""!==n){var a=await e.associateProjectID(this.game.appid,n,1);if(0!==a.status)return i.printToCreatorConsole("warn",i.validateString(a.msg)?`${a.msg} err_code: ${a.status}`:`${this.utils_t("bind_game_failed")} err_code: ${a.status}`),void 0}s.writeBindGame(this.game),"UNKNOW"!=t.appid&&(this.isBindGame=!0),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,this.service),window.ccServicesAnalytics&&window.ccServicesAnalytics.associateAppID(),this.isItemClickToBindGame?(this.isShowHome=!1,this.isShowService=!0,"0"===this.game.cid&&"2"===this.service.service_type?(i.printToCreatorConsole("warn",this.utils_t("select_company_service")),setTimeout(()=>{Editor.Dialog.messageBox({title:this.utils_t("dialog_title"),message:this.utils_t("select_company_service"),buttons:[this.utils_t("btn_ok")],defaultId:0,noLink:!0}),this.isShowHome=!0,this.isShowService=!1},1e3)):"0"!==this.game.cid&&"1"===this.service.service_type&&(i.printToCreatorConsole("warn",this.utils_t("select_person_service")),setTimeout(()=>{Editor.Dialog.messageBox({title:this.utils_t("dialog_title"),message:this.utils_t("select_person_service"),buttons:[this.utils_t("btn_ok")],defaultId:0,noLink:!0}),this.isShowHome=!0,this.isShowService=!1},1e3)),this.isShowService&&window.ccServicesAnalytics&&window.ccServicesAnalytics.enterService()):(this.isShowHome=!0,this.isShowService=!1),this.isShowBindGame=!1,this.isCompanyGame="0"!==this.game.cid,this.readEnableService()},readEnableService:function(){var t=s.readEnableService();for(var a of this.services)Vue.set(a,"enable",t.indexOf(a.service_id)>=0),a.enable&&(e.serviceExists(a.service_component_name)||(i.printToCreatorConsole("warn",a.service_name+this.utils_t("service_not_install")),this.isDownloadServicePackage=!0,e.installServicePackage(a.package_download_url,a.service_component_name,e=>{this.downloadTip=e.text,this.isDownloadServicePackage=!1,this.$nextTick(()=>this.isDownloadServicePackage=!0),e.complete&&("failed"===e.text&&i.printToCreatorConsole("warn",this.utils_t("download_failed")),this.isDownloadServicePackage=!0,this.$nextTick(()=>this.isDownloadServicePackage=!1))})))},unbindGame:async function(){if(this.isBindGame=!1,""!==n){var t=await e.associateProjectID(this.game.appid,n,0);if(0!==t.status)return i.printToCreatorConsole("warn",i.validateString(t.msg)?`${t.msg} err_code: ${t.status}`:`${this.utils_t("unbind_game_failed")} err_code: ${t.status}`),void 0}this.game={name:i.t("unknow_game"),appid:"UNKNOW"},s.writeBindGame(this.game),this.readEnableService(),window.ccServicesAnalytics&&window.ccServicesAnalytics.unassociateAppID(),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,this.service)},bindGame:function(){this.isShowHome=!1,this.isShowBindGame=!0,this.isItemClickToBindGame=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterBindCocosAppID()},enableService:function(e,i){for(var t of this.services)t.service_id===e&&(t.enable=i,s.wirteEnableService(e,t.enable))},watchFiles:function(e,s){var t=this.services;i.watch.createMonitor(e,i=>{i.on("removed",(i,a)=>{var c=i.substr(e.length+1);if(c.indexOf("/")<=-1)for(var r of t)if(r.service_component_name.indexOf(c)>=0)return s&&s(!0,r.service_id,r.service_name),void 0})})}}})}(this),window.CocosServices=this._vm},close(){Editor.User.removeListener("login",d),Editor.User.removeListener("logout",d),Editor.Ipc.sendToMain("cocos-services:panel-status-changed","cocos-services",!1)},listeners:{"panel-show"(){var i=s.readBindGame();i||(i={app_id:"UNKNOW"}),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(e.getUserData().cocos_uid,i,{}),window.ccServicesAnalytics&&window.ccServicesAnalytics.openServicePanel()}},messages:{"before-change-files"(i,s){e.execInstallNativePlatformScript(s,e=>{1,i.reply&&i.reply(null,"Cocos Service install successfully")})},"plugin-messages"(i,s,t){e.emit(s,t,(e,s)=>i.reply&&i.reply(e,s))}}});