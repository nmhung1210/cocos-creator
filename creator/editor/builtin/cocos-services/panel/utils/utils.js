"use strict";const e=require("fire-fs"),r=require("path"),t=require("./jszip"),i=require("compressing"),n=require("watch");let o=y()+"/local/logs/service.log";var s;function c(t){e.existsSync(r.dirname(t))||c(r.dirname(t)),e.mkdirSync(t)}function a(t,i){var n=r.dirname(i);!e.existsSync(n)&&c(n),e.copySync(String(t),String(i))}function l(r){try{return JSON.parse(e.existsSync(r)?e.readFileSync(r,"utf8"):"{}")}catch(e){return null}}function d(r,t){e.writeFileSync(r,JSON.stringify(t,null,"\t"))}function f(r,t=!1){var i=[];return e.readdirSync(r).forEach(n=>{var o=r+"/"+n,s=e.statSync(o);s&&s.isDirectory()?(t&&i.push(o+"/"),i=i.concat(f(o,t))):i.push(o)}),i}function u(r,t,i){var n=f(r,!0),o=n.length,s=0,l="";for(var d of(0==e.existsSync(t)&&c(t),n)){if("/"===(l=d.replace(r,t)).charAt(l.length-1)?0==e.existsSync(l)&&c(l):a(d,l),i)i(++s/o*100|0)}}function p(r){if(e.existsSync(r)){for(var t of e.readdirSync(r)){var i=r+"/"+t;e.statSync(i).isDirectory()?p(i):e.unlinkSync(i)}e.rmdirSync(r)}}function h(){return Editor.isMainProcess?Editor.Project?Editor.Project:Editor.projectInfo:Editor.remote.Project?Editor.remote.Project:Editor.remote.projectInfo}function v(){return h().name}function y(){return h().path}module.exports={t:function(e,...r){return Editor.T(`cocos-services.${e}`,...r)},getLang:function(){return Editor.lang},getCreatorHomePath:function(){return Editor.isMainProcess?Editor.App.home:Editor.remote.App.home},getProjectInfo:h,getProjectPath:y,getProjectName:v,getProjectID:function(){return void 0!==h().id?h().id:""},validateString:function(e){return void 0!==e&&""!==e},zip:function(e,t,n){var o=`${t||r.dirname(e)}/${r.basename(filename)}.zip`;i.zip.compressDir(e,o).then(()=>n&&n(null,!0)).catch(e=>n&&n(e,!1))},unzip:function(e,r,t){i.zip.uncompress(e,r).then(()=>t(null)).catch(e=>t(e))},mkdirs:c,copyDir:u,moveDir:function(e,r,t){u(e,r,t),p(e)},removeDir:p,walk:f,copyFile:a,readJson:l,saveJson:d,parseProjectJson:function(e,r,t=!1){var i=l(e);i.serviceClassPath||(i.serviceClassPath=[]);if(t)i.serviceClassPath.indexOf(r)<=-1&&i.serviceClassPath.push(r);else{var n=i.serviceClassPath.indexOf(r);n>=-1&&i.serviceClassPath.splice(n,1)}this.printLog(`insert array element to "${e}" node of serviceClassPath`),d(e,i)},insertCodeLine:function(r,t,i,n=!1){if(!e.existsSync(r))return;let o=e.readFileSync(r,"utf8").split("\n");for(let e=0;e<o.length;e++)if(o[e].match(t)){o.splice(n?e:e+1,0,i);break}e.writeFileSync(r,o.join("\n"))},appendCodeLine:function(r,t){if(!e.existsSync(r))return;let i=e.readFileSync(r,"utf8");i+=t,e.writeFileSync(r,i)},copyServicePackages:function(r){r.forEach(r=>{e.statSync(r.src).isDirectory()?(u(r.src,r.dst),this.printLog(`copy folder "${r.src} to "${r.dst}"`)):(a(r.src,r.dst),this.printLog(`copy file "${r.src} to "${r.dst}"`))})},deleteServicePackages:function(r){r.forEach(r=>{e.statSync(r.src).isDirectory()?(p(r.dst),this.printLog(`delete folder from "${r.dst}"`)):(e.existsSync(r.dst)&&e.unlinkSync(r.dst),this.printLog(`delete file from"${r.dst}"`))})},printLog:function(t,i=!1){s||(e.existsSync(r.dirname(o))||this.mkdirs(r.dirname(o)),s=e.createWriteStream(o,{flags:"a"}));try{var n=`Cocos Service ${(new Date).toLocaleString()} ${v()}\t${t}\n\n`;i&&this.printToCreatorConsole("log",n),s.write(n)}catch(e){console.error(e)}},openUrlWithDefaultExplorer:function(e){require("electron").shell.openExternal(e)},printToCreatorConsole:function(e,r){var t="Cocos Service --- "+r;"log"===e?Editor.isMainProcess?Editor.log(t):Editor.Ipc.sendToMain("cocos-services:log",t):"error"===e?Editor.isMainProcess?Editor.error(t):Editor.Ipc.sendToMain("cocos-services:error",t):"info"===e?Editor.isMainProcess?Editor.info(t):Editor.Ipc.sendToMain("cocos-services:info",t):"warn"===e?Editor.isMainProcess?Editor.warn(t):Editor.Ipc.sendToMain("cocos-services:warnning",t):"success"===e?Editor.isMainProcess?Editor.success(t):Editor.Ipc.sendToMain("cocos-services:success",t):"failed"===e&&(Editor.isMainProcess?Editor.failed(t):Editor.Ipc.sendToMain("cocos-services:failed",t))},unzipWithProgress:function(r,i,n){var o=i;"/"!=o.charAt(o.length-1)&&(i+="/");var s=new t;try{e.readFile(r,function(r,t){if(r)throw n&&n(r,null),r;s.loadAsync(t).then(r=>{var t=[];for(var o in r.files)t.push(o);t.sort();var s=t.length,a=0;for(var o of t){var l=i+o;"/"===o.charAt(o.length-1)?0==e.existsSync(l)&&c(l):r.file(o).nodeStream().pipe(e.createWriteStream(l)).on("finish",function(){e.chmodSync(l,493)}),n&&n(null,{status:"unziping",progress:++a/s*100|0})}n&&n(null,{status:"complete",progress:100})})})}catch(e){n&&n(e,null)}},watch:n};