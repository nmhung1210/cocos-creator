let e=require("./utils.js"),r=require("./network.js"),t=require("./serviceConfig.js"),s=require("fs");var i="https://creator-api.cocos.com/api/";"use strict";let a=new(require("events").EventEmitter);var n,o,c,d,v,l,u,_,p=!1,g=!1;Array.prototype.equals=function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var r=0,t=this.length;r<t;r++)if(this[r]instanceof Array&&e[r]instanceof Array){if(!this[r].equals(e[r]))return!1}else if(this[r]!=e[r])return!1;return!0},Object.defineProperty(Array.prototype,"equals",{enumerable:!1}),module.exports={async init(r=!1){if(!this.inited||r){if(this.readServiceConfig(),this.devmode&&console.log("ccServices init"),!g){var s=`Cocos Service Version ${this.getServiceVersion()}`;console.log(s),p&&!Editor.isMainProcess&&e.printToCreatorConsole("info",s),g=!0}if((_=await Editor.User.isLoggedIn())||p){n=p?await this.userLogin():await this.getSessionID();var i=await this.getSessionToken();n.session_token=i.data.session_token;var a=await this.getUserInfo();for(var o in a.data)n[o]=a.data[o];l={data:t.readBindGame()},c=await this.getGameList(),v=await this.getTargetUrl(),d=await this.getServiceList(),t.writeServiceList(d.data)}else n={corporation_id:"0"},l={data:t.readBindGame()},null==(d={data:t.readServiceList()}).data&&(d=await this.getServiceList(),t.writeServiceList(d.data));this.inited=!0,u||(u=t.readEnableService())}},readServiceConfig(){var e=t.readServiceConfig();if(this.debug=t.readDebugMode(),this.devmode=!1,this.readDevMode()){if(void 0===e.username||void 0===e.password)return;p=!0,this.devmode=!0,i="https://test-creator-api.cocos.com/api/",o={username:e.username,password:e.password}}},readDevMode:()=>t.readDevMode(),writeDevMode(e){t.writeDevMode(e),e||this.init()},registerServiceComponent(r){var t=e.getCreatorHomePath()+"/services";try{if(r){var i=r.split("-")[1],a=t+"/"+i+"/pages/index.js";s.existsSync(a)&&(delete require.cache[require.resolve(a)],this.registerI18n(r),require(a))}else{if(!s.existsSync(t))return;s.readdirSync(t).forEach(e=>{var r=t+"/"+e,i=s.statSync(r);i&&i.isDirectory()&&s.existsSync(r+"/pages/index.js")&&(delete require.cache[require.resolve(r+"/pages/index.js")],this.registerI18n(`service-${e}`),require(r+"/pages/index.js"))})}}catch(e){console.log(e)}},registerI18n(r){var t=e.getCreatorHomePath()+"/services",i=r.split("-")[1],a=t+"/"+i+`/pages/i18n/${e.getLang()}.js`;if(s.existsSync(a))try{delete require.cache[require.resolve(a)],Editor.i18n.extend({[`cocos-services.${i}`]:require(a)})}catch(e){}},readServicePackageInfo(r){if(!r||-1===r.indexOf("-"))return{version:e.t("not_installed")};var t=e.getCreatorHomePath()+"/services"+"/"+r.split("-")[1]+"/package.json";if(!s.existsSync(t))return{version:e.t("not_installed")};var i=e.readJson(t);return"zh"!==e.getLang()&&void 0!==i.upgrade_en&&(i.upgrade=i.upgrade_en,delete i.upgrade_en),i},readServiceVersionByURL(e){if(e){var r=e.split("/");return r[r.length-1].replace(".zip","")}return""},execInstallNativePlatformScript(r,i){this.readServiceConfig();var a=e.getCreatorHomePath()+"/services",n=t.readEnableService(),o=t.readServiceList();if(void 0===o)return e.printToCreatorConsole("warn","services not exists"),i(!0),void 0;if(!t.needExecNative())return i(!0),void 0;for(var c of(u||(u=n),this.backiOSPbxFile(r,!u.equals(n)),o)){var d=c.service_component_name.split("-")[1],v=a+"/"+d+"/install.js";if(s.existsSync(v)){var l=t.readServiceParam(c.service_id);try{delete require.cache[require.resolve(v)];var _=require(v);n.indexOf(c.service_id)>=0?_.onBuildedProjectEnable?(_.onBuildedProjectEnable(r,l),this.serviceIntegrationSubmit(c,"服务集成成功","Building Time")):p&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${c.service_name} SDK ${e.t("must_dev_info_install1")} -- ( onBuildedProjectEnable(options, params) {} )`):_.onBuildedProjectDisable?_.onBuildedProjectDisable(r,l):p&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${c.service_name} SDK ${e.t("must_dev_info_uninstall1")} -- ( onBuildedProjectDisable(options, params) {} )`)}catch(r){this.serviceIntegrationSubmit(c,"服务集成失败","Building Time",r.valueOf()),p&&e.printToCreatorConsole("warn",`${d}\n\t${r.valueOf()}`)}}}u=n,i(!0)},execInstallH5PlatformScript(r,t,i){this.readServiceConfig();var a=e.getCreatorHomePath()+"/services",n=r.service_component_name.split("-")[1],o=a+"/"+n+"/install.js";if(s.existsSync(o))try{delete require.cache[require.resolve(o)];var c=require(o);i?c.onServiceEnable?(c.onServiceEnable(e.getProjectPath(),t),this.serviceIntegrationSubmit(r,"服务集成成功","Editing Time")):p&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${r.service_name} JSSDK ${e.t("must_dev_info_install1")} -- ( onServiceEnable(projectPath, params) {} )`):c.onServiceDisable?c.onServiceDisable(e.getProjectPath(),t):p&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${r.service_name} JSSDK ${e.t("must_dev_info_uninstall1")} -- ( onServiceDisable(projectPath, params) {} )`)}catch(t){this.serviceIntegrationSubmit(r,"服务集成失败","Editing Time",t.valueOf()),p&&e.printToCreatorConsole("warn",`${n}\n\t${t.valueOf()}`)}},serviceIntegrationSubmit(e,r,s,i){var a={uid:n&&n.cocos_uid?n.cocos_uid:"",client_id:"CreatorServices",event:r,key_list:JSON.stringify(["app_id","app_name","service_id","service_name","version","cc_version","time",i?"error":""]),value_list:JSON.stringify([t.readBindGame().appid,t.readBindGame().name,e.service_id?e.service_id:"",e.service_name?e.service_name:"",this.getServiceVersion(),this.getCreatorVersion(),s,i?JSON.stringify(i):""])};this.submitLog(a)},serviceExists(r){var t=e.getCreatorHomePath()+"/services"+"/"+r.split("-")[1];return s.existsSync(t)},backiOSPbxFile(r,t){var i=r.dest+"/frameworks/runtime-src/proj.ios_mac/";if(s.existsSync(i)){var a=Date.parse(new Date),n=`${i}_backup/${r.projectName}.xcodeproj`,o=`${i}${r.projectName}.xcodeproj`;s.existsSync(n)?t&&(s.renameSync(o,`${i}_backup/${r.projectName}-${a}.xcodeproj`),e.copyDir(n,o)):e.copyDir(o,n)}},installServicePackage(t,s,i){const a=require("fs");var n=e.getCreatorHomePath()+"/services/",o=e.getCreatorHomePath()+"/download/";!a.existsSync(n)&&e.mkdirs(n),!a.existsSync(o)&&e.mkdirs(o);var c,d=o+s+".zip";let v=(e,r)=>{i&&i({text:e,complete:r})};if(!t.match(".zip"))return v("failed",!0),void 0;r.download(t,d,(r,s)=>{if(r)return v("failed",!0),void 0;var i=e.t("downloading")+s.progress+"%";if(c!=s.progress&&(c=s.progress,v(i,!1)),"complete"===s.status){if(100!==s.progress)return v("failed",!0),void 0;e.unzip(d,n,r=>{r?v("failed",!0):(v(e.t("installed"),!0),a.existsSync(t)&&a.unlinkSync(t))})}})},uninstallServicePackage(r){var t=e.getCreatorHomePath()+"/services/"+r.split("-")[1];e.removeDir(t)},getServicePackageDownloadUrl:(e,r)=>e.replace(/[0-9]+.[0-9]+.[0-9]+_[\x00-\xff]+.zip/,r+".zip"),async userLogin(){var t=i+"account/signin";return(await r.postAsync(t,{username:o.username,password:o.password,lang:e.getLang()})).data},async getSessionCode(){var e=i+"session/code",t={session_id:n.session_id};return await r.postAsync(e,this.paramPrase(t))},async openService(e,t,s){var a=i+"service/open",o={app_id:e,service_id:t,session_token:n.session_token};try{var c=await r.postAsync(a,this.paramPrase(o));s&&(0===c.status?s(!0):s(!1))}catch(e){s&&s(!1,e)}},async getSessionToken(){var e=i+"session/token",t={session_code:(await this.getSessionCode()).data.session_code,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async getServiceList(){var t=i+"service/lists";return await r.postAsync(t,{lang:e.getLang(),cs_version:this.getServiceVersion(),cc_version:this.getCreatorVersion()})},async getGameList(){var e=i+"game/lists",t={session_token:n.session_token,ip:"127.0.0.1"},s=await r.postAsync(e,this.paramPrase(t));return c=s,s},async getTCBTempKey(e,t){var s=i+"service/tcb_tmp_role",a={session_token:n.session_token,service_id:e,app_id:t};return new Promise((e,t)=>{r.postAsync(s,this.paramPrase(a)).then(r=>{r.data.secretId=r.data.secret_id,r.data.secretKey=r.data.secret_key,delete r.data.secret_id,delete r.data.secret_key,e(r.data)}).catch(r=>e(null))})},async createTCBEnv(e,t,s,a){var o=i+"service/tcb_create_env",c={session_token:n.session_token,service_id:e,env_id:s,alias:a,app_id:t};return await r.postAsync(o,this.paramPrase(c))},async getTCBEnvs(e,t){var s=i+"service/get_tcb_envs",a={session_token:n.session_token,service_id:e,app_id:t};return new Promise((e,t)=>{r.postAsync(s,this.paramPrase(a)).then(r=>e(r)).catch(r=>e({status:-1}))})},async getTCBQuotaData(e,t,s){var a=i+"service/get_tcb_quota_data",n={session_token:this.getUserData().session_token,service_id:e,app_id:t,env_id:s};return await r.postAsync(a,this.paramPrase(n))},async submitLog(e){var t=i+"log/add",s=this.paramPrase(e);await r.postAsync(t,s);p&&this.debug&&(e.submit_time=(new Date).toLocaleString(),console.log(e))},async getGameDetail(e){var t=i+"game/detail",s={session_token:n.session_token,ip:"127.0.0.1",app_id:e||l.data.app_id},a=await r.postAsync(t,this.paramPrase(s));return l=a,a},async getUserInfo(){var e=i+"user/info",t={session_token:n.session_token,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async getTargetUrl(){var e=i+"service/urls",t={session_token:n.session_token,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async associateProjectID(e,t,s){var a=i+"game/associate_project_id",o={session_token:n.session_token,ip:"127.0.0.1",app_id:e,project_id:t,action:s};return await r.postAsync(a,this.paramPrase(o))},async getIMSettings(){var e=i+"service/get_im_setting",t={session_token:n.session_token};return await r.postAsync(e,this.paramPrase(t))},getUserIsLogin:()=>_,getUserData(){return n||this.init(),n},async getUserDataAsync(){var e=await this.getUserInfo();for(var r in e.data)n[r]=e.data[r];return n},getGameLists(){return c||this.init(),c},getServiceLists(){return d||this.init(),d},getGame:()=>l||null,getUrl(r,t){if(!v)return e.printToCreatorConsole("warn",e.t("no_url_info")),"null data";var s,i=`${v.data.client_signin_url}session_id=${n.session_id}&redirect_url=`;return"dashboard"===r?s=i+v.data.cocos_dashboard_url:"create"===r?s=i+v.data.cocos_game_create_url:"service"===r?s=i+v.data.cocos_service_url:"enable_service"===r?s=i+encodeURIComponent(v.data.cocos_service_open_url+"?"+this.urlEncode(t).substring(1)):"person_verify"===r?s=i+v.data.cocos_personal_verify_url:"company_verify"===r?s=i+v.data.cocos_company_verify_url+"?"+this.urlEncode(t).substring(1):"person_bind_phone"===r?s=i+v.data.cocos_mobile_bind_personal_url:"company_bind_phone"===r?s=i+v.data.cocos_mobile_bind_company_url:"create_t_p_sub"===r?s=i+v.data.cocos_create_t_p_sub_url:"create_t_c_sub"===r&&(s=i+v.data.cocos_create_t_c_sub_url),s},async getSessionID(){if(Editor.User.getUserData&&"function"==typeof Editor.User.getUserData){var r=await Editor.User.getUserData();if(r.session_id)return r}return e.readJson(`${e.getCreatorHomePath()}/profiles/user_token.json`)},getServiceVersion:()=>e.readJson(Editor.url("packages://cocos-services/package.json")).version,compareVersion(e,r){for(var t=e.substring(0,e.indexOf("_")).split(".").map(Number),s=r.substring(0,r.indexOf("_")).split(".").map(Number),i=Math.min(t.length,s.length),a=0;a<i;a++){if(t[a]>s[a])return!0;if(t[a]<s[a])return!1}return t.length>s.length},getNumberVersion(){var e=this.getServiceVersion();return`${parseInt(e.replace(/\./g,""))/100}`},getCreatorVersion:()=>Editor.isMainProcess?Editor.versions.CocosCreator:Editor.remote.versions.CocosCreator,paramPrase(r){var t=require("md5"),s=r;s.plugin_id="1025",s.lang=e.getLang(),s.cs_version=this.getServiceVersion(),s.cc_version=this.getCreatorVersion(),s=this.objKeySort(s);var i=this.urlEncode(s)+"&32104adac01fdec28ac19df0b2f42d532b06311d";return s.sign=t(i.substr(1)),s},urlEncode(e,r,t){if(null==e)return"";var s="",i=typeof e;if("string"==i||"number"==i||"boolean"==i)s+="&"+r+"="+(t?encodeURIComponent(e):e);else for(var a in e){var n=null==r?a:r+(e instanceof Array?"["+a+"]":"."+a);s+=this.urlEncode(e[a],n,t)}return s},objKeySort(e){for(var r=Object.keys(e).sort(),t={},s=0;s<r.length;s++)t[r[s]]=e[r[s]];return t},on(...r){this.checkEvent(arguments[0])?e.printToCreatorConsole("warn",`${arguments[0]} Event Multiple Registration !!!`):a.on(...r)},emit(...e){this.checkEvent(arguments[0])?a.emit(...e):arguments[2](`${arguments[0]} Event Not Registration !!!`,null)},removeAll(e){a.removeAllListeners(e)},checkEvent:e=>a.eventNames().indexOf(e)>-1};