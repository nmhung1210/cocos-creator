"use strict";const r=require("fire-fs"),e=require("path"),n=require("./fs"),t=Editor.remote?Editor.remote.App.home:Editor.App.home;var o=function(r){return Editor.T(`store.package.${r}`)},i=e.join(t,"download",".temp");r.removeSync(i),exports.install=function(t,a,s){if(!r.existsSync(t))return s(new Error(o("exists_error")),!1);if(!/\.zip/.test(t))return s(new Error(o("type_error")),!1);Promise.resolve().then(function(){return new Promise((a,s)=>{var u=e.basename(t,".zip");u=e.join(i,u),n.unzip(t,u,e=>{if(e)return r.remove(u,r=>{r&&Editor.warn(r)}),Editor.warn(e),s(new Error(o("unzip_error")));a({tmp:u})})})}).then(function(n){return new Promise((t,i)=>{(function(n,t){var i=r.readdirSync(n),a=e.join(n,"package.json");if(r.existsSync(a)){let e=r.readFileSync(a,"utf-8");t(null,n,JSON.parse(e))}else{let a;if(i.some(t=>{var o=e.join(n,t,"package.json");return!!r.existsSync(o)&&(a=o,!0)}),a){let n=r.readFileSync(a,"utf-8");t(null,e.dirname(a),JSON.parse(n))}else t(new Error(o("pkg_unknown")))}})(n.tmp,(e,a,s)=>{if(e)return r.remove(n.tmp,r=>{r&&Editor.warn(r)}),Editor.warn(e),i(new Error(o("package_error")));n.dir=a,n.json=s,t(n)})})}).then(function(e){return new Promise((n,t)=>{exports.check(e.json.name,(o,i)=>i?1===Editor.Dialog.messageBox({title:Editor.T("store.package.install"),message:e.json.name+Editor.T("store.package.exists"),buttons:[Editor.T("store.button.cover"),Editor.T("store.button.cancel")],defaultId:0,cancelId:1,noLink:!0})?(e.exists=!0,n(e)):(exports.unload(e.json.name,o=>o?(r.remove(e.tmp,r=>{r&&Editor.warn(r)}),Editor.warn(o),t(Editor.T("store.package.uninstall_error"))):(e.exists=!1,n(e))),void 0):(e.exists=!1,n(e)))})}).then(function(t){return new Promise((i,s)=>{if(t.exists)return i(t);var u="";u="global"==a?Editor.App.home:Editor.Project.path;var c=e.join(u,"packages",t.json.name);n.copy(t.dir,c,e=>{if(e)return r.remove(t.tmp,r=>{r&&Editor.warn(r)}),n.remove(c,r=>{r&&Editor.warn(r)}),Editor.warn(e),s(new Error(o("install_error")));i(t)})})}).then(function(e){return new Promise((n,t)=>{r.remove(e.tmp,r=>{r&&Editor.warn(r),n(e)})})}).then(r=>{exports.load(r.dir,()=>{s(null,!r.exists)})}).catch(r=>{s(r,!1)})},exports.check=function(r,e){e(null,!!Editor.Package.find(r))},exports.unload=function(r,e){const t=Editor.Package.find(r);Editor.Package.unload(t,function(r){if(r)return e(r);setTimeout(()=>{n.remove(t,r=>{e(r)})},200)})},exports.load=function(r,e){Editor.Package.load(r,function(){e(null)})};