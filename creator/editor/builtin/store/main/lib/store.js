"use strict";const t=require("fs-extra"),i=require("path"),e=require("url"),r=require("querystring"),o=require("../utils/network"),{downloadZip:s,md5:n}=require("../utils/download"),a=require("../utils/package"),d=require("../utils/cloud-function"),u=require("../utils/fs"),l=Editor.remote?Editor.remote.App.home:Editor.App.home,c=i.join(l,".store.json"),p=i.join(l,"download");t.ensureDirSync(p);const f=function(){if(!t.existsSync(c))return[];try{return t.readJSONSync(c)}catch(t){return[]}}();exports.getList=function(){return f};let m=null;function _(){clearTimeout(m),m=setTimeout(()=>{t.writeJSONSync(c,f),Editor.Ipc.sendToAll("store:update")},200)}f.forEach(t=>{t.id;"download"==t.status&&(t.status="error",_()),"unzip"!=t.status&&"install"!=t.status||(t.status="finish",_()),f.sort((t,i)=>i.timestamp-t.timestamp)}),exports.download=async function(t){const n=e.parse(t),a=r.parse(n.query),d=await o.get(t,a);if(!d||"SUCCESS"!==d.status||200===d.status)throw new Error(Editor.T("store.tips.data_error"));if(f.some(t=>t.production_id===d.production_id&&t.version_id===d.version_id))throw Editor.warn(Editor.T("store.tips.package_exists")),new Error(Editor.T("store.tips.package_exists"));const u={name:d.name,name_en:d.name_en,file:i.join(p,d.production_id+"-"+d.version_id+".zip"),type:d.type_id,production_id:d.production_id,version_id:d.version_id,progress:0,status:"download",timestamp:Date.now()};return f.splice(0,0,u),_(),await s(d.download_url,u.file,function(t){u.progress=t,_()}),u.status="finish",_(),33!=d.type_id&&35!=d.type_id||(await new Promise(t=>{setTimeout(t,500)}),await exports.install(u.production_id,d.version_id)),u.file},exports.remove=function(i,e){const r=exports.find(i,e);if(!r)return;const o=f.indexOf(r);-1!==o&&(t.existsSync(r.file)&&t.removeSync(r.file),f.splice(o,1),_())},exports.find=function(t,i){return f.find(e=>e.production_id===t&&e.version_id===i)||null},exports.install=async function(i,e){const r=exports.find(i,e);if(!r)throw new Error(Editor.T("store.tips.package_no_exists"));if(!t.existsSync(r.file))throw new Error(Editor.T("store.tips.package_incorrect"));r.status="install",_();let o=r.name;if("zh"!=Editor.lang&&(o=r.name_en),33==r.type){const t=Editor.Dialog.messageBox({title:Editor.T("store.dialog.install"),message:Editor.T("store.dialog.install_message"),buttons:[Editor.T("store.button.global"),Editor.T("store.button.project"),Editor.T("store.button.cancel")],defaultId:0,cancelId:2,noLink:!0});return 2==t?(r.status="finish",_(),void 0):new Promise((i,e)=>{a.install(r.file,0==t?"global":"project",(t,o)=>{if(r.status="finish",_(),t)return e(t);i()})})}if(35==r.type){try{await d.install(r.production_id,r.file)}catch(t){throw r.status="finish",_(),t}return r.status="finish",_(),void 0}Editor.Dialog.messageBox({title:Editor.T("store.dialog.install"),message:Editor.T("store.dialog.unknown_type"),buttons:[Editor.T("store.button.confirm")],defaultId:0,cancelId:0}),r.status="finish",_()},exports.unzip=async function(e,r){const o=exports.find(e,r);if(!o)throw new Error(Editor.T("store.tips.package_no_exists"));if(!t.existsSync(o.file))throw new Error(Editor.T("store.tips.package_incorrect"));o.status="unzip",_();const s=Editor.Dialog.openFile({defaultPath:process.env.HOME||p,properties:["openDirectory"]}),n=s&&s[0]?s[0]:"";if(!n)return o.status="finish",_(),void 0;let a="";a="zh"==Editor.lang?o.name||o.name_en:o.name_en||o.name;let d=i.join(n,a),l=d,c=0;for(;t.existsSync(d);)d=`${l}_${++c}`;return new Promise((t,i)=>{u.unzip(o.file,d,e=>{if(o.status="finish",_(),e)return i(e);t()})})};