"use strict";const t=require("child_process").spawn,i=require(Editor.url("app://editor/page/qrcode")),e=(require(Editor.url("packages://xiaomi-runtime/lib/utils")),require(Editor.url("packages://xiaomi-runtime/lib/killPort"))),r=(require("path"),require("fire-fs")),{promisify:o}=require("util");var n=`\n    <section style="text-align:center;">\n        <h1>{{msg}}</h1>\n        <div id="qrCode" class="qrCode"></div>\n        <ui-button v-on:confirm="openDevtools">${Editor.T("xiaomi-runtime.debug_btn")}</ui-button>\n    </section>\n`;Editor.Panel.extend({_vm:null,style:"\n    body {\n            margin: 10px;\n            background-color: transparent;\n        }\n\n        h1 {\n            color: #f90\n        }\n\n        .qrCode {\n             width:150px;\n             height:150px;\n             margin:0px auto;\n             padding: 10px;\n        }\n",template:n,ops:null,$:{qrCode:"#qrCode"},messages:{},async run(i){if(this.pid)return;this.ops=i,this.pid=null;let e=this;this._vm=new window.Vue({el:this.shadowRoot,data:{msg:Editor.T("xiaomi-runtime.starting_server"),did:0},watch:{},destroyed:function(){this.did&&process.kill(this.did),this.did=0},methods:{openDevtools:function(){this.did&&process.kill(this.did);const i=t("win32"===process.platform?"npm.cmd":"npm",["run","debug"],{cwd:e.ops.dest});i.on("close",t=>{this.did=null}),i.stdout.on("data",t=>{this.did=i.pid,Editor.log(t.toString())}),i.stderr.on("data",t=>{Editor.error(t.toString())})}}}),this.startDebugServer(t=>{if(t)return this._vm.msg=Editor.T("xiaomi-runtime.start_server_error"),void 0;this.genQRCode(),this._vm.msg=""})},startDebugServer(i){let e=!1;if(!r.existsSync(this.ops.dest))return i&&i(!0),void 0;const o=t("win32"===process.platform?"npm.cmd":"npm",["run","server","--","--port",4e3],{cwd:this.ops.dest});o.on("close",t=>{!e&&i&&i(t),this.pid=null,e=!0}),o.stdout.on("data",t=>{-1!==t.toString().indexOf("生成HTTP服务器的二维码")&&(!e&&i&&i(!1),e=!0)}),o.stderr.on("data",t=>{!e&&i&&i(!0),Editor.error(t.toString()),e=!0}),this.pid=o.pid},genQRCode(){this.$qrCode.innerHTML="",this.qrcode=new i(this.$qrCode,{width:150,height:150}),this.qrcode.makeCode(`http://${Editor.remote.Network.ip}:4000`)},close(){this.pid&&e(this.pid,4e3),this.pid=null}});