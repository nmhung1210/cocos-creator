const e=require("electron"),t=require("fire-fs"),s=Editor.require("packages://package-asset/utils.js"),r=Editor.require("packages://package-asset/parse/export.js"),a=Editor.require("packages://package-asset/lib/jszip.min.js"),i=Editor.require("packages://package-asset/panel/common/asset-item.js");Vue.component("package-asset-item",i),Editor.Panel.extend({style:t.readFileSync(Editor.url("packages://package-asset/panel/style.css"))+"",template:t.readFileSync(Editor.url("packages://package-asset/panel/export/panel.html"))+"",ready(){s.init(this.profiles),this._vm=new window.Vue({el:this.shadowRoot,data:{assetUuid:"",assetTree:{name:"",url:"",children:[],type:"mount",folded:!0,selected:!0,parent:null},selectAll:!0},watch:{assetUuid:{handler(e){if(!e)return this.assetTree=null,void 0;this._queryDependAsset(e)}}},methods:{T:s.T,_showLoadBar(){return this.assetUuid&&!this.assetTree},_showContent(){return this.assetUuid&&this.assetTree},_isDisabled(){return""===this.assetUuid||this.assetTree&&0===this.assetTree.children.length},_isExportDisabled(){return this._isDisabled()||this.assetTree&&this.assetTree.children.every(e=>!e.selected)},changeSelectAll(e){this.selectAll=e.children.every(e=>e.selected)},onChooseScene(){s.showExportResDialog((e,t)=>{if(e)return Editor.error(e),void 0;this.assetUuid=t.uuid,s.save("current-scene-uuid",this.assetUuid)})},onRefresh(){this._queryDependAsset(this.assetUuid)},_queryDependAsset(e){this.assetTree=null,Editor.Scene.callSceneScript("package-asset","query-depend-asset",e,(e,t)=>{if(e)return Editor.error(e),void 0;this.assetTree=new r.FileRoot("assets","","mount"),r.queryAssetTreeByUuidList(this.assetTree,t)},5e4)},onAssetChanged(e){this.assetUuid=e.detail.value},onSelectAll(e){s.changedAssetTreeSelectState(this.assetTree,e.detail.value)},onExport(){let r=new a;function i(e,s,a,l){if(!e.selected)return l();if("folder"===e.type||"mount"===e.type){let n;if("assets"!==e.name&&(n=function(e,s){let a;return s?(a=s.folder(e.name)).file(e.name+".meta",t.readFileSync(e.url+".meta")):(a=r.folder(e.name),r.file(e.name+".meta",t.readFileSync(e.url+".meta"))),a}(e,s)),e.children.length<1)return l();let d=0;for(let t=0,s=e.children.length;t<s;++t){i(e.children[t],n,a,()=>{++d>=s&&l()})}}else(function(e,s){s?(s.file(e.name,t.readFileSync(e.url)),s.file(e.name+".meta",t.readFileSync(e.url+".meta"))):(r.file(e.name,t.readFileSync(e.url)),r.file(e.name+".meta",t.readFileSync(e.url+".meta")))})(e,s),a[e.name]=e.type,l()}s.showExportOutPathDialog((s,a)=>{if(s)return Editor.error(s),void 0;let l={};i(this.assetTree,null,l,()=>{r.file("&asset&type&.json",JSON.stringify(l)),r.generateNodeStream({type:"nodebuffer"}).pipe(t.createWriteStream(a)).on("finish",()=>{let e=this.T("EXPORT_ASSET.export_tips",{outPath:a});Editor.log(e)}),e.shell.showItemInFolder(a)})})}}})},messages:{"asset-db:asset-changed"(e,t){this._vm.onRefresh(t)}}});