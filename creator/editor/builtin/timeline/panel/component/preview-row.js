"use strict";const e=require("fire-fs"),t=require("path"),s=require("../libs/manager"),r=require("../libs/advice"),i=require("../libs/utils");exports.template=e.readFileSync(t.join(__dirname,"../template/preview-row.html"),"utf-8"),exports.props=["size","offset","scale","clip","node","sample","selected","box"],exports.watch={size:{deep:!0,handler(){try{this.updateDisplay()}catch(e){Editor.error(e)}}},clip(){try{this.updateKeys()}catch(e){Editor.error(e)}},sample(){try{this.updateKeys()}catch(e){Editor.error(e)}},box:{deep:!0,handler(e){e.y>=this.$el.offsetTop+20||e.h+e.y<=this.$el.offsetTop+4||this.keys.forEach(t=>{let s=t.frame*this.scale;s<e.x||s>e.x+e.w||t.rows.map(e=>i.packKey(this.clip.id,this.node.path,e.component,e.property,t.frame,t.value)).forEach(e=>{-1===i.indexOf(this.selected,e)&&this.selected.push(e)})})}}},exports.data=function(){return{display:!0,keys:[],lines:[],virtualkeys:[]}},exports.methods={t:Editor.T,updateDisplay(){this.display=this.size.top<=this.$el.offsetTop+24&&this.size.top+this.size.height>this.$el.offsetTop},queryLineStyle:(e,t,s,r)=>`transform: translateX(${e*s+r-1|0}px); width: ${t*s}px`,checkSelected(e){if(!this.clip)return!1;return e.rows.every(t=>-1!==i.indexOf(this.selected,{id:this.clip.id,path:this.node.path,component:t.component,property:t.property,frame:e.frame}))},updateKeys(){for(;this.keys.length;)this.keys.pop();for(;this.lines.length;)this.lines.pop();if(!this.clip||this.node.disabled)return;let e=this.clip.id,t=this.node.path;if(!e||!t)return;let r=s.Clip.queryCurve(this.clip.id,this.node.path),a={};i.forEachCurve(r,(e,t,s)=>{s.forEach(s=>{let r=Math.round(s.frame*this.sample);a[r]||(a[r]={list:[],rows:[]});let i=a[r];s.value?i.list.push(Editor.serialize(s.value)):i.list.push(null),i.rows.push({component:e,property:t})})});let o=null;Object.keys(a).forEach(e=>{let t=a[e],s={frame:parseInt(e),value:t.list,rows:t.rows};o&&!i.equalArray(o.value,s.value)&&this.lines.push({frame:o.frame,length:s.frame-o.frame}),o=s,this.keys.push(s)})},dragKeyStart(){this.keys.forEach(e=>{this.checkSelected(e)&&this.virtualkeys.push({frame:parseFloat(e.frame),offset:0,source:e})})},dragKeyMove(e){this.virtualkeys.forEach(t=>{t.offset=e})},dragKeyEnd(){for(;this.virtualkeys.length;)this.virtualkeys.pop();this.updateKeys()},queryKeyStyle:(e,t,s)=>`transform: translateX(${e*t+s-1|0}px);`,queryVKeyStyle:(e,t,s,r)=>`transform: translateX(${(e+t)*s+r-1|0}px);`,_onKeyMouseDown(e,t){r.emit("change-node",this.node);let s=t.rows.map(e=>i.packKey(this.clip.id,this.node.path,e.component,e.property,t.frame,t.value)),a=this.checkSelected(t);if(e&&!e.ctrlKey&&!e.metaKey&&!a)for(;this.selected.length;)this.selected.pop();s.forEach(e=>{a||this.selected.push(e)})},_onKeyMouseUp(e,t){t.rows.map(e=>i.packKey(this.clip.id,this.node.path,e.component,e.property,t.frame,t.value)).forEach(e=>{this.checkSelected(t)||this.selected.push(e)})},_onKeyClick(e){e&&e.preventDefault(),e&&e.stopPropagation()},_onKeyDragStart(e,t){let s=0,i=1/0;this.selected.forEach(e=>{e.frame<i&&(i=e.frame)}),r.emit("drag-key-start"),Editor.UI.startDrag("ew-resize",e,(e,t,a,o,h)=>{s+=isNaN(t)?0:t;let p=Math.round(s/this.scale);r.emit("drag-key-move",Math.max(-i,p))},(e,t,a,o,h)=>{let p=Math.round(s/this.scale);r.emit("drag-key-end",Math.max(-i,p))})},_onLineClick(e){event&&event.preventDefault(),event&&event.stopPropagation();let t=e.frame,r=e.frame+e.length,a=s.Clip.queryInfo(this.clip.id);if(!event.ctrlKey&&!event.metaKey)for(;this.selected.length;)this.selected.pop();let o=s.Clip.queryCurve(this.clip.id,this.node.path);i.forEachCurve(o,(e,s,o)=>{o.forEach(o=>{let h=Math.round(o.frame*a.sample);if(h===t||h===r){let t=i.packKey(this.clip.id,this.node.path,e,s,h,o.value);this.selected.push(t)}})})}},exports.created=function(){r.on("drag-key-start",this.dragKeyStart),r.on("drag-key-move",this.dragKeyMove),r.on("drag-key-end",this.dragKeyEnd),r.on("clip-data-update",this.updateKeys)},exports.compiled=function(){requestAnimationFrame(()=>{this.$el&&(this.updateDisplay(),this.updateKeys())})},exports.destroyed=function(){r.removeListener("drag-key-start",this.dragKeyStart),r.removeListener("drag-key-move",this.dragKeyMove),r.removeListener("drag-key-end",this.dragKeyEnd),r.removeListener("clip-data-update",this.updateKeys)};