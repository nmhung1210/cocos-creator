"use strict";const e=require("fire-fs"),t=require("fire-path"),r=require("electron"),i=require("node-uuid"),a=Editor.require("app://editor/share/build-platforms"),o=require(Editor.url("packages://builder/utils/event")),s=require(Editor.url("packages://builder/utils/module-events")),l=require(Editor.url("app://editor/share/build-utils")),n=require(Editor.url("packages://builder/panel/platform/android")),d=require(Editor.url("packages://builder/panel/platform/web-desktop")),u=require(Editor.url("packages://builder/panel/platform/web-mobile")),c=require(Editor.url("packages://builder/panel/platform/fb-instant-games")),p=require(Editor.url("packages://builder/panel/platform/android-instant")),m=require(Editor.url("packages://builder/panel/platform/windows")),h=require(Editor.url("packages://builder/panel/platform/ios")),f=require(Editor.url("packages://builder/panel/platform/mac")),g=require("electron").remote.dialog,{promisify:E}=require("util"),b=Editor.remote.Profile.load("global://settings.json"),v=Editor.remote.Profile.load("global://features.json"),P=Editor.require("app://editor/share/bundle-utils"),_={local:null,project:null,anysdk:null};let k=v.get("xiaomi-runtime")||!1,T=v.get("alipay-minigame")||!1,y=v.get("qtt-runtime")||!1,B=v.get("huawei-agc")||!1,D=v.get("link-sure")||!1,S=v.get("bytedance-minigame")||!1,j=["web-mobile","web-desktop","fb-instant-games","android",B?"huawei-agc":"HIDDEN","android-instant","ios",T?"alipay":"HIDDEN",y?"qtt-game":"HIDDEN",S?"bytedance":"HIDDEN",S?"bytedance-subcontext":"HIDDEN","jkw-game","huawei","quickgame","qgame",k?"xiaomi":"HIDDEN",D?"link-sure":"HIDDEN","baidugame","baidugame-subcontext","wechatgame","wechatgame-subcontext","cocos-runtime","qqplay","mac","win32"];Editor.Panel.extend({style:e.readFileSync(Editor.url("packages://builder/panel/builder.css")),template:e.readFileSync(Editor.url("packages://builder/panel/builder.html")),messages:{"builder:state-changed":function(e,t,r){if(this._vm){if(this._vm.setSystemBarProgress("error"===t||"finish"===t?-1:r),r*=100,"error"===t)return this._vm.buildProgress=r,this._vm.buildState="failed",this._vm.task="",void 0;if("finish"===t)return this._vm.buildProgress=100,this._vm.buildState="completed",this._vm.task="",void 0;this._vm.buildProgress=r,this._vm.buildState=t}},"builder:events":function(e,t,...r){o.emit(t,...r)},"keystore:created":function(e,t){this._vm.local.keystorePath=t.path,this._vm.local.keystorePassword=t.password,this._vm.local.keystoreAlias=t.alias,this._vm.local.keystoreAliasPassword=t.aliasPassword},"asset-db:assets-deleted":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"asset-db:assets-moved":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"asset-db:assets-created":async function(e,t){!!t.find(e=>"scene"===e.type)&&await this.updateSceneData()},"inspector:bundle-updated":async function(e,t){await this.updateSceneData()}},async ready(){let o=this.profiles.local,E=this.profiles.project;o.get("actualPlatform")||o.set("actualPlatform",o.get("platform")),function(e){let t=e.get("platform"),r=Object.keys(a),i=r.includes(t);if(i)return;let o=Editor.remote.Builder.simpleBuildTargets[t];t=o&&o.extends||t,(i=r.includes(t))||(t="web-mobile",e.set("actualPlatform","web-mobile")),e.set("platform",t)}(o),function(e){let t=e.get("packageName");if(!t)return;const r=["android","android-instant","ios","mac"];for(let i of r){let r=e.get(i);r&&!r.packageName&&(r.packageName=t,e.set(i,r))}}(E);let v={},P=[u,n,p,d,c,m,h,f],k=Editor.remote.Builder.simpleBuildTargets;for(let e in k){let t=k[e];if(t.settings){let e=require(t.settings);!e.name&&(e.name=t.platform),P.push(e)}else Editor.warn("Can not load package",t.name)}P.forEach(e=>{e.props||(e.props={});for(let t in _)!e.props[t]&&(e.props[t]=_[t]);v[e.name]=e});let T={platforms:function(e){let t=[];t.push({value:"web-mobile",text:Editor.T("BUILDER.platforms.web-mobile")}),t.push({value:"web-desktop",text:Editor.T("BUILDER.platforms.web-desktop")}),t.push({value:"fb-instant-games",text:Editor.T("BUILDER.platforms.fb-instant-games")}),t.push({value:"android",text:Editor.T("BUILDER.platforms.android")}),t.push({value:"android-instant",text:Editor.T("BUILDER.platforms.android-instant")}),"darwin"===process.platform&&(t.push({value:"ios",text:Editor.T("BUILDER.platforms.ios")}),t.push({value:"mac",text:Editor.T("BUILDER.platforms.mac")})),"win32"===process.platform&&t.push({value:"win32",text:Editor.T("BUILDER.platforms.win32")});let r=Editor.remote.Builder.simpleBuildTargets,i=[];for(let e in r){let t=r[e];t.settings&&i.push({value:t.platform,text:t.name})}return t=t.concat(i),j.map(e=>{if("string"==typeof e)return t.find(t=>t.value===e);{let r=e[Editor.lang];return t.find(e=>e.text.replace(/\s/g,"").toLowerCase()===r.replace(/\s/g,"").toLowerCase())}}).filter(Boolean)}(),scenes:[],all:!1,task:"",record:"",buildState:"idle",buildProgress:0,anysdk:"zh"===Editor.lang,local:o.getSelfData(),project:E.getSelfData(),compressionTypes:[{value:"none",text:Editor.T("INSPECTOR.folder.none"),title:Editor.T("INSPECTOR.folder.none_tooltip")},{value:"default",text:Editor.T("INSPECTOR.folder.default"),title:Editor.T("INSPECTOR.folder.default_tooltip")},{value:"merge_all_json",text:Editor.T("INSPECTOR.folder.merge_all_json"),title:Editor.T("INSPECTOR.folder.merge_all_json_tooltip")},{value:"subpackage",text:Editor.T("INSPECTOR.folder.subpackage"),title:Editor.T("INSPECTOR.folder.subpackage_tooltip")},{value:"zip",text:Editor.T("INSPECTOR.folder.zip"),title:Editor.T("INSPECTOR.folder.zip_tooltip")}]};var y=this._vm=new window.Vue({el:this.shadowRoot,data:T,computed:{scenesInList(){return this.scenes.filter(e=>!e.hidden)},actualPlatform:{get(){return this.local.actualPlatform},set(e){this.local.platform=this._actualPlatform2Platform(e),this.local.actualPlatform=e,this.isCompressionTypeVisible(this.project.mainCompressionType)||(this.project.mainCompressionType="default")}},isNative(){return a[this.local.platform].isNative},isRuntime(){return"runtime"===this.local.platform},supportSubpackage(){return l.supportSubpackage(this.actualPlatform)},supportZip(){return l.supportZip(this.actualPlatform)},supportRemoteMain(){return a[this.local.platform].supportRemoteMain&&l.supportRemote(this.actualPlatform)},isRemoteBundleReadonly(){return"zip"===this.project.mainCompressionType||"subpackage"===this.project.mainCompressionType},needPlayBtn(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return!(!t||!t.buttons||"object"!=typeof t.buttons[1])||(!t||!t.buttons||t.buttons.includes(e.DefaultButtons.Play))},needCompile(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return t&&t.buttons?t.buttons.includes(e.DefaultButtons.Compile):a[this.local.platform].isNative},needUpload(){var e=Editor.remote.Builder,t=e.simpleBuildTargets[this.local.actualPlatform];return!(!t||!t.buttons)&&t.buttons.includes(e.DefaultButtons.Upload)}},watch:{local:{handler(e){this.saveLocalData()},deep:!0},project:{handler(e){this.saveProjectData()},deep:!0},scenes:{handler(e){var t=this.project.startScene,r=!1;for(let a=0;a<e.length;a++){let o=e[a];if(o.text.startsWith("db://assets/resources/")||t===o.value)r=!0;else{var i=this.project.excludeScenes.indexOf(o.value);o.checked||-1!==i?o.checked&&-1!==i&&this.project.excludeScenes.splice(i,1):this.project.excludeScenes.push(o.value)}}e.length>0&&!r&&(this.project.startScene=e[0].value),this.all=this.scenes.every(function(e){return e.checked})},deep:!0}},components:v,methods:{_mainCompressionTypeChanged(){this.supportRemoteMain?this.isRemoteBundleReadonly&&("subpackage"===this.project.mainCompressionType?this.project.mainIsRemote=!1:"zip"===this.project.mainCompressionType&&(this.project.mainIsRemote=!0)):this.project.mainIsRemote=!1},isCompressionTypeVisible(e){return"subpackage"===e?this.supportSubpackage:"zip"!==e||this.supportZip},setSystemBarProgress(e){Editor.Ipc.sendToMain("builder:update-system-progress",e)},saveLocalData(){Object.keys(this.local).forEach(e=>{o.set(e,this.local[e])}),o.save()},saveProjectData(){Object.keys(this.project).forEach(e=>{E.set(e,this.project[e])}),E.save()},t:e=>Editor.T(e),_actualPlatform2Platform(e){let t=Editor.remote.Builder.simpleBuildTargets[e];return t&&t.extends||e},_onOpenCompileLogFile(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:open-cocos-console-log")},_onChooseDistPathClick(e){e.stopPropagation();let r=Editor.Dialog.openFile({defaultPath:l.getAbsoluteBuildPath(this.local.buildPath),properties:["openDirectory"]});r&&r[0]&&(t.contains(Editor.Project.path,r[0])?(this.local.buildPath=t.relative(Editor.Project.path,r[0]).replace(/\\/g,"/"),""===this.local.buildPath&&(this.local.buildPath="./")):this.local.buildPath=r[0])},_onShowInFinderClick(t){t.stopPropagation();let i=l.getAbsoluteBuildPath(this.local.buildPath);if(!e.existsSync(i))return Editor.warn("%s not exists!",i),void 0;r.shell.showItemInFolder(i),r.shell.beep()},_onSelectAllCheckedChanged(e){if(!this.scenes)return;let t=this.project.startScene;for(let i=0;i<this.scenes.length;i++){let a=this.scenes[i];if(!a.text.startsWith("db://assets/resources/")&&t!==a.value){a.checked=e.detail.value;var r=this.project.excludeScenes.indexOf(a.value);a.checked||-1!==r?a.checked&&-1!==r&&this.project.excludeScenes.splice(r,1):this.project.excludeScenes.push(a.value)}}},startTask(e,t){this.task=e;let r=Editor.Profile.load("project://project.json");t.excludedModules=r.get("excluded-modules"),Editor.Ipc.sendToMain("builder:start-task",e,t)},_onBuildClick(e){e.stopPropagation(),Editor.Ipc.sendToPanel("scene","scene:query-dirty-state",(e,t)=>{if(t.dirty)return Editor.error(t.name+" "+Editor.T("BUILDER.error.dirty_info")),void 0;this._build()})},async _build(){this.saveLocalData();var r=l.getAbsoluteBuildPath(this.local.buildPath),i=t.win32.dirname(r),n=this.local.platform;let d=a[n].isNative;if(!e.existsSync(i))return g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_dir_not_exists",{buildDir:i})),void 0;if(-1!==r.indexOf(" "))return g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_space")),void 0;if(/.*[\u4e00-\u9fa5]+.*$/.test(r))return g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.build_path_contains_chinese")),void 0;if(!/^[a-zA-Z0-9_-]*$/.test(this.project.title))return g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.project_name_not_legal")),void 0;let u=l.getOptions(E,o);u.separateEngineMode=!1,this.isNative&&!this.isRuntime&&(u.md5Cache=u.nativeMd5Cache),delete u.nativeMd5Cache;let c=this.$children[0];if(!c||!c.checkParams||await c.checkParams(u)){Editor.Ipc.sendToAll("builder:state-changed","ready",0);var p=this.scenes.filter(function(e){return e.checked}).map(function(e){return e.value});if(p.length>0){u.actualPlatform=this.local.actualPlatform,u.scenes=p;let e=u.platform;e&&(d&&"android-instant"!==e&&(u.inlineSpriteFrames=u.inlineSpriteFrames_native),u.embedWebDebugger=("web-mobile"===e||"fb-instant-games"===e)&&u.embedWebDebugger),this.startTask("build",u),Editor.Ipc.sendToMain("metrics:track-event",{category:"Project",action:"Build",label:u.actualPlatform||e}),s.trackModuleEvent()}else g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.select_scenes_to_build"))}},_onCompileClick(e){e.stopPropagation(),this.startTask("compile",l.getOptions(E,o))},_onStopCompileClick:function(e){e.stopPropagation(),Editor.Ipc.sendToMain("app:stop-compile")},_onPreviewClick(r){if(r.stopPropagation(),"android-instant"===this.local.platform&&!e.existsSync(t.join(b.get("android-sdk-root"),"extras/google/instantapps/ia")))return g.showErrorBox(Editor.T("BUILDER.error.build_error"),Editor.T("BUILDER.error.instant_utils_not_found")),void 0;var i=l.getOptions(E,o),a=Editor.remote.Builder,s=a.simpleBuildTargets[this.local.actualPlatform];if(s&&s.buttons){let e="object"==typeof s.buttons[1];if(e||s.buttons.includes(a.DefaultButtons.Play))if(e){let e=s.buttons[1].message;Editor.Ipc.sendToMain(`${s.package}:${e}`,i)}else Editor.Ipc.sendToMain(`${s.package}:play`,i)}else Editor.Ipc.sendToMain("app:run-project",i)},_onUploadClick(e){e.stopPropagation();let t=Editor.remote.Builder,r=t.simpleBuildTargets[this.local.actualPlatform];r&&r.buttons&&r.buttons.includes(t.DefaultButtons.Upload)&&Editor.Ipc.sendToMain(`${r.package}:upload`,l.getOptions(E,o))},_openExternal(e,t){e.stopPropagation(),r.shell.openExternal(t)},_onRecordClick(e){let r=function(e){return["FullYear","Month","Date","Hours","Minutes","Seconds"].map(t=>{let r=e[`get${t}`]();return"Month"===t&&r++,r<10&&(r="0"+r),r}).join("")}(new Date),i=t.join(Editor.Project.path,`/temp/android-instant-games/profiles/${r}`);Editor.Ipc.sendToMain("app:play-on-device",{platform:"simulator",recordPath:i})},_onRefactorClick(e){Editor.Panel.open("google-instant-games")}}});y.project.title||(y.project.title=Editor.Project.name),y.project.xxteaKey||(y.project.xxteaKey=i.v4().substr(0,16)),y.local.buildPath||(y.local.buildPath="./build"),Editor.Ipc.sendToMain("builder:query-current-state",(e,t)=>{if(e)return Editor.warn(e);y.task=t.task,Editor.Ipc.sendToAll("builder:state-changed",t.state,t.progress)}),await this.updateSceneData()},async updateSceneData(){let e=await P.queryBundlesWithScenes(),t=this._udpateExcludeScenes(e);this._updateSceneList(e),this._updateStartSceneList(),t&&this._vm.project.save()},_udpateExcludeScenes(e){let t=this._vm.project.excludeScenes,r=[];for(let t in e)r.push(...e[t]);let i=!1;for(let e=0;e<t.length;e++){let a=t[e];r.some(e=>e.uuid===a)||(i=!0,t.splice(e--,1))}return i},_updateSceneList(e){let t=this._vm.project.excludeScenes,r=this._vm.scenes;r.length=0;let i=[];for(let t in e)i.push(...e[t]);let a=[];["main","resources"].forEach(t=>{let r=e[t];r&&a.push(...r)}),a=a.map(e=>e.uuid),i.forEach(e=>{let o=a.includes(e.uuid);r.push({value:e.uuid,text:e.url,checked:!o||1===i.length||!t.includes(e.uuid),hidden:!o})})},_updateStartSceneList(){let e=this._vm.project,t=this._vm.scenes,r=e.startScene,i=!!t.find(function(e){return e.value===r&&!e.hidden});r&&i||((t=t.filter(e=>!e.hidden)).length>0?e.startScene=t[0].value:e.startScene="")}});