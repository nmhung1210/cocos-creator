const e=Editor.require("app://editor/share/adapters-build-utils"),t=require("fire-path"),n=require("fire-fs"),i=Editor.require("app://editor/share/build-utils"),o="project://bytedance.json",r=Editor.require("app://editor/share/3d-physics-build-utils");const s={"game.js":function(e,t){let n=e.contents.toString(),i=t.debug?"require('cocos2d-js.js')":"require('cocos2d-js-min.js')";n=n.replace("require('cocos2d-js-path')",i);let o=t.debug?"require('adapter.js')":"require('adapter-min.js')";n=n.replace("require('adapter-js-path')",o),n=r.updateMinigameRequire(t,n),e.contents=new Buffer(n)},"game.json":function(e,n){let r=Editor.Profile.load(o),s=JSON.parse(e.contents.toString());i.combineDestJson(n,s,t.basename(e.path)),s.deviceOrientation=r.get("orientation"),r.get("subContext")?s.openDataContext=r.get("subContext"):delete s.openDataContext,i.combineBuildTemplateJson(n,s,t.basename(e.path)),e.contents=new Buffer(JSON.stringify(s,null,4)),e.contents=new Buffer(e.contents)},"project.config.json":function(e,n){let r=Editor.Profile.load(o),s=JSON.parse(e.contents.toString());i.combineDestJson(n,s,t.basename(e.path)),s.appid=r.get("appid"),s.projectname=n.projectName,i.combineBuildTemplateJson(n,s,t.basename(e.path)),e.contents=new Buffer(JSON.stringify(s,null,4)),e.contents=new Buffer(e.contents)}};module.exports={name:Editor.T("bytedance.platform_name"),platform:"bytedance",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildStart:function(e){let t=e.excludedModules,n=t.indexOf("SubContext");-1!==n&&t.splice(n,1);let i=Editor.Profile.load(o);e.startSceneAssetBundle=i.get("startSceneAssetBundle")||!1},compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e){let n=Editor.Profile.load(o).get("subContext"),i=e.dest,r=[t.join(i,"**/*"),`!${t.join(i,"game.json")}`,`!${t.join(i,"project.config.json")}`];return n&&r.push(`!${t.join(i,n)}`,`!${t.join(i,n,"**/*")}`),r},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(t,n){let i=null;try{(function(){let e=Editor.Profile.load(o);if(!e)throw new Error("config file not found");e.get("appid")||Editor.warn("appid is empty, use 'testappid' by default")})(),n.settings.server=Editor.Profile.load(o).get("REMOTE_SERVER_ROOT"),await e.buildAdapter(n,"./platforms/bytedance/wrapper/sub-context-adapter.js"),await e.copyRes(n,null,s)}catch(e){i=e}t.reply(i)},"build-finished":function(e,i){let r=null;try{(function(e){for(var i=0,o=e.bundles.length;i<o;i++){var r=e.bundles[i];if("subpackage"!==r.compressionType)continue;let o=t.join(r.scriptDest,"index.js");n.existsSync(o)&&n.renameSync(o,t.join(r.scriptDest,"game.js"))}})(i),function(e){let t=Editor.Profile.load(o),n={id:t.get("appid"),resUrl:t.get("REMOTE_SERVER_ROOT"),orientation:t.get("orientation")};Editor.Ipc.sendToMain("builder:notify-build-result",e,n)}(i)}catch(e){r=e}e.reply(r)}},settings:Editor.url("packages://bytedance/build-ui.js")};