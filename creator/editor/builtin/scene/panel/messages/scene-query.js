"use strict";const e=Editor.require("scene://edit-mode"),n=Editor.require("scene://utils/animation"),r=Editor.require("scene://utils/scene"),t=Editor.require("scene://dump/hierarchy"),i=require("../../../../share/engine-extends/object-walker"),l=require("lodash");module.exports={"query-dirty-state"(n){if(n.reply){let r=e.dirtyMode();if(r)return n.reply(null,{dirty:!0,name:r.name}),void 0;n.reply(null,{name:"scene",dirty:_Scene.Undo.dirty()})}},"query-group-list"(e){e.reply&&e.reply(null,cc.game.groupList)},"query-hierarchy"(e){if(!cc.engine.isInitialized)return e.reply(null,"",[]),void 0;let n=t.node(),r=_Scene.currentScene().uuid;e.reply(null,r,n)},"query-nodes-by-comp-name"(e,n){let r=cc.director.getScene(),t=[],i=cc.js.getClassByName(n);i&&_Scene.walk(r,!1,e=>{e.getComponent(i)&&t.push(e.uuid)}),e.reply(null,t)},"query-node"(e,n,r){if(e.reply){let r=_Scene.dumpNode(n);return r=JSON.stringify(r),e.reply(null,r),void 0}let t=_Scene.dumpNode(r);t=JSON.stringify(t),Editor.Ipc.sendToWins("scene:reply-query-node",n,t)},"query-node-info"(e,n,r){let t=null,i=cc.engine.getInstanceById(n);i&&(t=i instanceof cc.Component?i.node:i);let l=null;t&&"cc.Node"!==r&&(l=t.getComponent(cc.js._getClassById(r))),e.reply(null,{name:t?t.name:"",missed:null===i,nodeID:t?t.uuid:null,compID:l?l.uuid:null})},"query-node-functions"(e,n){var r=cc.engine.getInstanceById(n),t=Editor.getNodeFunctions(r);e.reply(null,t)},"choose-last-rigid-body"(e,n){var r=cc.engine.getInstanceById(n);if(r instanceof cc.Joint){var t=r.node.getSiblingIndex()-1;t<0&&(t=r.node.parent.children.length-1);var i=r.node.parent.children[t];if(!i)return;_Scene.Undo.recordNode(r.node.uuid),r.connectedBody=i.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"choose-next-rigid-body"(e,n){var r=cc.engine.getInstanceById(n);if(r instanceof cc.Joint){var t=r.node.getSiblingIndex()+1;t>=r.node.parent.children.length&&(t=0);var i=r.node.parent.children[t];i||(i=r.node.parent),_Scene.Undo.recordNode(r.node.uuid),r.connectedBody=i.getComponent(cc.RigidBody),_Scene.Undo.commit()}},"is-child-class-of"(e,n,r){let t=cc.js._getClassById(n),i=cc.js._getClassById(r),l=cc.js.isChildClassOf(t,i);e.reply(null,l)},"has-copied-component":function(e){e.reply&&e.reply(null,r.hasCopiedComponent())},"query-animation-hierarchy"(e,n){let r=cc.engine.getInstanceById(n),i=r;for(;i&&!i.getComponent(cc.Animation);){if(i.parent instanceof cc.Scene){i=r;break}i=i.parent}e.reply&&e.reply(null,JSON.stringify(t.node(i,!0)))},"query-animation-list"(e,n){let r=cc.engine.getInstanceById(n);if(!r||r instanceof cc.Scene)return e.reply&&e.reply(null,[]),void 0;let t=r.getComponent(cc.Animation);if(!t)return e.reply&&e.reply(null,[]),void 0;let i=t.getClips(),l=(i=i.filter(function(e){return!!e})).map(e=>e._uuid);e.reply&&e.reply(null,l)},"query-animation-properties"(e,r){let t=cc.engine.getInstanceById(r),i=t;for(;i&&!i.getComponent(cc.Animation);){if(i.parent instanceof cc.Scene){i=t;break}i=i.parent}let l=Editor.getNodeDump(t),c=n.queryEditProperties(l,i!==t);e.reply&&e.reply(null,c)},"query-animation-record"(r){let t=e.curMode(),i=n.Cache.rNode,l=cc.engine.getInstanceById(n.Cache.component),c=l&&l.getAnimationState(n.Cache.animation).clip,o={record:t&&"animation"===t.name,root:i,clip:c?{id:c._uuid,name:c.name}:null};r.reply&&r.reply(null,o)},"query-animation-clip"(e,r){if(!n.curAnim)return e.reply&&e.reply(null,null);let t=n.curAnim.getClips();for(let n=0;n<t.length;n++){let i=t[n];if(i._uuid===r)return e.reply&&e.reply(null,Editor.serialize(i))}e.reply&&e.reply(null,null)},"query-asset-info"(e,n){e.reply&&Editor.assetdb.queryInfoByUuid(n,(...n)=>{e.reply(...n)})},"query-nodes-by-usedby-uuid"(e,n){let r=[];i.walkProperties(cc.director.getScene(),(e,t,i,c)=>{if(i instanceof cc.Asset&&i._uuid===n){let e=l.findLast(c,e=>e instanceof cc.Node);e&&r.push(e.uuid)}}),e.reply(null,r)}};