const e=require("fire-fs"),t=require("fire-path"),s=require("fire-url"),i=require("globby"),a=Editor.require("packages://assets/panel/utils/event"),r=Editor.require("packages://assets/panel/utils/cache"),o=Editor.require("packages://assets/panel/utils/operation"),l=Editor.require("packages://assets/panel/utils/utils");let n=function(e){return e.length<=1?e[0]:e[e.length-1]},d=function(e,t){let s=Editor.Selection.curSelection("asset"),i=n(s),a=t[t.findIndex(e=>e.id===i)+("down"===e?1:-1)];a&&Editor.Selection.select("asset",[a.id],!0,!0)},u=function(e){let t=r.queryShowNodes(),s=Editor.Selection.curSelection("asset"),i=n(s),a=s.indexOf(i),o=t.findIndex(e=>e.id===i),l=t[o],d=t[o+("down"===e?1:-1)];d&&(d.selected?(l.selected=!l.selected,s.splice(a,1)):(d.selected=!d.selected,d.selected?s.push(d.id):s.forEach((e,t)=>{e===d.id&&s.splice(t,1)})),Editor.Selection.select("asset",s,!0,!0))};Editor.Panel.extend({listeners:{"panel-resize"(){this._vm.length=(this.clientHeight-56)/r.lineHeight+3}},style:e.readFileSync(Editor.url("packages://assets/panel/style/index.css")),template:e.readFileSync(Editor.url("packages://assets/panel/template/index.html")),ready(){this._vm=function(e,t){return new Vue({el:e,data:{length:0,filter:"",currentPath:"db://",loading:!0},watch:{},methods:{},components:{tools:Editor.require("packages://assets/panel/component/tools"),nodes:Editor.require("packages://assets/panel/component/nodes"),search:Editor.require("packages://assets/panel/component/search")},created(){o.loadAssets(),a.on("filter-changed",e=>{this.filter=e}),a.on("start-loading",()=>{this.loading=!0}),a.on("finish-loading",()=>{this.loading=!1;let e=Editor.Selection.curSelection("asset");e.forEach(e=>{o.select(e,!0)}),e.length>0&&this.$refs.nodes.scrollToItem(e[0])}),a.on("empty-filter",()=>{let e=Editor.Selection.curSelection("asset");e.length>0&&this.$refs.nodes.scrollToItem(e[0])})}})}(this.shadowRoot),this._vm.length=(this.clientHeight-56)/r.lineHeight+3},close(){a.removeAllListeners(),this._vm&&this._vm.$destroy()},messages:{"assets:copy"(e,t){let s=Editor.Selection.curSelection("asset");-1===s.indexOf(t)?r.copyUuids=[t]:r.copyUuids=s},async"assets:paste"(e,s){let i=await l.uuid2path(s);if(!await l.isDir(i)&&(i=t.dirname(i),!await l.isDir(i)))return Editor.warn("The selected location is not a folder.");if(r.copyUuids&&await l.exists(i))for(let e=0;e<r.copyUuids.length;e++){let s=r.copyUuids[e];if(await l.isReadOnly(s))return;let a=await l.uuid2path(s);if(!a)return Editor.warn(`File is missing - ${s}`);let o=t.basename(a),n=t.join(i,o);if(await l.isDir(a)){let e=t.dirname(n);if(e===a||l.isSubDir(e,a))return Editor.Dialog.messageBox({type:"warning",title:" ",buttons:[Editor.T("MESSAGE.sure")],message:Editor.T("MESSAGE.assets.paste_folder_warn"),noLink:!0,defaultId:0}),void 0}if(!(n=await l.copy(a,n)))return;let d=t.relative(Editor.url("db://assets"),n);Editor.assetdb.refresh(`db://assets/${d}`)}},"assets:end-refresh"(e){this.hideLoader()},"assets:start-refresh"(e){this.showLoaderAfter(100)},"assets:sort"(e){o.autoSort(),this._vm.filter&&a.emit("search:sort")},"selection:selected"(e,t,s){if("asset"!==t||!s)return;let i=n(s);this._vm.currentPath=o.getRealUrl(i),s.forEach(e=>{o.select(e,!0)}),this._vm.filter?this._vm.$refs.search.scrollIfNeeded(i):this._vm.$refs.nodes.scrollIfNeeded(i)},"change-filter"(e,t){this._vm.filter=t},"selection:unselected"(e,t,s){"asset"===t&&s.forEach(e=>{o.select(e,!1)})},"asset-db:assets-created"(e,s){let i=[];if(s.forEach(e=>{if(e.hidden)return;let a=t.basenameNoExt(e.path),r=t.extname(e.path);"folder"===e.type?(a=t.basename(e.path),r=""):"mount"===e.type&&(a=e.name,r=""),o.add({name:a,extname:r,type:e.type,isSubAsset:e.isSubAsset,readonly:e.readonly,hidden:!1,parentUuid:e.parentUuid,uuid:e.uuid}),this._activeWhenCreated===e.url&&(this._activeWhenCreated=null,Editor.Selection.select("asset",e.uuid)),s.some(t=>t.uuid===e.parentUuid)||i.push(e)}),i.forEach(e=>{window.requestAnimationFrame(()=>{o.hint(e.uuid);let t=r.queryNode(e.uuid);t&&t.parent&&o.fold(t.parent,!1)})}),i.length){let e=i[0];this._vm.$refs.nodes.scrollToItem(e.uuid)}},"asset-db:assets-moved"(e,s){let i=Editor.Utils.arrayCmpFilter(s,(e,s)=>t.contains(e.srcPath,s.srcPath)?1:t.contains(s.srcPath,e.srcPath)?-1:0);i.forEach(e=>{Editor.assetdb.queryInfoByUuid(e.uuid,(s,i)=>{let a="";a="folder"===i.type?t.basename(e.destPath):t.basenameNoExt(e.destPath),o.move(e.uuid,e.parentUuid,a)})}),i.forEach(e=>{window.requestAnimationFrame(()=>{o.hint(e.uuid)})})},"asset-db:assets-deleted"(e,t){t.forEach(e=>{o.remove(e.uuid)});let s=t.map(e=>e.uuid);Editor.Selection.unselect("asset",s,!0)},"asset-db:asset-changed"(e,t){o.hint(t.uuid),"texture"!==t.type&&"sprite-frame"!==t.type||o.updateIcon(t.uuid)},"asset-db:asset-uuid-changed"(e,t){o.updateUuid(t.oldUuid,t.uuid)},"assets:hint"(e,t){this._vm.$refs.nodes.scrollToItem(t)},"assets:search"(e,t){this._vm.filter=t},"assets:clearSearch"(e){this._vm.filter=""},async"assets:new-asset"(a,l,n){let d,u,c;if(n){let e=Editor.Selection.contexts("asset");if(e.length>0){let s=e[0];"folder"===(u=r.queryNode(s)).assetType||"mount"===u.assetType?c=o.getRealUrl(u.id):(d=o.getRealUrl(u.id),c=t.dirname(d))}else c="db://assets"}else{let e=Editor.Selection.curActivate("asset");if(e){u=r.queryNode(e),d=o.getRealUrl(e),c="folder"===u.assetType||"mount"===u.assetType||u===r.queryRoot()?d:t.dirname(d)}else c="db://assets"}let h=l.data;l.url&&(h=e.readFileSync(Editor.url(l.url),{encoding:"utf8"}));let p=s.join(c,l.name);switch(s.extname(p)){case".fire":let e=Editor.Profile.load("project://project.json");(h=JSON.parse(h)).forEach(t=>{"cc.Canvas"===t.__type__&&(t._designResolution={__type__:"cc.Size",width:e.get("design-resolution-width"),height:e.get("design-resolution-height")},t._fitWidth=e.get("fit-width"),t._fitHeight=e.get("fit-height"))}),h=JSON.stringify(h);break;case".pac":if(i.sync(t.join(Editor.remote.assetdb.urlToFspath(c),"*.pac")).length>0)return Editor.Dialog.messageBox({type:"warning",title:" ",buttons:[Editor.T("MESSAGE.sure")],message:Editor.T("MESSAGE.assets.auto_atlas"),noLink:!0,defaultId:0}),void 0;break;case".js":case".ts":p=await o.getUniqueUrl(p,["typescript","javascript"])}(()=>{this._activeWhenCreated=p,Editor.assetdb.create(p,h,function(e,t){setTimeout(function(){if(!t)return;let e=t[0].uuid;Editor.Selection.select("asset",e,!0,!0),r.queryNode(e)&&o.rename(e)},50)})})()},"assets:find-usages"(e,t){this._vm.filter="used:"+t},"assets:rename"(e,t){o.rename(t)},"assets:delete"(e,t){this._delete(t)}},selectAll(e){e&&(e.stopPropagation(),e.preventDefault());let t=r.queryShowNodes().map(e=>e.id);Editor.Selection.select("asset",t,!0,!0)},showLoaderAfter(e){this._vm.loading||this._loaderID||(this._loaderID=setTimeout(()=>{this._vm.loading=!0,this._loaderID=null},e))},hideLoader(){this._vm.loading=!1,clearTimeout(this._loaderID)},find(e){},delete(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("asset");this._delete(t)},f2(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("asset");if(0===t.length)return;let s=n(t);o.rename(s)},left(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("asset"),s=n(t);o.fold(s,!0)},right(e){e&&(e.stopPropagation(),e.preventDefault());let t=Editor.Selection.curSelection("asset"),s=n(t);o.fold(s,!1)},async copyFile(e){e&&(e.stopPropagation(),e.preventDefault()),r.copyUuids=null;let t=[],s=Editor.Selection.curSelection("asset");for(let e=0;e<s.length;e++)await l.isReadOnly(s[e])||t.push(s[e]);r.copyUuids=t.length>0?t:null},async pasteFile(e){e&&(e.stopPropagation(),e.preventDefault());let s=Editor.Selection.curActivate("asset"),i="";if("mount-assets"===s?i=Editor.url("db://assets"):Editor.Utils.UuidUtils.isUuid(s)&&(i=await l.uuid2path(s)),!await l.isDir(i)&&(i=t.dirname(i),!await l.isDir(i)))return Editor.warn("The selected location is not a folder.");if(r.copyUuids&&await l.exists(i))for(let e=0;e<r.copyUuids.length;e++){let s=r.copyUuids[e];if(await l.isReadOnly(s))return;let a=await l.uuid2path(s);if(!a)return Editor.warn(`File is missing - ${s}`);let o=t.basename(a),n=t.join(i,o);if(await l.isDir(a)){let e=t.dirname(n);if(e===a||l.isSubDir(e,a))return Editor.Dialog.messageBox({type:"warning",title:" ",buttons:[Editor.T("MESSAGE.sure")],message:Editor.T("MESSAGE.assets.paste_folder_warn",{filename:o}),noLink:!0,defaultId:0}),void 0}if(!(n=await l.copy(a,n)))return;let d=t.relative(Editor.url("db://assets"),n);Editor.assetdb.refresh(`db://assets/${d}`)}},shiftUp(e){e&&(e.stopPropagation(),e.preventDefault()),u("up")},shiftDown(e){e&&(e.stopPropagation(),e.preventDefault()),u("down")},up(e){e&&(e.stopPropagation(),e.preventDefault()),d("up",this._vm.filter?this._vm.$refs.search.showList:r.queryShowNodes())},down(e){e&&(e.stopPropagation(),e.preventDefault()),d("down",this._vm.filter?this._vm.$refs.search.showList:r.queryShowNodes())},_delete(e){let t=e.map(e=>o.getRealUrl(e)),s=t;s.length>3&&(s=s.slice(0,3)).push("..."),s=s.join("\n"),0===Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.delete"),Editor.T("MESSAGE.cancel")],title:Editor.T("MESSAGE.assets.delete_title"),message:Editor.T("MESSAGE.assets.delete_message")+"\n"+s,detail:Editor.T("MESSAGE.assets.delete_detail"),defaultId:0,cancelId:1,noLink:!0})&&Editor.assetdb.delete(t)}});