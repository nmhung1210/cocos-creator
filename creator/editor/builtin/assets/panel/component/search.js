"use strict";const t=require("fs"),e=require("fire-path"),s=require("async"),{promisify:i}=require("util"),r=require("../utils/cache"),o=require("../utils/operation"),h=require("../utils/event"),l=require("../utils/utils");exports.template=t.readFileSync(e.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter","length"],exports.data=function(){return{nodes:r.queryNodes(),filterNodes:[],type:null,text:"",uuids:[],uh:{height:0},showList:[],start:0}},exports.watch={start(){this.reset()},length(){this.reset()},filterNodes(){this.reset()},nodes(){this.filter&&l.emptyFilter()},filter(){let t=this.filter;if(!t)return;let r=[],l="",n="",u=t.split(" ");t="";for(let e=0,s=u.length;e<s;e++){let s=u[e];if(s)if(/^t:.*/.test(s)){let t=s.substring(2).split(",").map(t=>t.trim());r=r.concat(t)}else/^u:.*/.test(s)?l=s.substring(2):/^used:.*/.test(s)?n=s.substring(5):t=s}clearTimeout(this._searchID),h.emit("start-loading",100),this.uuids=[],this._searchID=null;let d=setTimeout(async()=>{if(h.emit("finish-loading"),r.includes("asset-bundle")){let t=[];try{t=await i(Editor.assetdb.queryAssets)(null,"folder")}catch(t){return Editor.error(t),void 0}t.forEach(t=>{Editor.remote.assetdb.loadMeta(t.url).isBundle&&this.uuids.push(t.uuid)}),r=r.filter(t=>"asset-bundle"!==t)}let u=[];try{(r.length>0||l||n||t)&&(u=await i(Editor.assetdb.queryAssets)(null,r))}catch(t){return Editor.error(t),void 0}d===this._searchID&&(this.text=t.toLowerCase(),l=l.toLowerCase(),n=n.toLowerCase(),s.waterfall([t=>{if(!n||!Editor.Utils.UuidUtils.isUuid(n))return t(),void 0;Editor.assetdb.queryInfoByUuid(n,(e,s)=>{e?Editor.error(e):s&&this.isScript(s.type)&&(n=Editor.Utils.UuidUtils.compressUuid(n)),t()})},t=>{u.forEach(t=>{if(t.hidden)return;let s=e.basenameNoExt(t.path);e.extname(t.path);this.validate(s,this.text)&&this.validate(t.uuid,l)&&this.findUsages(t,n)&&this.uuids.push(t.uuid)}),t()},t=>{this.filterNodes=this.nodes.filter(t=>{if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(this.text){let e=t.name.toLowerCase();if(this.text=this.text.toLowerCase(),-1===e.indexOf(this.text))return!1}return!0}),t()}],()=>{Editor.Selection.curSelection("asset").forEach(t=>{o.select(t,!0)})}))},200);this._searchID=d}},exports.methods={isScript:t=>"javascript"===t||"typescript"===t,reset(){this._updateLock||(this._updateLock=!0,requestAnimationFrame(()=>{this._updateLock=!1,this.showNodeFilter()}))},sortShowNode(){r.sortAssetsTree(this.showList)},showNodeFilter:function(){this.uh.height=0,this.showList=[];let t=this.filterNodes,e=this.start+Math.ceil(this.length);e=e>t.length?t.length:e;for(let s=this.start;s<e;s++)this.showList.push(t[s]);r.sortAssetsTree(this.showList),this.uh.height=t.length*r.lineHeight+4},scrollIfNeeded(t){let e=r.queryNode(t);if(!e)return;let s=this.filterNodes.indexOf(e);if(-1===s)return;let i=s*r.lineHeight,o=this.$el.scrollTop+this.$el.clientHeight-r.lineHeight-2;i<this.$el.scrollTop-2?this.$el.scrollTop-=this.$el.scrollTop-2-i:i>=o&&(this.$el.scrollTop+=i-o)},validate:(t,e)=>t.toLowerCase().indexOf(e.toLowerCase())>-1,addShowList(t){-1===this.showList.indexOf(t)&&this.showList.push(t)},removeShowList(t){let e=this.showList.indexOf(t);-1!==e&&this.showList.splice(e,1)},findUsages(e,s){if(!s)return!0;if(s===e.uuid)return!1;if(!e.destPath)return!1;return t.readFileSync(e.destPath).indexOf(s)>=0},onUpdateFilter(t,e){if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(e){let s=t.name.toLowerCase();e=e.toLowerCase();let i=-1!==s.indexOf(e);return i?this.addShowList(t):this.removeShowList(t),i}return this.addShowList(t),!0},onScroll(t){let e=t.target.scrollTop;this.start=e/r.lineHeight|0},onDragStart:l.onDragStart,onDragOver:l.onDragOver,onDragEnd:l.onDragEnd},exports.created=function(){h.on("search:sort",this.sortShowNode)};