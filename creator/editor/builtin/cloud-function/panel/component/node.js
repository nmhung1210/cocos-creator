"use strict";const e=require("fs"),t=require("path"),n=(require("fire-url"),require("../utils/cache")),i=require("../utils/event"),o=require("../utils/utils"),r=require("../utils/operation"),s=require("../utils/communication"),l=require("../../selection");exports.template=e.readFileSync(t.join(__dirname,"../template/node.html"),"utf-8"),exports.props=["start","node"],exports.data=function(){return{style:{"padding-left":15*this.node.level+10,transform:`translateY(${this.start*n.lineHeight}px)`},iconUrl:this.node.iconUrl,oldIconUrl:null,lockRename:!1}},exports.created=function(){this.genIcon()},exports.watch={"node.rename":{handler:function(e,t){e&&!t&&(this.oriName=this.node.name),!e&&t&&this.nodeRename()}},"node.level":{handler:function(e,t){this.style["padding-left"]=15*e+10}},"node.iconUrl":{handler:function(e,t){this.oldIconUrl=t,this.genIcon()}}},exports.methods={t:e=>Editor.T(`HIERARCHY.${e}`),onUpdateStyle(e){return this.style.transform=`translateY(${e*n.lineHeight}px)`,this.style},genIcon(){if(this.node.iconUrl)return this.iconUrl=this.node.iconUrl,void 0;let e,t,n=this.node.assetType,i=this.node.id;if("texture"===n)return t='url("'+(e=`thumbnail://${i}?32`)+'")',this.iconUrl=`background-image:${t}`,this.oldIconUrl===this.iconUrl&&(t='url("'+(e+="&_ts="+Date.now())+'")',this.iconUrl=`background-image:${t}`),this.node.iconUrl=this.iconUrl,void 0;if("sprite-frame"===n){var o=this;return Editor.assetdb.queryMetaInfoByUuid(i,(e,t)=>{if(!t)return this.iconUrl=`background-image:${o._getDefaultIcon(n)}`,void 0;var i=JSON.parse(t.json);this.iconUrl=`background-image:${o._getDrawFrameIcon(i)}`,this.node.iconUrl=this.iconUrl}),void 0}this.iconUrl=`background-image:${this._getDefaultIcon(n)}`,this.node.iconUrl=this.iconUrl},_getDefaultIcon(e){let t,n=Editor.metas[e];return n&&n["asset-icon"]?'url("'+(t=n["asset-icon"])+'")':'url("'+(t="packages://assets/static/icon/"+e+".png")+'")'},_getDrawFrameIcon(e){let t,n,i=`thumbnail://${e.rawTextureUuid}?32`,o=e.trimX,r=e.trimY,s=0;e.rotated?(t=e.height,n=e.width,s=270):(t=e.width,n=e.height);let l=`&x=${o}&y=${r}&w=${t}&h=${n}`;0!==s&&(l+=`&rotate=${s}`);let a='url("'+(i+=l)+'")';return this.iconUrl===a&&(a='url("'+(i+="&_ts="+Date.now())+'")'),a},onClick(){this.node.selected&&!this.node.rename},onMouseDown(e){if(e.stopPropagation(),l.setContext("cloud-function",this.node.id),this._renameCancel(),2===e.button)return s.popup("context",{x:e.clientX,y:e.clientY,id:this.node.id,assetType:this.node.assetType,allowAssign:!1,copyEnable:!this.node.readonly&&!this.node.isSubAsset}),void 0},onMouseEnter(){l.hover("cloud-function",this.node.id)},onMouseUp(e){if(l.setContext("cloud-function"),e.ctrlKey||e.metaKey){let e=l.curSelection("cloud-function"),t=e.indexOf(this.node.id);return-1!==t?e.splice(t,1):e.push(this.node.id),l.select("cloud-function",e,!0,!0),void 0}if(e.shiftKey){let e=l.curSelection("cloud-function");if(!e||e.length<=0)return e=this.node.id,l.select("cloud-function",e,!0,!0),void 0;let t=n.queryShowNodes(),i=(n.queryNode(e[0]),t.findIndex(t=>t.id===e[0])),o=t.findIndex(e=>e.id===this.node.id);if(-1===i||-1===o)return console.log("can find uuid"),void 0;if(e[0]===this.node.id)return e=this.node.id,l.select("cloud-function",e,!0,!0),void 0;e=[];let r=i>o?-1:1;for(let n=i;n!==o+r;n+=r){let i=t[n];e.push(i.id)}return l.select("cloud-function",e,!0,!0),void 0}let t=this.node.id;l.select("cloud-function",t,!0,!0)},onMouseLeave(){l.hover("cloud-function",null)},onDBClick(t){if(t.stopPropagation(),t.preventDefault(),clearTimeout(this._renameTimer),1!==t.which||this.node.rename)return;if(t.shiftKey||t.metaKey||t.ctrlKey)return;if(!e.lstatSync(this.node.id).isDirectory())return this.onOpenAsset(this.node.id);let n=!this.node.fold;r.fold(this.node.id,n)},onIClick(e){e.stopPropagation(),e.preventDefault(),this._renameCancel();let t=!this.node.fold;e.altKey&&r.recFoldNodes(this.node.id,t),r.fold(this.node.id,t)},onIDBClick(e){e.stopPropagation(),e.preventDefault()},onIMouseDown(e){e.stopPropagation(),e.preventDefault()},onIMouseUp(e){e.stopPropagation(),e.preventDefault()},onInputBlur(e){if(e.stopPropagation(),this.lockRename)return this.lockRename=!1,void 0;this._renameSubmit(e.target.value)},nodeRename(){this.node.name?i.emit("create-cloud-function",this.node.name,this.node.id):(Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:o.tr("cloud-fcuntion-name-not-empty"),noLink:!0}),this.node.name=this.oriName,r.loadAssets(!1)),clearTimeout(this._renameTimer)},onInputKeydown(e){switch(e.stopPropagation(),e.keyCode){case 13:this.lockRename=!0,this._renameSubmit(e.target.value);case 27:this.lockRename=!0,this._renameCancel(!0)}},onInputMouseDown(e){e.stopPropagation()},onInputClick(e){e.stopPropagation(),e.preventDefault()},onOpenAsset(e){Editor.Ipc.sendToMain("cloud-function:open-text-file",e)},_renameSubmit(e){this.node.name=e,r.rename(),clearTimeout(this._renameTimer)},_renameCancel(e){r.rename(),clearTimeout(this._renameTimer),e&&i.emit("nodes_focus",!0)}},exports.directives={init(){setTimeout(()=>{if(!this.vm||!this.vm.$el)return;let e=this.vm.$el.getElementsByTagName("input")[0];e&&(e.focus(),e.select())},100)}};