"use strict";const e=require("fire-url"),t=require("./cache"),o=require("./event"),r=require("./utils");exports.loadAssets=function(e=!0){e&&o.emit("start-loading"),requestAnimationFrame((r,n)=>{try{t.genAssetsTree().children.forEach(e=>this.fold(e.id,!1))}catch(e){Editor.warn(e.message)}e&&o.emit("finish-loading")})},exports.show=function(e,o){let r=t.queryNode(e);return!!r&&(r.show=o,this.updateShowNodes(),!0)},exports.select=function(e,o){let r=t.queryNode(e);r&&(r.selected=o)},exports.rename=function(e){let o=t.queryCache();for(let t in o){let r=o[t];r.rename=r.id===e&&!r.readonly&&!r.isMount}},exports.fold=function(e,o){let r=t.queryCache()[e];if(!r)return console.log("can't find node ",e),!1;r.fold=o,r.children&&r.children.forEach(e=>(function e(t){t.show=!o,o?t.children.forEach(t=>e(t)):o===t.fold&&t.children.forEach(t=>e(t))})(e)),n(e,o),this.updateShowNodes()};let n=function(e,t){const o=`${Editor.Project.path}/local/cloud-funtion-state.json`;var n=r.readJson(o);n.nodeFoldStates||(n.nodeFoldStates=[]);var d=n.nodeFoldStates.indexOf(e);t?-1===d&&n.nodeFoldStates.push(e):d>=0&&n.nodeFoldStates.splice(d,1),r.saveJson(o,n)};exports.recFoldNodes=function(e,o){let r=t.queryNode(e);if(!r)return!1;r.children&&r.children.forEach(e=>{this.fold(e.id,o),this.recFoldNodes(e.id,o)})},exports.recParentNodes=function(e,o){let r=t.queryNode(e);if(!r)return;let n=e=>{let r=t.queryNode(e.parent);r&&(r!==t.queryRoot()&&this.fold(r.id,o),r.parent&&n(r))};n(r)},exports.updateShowNodes=function(){let e=t.queryRoot(),o=[],r=function(e){e.show&&e.children&&e.children.forEach(e=>{e.show&&(o.push(e),r(e))})};r(e),t.updateShowNodes(o)},exports.getRealUrl=function(o,r){let n=t.queryCache(),d=(t.queryRoot(),n[o]);if(!d)return null;let i=(r||d.name)+d.extname,s=n[d.parent];for(;s;)i=e.join(s.name+s.extname,i),s=n[s.parent];return i},exports.getPath=function(o){let r=t.queryCache(),n=r[o];if(!n)return null;let d="",i=r[n.parent];for(;i;)d=e.join(i.name+i.extname,d),i=r[i.parent];return d="db://"+d},exports.move=function(e,o,r){let n=t.queryNode(e);n.name=r||n.name;let d=t.queryNode(o);if(!d)return;let i=t.queryNode(n.parent),s=i.children.indexOf(n);s>-1&&i.children.splice(s,1),d.children.push(n),n.parent=o,n.level=d.level+1,n.children.forEach(e=>{e.level=n.level+1}),d.children.sort(t.sortChildrenNodes),this.fold(d.id,!1)},exports.updateUuid=function(e,o){let r=t.queryNode(e),n=t.queryCache();r.id=o,delete n[e],n[o]=r},exports.updateIcon=function(e){let o=t.queryNode(e);if(!o)return;o.iconUrl=null;let r=t.queryNode(o.parent);r&&(r.iconUrl=null)},exports.hint=function(e){let o=t.queryNode(e);if(!o||o.hint)return!1;o.hint=!0,setTimeout(()=>{o.hint=!1},800)},exports.remove=function(e){t.remove(e)&&this.updateShowNodes()},exports.add=function(e,o=!1){var r=t.add(e,o);return this.updateShowNodes(),r},exports.autoSort=function(){t.sortAssetsTree(),this.updateShowNodes()};let d=[];exports.staging=function(e){let o=t.queryNodes();d.length=0,o.forEach(t=>{t.selected&&d.push(t.id),t.selected=-1!==e.indexOf(t.id)})},exports.restore=function(){let e=[];return t.queryNodes().forEach(t=>{t.selected&&e.push(t.id),t.selected=-1!==d.indexOf(t.id)}),d=[],e};