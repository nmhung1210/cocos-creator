let e=require("./jszip.min.js"),t=require("path"),i=require("fs-extra"),n=require("./worker-util.js"),a=require("./adapter-util.js"),r=require("./tinypack-util.js"),o={};e.prototype.directory=function(e,n){if(!i.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;i.readdirSync(e).forEach(function(e){let n=this.zip,a=t.join(this.srcPath,e),r=i.statSync(a);r.isDirectory()?n.directory(a,e):r.isFile()?n.file(e,i.readFileSync(a)):Editor.error(a+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(n)}))},e.prototype.append=function(e,t){if(!i.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(t,i.readFileSync(e))},module.exports={async gatherInfo(s,c){if(o.customConfig=Editor.Profile.load("project://qtt-runtime.json").getSelfData(),!1===this.checkData(o,c,s))return!1;let m=o.customConfig;o.isTinyPackage=""!==m.tinyPackageServer,o.projectPath=s.project,o.buildPath=s.dest,o.options=s,o.title=s.title,o.cpkName=o.customConfig.package+"_"+o.customConfig.versionName+"_"+o.customConfig.versionCode+".cpk";let u=m.outputCpkPath,d=m.useCustomCpkPath;return o.buildResults=s.buildResults,o.startScene=s.startScene,!0===d?""!==u&&i.existsSync(u)?o.cpkPath=t.join(u,o.cpkName):(Editor.log(Editor.T("qtt-runtime.out_cpk_path_error")),o.cpkPath=t.join(o.buildPath,o.cpkName)):o.cpkPath=t.join(o.buildPath,o.cpkName),o.gameConfig={deviceOrientation:m.deviceOrientation,showStatusBar:m.showStatusBar,runtimeVersion:m.runtimeVersion},o.mainfest={deviceOrientation:m.deviceOrientation,package:m.package,name:m.name,versionName:m.versionName,versionCode:m.versionCode,icon:"logo.png"},o.JsZip=e,o.cpk=new e,await n.gatherInfo(o),await a.gatherInfo(o),await r.gatherInfo(o),!0},checkData(e,n,a){var r=e.customConfig.package,o=e.customConfig.name,s=e.customConfig.versionName,c=e.customConfig.versionCode,m=e.customConfig.icon,u=!0,d=[],p="";[{name:Editor.T("qtt-runtime.package"),value:r},{name:Editor.T("qtt-runtime.name"),value:o},{name:Editor.T("qtt-runtime.desktop_icon"),value:m},{name:Editor.T("qtt-runtime.version_name"),value:s},{name:Editor.T("qtt-runtime.version_number"),value:c}].forEach(function(e){e.value||(u=!1,d.push(e.name))}),u||(p+=d.join("„ÄÅ")+Editor.T("qtt-runtime.not_empty")),m&&(i.existsSync(m)||(u=!1,p+=m+Editor.T("qtt-runtime.icon_not_exist")));r.match(/^[a-zA-Z]+[0-9a-zA-Z]*(\.[a-zA-Z]+[0-9a-zA-Z]*)*$/)||(u=!1,p+=Editor.T("qtt-runtime.package_name_error"));o.match(/^[0-9a-zA-Z]*(\.[a-zA-Z]+[0-9a-zA-Z]*)*$/)||(u=!1,p+=Editor.T("qtt-runtime.game_name_error"));s.match(/^[0-9]*(\.[0-9]*)*$/)||(p+=Editor.T("qtt-runtime.game_version_name_error"));return c.match(/^[1-9]+[0-9]*]*$/)||(p+=Editor.T("qtt-runtime.game_version_number_error")),u?(i.existsSync(t.join(a.dest,"remote"))&&""===e.customConfig.tinyPackageServer&&Editor.warn(Editor.T("qtt-runtime.had_set_remote_without_tiny_mode")),!0):(n.reply(new Error(p)),!1)},async organizeResources(e){let r=o.buildPath;return await n.organizeResources(),!1!==await a.organizeResources(e)&&(i.writeJSONSync(t.join(r,"game.config.json"),o.gameConfig),i.writeJSONSync(t.join(r,"manifest.json"),o.mainfest),this.handleMainJS(),!0)},handleMainJS(){let e=Editor.url("packages://runtime-adapters/platforms/qtt");var n=t.join(o.buildPath,"main.js");i.copySync(t.join(e,"res","main.js"),n)},async pack(){let e=o.cpk,s=o.cpkPath,c=o.buildPath;i.existsSync(s)&&i.unlinkSync(s);let m=i.createWriteStream(s);await n.pack(),await a.pack(),await r.pack(),e.directory(t.join(c,"src"),"src"),e.directory(t.join(c,"assets"),"assets"),e.append(o.customConfig.icon,"logo.png"),e.append(t.join(c,"main.js"),"main.js"),e.append(t.join(c,"game.config.json"),"game.config.json"),e.append(t.join(c,"manifest.json"),"manifest.json"),e.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(m).on("finish",function(){r.packFinished()})}};