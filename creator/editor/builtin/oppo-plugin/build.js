const e="project://oppo-runtime.json",r="manifest.json",t="sign",n="logo.png",o="main.js";var i,a,s,p,u,c,d,m,l,v,g,f=require("path"),y=require("fs-extra"),{execSync:_,spawn:E}=require("child_process"),k=require("fix-path"),S={},j="win32"===process.platform;function h(e){let r=Editor.url("packages://runtime-adapters/platforms/oppo");return void 0===e||""===e?r:f.join(r,e)}function b(){return f.join(Editor.url("packages://runtime-adapters/quickgame-toolkit/lib/bin"),"index")}function T(e,l){Editor.log("Checking config file "+l.dest),i.npmPath?(Editor.log(Editor.T("oppo-runtime.custom_npm_path_config"),i.npmPath),S.Path=i.npmPath):(v&&Editor.log(Editor.T("oppo-runtime.custom_npm_path_not_config")),k(),S=process.env),!1!==x()&&(s=l.dest,a=f.resolve(l.dest,"..","tempTinyRes"),function(e){for(var r=[],t=[],n=0,o=e.bundles.length;n<o;n++){var i=e.bundles[n];if("subpackage"!==i.compressionType)continue;let o=f.join(i.scriptDest,"index.js");y.existsSync(o)&&y.renameSync(o,f.join(i.scriptDest,"main.js"));let a=i.name;t.includes(a)||(t.push(a),r.push({name:"usr_"+a,root:"subpackages/"+a+"/"}))}if(0===r.length)return u=void 0,void 0;u=r}(l),y.writeFileSync(f.join(s,n),y.readFileSync(p)),function(){var e=f.join(s,t);if(y.emptyDirSync(e),!m){var r=f.join(e,"release");y.ensureDirSync(r),y.existsSync(c)&&y.writeFileSync(f.join(r,"private.pem"),y.readFileSync(c)),y.existsSync(d)&&y.writeFileSync(f.join(r,"certificate.pem"),y.readFileSync(d))}}(),function(){var e=f.join(s,r),t={package:i.package,name:i.name,versionName:i.versionName,versionCode:i.versionCode,minPlatformVersion:i.minPlatformVersion,icon:"/logo.png",features:[{name:"system.prompt"},{name:"system.router"},{name:"system.shortcut"}],permissions:[{origin:"*"}],orientation:i.deviceOrientation};u&&(t.subpackages=u);var n=JSON.stringify(t);y.writeFileSync(e,n)}(),async function(e){let r=require("./build-jsb-adapter"),t=f.join(h("engine"),"index.js"),n=f.join(s,"jsb-adapter","engine","index.js");await r.build({rootPath:t,dstPath:n,isDebug:g.debug}),e&&e()}(function(){void y.copySync(f.join(h("res"),o),f.join(s,o)),function(){if(""===i.tinyPackageServer)return;var e=f.join(s,"remote"),r=f.join(a,"remote");y.emptyDirSync(r),y.existsSync(e)&&y.moveSync(e,r)}(),function(e){if(void 0===u)return function(e){var r=[b(),"cocoscreator"];m||r.push("release");var t=E("node",r,{env:S,cwd:s});t.stdout.on("data",e=>{}),t.stderr.on("data",e=>{Editor.error(`${e}`)}),t.on("close",r=>{var t=f.join(s,"dist",i.package+(m?".":".signed.")+"rpk");if(!y.existsSync(t))return e.reply(new Error(Editor.T("oppo-runtime.rpk_install_fail"))),void 0;Editor.log(Editor.T("oppo-runtime.rpk_install_success")+t),P(),e&&e.reply(),w()})}(e),void 0;Editor.log(Editor.T("oppo-runtime.building_subpack_rpk")),function(e){var r=[b(),"subpack","--no-build-js"];m||r.push("release");var t=E("node",r,{env:S,cwd:s});t.stdout.on("data",e=>{}),t.stderr.on("data",e=>{Editor.error(`${e}`)}),t.on("close",r=>{var t=f.join(s,"dist",i.package+(m?".":".signed.")+"rpk");if(!y.existsSync(t))return e.reply(new Error(Editor.T("oppo-runtime.build_subpack_rpk_error"))),void 0;var t=f.join(s,"dist",i.package+(m?".":".signed.")+"rpk");Editor.log(Editor.T("oppo-runtime.build_subpack_rpk_complet")+t),P(),e.reply(),w()})}(e)}(e)}))}function x(){try{_("node -v",{env:S})}catch(e){return i.npmPath?(event.reply(new Error(Editor.T("oppo-runtime.custom_npm_path_config_error"))),void 0):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),j&&event.reply(new Error(Editor.T("oppo-runtime.not_install_nodejs_windows_error"))),event.reply(new Error(Editor.T("oppo-runtime.not_install_nodejs_mac_error"))),!1)}return!0}function P(){var e=f.join(a,"remote"),r=f.join(s,"remote");""!==i.tinyPackageServer&&y.existsSync(e)&&(y.emptyDirSync(r),y.copySync(e,r)),y.existsSync(a)&&y.removeSync(a)}function w(){let e={resUrl:i.tinyPackageServer,orientation:i.deviceOrientation,projectName:i.name};Editor.Ipc.sendToMain("builder:notify-build-result",g,e),!0===i.useDebugKey||i.package.indexOf("test")>-1||i.name.indexOf("test")>-1||!0===l||Editor.Metrics.trackEvent("Project","BetaPlatforms","oppo-runtime",{packageName:i.package,appName:i.name,version:i.versionName,orientation:i.deviceOrientation})}module.exports={name:Editor.T("oppo-runtime.platform_name"),platform:"quickgame",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build],messages:{"script-build-finished":function(r,t){let n=Editor.Profile.load(e);t.settings.server=n.get("tinyPackageServer")||"",r.reply()},"build-finished":function(r,t){g=t;var n=Editor.Profile.load(e),o=(i=n.getSelfData()).package,a=i.name,s=i.versionName,u=i.versionCode,_=i.minPlatformVersion;v=i.showNpmPath,c=i.privatePath,d=i.certificatePath,m=i.useDebugKey,p=i.icon,l=t.debug,sendStatisticsSourceMaps=t.sourceMaps;var E=!0,k=[],S="";if([{name:Editor.T("oppo-runtime.package"),value:o},{name:Editor.T("oppo-runtime.name"),value:a},{name:Editor.T("oppo-runtime.desktop_icon"),value:p},{name:Editor.T("oppo-runtime.version_name"),value:s},{name:Editor.T("oppo-runtime.version_number"),value:u},{name:Editor.T("oppo-runtime.support_min_platform"),value:_}].forEach(function(e){e.value||(E=!1,k.push(e.name))}),E||(S+=k.join("„ÄÅ")+Editor.T("oppo-runtime.not_empty")),p&&(y.existsSync(p)||(E=!1,S+=p+Editor.T("oppo-runtime.icon_not_exist"))),m||(""===c?(E=!1,S+=Editor.T("oppo-runtime.private_pem_path_error")):y.existsSync(c)||(E=!1,S+=`${c}`+Editor.T("oppo-runtime.signature_not_exist")),""===d?(E=!1,S+=Editor.T("oppo-runtime.certificate_pem_path_error")):y.existsSync(d)||(E=!1,S+=`${d}`+Editor.T("oppo-runtime.signature_not_exist"))),o.match(/^[a-zA-Z]+[0-9a-zA-Z_]*(\.[a-zA-Z]+[0-9a-zA-Z_]*)*$/)||(E=!1,S+=Editor.T("oppo-runtime.package_name_error")),!E)return r.reply(new Error(S)),void 0;y.existsSync(f.join(t.dest,"remote"))&&""===i.tinyPackageServer&&Editor.warn(Editor.T("oppo-runtime.had_set_remote_without_tiny_mode")),T(r,t)}},md5:{globalIgnore:function(){return[/.*/]}},buildStart:function(r){let t=Editor.Profile.load(e);r.startSceneAssetBundle=t.get("packFirstScreenRes")||!1},delPattern:function(e){let r=e.dest;return[f.join(r,"**/*")]},settings:Editor.url("packages://oppo-runtime/build-ui.js")};