"use strict";const e=require("async"),r=require("path"),t=require("fire-fs"),i=require("xmldom").DOMParser,n=require("fire-url"),o=require("plist"),a=require("./csd-importer"),s=require("./xml-utils"),c="db://assets",l="cocosstudio",f="temp",d=/page [^\n]*(\n|$)/gi,u=/\w+=[^ \r\n]+/gi,m=/^[\-]?\d+$/;var g="",y="",v="",S="",p="",E=[];function h(e){t.existsSync(e)&&(t.readdirSync(e).forEach(function(i){var n=r.join(e,i);t.lstatSync(n).isDirectory()?h(n):t.unlinkSync(n)}),t.rmdirSync(e))}function b(e){if(!t.existsSync(e))return Editor.warn("%s is not found!",e),void 0;var i=r.relative(v,e),n=r.join(g,i);t.existsSync(n)||t.copySync(e,n)}function j(e){var i=r.relative(v,e),n=r.join(g,i);t.existsSync(n)||t.mkdirsSync(n)}function x(e){if(b(e),t.existsSync(e)){var i=o.parse(t.readFileSync(e,"utf8"));if(i){var n=r.join(r.dirname(e),i.textureFileName);t.existsSync(n)&&b(n)}}}function F(e){if(b(e),t.existsSync(e)){var n=t.readFileSync(e,"utf-8"),o=(new i).parseFromString(n);if(!o)return Editor.warn("Parse %s failed.",e),void 0;for(var a=o.documentElement.getElementsByTagName("tileset"),s=0,c=a.length;s<c;s++){var l=a[s],f=l.getAttribute("source");if(f){var d=r.join(r.dirname(e),f);if(b(d),t.existsSync(d)){var u=t.readFileSync(d,"utf-8"),m=(new i).parseFromString(u);m?g(m,d):Editor.warn("Parse %s failed.",d)}}g(l,e)}}function g(e,t){for(var i=e.getElementsByTagName("image"),n=0,o=i.length;n<o;n++){var a=i[n].getAttribute("source");if(a)b(r.join(r.dirname(t),a))}}}function w(e){if(b(e),t.existsSync(e)){var i=t.readFileSync(e,"utf8").match(d);if(!i||0===i.length)return Editor.warn("Parse fnt file %s failed!",e),void 0;var n=i[0].match(u);if(n){for(var o={},a=0,s=n.length;a<s;a++){var c=n[a],l=c.indexOf("="),f=c.substring(0,l),g=c.substring(l+1);g.match(m)?g=parseInt(g):'"'===g[0]&&(g=g.substring(1,g.length-1)),o[f]=g}if(o.file)b(r.join(r.dirname(e),o.file));else Editor.warn("Get image file config from fnt file %s failed!",e)}else Editor.warn('Get "page" config from fnt file %s failed!',e)}}module.exports={name:"Cocos Studio",exts:"ccs",importer:function(o,d){if(Editor.log("Import Cocos Studio project : ",o),y=r.dirname(o),v=r.join(y,l),!t.existsSync(v)||!t.isDirSync(v))return d(new Error(`Resource directory ${v} is not existed.`)),void 0;var u=t.readFileSync(o,"utf-8"),m=(new i).parseFromString(u);if(!m)return d(new Error(`Parse ${o} failed.`)),void 0;var N=m.documentElement;try{(function(e){var r=e.getElementsByTagName("PropertyGroup")[0];p=r.getAttribute("Name");var t=r.getAttribute("Version");S=n.join(c,p),Editor.log("Project Name : %s, Cocos Studio Version : %s",p,t)})(N)}catch(e){return d(new Error("Illegal format of project file.")),void 0}(function(){var e=n.basename(S);g=r.join(Editor.remote.Project.path,f,e),t.existsSync(g)&&h(g),t.mkdirsSync(g)})();try{j(v);var P=N.getElementsByTagName("SolutionFolder");(function e(t,i){for(var n=0,o=t.childNodes.length;n<o;n++){var a=t.childNodes[n];if(!s.shouldIgnoreNode(a)){var c=a.getAttribute("Name"),l=r.join(i,c);switch(a.nodeName){case"Folder":j(l),e(a,l);break;case"Project":E.push(l);break;case"PlistInfo":break;case"Image":case"TTF":case"Audio":b(l);break;case"PlistImageFolder":var f=r.join(i,a.getAttribute("PListFile"));b(f);var d=r.join(i,a.getAttribute("Image"));b(d);break;case"Fnt":w(l);break;case"PlistParticleFile":x(l);break;case"TmxFile":F(l)}}}})((P=(P=P[0].getElementsByTagName("Group"))[0].getElementsByTagName("RootFolder"))[0],v),e.waterfall([function(e){Editor.assetdb.import([g],c,!1,function(r,t){e()})},function(e){a.importCSDFiles(E,v,g,S,e)}],function(){Editor.log("Import Cocos Studio project finished."),Editor.log("Resources are imported to folder : %s",S),function(){try{h(g)}catch(e){Editor.warn("Delete temp path %s failed, please delete it manually!",g)}}(),d()})}catch(e){d(new Error("Import resource files failed."))}}};