const e=require("electron").app,t=require("electron").ipcMain,a=require("http"),o=require("https"),n=require("node-uuid"),s=require("./encrypt"),{caAppID:r,caURL:i,caEncryptURL:l}=require("./config"),{EventEmitter:c}=require("events");module.exports=new class extends c{constructor(){super(),this._openTime=Date.now(),this._showLog=!1,this._defaultParams={appVersion:`CocosCreator_${e.getVersion()}`,versionCode:"v1",uniqueID:this.user.userId+"",appID:r,platform:"darwin"===process.platform?"Mac":"Windows",engine:"electron",userID:this.user.userId+"",packageName:"",osVersion:require("os").release(),store:""},this.loadLogStatus()}loadLogStatus(){let e=Editor.Profile.load("global://features.json");this._showLog=!!e.get("debug-analytics")}init(){}get openTime(){return this._openTime}updateOpenTime(){this._openTime=Date.now()}get user(){let e=Editor.Profile.load("global://user_token.json");return{userName:e.get("nickname"),email:e.get("email"),userId:e.get("cocos_uid")}}_genMsgID(){return n.v4()}trackCocosEvent(e,t){if(!e||!t||!t.projectId)return;let a=this.defaultParams;t.store&&(a.store=t.store,delete t.store),t.packageName&&(a.packageName=t.packageName,delete t.packageName),a.language=Editor.lang||"unknown",a.eventID=e,a.eventValue=t,a.eventTag="succeed",this._showLog&&console.log("send analytics --\x3e",JSON.stringify(a));let o=l+encodeURIComponent(s.encryptPostData(JSON.stringify(a)));this._get(o)}trackEvent(e){let t={action:e.action};e.label&&(t.label=e.label),e.value&&(t=Object.assign(t,e.value));let a="succeed";e.value&&e.value.eventTag&&(a=e.value.eventTag,delete t.eventTag);let o=this.defaultParams;o.language=Editor.lang||"unknown",o.eventID=e.category,o.eventValue=t,o.eventTag=a,e.exitTag&&(o.exitTag=e.exitTag,o.eventTag=e.exitTag),e.onlineDuration&&(o.onlineDuration=e.onlineDuration);let n=i+encodeURIComponent(JSON.stringify(o));this._get(n)}_get(e){(e.startsWith("https://")?o:a).get(e,e=>{e.on("data",e=>{this._showLog&&console.log("receive analytics data --\x3e",e.toString())})}).on("error",e=>{this._showLog&&console.error("send analytics data fail",e)})}trackException(e){let t=this.defaultParams;t.eventID="exception",t.eventValue={desc:e},t.eventTag="succeed";let a=i+encodeURIComponent(JSON.stringify(t));this._get(a)}get defaultParams(){return this._defaultParams.eventID=void 0,this._defaultParams.eventValue=void 0,this._defaultParams.eventTag=void 0,this._defaultParams.msgID=this._genMsgID(),this._defaultParams.chargeTime=String(Date.now()),this._defaultParams}},t.on("cocos-metrics:track-event",(e,t)=>{module.exports.trackEvent(t,null)}),t.on("cocos-metrics:track-cocos-event",(e,t)=>{module.exports.trackCocosEvent(t,null)}),t.on("cocos-metrics:track-exception",(e,t)=>{module.exports.trackException(t,null)});