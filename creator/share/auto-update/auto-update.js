"use strict";const e=require("electron"),o=require("electron-dl"),t=Editor.versions.CocosCreator,i=require("electron").ipcMain,r=require("child_process").spawn,n=require("http"),a=require("fire-path"),d=require("fire-fs"),l=Editor.testing?"test":"",s=`http://fbupdater.leanapp.cn/updatemac/latest?testing=${l}&version=${t}`,u=`http://fbupdater.leanapp.cn/hotupdates/latest?testing=${l}&version=${t}`,c=a.join(Editor.App.path,".."),p=a.join(require("os").tmpdir(),"fireball-hotupdate");let f="",h="",v="",g=[],m="",E=null,b=!1;function w(e){let t=Editor.Profile.load("global://updates.json"),i=require("lodash"),r={},n="";for(let o=0;o<e.length;++o)if(r=e[o],!i.includes(t.get("installed-hotupdates"),r.objectId)&&(n=r.package_info[process.platform])){f=r.package_info["name_"+Editor.lang],h=r.notes;break}if(n){let e=require("md5-file");o.download(Editor.Window.main.nativeWin,n).then(o=>{v=o.getSavePath(),e(v,(e,o)=>e?(console.error(e),void 0):o!==r.md5?(console.log(`Downloaded hot-updates ${f} for v${r.version} failed md5 hash check. Abort updating.`),void 0):(m=r.objectId,function(){if(!d.existsSync(v))return console.error("Auto update failed! Downloaded file is damaged or removed!"),void 0;if(".zip"!==a.extname(v))return console.error("Hot update failed! Downloaded file is not zipped!"),void 0;let e=require("decompress");d.emptyDirSync(p),e(v,p).then(e=>{g=e.map(function(e){return a.join(c,e.path)}),q()}).catch(console.error)}(),void 0))}).catch(console.error)}}function q(){if(h){let e=["en","zh"],o=h.split("!#").map(function(o){var t=o.slice(0,2),i=e.indexOf(t);return-1===i?{notes:o,invalid:!0}:{notes:o.slice(2),lang:e[i]}}).filter(function(e){return!(!e||!e.notes||e.invalid)});for(let e=0;e<o.length;++e){let t=o[e];t.lang===Editor.lang&&(h=t.notes)}}else h="";E=new Editor.Window("Update",{title:Editor.T("DOWNLOADER.title"),width:600,height:700,alwaysOnTop:!0,show:!1,resizable:!0});let e=Editor.Window.main,o=e.nativeWin.getPosition(),t=e.nativeWin.getSize(),i=o[0]+t[0]/2-300,r=o[1];E.load("app://dashboard/page/update-index.html"),E.nativeWin.setPosition(Math.floor(i),Math.floor(r)),E.nativeWin.setMenuBarVisibility(!1),E.nativeWin.setTitle(Editor.T("DOWNLOADER.title")),E.show()}if(i.on("dashboard:query-update-info",e=>{let o=null;f&&h||(o=new Error("invalid update info")),e.reply(o,{releaseName:f,releaseNotes:h,downloadedPath:v,hotUpdateFiles:g})}),i.on("dashboard:install-update",()=>{if(!d.existsSync(v))return console.error("Auto update failed! Downloaded file is damaged or removed!"),void 0;e.shell.openItem(v),E&&E.close(),e.app.quit()}),i.on("dashboard:cancel-update",()=>{E&&E.close()}),i.on("dashboard:install-hotupdate",()=>{d.copy(p,c,{clobber:!0},function(o){if(o)return Editor.error(o),Editor.log("Hot update failed, please check if the application folder is writable and current user has permission."),void 0;let t=Editor.Profile.load("global://updates.json"),i=t.get("installed-hotupdates");-1===i.indexOf(m)&&(i.push(m),t.save()),E&&E.close(),e.app.quit()})}),Editor.isWin32){let o=e.app.getPath("exe"),t=a.join(a.dirname(o),"updater.exe");d.existsSync(t)&&r(t,["/silent"],{stdio:"inherit"})}else n.get(s,function(e){let t="";if(e.setEncoding("utf8"),200!==e.statusCode)return console.log("no valid update feed url."),void 0;e.on("data",e=>{t+=e}).on("end",()=>{var e;try{if(e=JSON.parse(t))return b=!0,function(e){let t=require("md5-file");f=e.name,h=e.notes,o.download(Editor.Window.main.nativeWin,e.url).then(o=>{v=o.getSavePath(),t(v,(o,t)=>o?(console.error(o),void 0):t!==e.md5?(console.log(`Downloaded v${e.version} update failed md5 hash check. Abort updating.`),void 0):(q(),void 0))}).catch(console.error)}(e),void 0}catch(e){return console.error(e),void 0}})}).on("error",e=>{console.log(`Got error: ${e.message}`)});b||n.get(u,function(e){let o="";if(e.setEncoding("utf8"),200!==e.statusCode)return console.log("no valid update feed url."),void 0;e.on("data",e=>{o+=e}).on("end",()=>{var e;try{if(e=JSON.parse(o))return w(e),void 0}catch(e){return console.error(e),void 0}})}).on("error",e=>{console.log(`Got error: ${e.message}`)});