"use strict";const t=require("vm"),e=require("../settings"),i=require("./utils"),s=require("../../../share/utils"),n=require("../utils/resource-mgr"),a=require("../utils/dom-utils"),r=require("../utils/focus-mgr"),h=require("../behaviors/focusable"),l=require("../behaviors/disable"),u=require("../behaviors/readonly"),p=require("../behaviors/input-state"),o=require("../behaviors/droppable"),_=require("../utils/drag-drop"),{promisify:d}=require("util");module.exports=i.registerElement("ui-num-input",{get type(){return this._type},set type(t){this._type!==t&&(this._type=t,"int"===this._type?(this._parseFn=parseInt,this._step=parseInt(this._step),this._step=0===this._step?e.stepInt:this._step):(this._parseFn=parseFloat,this._step=parseFloat(this._step),this._step=0===this._step?e.stepFloat:this._step))},get elementType(){return this.getAttribute("elementtype")},get resourceType(){return this.getAttribute("resourcetype")},get attrType(){return this.getAttribute("attrtype")},get value(){return this._value},set value(t){null!==t&&void 0!==t||(t=0),t=this._clampValue(t),this._value!==t&&(this._value=this._parseFn(t),this._multiValues||(this.$input.value=this._formatValue(this._value)))},get values(){return this._values},set values(t){this._values=t,this._multiValues&&(this.$input.value="-")},get highlighted(){return null!==this.getAttribute("highlighted")},set highlighted(t){t?this.setAttribute("highlighted",""):this.removeAttribute("highlighted")},get invalid(){return null!==this.getAttribute("invalid")},set invalid(t){t?this.setAttribute("invalid",""):this.removeAttribute("invalid")},get min(){return this._min},set min(t){if(null===t||void 0===t)return this._min=null,void 0;this._min!==t&&(this._min=this._parseFn(t),this.value=this._value)},get max(){return this._max},set max(t){if(null===t||void 0===t)return this._max=null,void 0;this._max!==t&&(this._max=this._parseFn(t),this.value=this._value)},get precision(){return this._precision},set precision(t){void 0!==t&&null!==t&&this._precision!==t&&(this._precision=parseInt(t),this.$input.value=this._formatValue(this._value))},get step(){return this._step},set step(t){void 0!==t&&null!==t&&this._step!==t&&(this._step=this._parseFn(t),"int"===this._type?this._step=0===this._step?e.stepInt:this._step:this._step=0===this._step?e.stepFloat:this._step)},get multiValues(){return this._multiValues},set multiValues(t){if((t=!(null==t||!1===t))!==this._multiValues)return t?(this.$input.value="-",this.setAttribute("multi-values","")):(this._value=this._parseFn(this._clampValue(this._value)),this.$input.value=this._formatValue(this._value),this.removeAttribute("multi-values")),this._multiValues=t},attributeChangedCallback(t,e,i){if("type"==t||"min"==t||"max"==t||"precision"==t||"step"==t||"multi-values"==t){this[t.replace(/\-(\w)/g,function(t,e){return e.toUpperCase()})]=i}},behaviors:[h,l,u,p,o],template:'\n    <input></input>\n    <div class="spin-wrapper" tabindex="-1">\n      <div class="spin up">\n        <i class="icon-up-dir"></i>\n      </div>\n      <div class="spin-div"></div>\n      <div class="spin down">\n        <i class="icon-down-dir"></i>\n      </div>\n    </div>\n  ',style:n.getResource("theme://elements/num-input.css"),$:{input:"input",spinWrapper:".spin-wrapper",spinUp:".spin.up",spinDown:".spin.down"},factoryImpl(t){isNaN(t)||(this.value=t)},ready(){let t=this.getAttribute("droppable");t&&(this.droppable=t),"int"===this.getAttribute("type")?(this._type="int",this._parseFn=parseInt):(this._type="float",this._parseFn=parseFloat);let i=this.getAttribute("precision");this._precision=null!==i?parseInt(i):7;let s=this.getAttribute("min");this._min=null!==s?this._parseFn(s):null;let n=this.getAttribute("max");this._max=null!==n?this._parseFn(n):null,this.multiValues=this.getAttribute("multi-values");let h=this.getAttribute("value");this._value=null!==h?this._parseFn(h):null,this._value=this._clampValue(this._value);let l=this.getAttribute("step");this._step=null!==l?this._parseFn(l):"int"===this._type?e.stepInt:e.stepFloat,this.$input.value=this._formatValue(this._value),this.$input.placeholder="-",this.$input._initValue="",this.$spinWrapper.addEventListener("keydown",t=>{27===t.keyCode&&this._holdingID&&(a.acceptEvent(t),this.cancel(),this._curSpin.removeAttribute("pressed"),this._stopHolding())}),a.installDownUpEvent(this.$spinUp),this.$spinUp.addEventListener("down",t=>{a.acceptEvent(t),r._setFocusElement(this),this.$spinWrapper.focus(),this.$spinUp.setAttribute("pressed",""),this.readonly||(this._stepUp(),this._startHolding(this.$spinUp,this._stepUp))}),this.$spinUp.addEventListener("up",t=>{a.acceptEvent(t),this.$spinUp.removeAttribute("pressed",""),this._holdingID&&(this._stopHolding(),this.confirm())}),a.installDownUpEvent(this.$spinDown),this.$spinDown.addEventListener("down",t=>{a.acceptEvent(t),r._setFocusElement(this),this.$spinWrapper.focus(),this.$spinDown.setAttribute("pressed",""),this.readonly||(this._stepDown(),this._startHolding(this.$spinDown,this._stepDown))}),this.$spinDown.addEventListener("up",t=>{a.acceptEvent(t),this.$spinDown.removeAttribute("pressed",""),this._holdingID&&(this._stopHolding(),this.confirm())}),this._initFocusable(this,this.$input),this._initDisable(!1),this._initReadonly(!1),this._initInputState(this.$input),this.droppable&&this._initDroppable(this),this.$input.readOnly=this.readonly,this._initEvents()},_setIsReadonlyAttribute(t){t?this.setAttribute("is-readonly",""):this.removeAttribute("is-readonly"),this.$input.readOnly=t},_initEvents(){this.addEventListener("mousedown",this._mouseDownHandler),this.addEventListener("keydown",this._keyDownHandler),this.addEventListener("focus-changed",this._focusChangedHandler),this.$input.addEventListener("keydown",t=>{this.readonly||(38===t.keyCode?(a.acceptEvent(t),this._stepUp()):40===t.keyCode&&(a.acceptEvent(t),this._stepDown()))}),this.$input.addEventListener("mousewheel",t=>{this.focused&&(t.stopPropagation(),t.preventDefault(),this.readonly||(t.deltaY>0?this._stepDown():this._stepUp(),a.fire(this,"confirm",{bubbles:!1,detail:{value:this._value,confirmByEnter:!1}})))}),this.droppable&&(this.addEventListener("drop-area-enter",this._onDropAreaEnter.bind(this)),this.addEventListener("drop-area-leave",this._onDropAreaLeave.bind(this)),this.addEventListener("drop-area-accept",this._onDropAreaAccept.bind(this)),this.addEventListener("drop-area-move",this._onDropAreaMove.bind(this)))},_isTypeValid(t){return t===this.resourceType||cc.js.isChildClassOf(Editor.assets[t],Editor.assets[this.resourceType])},_onDropAreaMove(t){t.stopPropagation(),this.invalid?_.updateDropEffect(t.detail.dataTransfer,"none"):_.updateDropEffect(t.detail.dataTransfer,"copy")},async _onDropAreaEnter(t){t.stopPropagation();let e=t.detail.dragItems;this.checking||(this.invalid=!await this._checkType(e.map(t=>t.id)),this.highlighted=!this.invalid)},_onDropAreaLeave(t){t.stopPropagation(),this._requestID&&(Editor.Ipc.cancelRequest(this._requestID),this._requestID=null),this.highlighted=!1,this.invalid=!1},_onDropAreaAccept(t){t.stopPropagation(),this.highlighted=!1,this.invalid=!1,this._updateValue(t.detail.dragItems)},_updateValue(t){let e=t.map(t=>t.id);this.$input.value=this._value+e.length,this._value+=e.length,Editor.UI.fire(this,"confirm",{bubbles:!1,detail:{value:this._value,dragItems:t}})},async _checkType(t){this.checking=!0;let e=!1,i=this.parentElement.__vue__;if(!i)return this.checking=!1,e;let s=!1,n=i.target;if(n&&n.values&&1===n.values.length&&(s=!!n.values[0].find(e=>!!t.find(t=>t===e.value.uuid))),s)return this.checking=!1,e;try{let i=t.map(async t=>"cc.Node"===this.elementType?await this._queryNodeInfo(t):await this._queryAssetInfo(t));await Promise.all(i),e=!0}catch(t){}return this.checking=!1,e},async _queryNodeInfo(t){let e=await d(Editor.Ipc.sendToPanel)("scene","scene:query-node-info",t,this.attrType);return this.highlighted=!0,"cc.Node"!==this.resourceType&&e.compID?Promise.resolve():Promise.reject()},async _queryAssetInfo(t){let e=await d(Editor.assetdb.queryMetaInfoByUuid)(t);if(this._isTypeValid(e.assetType))return Promise.resolve();let i=JSON.parse(e.json),s=Object.keys(i.subMetas);if(1!==s.length)return Promise.reject();let n=i.subMetas[s[0]].uuid,a=d(Editor.assetdb.queryInfoByUuid)(n);return this._isTypeValid(a.type)?Promise.resolve():Promise.reject()},_formatValue(t){return null===t||""===t?"":"int"===this._type?s.toFixed(t,0):0===this._precision?s.toFixed(t,this._precision):s.toFixed(t,this._precision,this._precision)},_clampValue(t){return null!==this._min&&void 0!==this._min&&(t=Math.max(this._min,t)),null!==this._max&&void 0!==this._max&&(t=Math.min(this._max,t)),t},_parseInput(){if(null===this.$input.value)return 0;if(""===this.$input.value.trim())return 0;let e={res:NaN};try{t.runInNewContext(`\n          res = ${this.$input.value};\n        `,e)}catch(t){}let i=this._parseFn(e.res);return isNaN(i)?(i=this._parseFn(this.$input._initValue),i=this._parseFn(this._formatValue(i))):i=this._parseFn(this._formatValue(i)),i},_stepUp(){var t=this._value;Array.isArray(t)&&(t=t[0]);let e=t+this._step;e=this._clampValue(e),this.$input.value=this._formatValue(e),this._onInputChange()},_stepDown(){var t=this._value;Array.isArray(t)&&(t=t[0]);let e=t-this._step;e=this._clampValue(e),this.$input.value=this._formatValue(e),this._onInputChange()},_startHolding(t,e){this._curSpin=t,this._holdingID=setTimeout(()=>{this._stepingID=setInterval(()=>{e.apply(this)},50)},500)},_stopHolding(){clearInterval(this._holdingID),this._holdingID=null,clearTimeout(this._stepingID),this._stepingID=null,this._curSpin=null},clear(){this.$input.value="",this.confirm()},confirm(){this._onInputConfirm(this.$input)},cancel(){this._onInputCancel(this.$input)},_onInputConfirm(t,e){if(!this.readonly&&this._changed){this._changed=!1;let i=this._parseInput(),s=i;i=this._clampValue(i);let n=this._formatValue(i);t.value=n,t._initValue=n,this._value=i,s!==i&&a.fire(this,"change",{bubbles:!1,detail:{value:this._value}}),a.fire(this,"confirm",{bubbles:!1,detail:{value:this._value,confirmByEnter:e}})}e&&this.focus()},_onInputCancel(t,e){if(!this.readonly&&this._changed){if(this._changed=!1,t._initValue!==t.value){t.value=t._initValue;let e=this._parseInput(),i=this._formatValue(e);t.value=i,t._initValue=i,this._value=e,a.fire(this,"change",{bubbles:!1,detail:{value:this._value}})}a.fire(this,"cancel",{bubbles:!1,detail:{value:this._value,cancelByEsc:e}})}e&&(t.blur(),this.focus())},_onInputChange(){this._changed=!0,this._value=this._parseInput(),this.multiValues=!1,a.fire(this,"change",{bubbles:!1,detail:{value:this._value}})},_mouseDownHandler(t){t.stopPropagation(),r._setFocusElement(this)},_keyDownHandler(t){this.disabled||13!==t.keyCode&&32!==t.keyCode||(a.acceptEvent(t),this.$input._initValue=this.$input.value,this.$input.focus(),this.$input.select())},_focusChangedHandler(){this.focused?this.$input._initValue=this.$input.value:this._unselect(this.$input)}});