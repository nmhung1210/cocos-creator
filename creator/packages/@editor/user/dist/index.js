"use strict";var __awaiter=this&&this.__awaiter||function(e,n,o,t){return new(o||(o=Promise))(function(i,s){function r(e){try{c(t.next(e))}catch(e){s(e)}}function a(e){try{c(t.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):new o(function(n){n(e.value)}).then(r,a)}c((t=t.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const{EventEmitter:EventEmitter}=require("events"),{network:network}=require("./utils"),info={session_id:"",session_key:"",cocos_uid:"",email:"",nickname:""},EventManager=new EventEmitter;function setData(e){info.session_id=e.session_id,info.session_key=e.session_key,info.cocos_uid=e.cocos_uid,info.email=e.email,info.nickname=e.nickname,EventManager.emit("info-update")}function getData(){return info}function isLoggedIn(){return __awaiter(this,void 0,void 0,function*(){if(!info.session_key)return!1;let e;return 0===(e=yield network.sendPostRequest("https://creator-api.cocos.com/api/account/is_online",{session_key:info.session_key})).status&&(info.session_id=e.data.session_id,info.session_key=e.data.session_key,info.cocos_uid=e.data.cocos_uid,info.email=e.data.email,info.nickname=e.data.nickname,EventManager.emit("info-update"),!0)})}function login(e,n){return __awaiter(this,void 0,void 0,function*(){let o;if(0!==(o=yield network.sendPostRequest("https://creator-api.cocos.com/api/account/signin",{username:e,password:n})).status)throw new Error(o.status+": "+o.msg);return info.session_id=o.data.session_id,info.session_key=o.data.session_key,info.cocos_uid=o.data.cocos_uid,info.email=o.data.email,info.nickname=o.data.nickname,EventManager.emit("info-update"),EventManager.emit("login"),{nickname:info.nickname,email:info.email}})}function logout(){return __awaiter(this,void 0,void 0,function*(){let e;if(0!==(e=yield network.sendPostRequest("https://creator-api.cocos.com/api/user/signout",{session_id:info.session_id})).status)throw new Error(e.status+": "+e.msg);return info.session_id="",info.session_key="",info.cocos_uid="",info.email="",info.nickname="",EventManager.emit("info-update"),EventManager.emit("logout"),!0})}function getUserToken(){return __awaiter(this,void 0,void 0,function*(){let e;if(0!==(e=yield network.sendPostRequest("https://creator-api.cocos.com/api/user/cocos_token",{session_id:info.session_id})).status)throw new Error(e.status+": "+e.msg);return e.data})}function getSessionCode(e){return __awaiter(this,void 0,void 0,function*(){let n;if(0!==(n=yield network.sendPostRequest("https://creator-api.cocos.com/api/session/code",{session_id:info.session_id,plugin_id:e})).status)throw new Error(n.status+": "+n.msg);return n.data})}function on(...e){EventManager.on(...e)}function once(...e){EventManager.once(...e)}function removeListener(...e){EventManager.removeListener(...e)}exports.setData=setData,exports.getData=getData,exports.isLoggedIn=isLoggedIn,exports.login=login,exports.logout=logout,exports.getUserToken=getUserToken,exports.getSessionCode=getSessionCode,exports.on=on,exports.once=once,exports.removeListener=removeListener;const children=[];function addChildProcess(e){-1===children.indexOf(e)&&(children.push(e),e.__handle=function(n){return __awaiter(this,void 0,void 0,function*(){if(!n||!n.channel||"cocos-user"!==n.channel)return;const o=module.exports[n.func];if(!o)return;let t;try{t=yield o(...n.params||[])}catch(o){return void e.send({channel:"cocos-user",id:n.id,error:o.message,result:null})}e.send({channel:"cocos-user",id:n.id,error:null,result:t})})},e.on("message",e.__handle))}function removeChildProcess(e){const n=children.indexOf(e);-1!==n&&(children.splice(n,1),e.removeListener("message",e.__handle))}if(exports.addChildProcess=addChildProcess,exports.removeChildProcess=removeChildProcess,EventManager.on("login",()=>{children.forEach(e=>{e.send({channel:"cocos-user",emit:"login",result:[]})})}),EventManager.on("logout",()=>{children.forEach(e=>{e.send({channel:"cocos-user",emit:"logout",result:[]})})}),EventManager.on("info-update",()=>{children.forEach(e=>{e.send({channel:"cocos-user",emit:"info-update",result:[]})})}),"browser"===process.type){const e=require("@base/electron-base-ipc");e.on("cocos-user",(e,n,o)=>__awaiter(this,void 0,void 0,function*(){const t=module.exports[n];if(!t)return;let i;try{i=yield t(...o||[])}catch(n){return void e.reply(n,null)}e.reply(null,i)})),EventManager.on("login",()=>{e.broadcast("cocos-user-emit","login")}),EventManager.on("logout",()=>{e.broadcast("cocos-user-emit","logout")}),EventManager.on("info-update",()=>{e.broadcast("cocos-user-emit","info-update")})}